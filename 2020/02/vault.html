
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="" />

  <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:ital,wght@0,400;0,700;1,400&family=Source+Sans+Pro:ital,wght@0,300;0,400;0,700;1,400&display=swap" rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="../../theme/stylesheet/style.min.css">

    <link id="dark-theme-style" rel="stylesheet" type="text/css"
          media="(prefers-color-scheme: dark)"
    href="../../theme/stylesheet/dark-theme.min.css">

    <link id="pygments-dark-theme" rel="stylesheet" type="text/css"
              media="(prefers-color-scheme: dark)"
          href="../../theme/pygments/monokai.min.css">
    <link id="pygments-light-theme" rel="stylesheet" type="text/css"
              media="(prefers-color-scheme: light), (prefers-color-scheme: no-preference)"
          href="../../theme/pygments/sas.min.css">


  <link rel="stylesheet" type="text/css" href="../../theme/font-awesome/css/fontawesome.css">
  <link rel="stylesheet" type="text/css" href="../../theme/font-awesome/css/brands.css">
  <link rel="stylesheet" type="text/css" href="../../theme/font-awesome/css/solid.css">


    <link href="https://maggick.fr/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="maggick's logs Atom">



  


 

<meta name="author" content="maggick" />
<meta name="description" content="&#34;Secure, store and tightly control access to tokens, passwords, certificates, encryption keys for protecting secrets and other sensitive data using a UI, CLI, or HTTP API.&#34;" />
<meta name="keywords" content="security, devops, vault">


  <meta property="og:site_name" content="maggick's logs"/>
  <meta property="og:title" content="Vault"/>
  <meta property="og:description" content="&#34;Secure, store and tightly control access to tokens, passwords, certificates, encryption keys for protecting secrets and other sensitive data using a UI, CLI, or HTTP API.&#34;"/>
  <meta property="og:locale" content="en_US"/>
  <meta property="og:url" content="../../2020/02/vault.html"/>
  <meta property="og:type" content="article"/>
  <meta property="article:published_time" content="2020-02-08 10:35:00+01:00"/>
  <meta property="article:modified_time" content=""/>
  <meta property="article:author" content="../../author/maggick.html">
  <meta property="article:section" content="security"/>
  <meta property="article:tag" content="security"/>
  <meta property="article:tag" content="devops"/>
  <meta property="article:tag" content="vault"/>
  <meta property="og:image" content="https://maggick.fr/media/image.png">

  <title>maggick's logs &ndash; Vault</title>

</head>
<body >
  <aside>
    <div>
      <a href="../../">
        <img src="https://maggick.fr/media/image.png" alt="maggick's logs" title="maggick's logs">
      </a>

      <h1>
        <a href="../../">maggick's logs</a>
      </h1>

<p>Offensive security tales</p>

      <nav>
        <ul class="list">


              <li>
                <a target="_self"
                   href="../../pages/about.html">
                  About
                </a>
              </li>
              <li>
                <a target="_self"
                   href="../../pages/notes.html">
                  Notes
                </a>
              </li>
              <li>
                <a target="_self"
                   href="../../pages/tools.html">
                  Tools
                </a>
              </li>

        </ul>
      </nav>

      <ul class="social">
          <li>
            <a  class="sc-github" href="https://github.com/maggick" target="_blank">
              <i class="fab fa-github"></i>
            </a>
          </li>
          <li>
            <a  class="sc-twitter" href="https://twitter.com/maggick_fr" target="_blank">
              <i class="fab fa-twitter"></i>
            </a>
          </li>
          <li>
            <a  class="sc-stack-overflow" href="http://stackoverflow.com/users/1827067/maggick" target="_blank">
              <i class="fab fa-stack-overflow"></i>
            </a>
          </li>
          <li>
            <a  class="sc-rss" href="https://maggick.fr/feeds/all.atom.xml" target="_blank">
              <i class="fas fa-rss"></i>
            </a>
          </li>
      </ul>
    </div>

  </aside>
  <main>

    <nav>
      <a href="../../">Home</a>

      <a href="/archives.html">Archives</a>
      <a href="/categories.html">Categories</a>
      <a href="/tags.html">Tags</a>

      <a href="https://maggick.fr/feeds/all.atom.xml">Atom</a>

    </nav>

<article class="single">
  <header>
      
    <h1 id="vault">Vault</h1>
    <p>
      Posted on 08 Feb 2020 in <a href="../../category/security.html">security</a>

        &#8226; 4 min read
    </p>
  </header>


  <div>
    <blockquote>
<p>"Secure, store and tightly control access to tokens, passwords, certificates, encryption keys for protecting secrets and other sensitive data using a UI, CLI, or HTTP API."</p>
</blockquote>


<h1>Presentation</h1>
<h2>Install</h2>
<p>Just go on the <a href="https://www.vaultproject.io/downloads.html">download page</a> and
get the package adapted to your system. Once you extract the downloaded zip, you
will get a binary. Execute it without any option to get the help menu.</p>
<div class="highlight"><pre><span></span><code>$ ./vault
Usage: vault &lt;command&gt; [args]

Common commands:
    read        Read data and retrieves secrets
    write       Write data, configuration, and secrets
    delete      Delete secrets and configuration
    list        List data or secrets
    login       Authenticate locally
    agent       Start a Vault agent
    server      Start a Vault server
    status      Print seal and HA status
    unwrap      Unwrap a wrapped secret

Other commands:
    audit          Interact with audit devices
    auth           Interact with auth methods
    debug          Runs the debug command
    kv             Interact with Vault&#39;s Key-Value storage
    lease          Interact with leases
    namespace      Interact with namespaces
    operator       Perform operator-specific tasks
    path-help      Retrieve API help for paths
    plugin         Interact with Vault plugins and catalog
    policy         Interact with policies
    print          Prints runtime configurations
    secrets        Interact with secrets engines
    ssh            Initiate an SSH session
    token          Interact with tokens
</code></pre></div>

<h2>Getting started</h2>
<p>Running dev server and exporting the <code>vault</code> address</p>
<blockquote>
<p>The dev server is a built-in, pre-configured server that is not very secure but useful for playing with Vault locally.</p>
</blockquote>
<div class="highlight"><pre><span></span><code>$ ./vault server -dev
$ export VAULT_ADDR=&#39;http://127.0.0.1:8200&#39;
</code></pre></div>

<p>We can get the server status with the <code>status</code> command. The server is
initialized and unsealed.</p>
<div class="highlight"><pre><span></span><code>$ ./vault status
Key             Value
---             -----
Seal Type       shamir
Initialized     true
Sealed          false
Total Shares    1
Threshold       1
Version         1.3.0
Cluster Name    vault-cluster-f6bdd069
Cluster ID      14ded467-9ad3-3fc4-4403-bea46156b766
HA Enabled      false
</code></pre></div>

<p>This article will not describe the vault's tutorial. If you want to
manipulate vault:
<a href="https://www.vaultproject.io/intro/getting-started/index.html">vault's getting started</a>.</p>
<h1>Vault for pentesters</h1>
<p>What is really interesting is how to steal vault's secrets and maybe escalate
your privileges.
For the following we simulate a situation where we compromised a GNU/Linux
box and get a user shell.</p>
<h2>Detecting the vault</h2>
<p>First of all we need to know of vault is running on the machine. For that we can
run a simple <code>ps</code>.</p>
<div class="highlight"><pre><span></span><code>$ ps aux | grep vault
root      2442  0.0  3.3  69564 68136 ?        SLsl 06:56   0:01 vault server -config /vault/config/config.hcl
</code></pre></div>

<h2>Login</h2>
<p>Then we need to login on the vault in order to get some information. Vault allow
sixteen login methods. Here we will present only two of them:</p>
<ol>
<li>token: the default method, a token is use to identify the user.</li>
<li>username: "classical" username/password authentication method</li>
</ol>
<p>In order to use a non default method you need to use the <code>--method</code> option for
instance:</p>
<div class="highlight"><pre><span></span><code>$ vault login -method=userpass username=my-username
Password (will be hidden):
</code></pre></div>

<p>For more information about
<a href="https://www.vaultproject.io/docs/auth/index.html">vault's authentication methods</a>.</p>
<p>In order to get a foothold on the vault instance we will need some
credentials: enumerate!</p>
<h3>Root policy</h3>
<p>Once login on the vault we can list our permission if we are in the "root"
policy we get a root access to the vault and can access every secret.</p>
<div class="highlight"><pre><span></span><code>$ vault login
Token (will be hidden):
Success! You are now authenticated. The token information displayed below
is already stored in the token helper. You do NOT need to run &quot;vault login&quot;
again. Future Vault requests will automatically use this token.

Key                  Value
---                  -----
token                f1783c8d-41c7-0b12-d1c1-cf2aa17ac6b9
token_accessor       1dd7b9a1-f0f1-f230-dc76-46970deb5103
token_duration       âˆž
token_renewable      false
token_policies       [&quot;root&quot;]
identity_policies    []
policies             [&quot;root&quot;]
</code></pre></div>

<p>If you do not have access to the "root" policy, you will still have access to
some secrets, maybe only with the right permissions.</p>
<p>Either ways, you should enumerate and see what you can do from there.</p>
<h2>Enumerating the secrets engines</h2>
<p>It is quit simple to list the available secrets engine (for a more detailed
output you can add the <code>-detailed</code> parameter):</p>
<div class="highlight"><pre><span></span><code>$ vault secrets list
Path          Type         Description
----          ----         -----------
cubbyhole/    cubbyhole    per-token private secret storage
secret/       kv           key/value secret storage
sys/          system       system endpoints used for control, policy and debugging
</code></pre></div>

<h2>Enumerating the secrets for an engine</h2>
<p>Once you know which secrets engines are running you will be able to list the
secrets from them.</p>
<p>Here we will list the secret from the basic kv (key-value) secrets engine.</p>
<p>If the vault is accessible with HTTP, open your browser and login to list
graphically the available information.</p>
<p><img alt="listing the secret engines" src="/media/2020.02/vault_1.png"></p>
<p><img alt="Exploring the secrets' secrets" src="/media/2020.02/vault_2.png"></p>
<p><img alt="Displaying the value associated to the &quot;foo&quot; key" src="/media/2020.02/vault_3.png"></p>
<p>If you do not have access to a web interface, you can list the secret using the
CLI.</p>
<div class="highlight"><pre><span></span><code>$ ./vault kv list secret/
Keys
----
adsfdasfdas
hello
$ ./vault kv list secret/
Keys
----
adsfdasfdas
hello
$ ./vault kv get secret/hello
====== Metadata ======
Key              Value
---              -----
created_time     2019-11-15T14:10:00.428186002Z
deletion_time    n/a
destroyed        false
version          2

=== Data ===
Key    Value
---    -----
foo    world
</code></pre></div>

<h2>SSH</h2>
<p>Vault allow to store other object than key:value couples. For instance it is
possible to configure Vault to provide a one time password to connect with ssh
to a remote server (with the contribution of an ssh-helper client side. More
information on how to install this:
<a href="https://www.vaultproject.io/docs/secrets/ssh/one-time-ssh-passwords.html">documentation OTP SSH</a>)</p>
<p>Once installed and configured it allow to connect to "remote" host:</p>
<div class="highlight"><pre><span></span><code>user@vm:~$ vault ssh -mode=otp -role=root_otp root@127.0.0.1
Vault could not locate &quot;sshpass&quot;. The OTP code for the session is displayed
below. Enter this code in the SSH password prompt. If you install sshpass,
Vault can automatically perform this step for you.
OTP for the session is: 3ee17d0c-1eef-a286-fd6d-e50702c38c00

Password:
root@vm:~# id
uid=0(root) gid=0(root) groups=0(root)
</code></pre></div>

<p>This might allow you to pivot from the compromised host to another.</p>
<h1>Short conclusion</h1>
<p>This article just scratch the vault surface as there is <a href="https://www.vaultproject.io/docs/secrets/index.html">eighteen secrets
engine</a> at the moment and I
have not speak about sealing and unsealing the vault.
This solution can resolve some authentication and secret sharing issues but
it is crucial that the vault's authentication secrets are well keep.</p>
  </div>
  <div class="tag-cloud">
    <p>
      <a href="../../tag/security.html">security</a>
      <a href="../../tag/devops.html">devops</a>
      <a href="../../tag/vault.html">vault</a>
    </p>
  </div>


  <div class="neighbors">
    <a class="btn float-left" href="../../2020/01/htb-bitlab.html" title="HTB: Bitlab">
      <i class="fa fa-angle-left"></i> Previous Post
    </a>
    <a class="btn float-right" href="../../2020/03/htb-postman.html" title="HTB: Postman">
      Next Post <i class="fa fa-angle-right"></i>
    </a>
  </div>



</article>

    <footer>
<p>
  &copy; 2022  - This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/4.0/deed.en_US" target="_blank">Creative Commons Attribution</a>
</p>
<p>
Built with <a href="http://getpelican.com" target="_blank">Pelican</a> using <a href="http://bit.ly/flex-pelican" target="_blank">Flex</a> theme
  <span class="footer-separator">|</span>
  Switch to the <a href="javascript:void(0)" onclick="theme.switch(`dark`)">dark</a> | <a href="javascript:void(0)" onclick="theme.switch(`light`)">light</a> | <a href="javascript:void(0)" onclick="theme.switch(`browser`)">browser</a> theme
  <script id="dark-theme-script"
          src="../../theme/dark-theme/dark-theme.min.js"
          data-enable-auto-detect-theme="True"
          data-default-theme="light"
          type="text/javascript">
  </script>
</p><p>
  <a rel="license"
     href="http://creativecommons.org/licenses/by/4.0/"
     target="_blank">
    <img alt="Creative Commons License"
         title="Creative Commons License"
         style="border-width:0"
           src="https://i.creativecommons.org/l/by/4.0/80x15.png"
         width="80"
         height="15"/>
  </a>
</p>    </footer>
  </main>




<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " maggick's logs ",
  "url" : "../..",
  "image": "https://maggick.fr/media/image.png",
  "description": ""
}
</script>

</body>
</html>