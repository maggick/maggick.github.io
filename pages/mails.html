
<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="IE=edge" http-equiv="X-UA-Compatible"/>
<meta content="True" name="HandheldFriendly"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<meta content="noindex, nofollow" name="robots"/>
<link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:ital,wght@0,400;0,700;1,400&amp;family=Source+Sans+Pro:ital,wght@0,300;0,400;0,700;1,400&amp;display=swap" rel="stylesheet"/>
<link href="../theme/stylesheet/style.min.css" rel="stylesheet" type="text/css"/>
<link href="../theme/stylesheet/dark-theme.min.css" id="dark-theme-style" media="(prefers-color-scheme: dark)" rel="stylesheet" type="text/css"/>
<link href="../theme/pygments/monokai.min.css" id="pygments-dark-theme" media="(prefers-color-scheme: dark)" rel="stylesheet" type="text/css"/>
<link href="../theme/pygments/sas.min.css" id="pygments-light-theme" media="(prefers-color-scheme: light), (prefers-color-scheme: no-preference)" rel="stylesheet" type="text/css"/>
<link href="../theme/font-awesome/css/fontawesome.css" rel="stylesheet" type="text/css"/>
<link href="../theme/font-awesome/css/brands.css" rel="stylesheet" type="text/css"/>
<link href="../theme/font-awesome/css/solid.css" rel="stylesheet" type="text/css"/>
<link href="https://maggick.fr/feeds/all.atom.xml" rel="alternate" title="maggick's logs Atom" type="application/atom+xml"/>
<meta content="maggick" name="author"/>
<meta content="" name="description"/>
<meta content="maggick's logs" property="og:site_name"/>
<meta content="blog" property="og:type"/>
<meta content="maggick's logs" property="og:title"/>
<meta content="" property="og:description"/>
<meta content="en_US" property="og:locale"/>
<meta content=".." property="og:url"/>
<meta content="https://maggick.fr/media/image.png" property="og:image"/>
<title>maggick's logs – Mails</title>
</head>
<body>
<aside>
<div>
<a href="../">
<img alt="maggick's logs" src="https://maggick.fr/media/image.png" title="maggick's logs"/>
</a>
<h1>
<a href="../">maggick's logs</a>
</h1>
<p>Offensive security tales</p>
<nav>
<ul class="list">
<li>
<a href="../pages/about.html" target="_self">
                About
              </a>
</li>
<li>
<a href="../pages/links.html" target="_self">
                Links
              </a>
</li>
<li>
<a href="../pages/notes.html" target="_self">
                Notes
              </a>
</li>
<li>
<a href="../pages/tools.html" target="_self">
                Tools
              </a>
</li>
</ul>
</nav>
<ul class="social">
<li>
<a class="sc-github" href="https://github.com/maggick" target="_blank">
<i class="fa-brands fa-github"></i>
</a>
</li>
<li>
<a class="sc-twitter" href="https://twitter.com/maggick_fr" target="_blank">
<i class="fa-brands fa-twitter"></i>
</a>
</li>
<li>
<a class="sc-stack-overflow" href="http://stackoverflow.com/users/1827067/maggick" target="_blank">
<i class="fa-brands fa-stack-overflow"></i>
</a>
</li>
<li>
<a class="sc-rss" href="https://maggick.fr/feeds/all.atom.xml" target="_blank">
<i class="fa-solid fa-rss"></i>
</a>
</li>
</ul>
</div>
</aside>
<main>
<nav>
<a href="../">Home</a>
<a href="/archives.html">Archives</a>
<a href="/categories.html">Categories</a>
<a href="/tags.html">Tags</a>
<a href="https://maggick.fr/feeds/all.atom.xml">Atom</a>
</nav>
<article class="single">
<header>
<h1 id="mails">Mails</h1>
</header>
<div>
<h1>Mail</h1>
<p>When I start to install my own mail server to never be dependent of a service
as Gmail, hotmail or whatever.
I choose postifix as SMTP server.</p>
<h2>SPF</h2>
<p>Sender Policy Framework (SPF) is an email validation system designed to prevent
email spam by detecting email spoofing, a common vulnerability, by verifying
sender IP addresses.</p>
<p>It is really easy to put an SPF in place.
You just have to add a DNS TXT entry :</p>
<div class="highlight"><pre><span></span><code>yourdomain.com. IN TXT "v=spf1 a mx ~all"
</code></pre></div>
<p>Source: <a href="http://nickwilsdon.com/spf-domain-records/">nickwilsdon</a></p>
<h2>DKIM</h2>
<p>DomainKeys Identified Mail (DKIM) is a method for associating a domain name to
an email message.</p>
<h3>Install</h3>
<p>First of all you need to install your DKIM solution, I use opendkim and debian:</p>
<div class="highlight"><pre><span></span><code><span class="n">aptitude</span><span class="w"> </span><span class="n">install</span><span class="w"> </span><span class="n">opendkim</span><span class="w"> </span><span class="n">opendkim</span><span class="o">-</span><span class="n">tools</span>
</code></pre></div>
<h3>Keys generation</h3>
<p>We should choose the directory were to put the keys, we choose
<code>/etc/opendkim/yourdomain/</code> (create the directory).
Then we need to create the private and the public rsa keys for singing:</p>
<div class="highlight"><pre><span></span><code>opendkim-genkey -b 2048 -r -d yourdomain.tld
</code></pre></div>
<p>the <code>-b 2048</code> define the longer of the key, here 2048 bits, the <code>-r</code> is for
restrict the key for use in e-mail signing only and the <code>-t yourdomain.tld</code> is
for a comment in the TXT record file.</p>
<h3>Configuration</h3>
<p>Now we need to edit the configuration files:</p>
<ol>
<li>/etc/opendkim.conf – OpenDKIM’s main configuration file</li>
<li>/etc/opendkim/KeyTable – a list of keys available for signing</li>
<li>/etc/opendkim/SigningTable - a list of domains and accounts allowed to sign</li>
<li>/etc/opendkim/TrustedHosts – a list of servers to “trust” when signing or
verifying</li>
</ol>
<p>(You may have to create folders and files).</p>
<h4>/etc/opendkim.conf</h4>
<p>You may have to uncomment some lines:</p>
<div class="highlight"><pre><span></span><code><span class="n">Umask</span><span class="w">         </span><span class="mi">002</span>
<span class="n">UserID</span><span class="w">        </span><span class="nl">opendkim</span><span class="p">:</span><span class="n">opendkim</span>
<span class="n">Socket</span><span class="w">        </span><span class="nl">inet</span><span class="p">:</span><span class="mi">8891</span><span class="nv">@localhost</span>
<span class="k">Domain</span><span class="w">        </span><span class="n">yourdomain</span><span class="p">.</span><span class="n">tld</span>
</code></pre></div>
<p>Next, add the following line to the configuration in order to give the location of the
other configuration to opendkim:</p>
<div class="highlight"><pre><span></span><code>Selector                deflaut
KeyTable                refile:/etc/opendkim/KeyTable
SigningTable            refile:/etc/opendkim/SigningTable
ExternalIgnoreList      refile:/etc/opendkim/TrustedHosts
InternalHosts           refile:/etc/opendkim/TrustedHosts
</code></pre></div>
<h4>/etc/opendkim/KeyTable</h4>
<p>This file contains the path to your DKIM keys (one per line) , here we have only
one key so our file is just one line:</p>
<div class="highlight"><pre><span></span><code>yourdomain.tld yourdomain.tld:default:/etc/opendkim/yourdomain/default.private
</code></pre></div>
<h4>/etc/opendkim/SigningTable</h4>
<p>This file tells to opendkim how to use the keys, here we want every mails
send from our domain to be signed:</p>
<div class="highlight"><pre><span></span><code><span class="o">*</span><span class="nv">@yourdomain</span><span class="p">.</span><span class="n">tld</span><span class="w"> </span><span class="n">yourdomain</span><span class="p">.</span><span class="n">tld</span>
</code></pre></div>
<h4>/etc/opendkim/TrustedHosts</h4>
<p>This file tells OpenDKIM who to let use your keys:</p>
<div class="highlight"><pre><span></span><code><span class="mf">127.0.0.1</span>
<span class="n">yourdomain</span><span class="mf">.</span><span class="n">tld</span>
<span class="n">mail</span><span class="mf">.</span><span class="n">yourdomain</span><span class="mf">.</span><span class="n">tld</span>
</code></pre></div>
<h3>DNS record</h3>
<p>The DNS record is the last part of this operation. You need to do it properbly
otherwise your signature would be false and unreconized by the mailing servers.
you should have a filed who describe the way you handle your DKIM:</p>
<div class="highlight"><pre><span></span><code>_domainkey                IN TXT    "o=-;"
</code></pre></div>
<p>And an other where you put your public key:</p>
<div class="highlight"><pre><span></span><code>default._domainkey        IN TXT    ( "k=rsa;
p=MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAz33vJpYC9pgwtm4JyRWLLDM5LLIn66IhgMODhW1PX7zk1eMuCdp8509sUmpk47RDbJq2VhFDGElC/9zkCMo6hrep241fVnwmOfuxA5Nvcu8YxbAvXacwusU9ct4r9Re2NjO9kshbIWBAVJ66CxBzWWsi6+ikChHbv7GsF2jbx+VG1rwbShr8AD5FbFGIh5CEVs83E"
"qJ6g8Nla+BX2A2V2gwOxT2Xp0mCIqjIFqfoyhxIcftKHHBDFxiun2WLwsUD5ivFewy54ntgphkWJUXfob+NtZ6M8sv531Zd/mgdBgnYAPzWNy5m5MGquNZNEnA44o0sAcKiCRMb7nKpTvfDQQIDAQAB"
)
</code></pre></div>
<p>Source: <a href="http://stevejenkins.com/blog/2011/08/installing-opendkim-rpm-via-yum-with-postfix-or-sendmail-for-rhel-centos-fedora/">stevejenkins</a>
<a href="http://domainkeys.sourceforge.net/policycheck.html">A DomainKey Policy Record
Tester</a>
<a href="http://domainkeys.sourceforge.net/selectorcheck.html">A DomainKey Selector Record
Tester</a></p>
<h2>Catch all</h2>
<p>Is is really interesting to catch all e-mails directed to your domain. For
instance you will catch wahtever@yourdomain.com.
To define a catch all create the <code>virtual</code> file and add it to postmap :</p>
<div class="highlight"><pre><span></span><code><span class="err">#</span><span class="w"> </span><span class="n">echo</span><span class="w"> </span><span class="s1">'@yourdomain.com emailusername'</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="k">postfix</span><span class="o">/</span><span class="n">virtual</span>
<span class="err">#</span><span class="w"> </span><span class="n">postmap</span><span class="w"> </span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="k">postfix</span><span class="o">/</span><span class="n">virtual</span>
</code></pre></div>
<p>Check that the virtual map is defined in postfix's configuration
by verifing that the following line is in the <code>/etc/postfix/main.cf</code> file.</p>
<div class="highlight"><pre><span></span><code># postmap /etc/postfix/virtual
</code></pre></div>
<p>and restart the postfix service :</p>
<div class="highlight"><pre><span></span><code><span class="c1"># service postfix reload</span>
</code></pre></div>
<p>Source: <a href="http://www.cyberciti.biz/faq/howto-setup-postfix-catch-all-email-accounts/">cyberciti</a></p>
<h3>Trouble</h3>
<p>In odrder that the existing users can get their e-mails when
there is a cath all :</p>
<p>edit the virtual_map in <code>/etc/postfix/virtual</code> and add the following line :</p>
<div class="highlight"><pre><span></span><code><span class="k">user</span><span class="nv">@domain</span><span class="p">.</span><span class="n">tld</span><span class="w"> </span><span class="k">user</span>
</code></pre></div>
<p>next execute the following commands:</p>
<div class="highlight"><pre><span></span><code>postmap /etc/postfix/virtual
service postfix restart
</code></pre></div>
<h3>Catch all with regex :</h3>
<p>You can configure some regex catch all for instance you can catch
whatever.youruser@yourdomain.com
In order to make a catch all for an user :
edit (or create) the file</p>
<div class="highlight"><pre><span></span><code><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">postfix</span><span class="o">/</span><span class="n">virtual</span><span class="o">-</span><span class="n">regexp</span>
</code></pre></div>
<p>add regexp:/etc/postfix/virtual-regexp to virtual_maps in /etc/postfix/main.cf
this will look like</p>
<div class="highlight"><pre><span></span><code><span class="n">virtual_maps</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nl">hash:</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">postfix</span><span class="o">/</span><span class="n">virtual</span><span class="p">,</span><span class="w"> </span><span class="nl">regexp:</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">postfix</span><span class="o">/</span><span class="n">virtual</span><span class="o">-</span><span class="n">regexp</span>
</code></pre></div>
<p>add the line:</p>
<div class="highlight"><pre><span></span><code><span class="o">/^</span><span class="p">.</span><span class="o">*</span><span class="k">user</span><span class="nv">@domnain</span><span class="p">.</span><span class="n">tld</span><span class="o">/</span><span class="w"> </span><span class="k">user</span>
</code></pre></div>
<p>The user will receive all mail in the form *.user@domain.tld (where * is the
classic Unix joker)</p> </div>
</article>
<footer>
<p>
  © 2022  - This work is licensed under a <a href="http://creativecommons.org/licenses/by/4.0/deed.en_US" rel="license" target="_blank">Creative Commons Attribution</a>
</p>
<p>
Built with <a href="http://getpelican.com" target="_blank">Pelican</a> using <a href="http://bit.ly/flex-pelican" target="_blank">Flex</a> theme
  <span class="footer-separator">|</span>
  Switch to the <a href="javascript:void(0)" onclick="theme.switch(`dark`)">dark</a> | <a href="javascript:void(0)" onclick="theme.switch(`light`)">light</a> | <a href="javascript:void(0)" onclick="theme.switch(`browser`)">browser</a> theme
  <script data-default-theme="light" data-enable-auto-detect-theme="True" id="dark-theme-script" src="../theme/dark-theme/dark-theme.min.js" type="text/javascript">
</script>
</p><p>
<a href="http://creativecommons.org/licenses/by/4.0/" rel="license" target="_blank">
<img alt="Creative Commons License" height="15" src="https://i.creativecommons.org/l/by/4.0/80x15.png" style="border-width:0" title="Creative Commons License" width="80">
</img></a>
</p></footer> </main>
<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " maggick's logs ",
  "url" : "..",
  "image": "https://maggick.fr/media/image.png",
  "description": ""
}
</script>
</body>
</html>